<head>
    <!-- Other head elements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>

  
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A blog about tech stuff">
      
      
        <meta name="author" content="matt.pollock@outlook.com">
      
      
        <link rel="canonical" href="https://blog.pollockweb.com/blog/category/azure/">
      
      
        <link rel="prev" href="../automation/">
      
      
        <link rel="next" href="../azure-openai/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/icons/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Azure - cloudlabmp</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-800NGKWBYL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-800NGKWBYL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-800NGKWBYL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Azure - cloudlabmp" >
      
        <meta  property="og:description"  content="A blog about tech stuff" >
      
        <meta  property="og:image"  content="https://blog.pollockweb.com/assets/images/social/blog/category/azure.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://blog.pollockweb.com/blog/category/azure/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Azure - cloudlabmp" >
      
        <meta  name="twitter:description"  content="A blog about tech stuff" >
      
        <meta  name="twitter:image"  content="https://blog.pollockweb.com/assets/images/social/blog/category/azure.png" >
      
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#azure" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
    <div class="announcement-content">
      <p>Welcome to my blog! Connect with me:</p>
      <a href="https://www.linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe fa-2x"></i>
      </a>
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github fa-2x"></i>
      </a>
      <a href="https://blog.pollockweb.com/feed_rss_created.xml" target="_blank" title="RSS Feed">
        <i class="fa-solid fa-rss fa-2x"></i>
      </a>
    </div>
  
          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://blog.pollockweb.com/blog/" title="cloudlabmp" class="md-header__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cloudlabmp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Azure
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../learn/" class="md-tabs__link">
        
  
    
  
  Learn

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../work/" class="md-tabs__link">
        
  
    
  
  Work

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://blog.pollockweb.com/blog/" title="cloudlabmp" class="md-nav__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    cloudlabmp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Posts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Posts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai--study-techniques/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI &amp; Study Techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI Integration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../application-insights/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Insights
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Azure
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Azure
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-bcdr-review-turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      ⚙️ Azure BCDR Review – Turning Inherited Cloud Infrastructure into a Resilient Recovery Strategy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-bcdr-how-i-turned-a-dr-review-into-a-strategic-recovery-plan" class="md-nav__link">
    <span class="md-ellipsis">
      🧾 Azure BCDR – How I Turned a DR Review into a Strategic Recovery Plan
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads" class="md-nav__link">
    <span class="md-ellipsis">
      🕵️ Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing SQL Credentials with User Assigned Managed Identity (UAMI) in Azure SQL Managed Instance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-an-iis-based-web-farm-with-azure-application-insights" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Monitoring an IIS-Based Web Farm with Azure Application Insights
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../azure-openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure OpenAI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../bcdr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BCDR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blogging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blogging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CI/CD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../career-development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Career Development
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../claude-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Claude Code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-engineering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Engineering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-resume-challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Resume Challenge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../containers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Containers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../finops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FinOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../gitops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../group-policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Group Policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../iis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IIS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../iac/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IaC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../identity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Identity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../infrastructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../intune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../learning-projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning Projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../life-update/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Life Update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../microsoft-certifications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microsoft Certifications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../patch-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Patch Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../powershell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PowerShell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../rag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RAG
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../regional-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Regional Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../scripting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scripting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../self-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Self-Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../serverless/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serverless
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../time-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../vector-databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vector Databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../vibe-coding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vibe Coding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../web-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learn
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../work/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Work
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-bcdr-review-turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      ⚙️ Azure BCDR Review – Turning Inherited Cloud Infrastructure into a Resilient Recovery Strategy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-bcdr-how-i-turned-a-dr-review-into-a-strategic-recovery-plan" class="md-nav__link">
    <span class="md-ellipsis">
      🧾 Azure BCDR – How I Turned a DR Review into a Strategic Recovery Plan
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads" class="md-nav__link">
    <span class="md-ellipsis">
      🕵️ Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing SQL Credentials with User Assigned Managed Identity (UAMI) in Azure SQL Managed Instance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-an-iis-based-web-farm-with-azure-application-insights" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Monitoring an IIS-Based Web Farm with Azure Application Insights
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="azure">Azure</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-29 00:00:00+00:00">May 29, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../automation/" class="md-meta__link">Automation</a>, 
              <a href="../patch-management/" class="md-meta__link">Patch Management</a></li>
        
        
          
          <li class="md-meta__item">
            
              21 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager</a></h2>
<blockquote>
<p>It's all fun and games until the MSP contract expires and you realise 90 VMs still need their patching schedules sorted…</p>
</blockquote>
<p>With our MSP contract winding down, the time had come to bring VM patching <em>back in house</em>. Our third-party provider had been handling it with their own tooling, which would no longer be used when the service contract expired.</p>
<p>Enter <a href="https://learn.microsoft.com/en-us/azure/update-manager/overview">Azure Update Manager</a> — the modern, agentless way to manage patching schedules across your Azure VMs. Add a bit of PowerShell, sprinkle in some Azure Policy, and you've got yourself a scalable, policy-driven solution that's more visible, auditable, and way more maintainable.</p>
<p>Here's how I made the switch — and managed to avoid a patching panic.</p>
<hr />
<h3 id="prerequisites-permissions"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#prerequisites-permissions">⚙️ Prerequisites &amp; Permissions</a></h3>
<p>Let's get the plumbing sorted before diving in.</p>
<p>You'll need:</p>
<ul>
<li>The right <strong>PowerShell modules</strong>:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nb">Install-Module</span> <span class="n">Az</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span> <span class="n">-Force</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="nb">Import-Module</span> <span class="n">Az</span><span class="p">.</span><span class="n">Maintenance</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Resources</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Compute</span>
</span></code></pre></div>
<ul>
<li>An account with <strong>Contributor</strong> permissions (or higher)</li>
<li>Registered providers to avoid mysterious error messages:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Maintenance</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">GuestConfiguration</span>
</span></code></pre></div>
<blockquote>
<p><strong>Why Resource Providers?</strong> Azure Update Manager needs these registered to create the necessary API endpoints and resource types in your subscription. Without them, you'll get cryptic "resource type not found" errors.</p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/overview#prerequisites">Official documentation on Azure Update Manager prerequisites</a></p>
<hr />
<h3 id="step-1-audit-the-current-setup"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-1-audit-the-current-setup">🕵️ Step 1 – Audit the Current Setup</a></h3>
<p>First order of business: collect the patching summary data from the MSP — which, helpfully, came in the form of multiple weekly CSV exports.</p>
<p>I used GenAI to wrangle the mess into a structured format. The result was a clear categorisation of VMs based on the day and time they were typically patched — a solid foundation to work from.</p>
<hr />
<h3 id="step-2-create-seven-new-maintenance-configurations"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-2-create-seven-new-maintenance-configurations">🧱 Step 2 – Create Seven New Maintenance Configurations</a></h3>
<p>This is the foundation of Update Manager — define your recurring patch windows.</p>
<details>
<summary>Click to expand: Create Maintenance Configurations (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c"># Azure Update Manager - Create Weekly Maintenance Configurations</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="c"># Pure PowerShell syntax</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="c"># Define parameters</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="nv">$resourceGroupName</span> <span class="p">=</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="nv">$location</span> <span class="p">=</span> <span class="s2">&quot;uksouth&quot;</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="nv">$timezone</span> <span class="p">=</span> <span class="s2">&quot;GMT Standard Time&quot;</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="nv">$startDateTime</span> <span class="p">=</span> <span class="s2">&quot;2024-06-01 21:00&quot;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="nv">$duration</span> <span class="p">=</span> <span class="s2">&quot;03:00&quot;</span>  <span class="c"># 3 hours - meets minimum requirement</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="c"># Day mapping for config naming (3-letter lowercase)</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="nv">$dayMap</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>    <span class="s2">&quot;Monday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>    <span class="s2">&quot;Tuesday&quot;</span>   <span class="p">=</span> <span class="s2">&quot;tue&quot;</span> 
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>    <span class="s2">&quot;Thursday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>    <span class="s2">&quot;Friday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>    <span class="s2">&quot;Saturday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;sat&quot;</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>    <span class="s2">&quot;Sunday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="p">}</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="c"># Create maintenance configurations for each day</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$day</span> <span class="k">in</span> <span class="nv">$dayMap</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>    <span class="nv">$shortDay</span> <span class="p">=</span> <span class="nv">$dayMap</span><span class="p">[</span><span class="nv">$day</span><span class="p">]</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>    <span class="nv">$configName</span> <span class="p">=</span> <span class="s2">&quot;contoso-maintenance-config-vms-$shortDay&quot;</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Creating: $configName for $day...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">New-AzMaintenanceConfiguration</span> <span class="p">`</span>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>            <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="p">`</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>            <span class="n">-Name</span> <span class="nv">$configName</span> <span class="p">`</span>
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>            <span class="n">-MaintenanceScope</span> <span class="s2">&quot;InGuestPatch&quot;</span> <span class="p">`</span>
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>            <span class="n">-Location</span> <span class="nv">$location</span> <span class="p">`</span>
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>            <span class="n">-StartDateTime</span> <span class="nv">$startDateTime</span> <span class="p">`</span>
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>            <span class="n">-Timezone</span> <span class="nv">$timezone</span> <span class="p">`</span>
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>            <span class="n">-Duration</span> <span class="nv">$duration</span> <span class="p">`</span>
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>            <span class="n">-RecurEvery</span> <span class="s2">&quot;Week $day&quot;</span> <span class="p">`</span>
</span><span id="__span-44-39"><a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>            <span class="n">-InstallPatchRebootSetting</span> <span class="s2">&quot;IfRequired&quot;</span> <span class="p">`</span>
</span><span id="__span-44-40"><a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a>            <span class="n">-ExtensionProperty</span> <span class="p">@{</span><span class="s2">&quot;InGuestPatchMode&quot;</span> <span class="p">=</span> <span class="s2">&quot;User&quot;</span><span class="p">}</span> <span class="p">`</span>
</span><span id="__span-44-41"><a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>            <span class="n">-WindowParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-44-42"><a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a>            <span class="n">-LinuxParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-44-43"><a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a>            <span class="n">-Tag</span> <span class="p">@{</span>
</span><span id="__span-44-44"><a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a>                <span class="s2">&quot;Application&quot;</span>  <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-44-45"><a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a>                <span class="s2">&quot;Owner&quot;</span>        <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-44-46"><a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a>                <span class="s2">&quot;PatchWindow&quot;</span>  <span class="p">=</span> <span class="nv">$shortDay</span>
</span><span id="__span-44-47"><a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a>            <span class="p">}</span> <span class="p">`</span>
</span><span id="__span-44-48"><a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a>            <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-44-49"><a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a>
</span><span id="__span-44-50"><a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✓ SUCCESS: $configName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-44-51"><a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a>
</span><span id="__span-44-52"><a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a>        <span class="c"># Quick validation</span>
</span><span id="__span-44-53"><a id="__codelineno-44-53" name="__codelineno-44-53" href="#__codelineno-44-53"></a>        <span class="nv">$createdConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="n">-Name</span> <span class="nv">$configName</span>
</span><span id="__span-44-54"><a id="__codelineno-44-54" name="__codelineno-44-54" href="#__codelineno-44-54"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Validated: </span><span class="p">$(</span><span class="nv">$createdConfig</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2"> schedule confirmed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-44-55"><a id="__codelineno-44-55" name="__codelineno-44-55" href="#__codelineno-44-55"></a>
</span><span id="__span-44-56"><a id="__codelineno-44-56" name="__codelineno-44-56" href="#__codelineno-44-56"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-44-57"><a id="__codelineno-44-57" name="__codelineno-44-57" href="#__codelineno-44-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✗ FAILED: $configName - </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-44-58"><a id="__codelineno-44-58" name="__codelineno-44-58" href="#__codelineno-44-58"></a>        <span class="k">continue</span>
</span><span id="__span-44-59"><a id="__codelineno-44-59" name="__codelineno-44-59" href="#__codelineno-44-59"></a>    <span class="p">}</span>
</span><span id="__span-44-60"><a id="__codelineno-44-60" name="__codelineno-44-60" href="#__codelineno-44-60"></a><span class="p">}</span>
</span></code></pre></div>

</details>

<blockquote>
<p>⚠️ <em>Don't forget: duration format is ISO 8601, not "2 hours" — and start time has to match the day it's tied to.</em></p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/new-azmaintenanceconfiguration">Learn more about New-AzMaintenanceConfiguration</a></p>
<hr />
<h3 id="step-3-tweak-the-maintenance-configs"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-3-tweak-the-maintenance-configs">🛠️ Step 3 – Tweak the Maintenance Configs</a></h3>
<p>Some patch windows felt too tight — and, just as importantly, I needed to avoid overlaps with existing backup jobs. Rather than let a large CU fail halfway through or run headlong into an Azure Backup job, I extended the duration on select configs and staggered them across the week:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span> <span class="p">=</span> <span class="s2">&quot;04:00&quot;</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nb">Update-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span> <span class="n">-Configuration</span> <span class="nv">$config</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="c"># Verify the change</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="nv">$updatedConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Sunday window now: </span><span class="p">$(</span><span class="nv">$updatedConfig</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2"> duration&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></code></pre></div>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/update-azmaintenanceconfiguration?view=azps-14.0.0&amp;viewFallbackFrom=azps-13.5.0">Learn more about Update-AzMaintenanceConfiguration</a></p>
<hr />
<h3 id="step-4-use-ai-to-group-vms-by-patch-activity"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-4-use-ai-to-group-vms-by-patch-activity">🤖 Step 4 – Use AI to Group VMs by Patch Activity</a></h3>
<p>Armed with CSV exports of the latest patching summaries, I got AI to do the grunt work and make sense of the contents.</p>
<p><strong>What I did:</strong></p>
<ol>
<li><strong>Exported MSP data:</strong> Weekly CSV reports showing patch installation timestamps for each VM</li>
<li>
<p><strong>Used Gen AI</strong> with various iterative prompts, starting the conversation with this:</p>
<blockquote>
<p>"Attached is an export summary of the current patching activity from our incumbent MSP who currently look after the patching of the VM's in Azure
I need you to review timestamps and work out which maintenance window each vm is currently in, and then match that to the appropriate maintenance config that we have just created.
If there are mis matches in new and current schedule then we may need to tweak the settings of the new configs"</p>
</blockquote>
</li>
<li>
<p><strong>AI analysis revealed:</strong></p>
</li>
<li>60% of VMs were patching on one weekday evening</li>
<li>Several critical systems patching simultaneously</li>
<li>
<p>No consideration for application dependencies</p>
</li>
<li>
<p><strong>AI recommendation:</strong> Spread VMs across weekdays based on:</p>
</li>
<li><strong>Criticality:</strong> Domain controllers on different days</li>
<li><strong>Function:</strong> Similar servers on different days (avoid single points of failure)  </li>
<li><strong>Dependencies:</strong> Database servers before application servers</li>
</ol>
<p><strong>The result:</strong> A logical rebalancing that avoided "all our eggs in Sunday 1AM" basket and considered business impact.</p>
<blockquote>
<p><strong>Why this matters:</strong> The current patching schedule was not optimized for business continuity. AI helped identify risks we hadn't considered.</p>
</blockquote>
<hr />
<h3 id="step-5-discover-all-vms-and-identify-gaps"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-5-discover-all-vms-and-identify-gaps">🔍 Step 5 – Discover All VMs and Identify Gaps</a></h3>
<p>Before diving into bulk tagging, I needed to understand what we were working with across all subscriptions.</p>
<p><strong>First, let's see what VMs we have:</strong></p>
<details>
<summary>Click to expand: Discover Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c"># Discover Untagged VMs Script for Azure Update Manager</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="c"># This script identifies VMs that are missing Azure Update Manager tags</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Azure Update Manager - Discover Untagged VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Scanning all accessible subscriptions for VMs missing maintenance tags...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="c"># Function to check if VM has Azure Update Manager tags</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="k">function</span> <span class="nb">Test-VMHasMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">)</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>    <span class="c"># Check for the three required tags</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>    <span class="nv">$hasOwnerTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Owner&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Owner&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>    <span class="nv">$hasUpdatesTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Updates&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Updates&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>    <span class="nv">$hasPatchWindowTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">)</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>    <span class="k">return</span> <span class="nv">$hasOwnerTag</span> <span class="o">-and</span> <span class="nv">$hasUpdatesTag</span> <span class="o">-and</span> <span class="nv">$hasPatchWindowTag</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="p">}</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="c"># Function to get VM details for reporting</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="k">function</span> <span class="nb">Get-VMDetails</span> <span class="p">{</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">,</span> <span class="nv">$SubscriptionName</span><span class="p">)</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a>    <span class="k">return</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a>        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a>        <span class="n">ResourceGroup</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a>        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-46-30"><a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a>        <span class="n">Subscription</span> <span class="p">=</span> <span class="nv">$SubscriptionName</span>
</span><span id="__span-46-31"><a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a>        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">SubscriptionId</span>
</span><span id="__span-46-32"><a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a>        <span class="n">PowerState</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">PowerState</span>
</span><span id="__span-46-33"><a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a>        <span class="n">OsType</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">StorageProfile</span><span class="p">.</span><span class="n">OsDisk</span><span class="p">.</span><span class="n">OsType</span>
</span><span id="__span-46-34"><a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a>        <span class="n">VmSize</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">HardwareProfile</span><span class="p">.</span><span class="n">VmSize</span>
</span><span id="__span-46-35"><a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a>        <span class="n">Tags</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="s2">&quot;$_=</span><span class="p">$(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">])</span><span class="s2">&quot;</span> <span class="p">})</span> <span class="n">-join</span> <span class="s2">&quot;; &quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;No tags&quot;</span> <span class="p">}</span>
</span><span id="__span-46-36"><a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a>    <span class="p">}</span>
</span><span id="__span-46-37"><a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a><span class="p">}</span>
</span><span id="__span-46-38"><a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a>
</span><span id="__span-46-39"><a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a><span class="c"># Initialize collections</span>
</span><span id="__span-46-40"><a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a><span class="nv">$taggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-46-41"><a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a><span class="nv">$untaggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-46-42"><a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a><span class="nv">$allVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-46-43"><a id="__codelineno-46-43" name="__codelineno-46-43" href="#__codelineno-46-43"></a><span class="nv">$subscriptionSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-46-44"><a id="__codelineno-46-44" name="__codelineno-46-44" href="#__codelineno-46-44"></a>
</span><span id="__span-46-45"><a id="__codelineno-46-45" name="__codelineno-46-45" href="#__codelineno-46-45"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== DISCOVERING VMs ACROSS ALL SUBSCRIPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-46"><a id="__codelineno-46-46" name="__codelineno-46-46" href="#__codelineno-46-46"></a>
</span><span id="__span-46-47"><a id="__codelineno-46-47" name="__codelineno-46-47" href="#__codelineno-46-47"></a><span class="c"># Get all accessible subscriptions</span>
</span><span id="__span-46-48"><a id="__codelineno-46-48" name="__codelineno-46-48" href="#__codelineno-46-48"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-46-49"><a id="__codelineno-46-49" name="__codelineno-46-49" href="#__codelineno-46-49"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Found </span><span class="p">$(</span><span class="nv">$subscriptions</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> accessible subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-50"><a id="__codelineno-46-50" name="__codelineno-46-50" href="#__codelineno-46-50"></a>
</span><span id="__span-46-51"><a id="__codelineno-46-51" name="__codelineno-46-51" href="#__codelineno-46-51"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-52"><a id="__codelineno-46-52" name="__codelineno-46-52" href="#__codelineno-46-52"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-46-53"><a id="__codelineno-46-53" name="__codelineno-46-53" href="#__codelineno-46-53"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Scanning subscription: </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="s2">)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-46-54"><a id="__codelineno-46-54" name="__codelineno-46-54" href="#__codelineno-46-54"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-46-55"><a id="__codelineno-46-55" name="__codelineno-46-55" href="#__codelineno-46-55"></a>
</span><span id="__span-46-56"><a id="__codelineno-46-56" name="__codelineno-46-56" href="#__codelineno-46-56"></a>        <span class="c"># Get all VMs in this subscription</span>
</span><span id="__span-46-57"><a id="__codelineno-46-57" name="__codelineno-46-57" href="#__codelineno-46-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Retrieving VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-58"><a id="__codelineno-46-58" name="__codelineno-46-58" href="#__codelineno-46-58"></a>        <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Status</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-46-59"><a id="__codelineno-46-59" name="__codelineno-46-59" href="#__codelineno-46-59"></a>
</span><span id="__span-46-60"><a id="__codelineno-46-60" name="__codelineno-46-60" href="#__codelineno-46-60"></a>        <span class="nv">$subTagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-46-61"><a id="__codelineno-46-61" name="__codelineno-46-61" href="#__codelineno-46-61"></a>        <span class="nv">$subUntagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-46-62"><a id="__codelineno-46-62" name="__codelineno-46-62" href="#__codelineno-46-62"></a>        <span class="nv">$subTotal</span> <span class="p">=</span> <span class="nv">$vms</span><span class="p">.</span><span class="n">Count</span>
</span><span id="__span-46-63"><a id="__codelineno-46-63" name="__codelineno-46-63" href="#__codelineno-46-63"></a>
</span><span id="__span-46-64"><a id="__codelineno-46-64" name="__codelineno-46-64" href="#__codelineno-46-64"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Found $subTotal VMs in this subscription&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-65"><a id="__codelineno-46-65" name="__codelineno-46-65" href="#__codelineno-46-65"></a>
</span><span id="__span-46-66"><a id="__codelineno-46-66" name="__codelineno-46-66" href="#__codelineno-46-66"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-67"><a id="__codelineno-46-67" name="__codelineno-46-67" href="#__codelineno-46-67"></a>            <span class="nv">$vmDetails</span> <span class="p">=</span> <span class="nb">Get-VMDetails</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-SubscriptionName</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-46-68"><a id="__codelineno-46-68" name="__codelineno-46-68" href="#__codelineno-46-68"></a>            <span class="nv">$allVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-46-69"><a id="__codelineno-46-69" name="__codelineno-46-69" href="#__codelineno-46-69"></a>
</span><span id="__span-46-70"><a id="__codelineno-46-70" name="__codelineno-46-70" href="#__codelineno-46-70"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">Test-VMHasMaintenanceTags</span> <span class="n">-VM</span> <span class="nv">$vm</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-71"><a id="__codelineno-46-71" name="__codelineno-46-71" href="#__codelineno-46-71"></a>                <span class="nv">$taggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-46-72"><a id="__codelineno-46-72" name="__codelineno-46-72" href="#__codelineno-46-72"></a>                <span class="nv">$subTagged</span><span class="p">++</span>
</span><span id="__span-46-73"><a id="__codelineno-46-73" name="__codelineno-46-73" href="#__codelineno-46-73"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ✓ Tagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-46-74"><a id="__codelineno-46-74" name="__codelineno-46-74" href="#__codelineno-46-74"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-46-75"><a id="__codelineno-46-75" name="__codelineno-46-75" href="#__codelineno-46-75"></a>                <span class="nv">$untaggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-46-76"><a id="__codelineno-46-76" name="__codelineno-46-76" href="#__codelineno-46-76"></a>                <span class="nv">$subUntagged</span><span class="p">++</span>
</span><span id="__span-46-77"><a id="__codelineno-46-77" name="__codelineno-46-77" href="#__codelineno-46-77"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ⚠️ Untagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-46-78"><a id="__codelineno-46-78" name="__codelineno-46-78" href="#__codelineno-46-78"></a>            <span class="p">}</span>
</span><span id="__span-46-79"><a id="__codelineno-46-79" name="__codelineno-46-79" href="#__codelineno-46-79"></a>        <span class="p">}</span>
</span><span id="__span-46-80"><a id="__codelineno-46-80" name="__codelineno-46-80" href="#__codelineno-46-80"></a>
</span><span id="__span-46-81"><a id="__codelineno-46-81" name="__codelineno-46-81" href="#__codelineno-46-81"></a>        <span class="c"># Store subscription summary</span>
</span><span id="__span-46-82"><a id="__codelineno-46-82" name="__codelineno-46-82" href="#__codelineno-46-82"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-46-83"><a id="__codelineno-46-83" name="__codelineno-46-83" href="#__codelineno-46-83"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="nv">$subTotal</span>
</span><span id="__span-46-84"><a id="__codelineno-46-84" name="__codelineno-46-84" href="#__codelineno-46-84"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="nv">$subTagged</span>
</span><span id="__span-46-85"><a id="__codelineno-46-85" name="__codelineno-46-85" href="#__codelineno-46-85"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="nv">$subUntagged</span>
</span><span id="__span-46-86"><a id="__codelineno-46-86" name="__codelineno-46-86" href="#__codelineno-46-86"></a>            <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-46-87"><a id="__codelineno-46-87" name="__codelineno-46-87" href="#__codelineno-46-87"></a>        <span class="p">}</span>
</span><span id="__span-46-88"><a id="__codelineno-46-88" name="__codelineno-46-88" href="#__codelineno-46-88"></a>
</span><span id="__span-46-89"><a id="__codelineno-46-89" name="__codelineno-46-89" href="#__codelineno-46-89"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Subscription Summary - Total: $subTotal | Tagged: $subTagged | Untagged: $subUntagged&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-90"><a id="__codelineno-46-90" name="__codelineno-46-90" href="#__codelineno-46-90"></a>
</span><span id="__span-46-91"><a id="__codelineno-46-91" name="__codelineno-46-91" href="#__codelineno-46-91"></a>    <span class="p">}</span>
</span><span id="__span-46-92"><a id="__codelineno-46-92" name="__codelineno-46-92" href="#__codelineno-46-92"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-46-93"><a id="__codelineno-46-93" name="__codelineno-46-93" href="#__codelineno-46-93"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-46-94"><a id="__codelineno-46-94" name="__codelineno-46-94" href="#__codelineno-46-94"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-46-95"><a id="__codelineno-46-95" name="__codelineno-46-95" href="#__codelineno-46-95"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-46-96"><a id="__codelineno-46-96" name="__codelineno-46-96" href="#__codelineno-46-96"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-46-97"><a id="__codelineno-46-97" name="__codelineno-46-97" href="#__codelineno-46-97"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-46-98"><a id="__codelineno-46-98" name="__codelineno-46-98" href="#__codelineno-46-98"></a>            <span class="n">Error</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>
</span><span id="__span-46-99"><a id="__codelineno-46-99" name="__codelineno-46-99" href="#__codelineno-46-99"></a>        <span class="p">}</span>
</span><span id="__span-46-100"><a id="__codelineno-46-100" name="__codelineno-46-100" href="#__codelineno-46-100"></a>    <span class="p">}</span>
</span><span id="__span-46-101"><a id="__codelineno-46-101" name="__codelineno-46-101" href="#__codelineno-46-101"></a><span class="p">}</span>
</span><span id="__span-46-102"><a id="__codelineno-46-102" name="__codelineno-46-102" href="#__codelineno-46-102"></a>
</span><span id="__span-46-103"><a id="__codelineno-46-103" name="__codelineno-46-103" href="#__codelineno-46-103"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-104"><a id="__codelineno-46-104" name="__codelineno-46-104" href="#__codelineno-46-104"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== OVERALL DISCOVERY SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-105"><a id="__codelineno-46-105" name="__codelineno-46-105" href="#__codelineno-46-105"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs found: </span><span class="p">$(</span><span class="nv">$allVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-106"><a id="__codelineno-46-106" name="__codelineno-46-106" href="#__codelineno-46-106"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs with maintenance tags: </span><span class="p">$(</span><span class="nv">$taggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-46-107"><a id="__codelineno-46-107" name="__codelineno-46-107" href="#__codelineno-46-107"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs missing maintenance tags: </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-46-108"><a id="__codelineno-46-108" name="__codelineno-46-108" href="#__codelineno-46-108"></a>
</span><span id="__span-46-109"><a id="__codelineno-46-109" name="__codelineno-46-109" href="#__codelineno-46-109"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-110"><a id="__codelineno-46-110" name="__codelineno-46-110" href="#__codelineno-46-110"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs ARE ALREADY TAGGED! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-46-111"><a id="__codelineno-46-111" name="__codelineno-46-111" href="#__codelineno-46-111"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;No further action required.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-112"><a id="__codelineno-46-112" name="__codelineno-46-112" href="#__codelineno-46-112"></a>    <span class="n">exit</span> <span class="n">0</span>
</span><span id="__span-46-113"><a id="__codelineno-46-113" name="__codelineno-46-113" href="#__codelineno-46-113"></a><span class="p">}</span>
</span><span id="__span-46-114"><a id="__codelineno-46-114" name="__codelineno-46-114" href="#__codelineno-46-114"></a>
</span><span id="__span-46-115"><a id="__codelineno-46-115" name="__codelineno-46-115" href="#__codelineno-46-115"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-116"><a id="__codelineno-46-116" name="__codelineno-46-116" href="#__codelineno-46-116"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SUBSCRIPTION BREAKDOWN ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-117"><a id="__codelineno-46-117" name="__codelineno-46-117" href="#__codelineno-46-117"></a><span class="nv">$subscriptionSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-118"><a id="__codelineno-46-118" name="__codelineno-46-118" href="#__codelineno-46-118"></a>    <span class="nv">$sub</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-46-119"><a id="__codelineno-46-119" name="__codelineno-46-119" href="#__codelineno-46-119"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-120"><a id="__codelineno-46-120" name="__codelineno-46-120" href="#__codelineno-46-120"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: ERROR - </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-46-121"><a id="__codelineno-46-121" name="__codelineno-46-121" href="#__codelineno-46-121"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-46-122"><a id="__codelineno-46-122" name="__codelineno-46-122" href="#__codelineno-46-122"></a>        <span class="nv">$percentage</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span> <span class="no">[math]</span><span class="p">::</span><span class="n">Round</span><span class="p">((</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span> <span class="p">/</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span> <span class="p">*</span> <span class="n">100</span><span class="p">,</span> <span class="n">1</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">0</span> <span class="p">}</span>
</span><span id="__span-46-123"><a id="__codelineno-46-123" name="__codelineno-46-123" href="#__codelineno-46-123"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span><span class="p">)</span><span class="s2">/</span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span><span class="s2"> tagged ($percentage%)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-124"><a id="__codelineno-46-124" name="__codelineno-46-124" href="#__codelineno-46-124"></a>    <span class="p">}</span>
</span><span id="__span-46-125"><a id="__codelineno-46-125" name="__codelineno-46-125" href="#__codelineno-46-125"></a><span class="p">}</span>
</span><span id="__span-46-126"><a id="__codelineno-46-126" name="__codelineno-46-126" href="#__codelineno-46-126"></a>
</span><span id="__span-46-127"><a id="__codelineno-46-127" name="__codelineno-46-127" href="#__codelineno-46-127"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-128"><a id="__codelineno-46-128" name="__codelineno-46-128" href="#__codelineno-46-128"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== UNTAGGED VMs DETAILED LIST ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-46-129"><a id="__codelineno-46-129" name="__codelineno-46-129" href="#__codelineno-46-129"></a><span class="nb">Write-Host</span> <span class="s2">&quot;The following </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs are missing Azure Update Manager maintenance tags:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-130"><a id="__codelineno-46-130" name="__codelineno-46-130" href="#__codelineno-46-130"></a>
</span><span id="__span-46-131"><a id="__codelineno-46-131" name="__codelineno-46-131" href="#__codelineno-46-131"></a><span class="c"># Group untagged VMs by subscription for easier reading</span>
</span><span id="__span-46-132"><a id="__codelineno-46-132" name="__codelineno-46-132" href="#__codelineno-46-132"></a><span class="nv">$untaggedBySubscription</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Subscription</span>
</span><span id="__span-46-133"><a id="__codelineno-46-133" name="__codelineno-46-133" href="#__codelineno-46-133"></a>
</span><span id="__span-46-134"><a id="__codelineno-46-134" name="__codelineno-46-134" href="#__codelineno-46-134"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$group</span> <span class="k">in</span> <span class="nv">$untaggedBySubscription</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-135"><a id="__codelineno-46-135" name="__codelineno-46-135" href="#__codelineno-46-135"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Subscription: </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> untagged VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-46-136"><a id="__codelineno-46-136" name="__codelineno-46-136" href="#__codelineno-46-136"></a>
</span><span id="__span-46-137"><a id="__codelineno-46-137" name="__codelineno-46-137" href="#__codelineno-46-137"></a>    <span class="nv">$group</span><span class="p">.</span><span class="nb">Group </span><span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-138"><a id="__codelineno-46-138" name="__codelineno-46-138" href="#__codelineno-46-138"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  • </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-46-139"><a id="__codelineno-46-139" name="__codelineno-46-139" href="#__codelineno-46-139"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Resource Group: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ResourceGroup</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-140"><a id="__codelineno-46-140" name="__codelineno-46-140" href="#__codelineno-46-140"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Location: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Location</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-141"><a id="__codelineno-46-141" name="__codelineno-46-141" href="#__codelineno-46-141"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    OS Type: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">OsType</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-142"><a id="__codelineno-46-142" name="__codelineno-46-142" href="#__codelineno-46-142"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    VM Size: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">VmSize</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-143"><a id="__codelineno-46-143" name="__codelineno-46-143" href="#__codelineno-46-143"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Power State: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PowerState</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-144"><a id="__codelineno-46-144" name="__codelineno-46-144" href="#__codelineno-46-144"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-ne</span> <span class="s2">&quot;No tags&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-46-145"><a id="__codelineno-46-145" name="__codelineno-46-145" href="#__codelineno-46-145"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;    Existing Tags: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">DarkGray</span>
</span><span id="__span-46-146"><a id="__codelineno-46-146" name="__codelineno-46-146" href="#__codelineno-46-146"></a>        <span class="p">}</span>
</span><span id="__span-46-147"><a id="__codelineno-46-147" name="__codelineno-46-147" href="#__codelineno-46-147"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-148"><a id="__codelineno-46-148" name="__codelineno-46-148" href="#__codelineno-46-148"></a>    <span class="p">}</span>
</span><span id="__span-46-149"><a id="__codelineno-46-149" name="__codelineno-46-149" href="#__codelineno-46-149"></a><span class="p">}</span>
</span><span id="__span-46-150"><a id="__codelineno-46-150" name="__codelineno-46-150" href="#__codelineno-46-150"></a>
</span><span id="__span-46-151"><a id="__codelineno-46-151" name="__codelineno-46-151" href="#__codelineno-46-151"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== ANALYSIS BY VM CHARACTERISTICS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-152"><a id="__codelineno-46-152" name="__codelineno-46-152" href="#__codelineno-46-152"></a>
</span><span id="__span-46-153"><a id="__codelineno-46-153" name="__codelineno-46-153" href="#__codelineno-46-153"></a><span class="c"># Analyze by OS Type</span>
</span><span id="__span-46-154"><a id="__codelineno-46-154" name="__codelineno-46-154" href="#__codelineno-46-154"></a><span class="nv">$untaggedByOS</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">OsType</span>
</span><span id="__span-46-155"><a id="__codelineno-46-155" name="__codelineno-46-155" href="#__codelineno-46-155"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by OS Type:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-156"><a id="__codelineno-46-156" name="__codelineno-46-156" href="#__codelineno-46-156"></a><span class="nv">$untaggedByOS</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-157"><a id="__codelineno-46-157" name="__codelineno-46-157" href="#__codelineno-46-157"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-158"><a id="__codelineno-46-158" name="__codelineno-46-158" href="#__codelineno-46-158"></a><span class="p">}</span>
</span><span id="__span-46-159"><a id="__codelineno-46-159" name="__codelineno-46-159" href="#__codelineno-46-159"></a>
</span><span id="__span-46-160"><a id="__codelineno-46-160" name="__codelineno-46-160" href="#__codelineno-46-160"></a><span class="c"># Analyze by Location</span>
</span><span id="__span-46-161"><a id="__codelineno-46-161" name="__codelineno-46-161" href="#__codelineno-46-161"></a><span class="nv">$untaggedByLocation</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Location</span>
</span><span id="__span-46-162"><a id="__codelineno-46-162" name="__codelineno-46-162" href="#__codelineno-46-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Location:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-163"><a id="__codelineno-46-163" name="__codelineno-46-163" href="#__codelineno-46-163"></a><span class="nv">$untaggedByLocation</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-164"><a id="__codelineno-46-164" name="__codelineno-46-164" href="#__codelineno-46-164"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-165"><a id="__codelineno-46-165" name="__codelineno-46-165" href="#__codelineno-46-165"></a><span class="p">}</span>
</span><span id="__span-46-166"><a id="__codelineno-46-166" name="__codelineno-46-166" href="#__codelineno-46-166"></a>
</span><span id="__span-46-167"><a id="__codelineno-46-167" name="__codelineno-46-167" href="#__codelineno-46-167"></a><span class="c"># Analyze by VM Size (to understand workload types)</span>
</span><span id="__span-46-168"><a id="__codelineno-46-168" name="__codelineno-46-168" href="#__codelineno-46-168"></a><span class="nv">$untaggedBySize</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">VmSize</span>
</span><span id="__span-46-169"><a id="__codelineno-46-169" name="__codelineno-46-169" href="#__codelineno-46-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Size:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-170"><a id="__codelineno-46-170" name="__codelineno-46-170" href="#__codelineno-46-170"></a><span class="nv">$untaggedBySize</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-171"><a id="__codelineno-46-171" name="__codelineno-46-171" href="#__codelineno-46-171"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-172"><a id="__codelineno-46-172" name="__codelineno-46-172" href="#__codelineno-46-172"></a><span class="p">}</span>
</span><span id="__span-46-173"><a id="__codelineno-46-173" name="__codelineno-46-173" href="#__codelineno-46-173"></a>
</span><span id="__span-46-174"><a id="__codelineno-46-174" name="__codelineno-46-174" href="#__codelineno-46-174"></a><span class="c"># Analyze by Resource Group (might indicate application/workload groupings)</span>
</span><span id="__span-46-175"><a id="__codelineno-46-175" name="__codelineno-46-175" href="#__codelineno-46-175"></a><span class="nv">$untaggedByRG</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">ResourceGroup</span>
</span><span id="__span-46-176"><a id="__codelineno-46-176" name="__codelineno-46-176" href="#__codelineno-46-176"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Resource Group (Top 10):&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-177"><a id="__codelineno-46-177" name="__codelineno-46-177" href="#__codelineno-46-177"></a><span class="nv">$untaggedByRG</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-178"><a id="__codelineno-46-178" name="__codelineno-46-178" href="#__codelineno-46-178"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-179"><a id="__codelineno-46-179" name="__codelineno-46-179" href="#__codelineno-46-179"></a><span class="p">}</span>
</span><span id="__span-46-180"><a id="__codelineno-46-180" name="__codelineno-46-180" href="#__codelineno-46-180"></a>
</span><span id="__span-46-181"><a id="__codelineno-46-181" name="__codelineno-46-181" href="#__codelineno-46-181"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-182"><a id="__codelineno-46-182" name="__codelineno-46-182" href="#__codelineno-46-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== POWER STATE ANALYSIS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-183"><a id="__codelineno-46-183" name="__codelineno-46-183" href="#__codelineno-46-183"></a><span class="nv">$powerStates</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">PowerState</span>
</span><span id="__span-46-184"><a id="__codelineno-46-184" name="__codelineno-46-184" href="#__codelineno-46-184"></a><span class="nv">$powerStates</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-46-185"><a id="__codelineno-46-185" name="__codelineno-46-185" href="#__codelineno-46-185"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-186"><a id="__codelineno-46-186" name="__codelineno-46-186" href="#__codelineno-46-186"></a><span class="p">}</span>
</span><span id="__span-46-187"><a id="__codelineno-46-187" name="__codelineno-46-187" href="#__codelineno-46-187"></a>
</span><span id="__span-46-188"><a id="__codelineno-46-188" name="__codelineno-46-188" href="#__codelineno-46-188"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-189"><a id="__codelineno-46-189" name="__codelineno-46-189" href="#__codelineno-46-189"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== EXPORT OPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-190"><a id="__codelineno-46-190" name="__codelineno-46-190" href="#__codelineno-46-190"></a><span class="nb">Write-Host</span> <span class="s2">&quot;You can export this data for further analysis:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-191"><a id="__codelineno-46-191" name="__codelineno-46-191" href="#__codelineno-46-191"></a>
</span><span id="__span-46-192"><a id="__codelineno-46-192" name="__codelineno-46-192" href="#__codelineno-46-192"></a><span class="c"># Export to CSV option</span>
</span><span id="__span-46-193"><a id="__codelineno-46-193" name="__codelineno-46-193" href="#__codelineno-46-193"></a><span class="nv">$timestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s2">&quot;yyyyMMdd-HHmm&quot;</span>
</span><span id="__span-46-194"><a id="__codelineno-46-194" name="__codelineno-46-194" href="#__codelineno-46-194"></a><span class="nv">$csvPath</span> <span class="p">=</span> <span class="s2">&quot;D:\UntaggedVMs-$timestamp.csv&quot;</span>
</span><span id="__span-46-195"><a id="__codelineno-46-195" name="__codelineno-46-195" href="#__codelineno-46-195"></a>
</span><span id="__span-46-196"><a id="__codelineno-46-196" name="__codelineno-46-196" href="#__codelineno-46-196"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-46-197"><a id="__codelineno-46-197" name="__codelineno-46-197" href="#__codelineno-46-197"></a>    <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="nv">$csvPath</span> <span class="n">-NoTypeInformation</span>
</span><span id="__span-46-198"><a id="__codelineno-46-198" name="__codelineno-46-198" href="#__codelineno-46-198"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✓ Exported untagged VMs to: $csvPath&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-46-199"><a id="__codelineno-46-199" name="__codelineno-46-199" href="#__codelineno-46-199"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-46-200"><a id="__codelineno-46-200" name="__codelineno-46-200" href="#__codelineno-46-200"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✗ Failed to export CSV: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-46-201"><a id="__codelineno-46-201" name="__codelineno-46-201" href="#__codelineno-46-201"></a><span class="p">}</span>
</span><span id="__span-46-202"><a id="__codelineno-46-202" name="__codelineno-46-202" href="#__codelineno-46-202"></a>
</span><span id="__span-46-203"><a id="__codelineno-46-203" name="__codelineno-46-203" href="#__codelineno-46-203"></a><span class="c"># Show simple list for easy copying</span>
</span><span id="__span-46-204"><a id="__codelineno-46-204" name="__codelineno-46-204" href="#__codelineno-46-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-205"><a id="__codelineno-46-205" name="__codelineno-46-205" href="#__codelineno-46-205"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SIMPLE VM NAME LIST (for copy/paste) ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-206"><a id="__codelineno-46-206" name="__codelineno-46-206" href="#__codelineno-46-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VM Names:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-207"><a id="__codelineno-46-207" name="__codelineno-46-207" href="#__codelineno-46-207"></a><span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span> <span class="p">}</span>
</span><span id="__span-46-208"><a id="__codelineno-46-208" name="__codelineno-46-208" href="#__codelineno-46-208"></a>
</span><span id="__span-46-209"><a id="__codelineno-46-209" name="__codelineno-46-209" href="#__codelineno-46-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-210"><a id="__codelineno-46-210" name="__codelineno-46-210" href="#__codelineno-46-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEXT STEPS RECOMMENDATIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-211"><a id="__codelineno-46-211" name="__codelineno-46-211" href="#__codelineno-46-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Review the untagged VMs list above&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-212"><a id="__codelineno-46-212" name="__codelineno-46-212" href="#__codelineno-46-212"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Investigate why these VMs were not in the original patching schedule&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-213"><a id="__codelineno-46-213" name="__codelineno-46-213" href="#__codelineno-46-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Determine appropriate maintenance windows for these VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-214"><a id="__codelineno-46-214" name="__codelineno-46-214" href="#__codelineno-46-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Consider grouping by:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-215"><a id="__codelineno-46-215" name="__codelineno-46-215" href="#__codelineno-46-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Application/workload (Resource Group analysis)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-216"><a id="__codelineno-46-216" name="__codelineno-46-216" href="#__codelineno-46-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Environment (naming patterns, tags)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-217"><a id="__codelineno-46-217" name="__codelineno-46-217" href="#__codelineno-46-217"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Business criticality&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-218"><a id="__codelineno-46-218" name="__codelineno-46-218" href="#__codelineno-46-218"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Maintenance window preferences&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-219"><a id="__codelineno-46-219" name="__codelineno-46-219" href="#__codelineno-46-219"></a><span class="nb">Write-Host</span> <span class="s2">&quot;5. Run the tagging script to assign maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-220"><a id="__codelineno-46-220" name="__codelineno-46-220" href="#__codelineno-46-220"></a>
</span><span id="__span-46-221"><a id="__codelineno-46-221" name="__codelineno-46-221" href="#__codelineno-46-221"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-222"><a id="__codelineno-46-222" name="__codelineno-46-222" href="#__codelineno-46-222"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-223"><a id="__codelineno-46-223" name="__codelineno-46-223" href="#__codelineno-46-223"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query in Azure Resource Graph Explorer to verify results:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-46-224"><a id="__codelineno-46-224" name="__codelineno-46-224" href="#__codelineno-46-224"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-225"><a id="__codelineno-46-225" name="__codelineno-46-225" href="#__codelineno-46-225"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-46-226"><a id="__codelineno-46-226" name="__codelineno-46-226" href="#__codelineno-46-226"></a><span class="sh">Resources</span>
</span><span id="__span-46-227"><a id="__codelineno-46-227" name="__codelineno-46-227" href="#__codelineno-46-227"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-46-228"><a id="__codelineno-46-228" name="__codelineno-46-228" href="#__codelineno-46-228"></a><span class="sh">| where tags.PatchWindow == &quot;&quot; or isempty(tags.PatchWindow) or isnull(tags.PatchWindow)</span>
</span><span id="__span-46-229"><a id="__codelineno-46-229" name="__codelineno-46-229" href="#__codelineno-46-229"></a><span class="sh">| project name, resourceGroup, subscriptionId, location, </span>
</span><span id="__span-46-230"><a id="__codelineno-46-230" name="__codelineno-46-230" href="#__codelineno-46-230"></a><span class="sh">          osType = properties.storageProfile.osDisk.osType,</span>
</span><span id="__span-46-231"><a id="__codelineno-46-231" name="__codelineno-46-231" href="#__codelineno-46-231"></a><span class="sh">          vmSize = properties.hardwareProfile.vmSize,</span>
</span><span id="__span-46-232"><a id="__codelineno-46-232" name="__codelineno-46-232" href="#__codelineno-46-232"></a><span class="sh">          powerState = properties.extended.instanceView.powerState.displayStatus,</span>
</span><span id="__span-46-233"><a id="__codelineno-46-233" name="__codelineno-46-233" href="#__codelineno-46-233"></a><span class="sh">          tags</span>
</span><span id="__span-46-234"><a id="__codelineno-46-234" name="__codelineno-46-234" href="#__codelineno-46-234"></a><span class="sh">| sort by name asc</span>
</span><span id="__span-46-235"><a id="__codelineno-46-235" name="__codelineno-46-235" href="#__codelineno-46-235"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-46-236"><a id="__codelineno-46-236" name="__codelineno-46-236" href="#__codelineno-46-236"></a>
</span><span id="__span-46-237"><a id="__codelineno-46-237" name="__codelineno-46-237" href="#__codelineno-46-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-46-238"><a id="__codelineno-46-238" name="__codelineno-46-238" href="#__codelineno-46-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-46-239"><a id="__codelineno-46-239" name="__codelineno-46-239" href="#__codelineno-46-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<p><strong>Discovery results:</strong></p>
<ul>
<li><strong>35 VMs</strong> from the original MSP schedule (our planned list)</li>
<li><strong>12 additional VMs</strong> not in the MSP schedule (the "stragglers")</li>
<li><strong>Total: 90 VMs</strong> needing Update Manager tags</li>
</ul>
<blockquote>
<p><strong>Key insight:</strong> The MSP wasn't managing everything. Several dev/test VMs and a few production systems were missing from their schedule.</p>
</blockquote>
<hr />
<h3 id="step-6-bulk-tag-all-vms-with-patch-windows"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-6-bulk-tag-all-vms-with-patch-windows">✍️ Step 6 – Bulk Tag All VMs with Patch Windows</a></h3>
<p>Now for the main event: tagging all VMs with their maintenance windows. This includes both our planned VMs and the newly discovered ones.</p>
<h4 id="main-vm-tagging-planned-schedule"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#main-vm-tagging-planned-schedule">🎯 Main VM Tagging (Planned Schedule)</a></h4>
<p>Each tag serves a specific purpose:</p>
<ul>
<li><code>PatchWindow</code> — The key tag used by dynamic scopes to assign VMs to maintenance configurations</li>
<li><code>Owner</code> — For accountability and filtering</li>
<li><code>Updates</code> — Identifies VMs managed by Azure Update Manager</li>
</ul>
<details>
<summary>Click to expand: Multi-Subscription Azure Update Manager VM Tagging (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c"># Multi-Subscription Azure Update Manager VM Tagging Script</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="c"># This script discovers VMs across multiple subscriptions and tags them appropriately</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Multi-Subscription Azure Update Manager - VM Tagging Script ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="c"># Function to safely tag a VM</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>    <span class="p">)</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>        <span class="c"># Get the VM and update tags</span>
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">}</span>
</span><span id="__span-47-27"><a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-47-28"><a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-47-29"><a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a>        <span class="p">}</span>
</span><span id="__span-47-30"><a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a>
</span><span id="__span-47-31"><a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-47-32"><a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-47-33"><a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a>
</span><span id="__span-47-34"><a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-47-35"><a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a>    <span class="p">}</span>
</span><span id="__span-47-36"><a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-47-37"><a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-47-38"><a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-47-39"><a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a>    <span class="p">}</span>
</span><span id="__span-47-40"><a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="p">}</span>
</span><span id="__span-47-41"><a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a>
</span><span id="__span-47-42"><a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="c"># Define all target VMs organized by maintenance window</span>
</span><span id="__span-47-43"><a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a><span class="nv">$maintenanceGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-44"><a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-45"><a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-47-46"><a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-47"><a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-48"><a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-49"><a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-47-50"><a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a>        <span class="p">}</span>
</span><span id="__span-47-51"><a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a>    <span class="p">}</span>
</span><span id="__span-47-52"><a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-53"><a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">)</span>
</span><span id="__span-47-54"><a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-55"><a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-56"><a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-57"><a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;tue&quot;</span>
</span><span id="__span-47-58"><a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a>        <span class="p">}</span>
</span><span id="__span-47-59"><a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a>    <span class="p">}</span>
</span><span id="__span-47-60"><a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-61"><a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-03&quot;</span><span class="p">)</span>
</span><span id="__span-47-62"><a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-63"><a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-64"><a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-65"><a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-47-66"><a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a>        <span class="p">}</span>
</span><span id="__span-47-67"><a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a>    <span class="p">}</span>
</span><span id="__span-47-68"><a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-69"><a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;PRINT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-47-70"><a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-71"><a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-72"><a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-73"><a id="__codelineno-47-73" name="__codelineno-47-73" href="#__codelineno-47-73"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-47-74"><a id="__codelineno-47-74" name="__codelineno-47-74" href="#__codelineno-47-74"></a>        <span class="p">}</span>
</span><span id="__span-47-75"><a id="__codelineno-47-75" name="__codelineno-47-75" href="#__codelineno-47-75"></a>    <span class="p">}</span>
</span><span id="__span-47-76"><a id="__codelineno-47-76" name="__codelineno-47-76" href="#__codelineno-47-76"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-77"><a id="__codelineno-47-77" name="__codelineno-47-77" href="#__codelineno-47-77"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;MONITOR-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-47-78"><a id="__codelineno-47-78" name="__codelineno-47-78" href="#__codelineno-47-78"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-79"><a id="__codelineno-47-79" name="__codelineno-47-79" href="#__codelineno-47-79"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-80"><a id="__codelineno-47-80" name="__codelineno-47-80" href="#__codelineno-47-80"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-81"><a id="__codelineno-47-81" name="__codelineno-47-81" href="#__codelineno-47-81"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-47-82"><a id="__codelineno-47-82" name="__codelineno-47-82" href="#__codelineno-47-82"></a>        <span class="p">}</span>
</span><span id="__span-47-83"><a id="__codelineno-47-83" name="__codelineno-47-83" href="#__codelineno-47-83"></a>    <span class="p">}</span>
</span><span id="__span-47-84"><a id="__codelineno-47-84" name="__codelineno-47-84" href="#__codelineno-47-84"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-85"><a id="__codelineno-47-85" name="__codelineno-47-85" href="#__codelineno-47-85"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">,</span> <span class="s2">&quot;SANDBOX-01&quot;</span><span class="p">)</span>
</span><span id="__span-47-86"><a id="__codelineno-47-86" name="__codelineno-47-86" href="#__codelineno-47-86"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-87"><a id="__codelineno-47-87" name="__codelineno-47-87" href="#__codelineno-47-87"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-88"><a id="__codelineno-47-88" name="__codelineno-47-88" href="#__codelineno-47-88"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-89"><a id="__codelineno-47-89" name="__codelineno-47-89" href="#__codelineno-47-89"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>
</span><span id="__span-47-90"><a id="__codelineno-47-90" name="__codelineno-47-90" href="#__codelineno-47-90"></a>        <span class="p">}</span>
</span><span id="__span-47-91"><a id="__codelineno-47-91" name="__codelineno-47-91" href="#__codelineno-47-91"></a>    <span class="p">}</span>
</span><span id="__span-47-92"><a id="__codelineno-47-92" name="__codelineno-47-92" href="#__codelineno-47-92"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-93"><a id="__codelineno-47-93" name="__codelineno-47-93" href="#__codelineno-47-93"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;MGMT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-47-94"><a id="__codelineno-47-94" name="__codelineno-47-94" href="#__codelineno-47-94"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-95"><a id="__codelineno-47-95" name="__codelineno-47-95" href="#__codelineno-47-95"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-47-96"><a id="__codelineno-47-96" name="__codelineno-47-96" href="#__codelineno-47-96"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-47-97"><a id="__codelineno-47-97" name="__codelineno-47-97" href="#__codelineno-47-97"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-47-98"><a id="__codelineno-47-98" name="__codelineno-47-98" href="#__codelineno-47-98"></a>        <span class="p">}</span>
</span><span id="__span-47-99"><a id="__codelineno-47-99" name="__codelineno-47-99" href="#__codelineno-47-99"></a>    <span class="p">}</span>
</span><span id="__span-47-100"><a id="__codelineno-47-100" name="__codelineno-47-100" href="#__codelineno-47-100"></a><span class="p">}</span>
</span><span id="__span-47-101"><a id="__codelineno-47-101" name="__codelineno-47-101" href="#__codelineno-47-101"></a>
</span><span id="__span-47-102"><a id="__codelineno-47-102" name="__codelineno-47-102" href="#__codelineno-47-102"></a><span class="c"># Function to discover VMs across all subscriptions</span>
</span><span id="__span-47-103"><a id="__codelineno-47-103" name="__codelineno-47-103" href="#__codelineno-47-103"></a><span class="k">function</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="p">{</span>
</span><span id="__span-47-104"><a id="__codelineno-47-104" name="__codelineno-47-104" href="#__codelineno-47-104"></a>    <span class="k">param</span><span class="p">(</span><span class="no">[array]</span><span class="nv">$TargetVMNames</span><span class="p">)</span>
</span><span id="__span-47-105"><a id="__codelineno-47-105" name="__codelineno-47-105" href="#__codelineno-47-105"></a>
</span><span id="__span-47-106"><a id="__codelineno-47-106" name="__codelineno-47-106" href="#__codelineno-47-106"></a>    <span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-47-107"><a id="__codelineno-47-107" name="__codelineno-47-107" href="#__codelineno-47-107"></a>    <span class="nv">$vmInventory</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-47-108"><a id="__codelineno-47-108" name="__codelineno-47-108" href="#__codelineno-47-108"></a>
</span><span id="__span-47-109"><a id="__codelineno-47-109" name="__codelineno-47-109" href="#__codelineno-47-109"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-110"><a id="__codelineno-47-110" name="__codelineno-47-110" href="#__codelineno-47-110"></a>        <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-47-111"><a id="__codelineno-47-111" name="__codelineno-47-111" href="#__codelineno-47-111"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-47-112"><a id="__codelineno-47-112" name="__codelineno-47-112" href="#__codelineno-47-112"></a>            <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-47-113"><a id="__codelineno-47-113" name="__codelineno-47-113" href="#__codelineno-47-113"></a>
</span><span id="__span-47-114"><a id="__codelineno-47-114" name="__codelineno-47-114" href="#__codelineno-47-114"></a>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-115"><a id="__codelineno-47-115" name="__codelineno-47-115" href="#__codelineno-47-115"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span> <span class="n">-in</span> <span class="nv">$TargetVMNames</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-116"><a id="__codelineno-47-116" name="__codelineno-47-116" href="#__codelineno-47-116"></a>                    <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-47-117"><a id="__codelineno-47-117" name="__codelineno-47-117" href="#__codelineno-47-117"></a>                        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-47-118"><a id="__codelineno-47-118" name="__codelineno-47-118" href="#__codelineno-47-118"></a>                        <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-47-119"><a id="__codelineno-47-119" name="__codelineno-47-119" href="#__codelineno-47-119"></a>                        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-47-120"><a id="__codelineno-47-120" name="__codelineno-47-120" href="#__codelineno-47-120"></a>                        <span class="n">SubscriptionName</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-47-121"><a id="__codelineno-47-121" name="__codelineno-47-121" href="#__codelineno-47-121"></a>                        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-47-122"><a id="__codelineno-47-122" name="__codelineno-47-122" href="#__codelineno-47-122"></a>                    <span class="p">}</span>
</span><span id="__span-47-123"><a id="__codelineno-47-123" name="__codelineno-47-123" href="#__codelineno-47-123"></a>                <span class="p">}</span>
</span><span id="__span-47-124"><a id="__codelineno-47-124" name="__codelineno-47-124" href="#__codelineno-47-124"></a>            <span class="p">}</span>
</span><span id="__span-47-125"><a id="__codelineno-47-125" name="__codelineno-47-125" href="#__codelineno-47-125"></a>        <span class="p">}</span>
</span><span id="__span-47-126"><a id="__codelineno-47-126" name="__codelineno-47-126" href="#__codelineno-47-126"></a>        <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-47-127"><a id="__codelineno-47-127" name="__codelineno-47-127" href="#__codelineno-47-127"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-47-128"><a id="__codelineno-47-128" name="__codelineno-47-128" href="#__codelineno-47-128"></a>        <span class="p">}</span>
</span><span id="__span-47-129"><a id="__codelineno-47-129" name="__codelineno-47-129" href="#__codelineno-47-129"></a>    <span class="p">}</span>
</span><span id="__span-47-130"><a id="__codelineno-47-130" name="__codelineno-47-130" href="#__codelineno-47-130"></a>
</span><span id="__span-47-131"><a id="__codelineno-47-131" name="__codelineno-47-131" href="#__codelineno-47-131"></a>    <span class="k">return</span> <span class="nv">$vmInventory</span>
</span><span id="__span-47-132"><a id="__codelineno-47-132" name="__codelineno-47-132" href="#__codelineno-47-132"></a><span class="p">}</span>
</span><span id="__span-47-133"><a id="__codelineno-47-133" name="__codelineno-47-133" href="#__codelineno-47-133"></a>
</span><span id="__span-47-134"><a id="__codelineno-47-134" name="__codelineno-47-134" href="#__codelineno-47-134"></a><span class="c"># Get all unique VM names and discover their locations</span>
</span><span id="__span-47-135"><a id="__codelineno-47-135" name="__codelineno-47-135" href="#__codelineno-47-135"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-47-136"><a id="__codelineno-47-136" name="__codelineno-47-136" href="#__codelineno-47-136"></a><span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$allTargetVMs</span> <span class="p">+=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">VMs</span> <span class="p">}</span>
</span><span id="__span-47-137"><a id="__codelineno-47-137" name="__codelineno-47-137" href="#__codelineno-47-137"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="nv">$allTargetVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Unique</span>
</span><span id="__span-47-138"><a id="__codelineno-47-138" name="__codelineno-47-138" href="#__codelineno-47-138"></a>
</span><span id="__span-47-139"><a id="__codelineno-47-139" name="__codelineno-47-139" href="#__codelineno-47-139"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Discovering locations for </span><span class="p">$(</span><span class="nv">$allTargetVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> target VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-47-140"><a id="__codelineno-47-140" name="__codelineno-47-140" href="#__codelineno-47-140"></a><span class="nv">$vmInventory</span> <span class="p">=</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="n">-TargetVMNames</span> <span class="nv">$allTargetVMs</span>
</span><span id="__span-47-141"><a id="__codelineno-47-141" name="__codelineno-47-141" href="#__codelineno-47-141"></a>
</span><span id="__span-47-142"><a id="__codelineno-47-142" name="__codelineno-47-142" href="#__codelineno-47-142"></a><span class="c"># Process each maintenance window</span>
</span><span id="__span-47-143"><a id="__codelineno-47-143" name="__codelineno-47-143" href="#__codelineno-47-143"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-47-144"><a id="__codelineno-47-144" name="__codelineno-47-144" href="#__codelineno-47-144"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-47-145"><a id="__codelineno-47-145" name="__codelineno-47-145" href="#__codelineno-47-145"></a>
</span><span id="__span-47-146"><a id="__codelineno-47-146" name="__codelineno-47-146" href="#__codelineno-47-146"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$windowName</span> <span class="k">in</span> <span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-147"><a id="__codelineno-47-147" name="__codelineno-47-147" href="#__codelineno-47-147"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$maintenanceGroups</span><span class="p">[</span><span class="nv">$windowName</span><span class="p">]</span>
</span><span id="__span-47-148"><a id="__codelineno-47-148" name="__codelineno-47-148" href="#__codelineno-47-148"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $windowName MAINTENANCE WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-47-149"><a id="__codelineno-47-149" name="__codelineno-47-149" href="#__codelineno-47-149"></a>
</span><span id="__span-47-150"><a id="__codelineno-47-150" name="__codelineno-47-150" href="#__codelineno-47-150"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmName</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-47-151"><a id="__codelineno-47-151" name="__codelineno-47-151" href="#__codelineno-47-151"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vmInventory</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$vmName</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-47-152"><a id="__codelineno-47-152" name="__codelineno-47-152" href="#__codelineno-47-152"></a>            <span class="nv">$vmInfo</span> <span class="p">=</span> <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vmName</span><span class="p">]</span>
</span><span id="__span-47-153"><a id="__codelineno-47-153" name="__codelineno-47-153" href="#__codelineno-47-153"></a>            <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">ResourceGroupName</span> <span class="n">-SubscriptionId</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">SubscriptionId</span> <span class="n">-Tags</span> <span class="nv">$group</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$windowName</span>
</span><span id="__span-47-154"><a id="__codelineno-47-154" name="__codelineno-47-154" href="#__codelineno-47-154"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$totalSuccess</span><span class="p">++</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nv">$totalFailed</span><span class="p">++</span> <span class="p">}</span>
</span><span id="__span-47-155"><a id="__codelineno-47-155" name="__codelineno-47-155" href="#__codelineno-47-155"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-47-156"><a id="__codelineno-47-156" name="__codelineno-47-156" href="#__codelineno-47-156"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;  ⚠️ VM not found: $vmName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-47-157"><a id="__codelineno-47-157" name="__codelineno-47-157" href="#__codelineno-47-157"></a>            <span class="nv">$totalFailed</span><span class="p">++</span>
</span><span id="__span-47-158"><a id="__codelineno-47-158" name="__codelineno-47-158" href="#__codelineno-47-158"></a>        <span class="p">}</span>
</span><span id="__span-47-159"><a id="__codelineno-47-159" name="__codelineno-47-159" href="#__codelineno-47-159"></a>    <span class="p">}</span>
</span><span id="__span-47-160"><a id="__codelineno-47-160" name="__codelineno-47-160" href="#__codelineno-47-160"></a><span class="p">}</span>
</span><span id="__span-47-161"><a id="__codelineno-47-161" name="__codelineno-47-161" href="#__codelineno-47-161"></a>
</span><span id="__span-47-162"><a id="__codelineno-47-162" name="__codelineno-47-162" href="#__codelineno-47-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-47-163"><a id="__codelineno-47-163" name="__codelineno-47-163" href="#__codelineno-47-163"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-47-164"><a id="__codelineno-47-164" name="__codelineno-47-164" href="#__codelineno-47-164"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></code></pre></div>

</details>

<h4 id="handle-the-stragglers"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#handle-the-stragglers">🧹 Handle the Stragglers</a></h4>
<p>For the 12 VMs not in the original MSP schedule, I used intelligent assignment based on their function:</p>
<details>
<summary>Click to expand: Tagging Script for Remaining Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c"># Intelligent VM Tagging Script for Remaining Untagged VMs</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="c"># This script analyzes and tags the remaining VMs based on workload patterns and load balancing</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Intelligent VM Tagging for Remaining VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Analyzing and tagging 26 untagged VMs with optimal maintenance window distribution...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="c"># Function to safely tag a VM across subscriptions</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>    <span class="p">)</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>        <span class="nv">$currentContext</span> <span class="p">=</span> <span class="nb">Get-AzContext</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$currentContext</span><span class="p">.</span><span class="n">Subscription</span><span class="p">.</span><span class="n">Id</span> <span class="o">-ne</span> <span class="nv">$SubscriptionId</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>        <span class="p">}</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>
</span><span id="__span-48-29"><a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>        <span class="c"># Get the VM</span>
</span><span id="__span-48-30"><a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-48-31"><a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>
</span><span id="__span-48-32"><a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>        <span class="c"># Add maintenance tags to existing tags (preserve existing tags)</span>
</span><span id="__span-48-33"><a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-34"><a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-48-35"><a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>                <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-48-36"><a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a>            <span class="p">}</span>
</span><span id="__span-48-37"><a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-48-38"><a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-48-39"><a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>        <span class="p">}</span>
</span><span id="__span-48-40"><a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a>
</span><span id="__span-48-41"><a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a>        <span class="c"># Update the VM tags</span>
</span><span id="__span-48-42"><a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-48-43"><a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-44"><a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a>
</span><span id="__span-48-45"><a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-48-46"><a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a>    <span class="p">}</span>
</span><span id="__span-48-47"><a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-48-48"><a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-48-49"><a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-48-50"><a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a>    <span class="p">}</span>
</span><span id="__span-48-51"><a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a><span class="p">}</span>
</span><span id="__span-48-52"><a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a>
</span><span id="__span-48-53"><a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a><span class="c"># Define current maintenance window loads (after existing 59 VMs)</span>
</span><span id="__span-48-54"><a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a><span class="nv">$currentLoad</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-55"><a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">7</span>
</span><span id="__span-48-56"><a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">7</span> 
</span><span id="__span-48-57"><a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">10</span>
</span><span id="__span-48-58"><a id="__codelineno-48-58" name="__codelineno-48-58" href="#__codelineno-48-58"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-48-59"><a id="__codelineno-48-59" name="__codelineno-48-59" href="#__codelineno-48-59"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-48-60"><a id="__codelineno-48-60" name="__codelineno-48-60" href="#__codelineno-48-60"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">17</span>  <span class="c"># Dev/Test at 09:00</span>
</span><span id="__span-48-61"><a id="__codelineno-48-61" name="__codelineno-48-61" href="#__codelineno-48-61"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-48-62"><a id="__codelineno-48-62" name="__codelineno-48-62" href="#__codelineno-48-62"></a><span class="p">}</span>
</span><span id="__span-48-63"><a id="__codelineno-48-63" name="__codelineno-48-63" href="#__codelineno-48-63"></a>
</span><span id="__span-48-64"><a id="__codelineno-48-64" name="__codelineno-48-64" href="#__codelineno-48-64"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== CURRENT MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-65"><a id="__codelineno-48-65" name="__codelineno-48-65" href="#__codelineno-48-65"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-48-66"><a id="__codelineno-48-66" name="__codelineno-48-66" href="#__codelineno-48-66"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-67"><a id="__codelineno-48-67" name="__codelineno-48-67" href="#__codelineno-48-67"></a><span class="p">}</span>
</span><span id="__span-48-68"><a id="__codelineno-48-68" name="__codelineno-48-68" href="#__codelineno-48-68"></a>
</span><span id="__span-48-69"><a id="__codelineno-48-69" name="__codelineno-48-69" href="#__codelineno-48-69"></a><span class="c"># Initialize counters for new assignments</span>
</span><span id="__span-48-70"><a id="__codelineno-48-70" name="__codelineno-48-70" href="#__codelineno-48-70"></a><span class="nv">$newAssignments</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-71"><a id="__codelineno-48-71" name="__codelineno-48-71" href="#__codelineno-48-71"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-72"><a id="__codelineno-48-72" name="__codelineno-48-72" href="#__codelineno-48-72"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-73"><a id="__codelineno-48-73" name="__codelineno-48-73" href="#__codelineno-48-73"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-74"><a id="__codelineno-48-74" name="__codelineno-48-74" href="#__codelineno-48-74"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-75"><a id="__codelineno-48-75" name="__codelineno-48-75" href="#__codelineno-48-75"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-76"><a id="__codelineno-48-76" name="__codelineno-48-76" href="#__codelineno-48-76"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">0</span>  <span class="c"># Will use sat-09 for dev/test</span>
</span><span id="__span-48-77"><a id="__codelineno-48-77" name="__codelineno-48-77" href="#__codelineno-48-77"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-78"><a id="__codelineno-48-78" name="__codelineno-48-78" href="#__codelineno-48-78"></a><span class="p">}</span>
</span><span id="__span-48-79"><a id="__codelineno-48-79" name="__codelineno-48-79" href="#__codelineno-48-79"></a>
</span><span id="__span-48-80"><a id="__codelineno-48-80" name="__codelineno-48-80" href="#__codelineno-48-80"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-81"><a id="__codelineno-48-81" name="__codelineno-48-81" href="#__codelineno-48-81"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== INTELLIGENT VM GROUPING AND ASSIGNMENT ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-82"><a id="__codelineno-48-82" name="__codelineno-48-82" href="#__codelineno-48-82"></a>
</span><span id="__span-48-83"><a id="__codelineno-48-83" name="__codelineno-48-83" href="#__codelineno-48-83"></a><span class="c"># Define VM groups with intelligent maintenance window assignments</span>
</span><span id="__span-48-84"><a id="__codelineno-48-84" name="__codelineno-48-84" href="#__codelineno-48-84"></a><span class="nv">$vmGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-85"><a id="__codelineno-48-85" name="__codelineno-48-85" href="#__codelineno-48-85"></a>
</span><span id="__span-48-86"><a id="__codelineno-48-86" name="__codelineno-48-86" href="#__codelineno-48-86"></a>    <span class="c"># CRITICAL PRODUCTION SYSTEMS - Spread across different days</span>
</span><span id="__span-48-87"><a id="__codelineno-48-87" name="__codelineno-48-87" href="#__codelineno-48-87"></a>    <span class="s2">&quot;Critical Infrastructure&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-88"><a id="__codelineno-48-88" name="__codelineno-48-88" href="#__codelineno-48-88"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-48-89"><a id="__codelineno-48-89" name="__codelineno-48-89" href="#__codelineno-48-89"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Sunday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - critical infrastructure&quot;</span> <span class="p">},</span>
</span><span id="__span-48-90"><a id="__codelineno-48-90" name="__codelineno-48-90" href="#__codelineno-48-90"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - spread from other DCs&quot;</span> <span class="p">},</span>
</span><span id="__span-48-91"><a id="__codelineno-48-91" name="__codelineno-48-91" href="#__codelineno-48-91"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-backup&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Backup Server - spread across week&quot;</span> <span class="p">}</span>
</span><span id="__span-48-92"><a id="__codelineno-48-92" name="__codelineno-48-92" href="#__codelineno-48-92"></a>        <span class="p">)</span>
</span><span id="__span-48-93"><a id="__codelineno-48-93" name="__codelineno-48-93" href="#__codelineno-48-93"></a>    <span class="p">}</span>
</span><span id="__span-48-94"><a id="__codelineno-48-94" name="__codelineno-48-94" href="#__codelineno-48-94"></a>
</span><span id="__span-48-95"><a id="__codelineno-48-95" name="__codelineno-48-95" href="#__codelineno-48-95"></a>    <span class="c"># PRODUCTION BUSINESS APPLICATIONS - Spread for business continuity</span>
</span><span id="__span-48-96"><a id="__codelineno-48-96" name="__codelineno-48-96" href="#__codelineno-48-96"></a>    <span class="s2">&quot;Production Applications&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-97"><a id="__codelineno-48-97" name="__codelineno-48-97" href="#__codelineno-48-97"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-48-98"><a id="__codelineno-48-98" name="__codelineno-48-98" href="#__codelineno-48-98"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Server - Monday for week start&quot;</span> <span class="p">},</span>
</span><span id="__span-48-99"><a id="__codelineno-48-99" name="__codelineno-48-99" href="#__codelineno-48-99"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Server - Tuesday&quot;</span> <span class="p">},</span>
</span><span id="__span-48-100"><a id="__codelineno-48-100" name="__codelineno-48-100" href="#__codelineno-48-100"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-app-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Wednesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Application Server - mid-week&quot;</span> <span class="p">}</span>
</span><span id="__span-48-101"><a id="__codelineno-48-101" name="__codelineno-48-101" href="#__codelineno-48-101"></a>        <span class="p">)</span>
</span><span id="__span-48-102"><a id="__codelineno-48-102" name="__codelineno-48-102" href="#__codelineno-48-102"></a>    <span class="p">}</span>
</span><span id="__span-48-103"><a id="__codelineno-48-103" name="__codelineno-48-103" href="#__codelineno-48-103"></a>
</span><span id="__span-48-104"><a id="__codelineno-48-104" name="__codelineno-48-104" href="#__codelineno-48-104"></a>    <span class="c"># DEV/TEST SYSTEMS - Saturday morning maintenance (like existing dev/test)</span>
</span><span id="__span-48-105"><a id="__codelineno-48-105" name="__codelineno-48-105" href="#__codelineno-48-105"></a>    <span class="s2">&quot;Development Systems&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-106"><a id="__codelineno-48-106" name="__codelineno-48-106" href="#__codelineno-48-106"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-48-107"><a id="__codelineno-48-107" name="__codelineno-48-107" href="#__codelineno-48-107"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-48-108"><a id="__codelineno-48-108" name="__codelineno-48-108" href="#__codelineno-48-108"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-48-109"><a id="__codelineno-48-109" name="__codelineno-48-109" href="#__codelineno-48-109"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-testing&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Test Server - join existing dev/test window&quot;</span> <span class="p">}</span>
</span><span id="__span-48-110"><a id="__codelineno-48-110" name="__codelineno-48-110" href="#__codelineno-48-110"></a>            <span class="c"># ... additional dev/test VMs</span>
</span><span id="__span-48-111"><a id="__codelineno-48-111" name="__codelineno-48-111" href="#__codelineno-48-111"></a>        <span class="p">)</span>
</span><span id="__span-48-112"><a id="__codelineno-48-112" name="__codelineno-48-112" href="#__codelineno-48-112"></a>    <span class="p">}</span>
</span><span id="__span-48-113"><a id="__codelineno-48-113" name="__codelineno-48-113" href="#__codelineno-48-113"></a><span class="p">}</span>
</span><span id="__span-48-114"><a id="__codelineno-48-114" name="__codelineno-48-114" href="#__codelineno-48-114"></a>
</span><span id="__span-48-115"><a id="__codelineno-48-115" name="__codelineno-48-115" href="#__codelineno-48-115"></a><span class="c"># Initialize counters</span>
</span><span id="__span-48-116"><a id="__codelineno-48-116" name="__codelineno-48-116" href="#__codelineno-48-116"></a><span class="nv">$totalProcessed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-117"><a id="__codelineno-48-117" name="__codelineno-48-117" href="#__codelineno-48-117"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-118"><a id="__codelineno-48-118" name="__codelineno-48-118" href="#__codelineno-48-118"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-48-119"><a id="__codelineno-48-119" name="__codelineno-48-119" href="#__codelineno-48-119"></a>
</span><span id="__span-48-120"><a id="__codelineno-48-120" name="__codelineno-48-120" href="#__codelineno-48-120"></a><span class="c"># Process each group</span>
</span><span id="__span-48-121"><a id="__codelineno-48-121" name="__codelineno-48-121" href="#__codelineno-48-121"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$groupName</span> <span class="k">in</span> <span class="nv">$vmGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-122"><a id="__codelineno-48-122" name="__codelineno-48-122" href="#__codelineno-48-122"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$vmGroups</span><span class="p">[</span><span class="nv">$groupName</span><span class="p">]</span>
</span><span id="__span-48-123"><a id="__codelineno-48-123" name="__codelineno-48-123" href="#__codelineno-48-123"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $groupName ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-48-124"><a id="__codelineno-48-124" name="__codelineno-48-124" href="#__codelineno-48-124"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Processing </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs in this group&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-125"><a id="__codelineno-48-125" name="__codelineno-48-125" href="#__codelineno-48-125"></a>
</span><span id="__span-48-126"><a id="__codelineno-48-126" name="__codelineno-48-126" href="#__codelineno-48-126"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmInfo</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-127"><a id="__codelineno-48-127" name="__codelineno-48-127" href="#__codelineno-48-127"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Window</span>
</span><span id="__span-48-128"><a id="__codelineno-48-128" name="__codelineno-48-128" href="#__codelineno-48-128"></a>        <span class="nv">$vmName</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-48-129"><a id="__codelineno-48-129" name="__codelineno-48-129" href="#__codelineno-48-129"></a>
</span><span id="__span-48-130"><a id="__codelineno-48-130" name="__codelineno-48-130" href="#__codelineno-48-130"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">�️ $vmName → $window maintenance window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-48-131"><a id="__codelineno-48-131" name="__codelineno-48-131" href="#__codelineno-48-131"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;   Reason: </span><span class="p">$(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Reason</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-48-132"><a id="__codelineno-48-132" name="__codelineno-48-132" href="#__codelineno-48-132"></a>
</span><span id="__span-48-133"><a id="__codelineno-48-133" name="__codelineno-48-133" href="#__codelineno-48-133"></a>        <span class="c"># Determine subscription ID from name</span>
</span><span id="__span-48-134"><a id="__codelineno-48-134" name="__codelineno-48-134" href="#__codelineno-48-134"></a>        <span class="nv">$subscriptionId</span> <span class="p">=</span> <span class="k">switch</span> <span class="p">(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Sub</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-135"><a id="__codelineno-48-135" name="__codelineno-48-135" href="#__codelineno-48-135"></a>            <span class="s2">&quot;Production&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Production&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-48-136"><a id="__codelineno-48-136" name="__codelineno-48-136" href="#__codelineno-48-136"></a>            <span class="s2">&quot;DevTest&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DevTest&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-48-137"><a id="__codelineno-48-137" name="__codelineno-48-137" href="#__codelineno-48-137"></a>            <span class="s2">&quot;Identity&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Identity&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-48-138"><a id="__codelineno-48-138" name="__codelineno-48-138" href="#__codelineno-48-138"></a>            <span class="s2">&quot;DMZ&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DMZ&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-48-139"><a id="__codelineno-48-139" name="__codelineno-48-139" href="#__codelineno-48-139"></a>        <span class="p">}</span>
</span><span id="__span-48-140"><a id="__codelineno-48-140" name="__codelineno-48-140" href="#__codelineno-48-140"></a>
</span><span id="__span-48-141"><a id="__codelineno-48-141" name="__codelineno-48-141" href="#__codelineno-48-141"></a>        <span class="c"># Create appropriate tags based on maintenance window</span>
</span><span id="__span-48-142"><a id="__codelineno-48-142" name="__codelineno-48-142" href="#__codelineno-48-142"></a>        <span class="nv">$tags</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-48-143"><a id="__codelineno-48-143" name="__codelineno-48-143" href="#__codelineno-48-143"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-48-144"><a id="__codelineno-48-144" name="__codelineno-48-144" href="#__codelineno-48-144"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-48-145"><a id="__codelineno-48-145" name="__codelineno-48-145" href="#__codelineno-48-145"></a>        <span class="p">}</span>
</span><span id="__span-48-146"><a id="__codelineno-48-146" name="__codelineno-48-146" href="#__codelineno-48-146"></a>
</span><span id="__span-48-147"><a id="__codelineno-48-147" name="__codelineno-48-147" href="#__codelineno-48-147"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$window</span> <span class="o">-eq</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-148"><a id="__codelineno-48-148" name="__codelineno-48-148" href="#__codelineno-48-148"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>  <span class="c"># Saturday 09:00 for dev/test</span>
</span><span id="__span-48-149"><a id="__codelineno-48-149" name="__codelineno-48-149" href="#__codelineno-48-149"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-48-150"><a id="__codelineno-48-150" name="__codelineno-48-150" href="#__codelineno-48-150"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$window</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  <span class="c"># mon, tue, wed, etc.</span>
</span><span id="__span-48-151"><a id="__codelineno-48-151" name="__codelineno-48-151" href="#__codelineno-48-151"></a>        <span class="p">}</span>
</span><span id="__span-48-152"><a id="__codelineno-48-152" name="__codelineno-48-152" href="#__codelineno-48-152"></a>
</span><span id="__span-48-153"><a id="__codelineno-48-153" name="__codelineno-48-153" href="#__codelineno-48-153"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">RG</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscriptionId</span> <span class="n">-Tags</span> <span class="nv">$tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$window</span>
</span><span id="__span-48-154"><a id="__codelineno-48-154" name="__codelineno-48-154" href="#__codelineno-48-154"></a>
</span><span id="__span-48-155"><a id="__codelineno-48-155" name="__codelineno-48-155" href="#__codelineno-48-155"></a>        <span class="nv">$totalProcessed</span><span class="p">++</span>
</span><span id="__span-48-156"><a id="__codelineno-48-156" name="__codelineno-48-156" href="#__codelineno-48-156"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> 
</span><span id="__span-48-157"><a id="__codelineno-48-157" name="__codelineno-48-157" href="#__codelineno-48-157"></a>            <span class="nv">$totalSuccess</span><span class="p">++</span>
</span><span id="__span-48-158"><a id="__codelineno-48-158" name="__codelineno-48-158" href="#__codelineno-48-158"></a>            <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-48-159"><a id="__codelineno-48-159" name="__codelineno-48-159" href="#__codelineno-48-159"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span><span id="__span-48-160"><a id="__codelineno-48-160" name="__codelineno-48-160" href="#__codelineno-48-160"></a>            <span class="nv">$totalFailed</span><span class="p">++</span> 
</span><span id="__span-48-161"><a id="__codelineno-48-161" name="__codelineno-48-161" href="#__codelineno-48-161"></a>        <span class="p">}</span>
</span><span id="__span-48-162"><a id="__codelineno-48-162" name="__codelineno-48-162" href="#__codelineno-48-162"></a>    <span class="p">}</span>
</span><span id="__span-48-163"><a id="__codelineno-48-163" name="__codelineno-48-163" href="#__codelineno-48-163"></a><span class="p">}</span>
</span><span id="__span-48-164"><a id="__codelineno-48-164" name="__codelineno-48-164" href="#__codelineno-48-164"></a>
</span><span id="__span-48-165"><a id="__codelineno-48-165" name="__codelineno-48-165" href="#__codelineno-48-165"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-166"><a id="__codelineno-48-166" name="__codelineno-48-166" href="#__codelineno-48-166"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-167"><a id="__codelineno-48-167" name="__codelineno-48-167" href="#__codelineno-48-167"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs processed: $totalProcessed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-168"><a id="__codelineno-48-168" name="__codelineno-48-168" href="#__codelineno-48-168"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-169"><a id="__codelineno-48-169" name="__codelineno-48-169" href="#__codelineno-48-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-48-170"><a id="__codelineno-48-170" name="__codelineno-48-170" href="#__codelineno-48-170"></a>
</span><span id="__span-48-171"><a id="__codelineno-48-171" name="__codelineno-48-171" href="#__codelineno-48-171"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-172"><a id="__codelineno-48-172" name="__codelineno-48-172" href="#__codelineno-48-172"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEW MAINTENANCE WINDOW DISTRIBUTION ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-173"><a id="__codelineno-48-173" name="__codelineno-48-173" href="#__codelineno-48-173"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs added to each maintenance window:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-174"><a id="__codelineno-48-174" name="__codelineno-48-174" href="#__codelineno-48-174"></a>
</span><span id="__span-48-175"><a id="__codelineno-48-175" name="__codelineno-48-175" href="#__codelineno-48-175"></a><span class="nv">$newAssignments</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-48-176"><a id="__codelineno-48-176" name="__codelineno-48-176" href="#__codelineno-48-176"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-177"><a id="__codelineno-48-177" name="__codelineno-48-177" href="#__codelineno-48-177"></a>        <span class="nv">$newTotal</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-48-178"><a id="__codelineno-48-178" name="__codelineno-48-178" href="#__codelineno-48-178"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: +</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs (total: $newTotal VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-179"><a id="__codelineno-48-179" name="__codelineno-48-179" href="#__codelineno-48-179"></a>    <span class="p">}</span>
</span><span id="__span-48-180"><a id="__codelineno-48-180" name="__codelineno-48-180" href="#__codelineno-48-180"></a><span class="p">}</span>
</span><span id="__span-48-181"><a id="__codelineno-48-181" name="__codelineno-48-181" href="#__codelineno-48-181"></a>
</span><span id="__span-48-182"><a id="__codelineno-48-182" name="__codelineno-48-182" href="#__codelineno-48-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-183"><a id="__codelineno-48-183" name="__codelineno-48-183" href="#__codelineno-48-183"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== FINAL MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-184"><a id="__codelineno-48-184" name="__codelineno-48-184" href="#__codelineno-48-184"></a><span class="nv">$finalLoad</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-48-185"><a id="__codelineno-48-185" name="__codelineno-48-185" href="#__codelineno-48-185"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-48-186"><a id="__codelineno-48-186" name="__codelineno-48-186" href="#__codelineno-48-186"></a>    <span class="nv">$finalLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-48-187"><a id="__codelineno-48-187" name="__codelineno-48-187" href="#__codelineno-48-187"></a><span class="p">}</span>
</span><span id="__span-48-188"><a id="__codelineno-48-188" name="__codelineno-48-188" href="#__codelineno-48-188"></a>
</span><span id="__span-48-189"><a id="__codelineno-48-189" name="__codelineno-48-189" href="#__codelineno-48-189"></a><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-48-190"><a id="__codelineno-48-190" name="__codelineno-48-190" href="#__codelineno-48-190"></a>    <span class="nv">$status</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">8</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Green&quot;</span> <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">12</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Yellow&quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;Red&quot;</span> <span class="p">}</span>
</span><span id="__span-48-191"><a id="__codelineno-48-191" name="__codelineno-48-191" href="#__codelineno-48-191"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="nv">$status</span>
</span><span id="__span-48-192"><a id="__codelineno-48-192" name="__codelineno-48-192" href="#__codelineno-48-192"></a><span class="p">}</span>
</span><span id="__span-48-193"><a id="__codelineno-48-193" name="__codelineno-48-193" href="#__codelineno-48-193"></a>
</span><span id="__span-48-194"><a id="__codelineno-48-194" name="__codelineno-48-194" href="#__codelineno-48-194"></a><span class="nv">$grandTotal</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="nb">Measure-Object</span> <span class="n">-Sum</span><span class="p">).</span><span class="n">Sum</span>
</span><span id="__span-48-195"><a id="__codelineno-48-195" name="__codelineno-48-195" href="#__codelineno-48-195"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Grand Total: $grandTotal VMs across all maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-196"><a id="__codelineno-48-196" name="__codelineno-48-196" href="#__codelineno-48-196"></a>
</span><span id="__span-48-197"><a id="__codelineno-48-197" name="__codelineno-48-197" href="#__codelineno-48-197"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-198"><a id="__codelineno-48-198" name="__codelineno-48-198" href="#__codelineno-48-198"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== BUSINESS LOGIC APPLIED ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-199"><a id="__codelineno-48-199" name="__codelineno-48-199" href="#__codelineno-48-199"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Critical systems spread across different days for resilience&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-200"><a id="__codelineno-48-200" name="__codelineno-48-200" href="#__codelineno-48-200"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Domain Controllers distributed to avoid single points of failure&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-201"><a id="__codelineno-48-201" name="__codelineno-48-201" href="#__codelineno-48-201"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Dev/Test systems consolidated to Saturday morning (existing pattern)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-202"><a id="__codelineno-48-202" name="__codelineno-48-202" href="#__codelineno-48-202"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Production workstations spread to minimize user impact&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-203"><a id="__codelineno-48-203" name="__codelineno-48-203" href="#__codelineno-48-203"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Business applications distributed for operational continuity&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-204"><a id="__codelineno-48-204" name="__codelineno-48-204" href="#__codelineno-48-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Load balancing maintained across the week&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-205"><a id="__codelineno-48-205" name="__codelineno-48-205" href="#__codelineno-48-205"></a>
</span><span id="__span-48-206"><a id="__codelineno-48-206" name="__codelineno-48-206" href="#__codelineno-48-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-207"><a id="__codelineno-48-207" name="__codelineno-48-207" href="#__codelineno-48-207"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VERIFICATION STEPS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-208"><a id="__codelineno-48-208" name="__codelineno-48-208" href="#__codelineno-48-208"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Verify tags in Azure Portal across all subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-209"><a id="__codelineno-48-209" name="__codelineno-48-209" href="#__codelineno-48-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Check that critical systems are on different days&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-210"><a id="__codelineno-48-210" name="__codelineno-48-210" href="#__codelineno-48-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Confirm dev/test systems are in Saturday morning window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-211"><a id="__codelineno-48-211" name="__codelineno-48-211" href="#__codelineno-48-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Review production systems distribution&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-212"><a id="__codelineno-48-212" name="__codelineno-48-212" href="#__codelineno-48-212"></a>
</span><span id="__span-48-213"><a id="__codelineno-48-213" name="__codelineno-48-213" href="#__codelineno-48-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-214"><a id="__codelineno-48-214" name="__codelineno-48-214" href="#__codelineno-48-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH VERIFICATION QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-215"><a id="__codelineno-48-215" name="__codelineno-48-215" href="#__codelineno-48-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query to verify all VMs are now tagged:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-48-216"><a id="__codelineno-48-216" name="__codelineno-48-216" href="#__codelineno-48-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-217"><a id="__codelineno-48-217" name="__codelineno-48-217" href="#__codelineno-48-217"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-48-218"><a id="__codelineno-48-218" name="__codelineno-48-218" href="#__codelineno-48-218"></a><span class="sh">Resources</span>
</span><span id="__span-48-219"><a id="__codelineno-48-219" name="__codelineno-48-219" href="#__codelineno-48-219"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-48-220"><a id="__codelineno-48-220" name="__codelineno-48-220" href="#__codelineno-48-220"></a><span class="sh">| where tags.Updates == &quot;Azure Update Manager&quot;</span>
</span><span id="__span-48-221"><a id="__codelineno-48-221" name="__codelineno-48-221" href="#__codelineno-48-221"></a><span class="sh">| project name, resourceGroup, subscriptionId, </span>
</span><span id="__span-48-222"><a id="__codelineno-48-222" name="__codelineno-48-222" href="#__codelineno-48-222"></a><span class="sh">          patchWindow = tags.PatchWindow,</span>
</span><span id="__span-48-223"><a id="__codelineno-48-223" name="__codelineno-48-223" href="#__codelineno-48-223"></a><span class="sh">          owner = tags.Owner,</span>
</span><span id="__span-48-224"><a id="__codelineno-48-224" name="__codelineno-48-224" href="#__codelineno-48-224"></a><span class="sh">          updates = tags.Updates</span>
</span><span id="__span-48-225"><a id="__codelineno-48-225" name="__codelineno-48-225" href="#__codelineno-48-225"></a><span class="sh">| sort by patchWindow, name</span>
</span><span id="__span-48-226"><a id="__codelineno-48-226" name="__codelineno-48-226" href="#__codelineno-48-226"></a><span class="sh">| summarize count() by patchWindow</span>
</span><span id="__span-48-227"><a id="__codelineno-48-227" name="__codelineno-48-227" href="#__codelineno-48-227"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-48-228"><a id="__codelineno-48-228" name="__codelineno-48-228" href="#__codelineno-48-228"></a>
</span><span id="__span-48-229"><a id="__codelineno-48-229" name="__codelineno-48-229" href="#__codelineno-48-229"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$totalFailed</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-48-230"><a id="__codelineno-48-230" name="__codelineno-48-230" href="#__codelineno-48-230"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-231"><a id="__codelineno-48-231" name="__codelineno-48-231" href="#__codelineno-48-231"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs SUCCESSFULLY TAGGED WITH INTELLIGENT DISTRIBUTION! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-48-232"><a id="__codelineno-48-232" name="__codelineno-48-232" href="#__codelineno-48-232"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-48-233"><a id="__codelineno-48-233" name="__codelineno-48-233" href="#__codelineno-48-233"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-234"><a id="__codelineno-48-234" name="__codelineno-48-234" href="#__codelineno-48-234"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;⚠️ Some VMs failed to tag. Please review errors above.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-48-235"><a id="__codelineno-48-235" name="__codelineno-48-235" href="#__codelineno-48-235"></a><span class="p">}</span>
</span><span id="__span-48-236"><a id="__codelineno-48-236" name="__codelineno-48-236" href="#__codelineno-48-236"></a>
</span><span id="__span-48-237"><a id="__codelineno-48-237" name="__codelineno-48-237" href="#__codelineno-48-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-48-238"><a id="__codelineno-48-238" name="__codelineno-48-238" href="#__codelineno-48-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-48-239"><a id="__codelineno-48-239" name="__codelineno-48-239" href="#__codelineno-48-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<blockquote>
<p><strong>Key insight:</strong> I grouped VMs by function and criticality, not just by convenience. Domain controllers got spread across different days, dev/test systems joined the existing Saturday morning window, and production applications were distributed for business continuity.</p>
</blockquote>
<hr />
<h3 id="step-7-configure-azure-policy-prerequisites"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-7-configure-azure-policy-prerequisites">🧰 Step 7 – Configure Azure Policy Prerequisites</a></h3>
<p>Here's where things get interesting. Update Manager is built on compliance — but your VMs won't show up in dynamic scopes unless they meet certain prerequisites. Enter Azure Policy to save the day.</p>
<p>You'll need two specific built-in policies assigned at the subscription (or management group) level:</p>
<h4 id="policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines">✅ Policy 1: <code>Set prerequisites for scheduling recurring updates on Azure virtual machines</code></a></h4>
<p><strong>What it does:</strong> This policy ensures your VMs have the necessary configurations to participate in Azure Update Manager. It automatically:</p>
<ul>
<li>Installs the Azure Update Manager extension on Windows VMs</li>
<li>Registers required resource providers</li>
<li>Configures the VM to report its update compliance status</li>
<li>Sets the patch orchestration mode appropriately</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> Without this policy, VMs won't appear in Update Manager scopes even if they're tagged correctly. The policy handles all the "plumbing" automatically.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Apply this at subscription or management group level to catch all VMs.</p>
<h4 id="policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines">✅ Policy 2: <code>Configure periodic checking for missing system updates on Azure virtual machines</code></a></h4>
<p><strong>What it does:</strong> This is your compliance engine. It configures VMs to:</p>
<ul>
<li>Regularly scan for available updates (but not install them automatically)</li>
<li>Report update status back to Azure Update Manager</li>
<li>Enable the compliance dashboard views in the portal</li>
<li>Provide the data needed for maintenance configuration targeting</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> This policy turns on the "update awareness" for your VMs. Without it, Azure Update Manager has no visibility into what patches are needed.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Same as above — subscription or management group level.</p>
<h4 id="assigning-the-policies"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#assigning-the-policies">🎯 Assigning the Policies</a></h4>
<p><strong>Step-by-step in Azure Portal:</strong></p>
<ol>
<li><strong>Navigate to Azure Policy</strong></li>
<li>
<p>Azure Portal → Search "Policy" → Select "Policy"</p>
</li>
<li>
<p><strong>Find the First Policy</strong></p>
</li>
<li>Left menu: <strong>Definitions</strong></li>
<li>Search: <code>Set prerequisites for scheduling recurring updates</code></li>
<li>
<p>Click on the policy title</p>
</li>
<li>
<p><strong>Assign the Policy</strong></p>
</li>
<li>Click <strong>Assign</strong> button</li>
<li><strong>Scope:</strong> Select your subscription(s)</li>
<li><strong>Basics:</strong> Leave policy name as default</li>
<li><strong>Parameters:</strong> Leave as default</li>
<li><strong>Remediation:</strong> ✅ Check "Create remediation task"</li>
<li>
<p><strong>Review + create</strong></p>
</li>
<li>
<p><strong>Repeat for Second Policy</strong></p>
</li>
<li>Search: <code>Configure periodic checking for missing system updates</code></li>
<li>Follow same assignment process</li>
</ol>
<blockquote>
<p>⚠️ <strong>Important:</strong> Policy compliance can take 30+ minutes to evaluate and apply. Perfect time for that brew I mentioned earlier.</p>
</blockquote>
<h4 id="monitoring-compliance"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#monitoring-compliance">🔍 Monitoring Compliance</a></h4>
<p>Once assigned, you can track compliance in <strong>Azure Policy &gt; Compliance</strong>. Look for:</p>
<ul>
<li>Non-compliant VMs that need the extension installed</li>
<li>VMs that aren't reporting update status properly</li>
<li>Any policy assignment errors that need investigation</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/prerequsite-for-schedule-patching">Learn more about Azure Policy for Update Management</a></p>
<hr />
<h3 id="step-8-create-dynamic-scopes-in-update-manager"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-8-create-dynamic-scopes-in-update-manager">🧪 Step 8 – Create Dynamic Scopes in Update Manager</a></h3>
<p>This is where it all comes together — and where the magic happens.</p>
<p>Dynamic scopes use those <code>PatchWindow</code> tags to assign VMs to the correct patch config automatically. No more manual VM assignment, no more "did we remember to add the new server?" conversations.</p>
<h4 id="the-portal-dance"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#the-portal-dance">🎯 The Portal Dance</a></h4>
<p>Unfortunately, as of writing, dynamic scopes can only be configured through the Azure portal — no PowerShell or ARM template support yet.</p>
<blockquote>
<p><strong>Why portal only?</strong> Dynamic scopes are still in preview, and Microsoft hasn't released the PowerShell cmdlets or ARM template schemas yet. This means you can't fully automate the deployment, but the functionality itself works perfectly.</p>
</blockquote>
<p>Here's the step-by-step:</p>
<ol>
<li><strong>Navigate to Azure Update Manager</strong></li>
<li>
<p>Portal → All Services → Azure Update Manager</p>
</li>
<li>
<p><strong>Access Maintenance Configurations</strong></p>
</li>
<li>Go to <strong>Maintenance Configurations (Preview)</strong></li>
<li>
<p>Select one of your configs (e.g., <code>contoso-maintenance-config-vms-mon</code>)</p>
</li>
<li>
<p><strong>Create Dynamic Scope</strong></p>
</li>
<li>Click <strong>Dynamic Scopes</strong> → <strong>Add</strong></li>
<li><strong>Name:</strong> <code>DynamicScope-Monday-VMs</code></li>
<li>
<p><strong>Description:</strong> <code>Auto-assign Windows VMs tagged for Monday maintenance</code></p>
</li>
<li>
<p><strong>Configure Scope Settings</strong></p>
</li>
<li><strong>Subscription:</strong> Select your subscription(s)</li>
<li><strong>Resource Type:</strong> <code>Microsoft.Compute/virtualMachines</code></li>
<li>
<p><strong>OS Type:</strong> <code>Windows</code> (create separate scopes for Linux if needed)</p>
</li>
<li>
<p><strong>Set Tag Filters</strong></p>
</li>
<li><strong>Tag Name:</strong> <code>PatchWindow</code></li>
<li><strong>Tag Value:</strong> <code>mon</code> (must match your maintenance config naming)</li>
<li>
<p><strong>Additional filters</strong> (optional):</p>
<ul>
<li><code>Owner</code> = <code>Contoso</code></li>
<li><code>Updates</code> = <code>Azure Update Manager</code></li>
</ul>
</li>
<li>
<p><strong>Review and Create</strong></p>
</li>
<li>Verify the filter logic</li>
<li>Click <strong>Create</strong></li>
</ol>
<h4 id="repeat-for-all-days"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#repeat-for-all-days">🔄 Repeat for All Days</a></h4>
<p>You'll need to create dynamic scopes for each maintenance configuration:</p>
<table>
<thead>
<tr>
<th>Maintenance Config</th>
<th>Dynamic Scope Name</th>
<th>Tag Filter</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>contoso-maintenance-config-vms-mon</code></td>
<td><code>DynamicScope-Monday-VMs</code></td>
<td><code>PatchWindow = mon</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-tue</code></td>
<td><code>DynamicScope-Tuesday-VMs</code></td>
<td><code>PatchWindow = tue</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-wed</code></td>
<td><code>DynamicScope-Wednesday-VMs</code></td>
<td><code>PatchWindow = wed</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-thu</code></td>
<td><code>DynamicScope-Thursday-VMs</code></td>
<td><code>PatchWindow = thu</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-fri</code></td>
<td><code>DynamicScope-Friday-VMs</code></td>
<td><code>PatchWindow = fri</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sat</code></td>
<td><code>DynamicScope-Saturday-VMs</code></td>
<td><code>PatchWindow = sat-09</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sun</code></td>
<td><code>DynamicScope-Sunday-VMs</code></td>
<td><code>PatchWindow = sun</code></td>
</tr>
</tbody>
</table>
<h4 id="verify-dynamic-scope-assignment"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#verify-dynamic-scope-assignment">🔍 Verify Dynamic Scope Assignment</a></h4>
<p>Once created, you can verify the scopes are working:</p>
<ol>
<li><strong>In the Maintenance Configuration:</strong></li>
<li>Go to <strong>Dynamic Scopes</strong></li>
<li>Check <strong>Resources</strong> tab to see matched VMs</li>
<li>Verify expected VM count matches your tagging</li>
<li>
<p><strong>Wait time:</strong> Allow 15-30 minutes for newly tagged VMs to appear</p>
</li>
<li>
<p><strong>What success looks like:</strong></p>
</li>
<li>Monday scope shows 5 VMs (WEB-PROD-01, DB-PROD-01, etc.)</li>
<li>Saturday scope shows 5 VMs (WEB-DEV-01, DB-DEV-01, etc.)</li>
<li>
<p>No VMs showing? Check tag case sensitivity and filters</p>
</li>
<li>
<p><strong>In Azure Resource Graph:</strong></p>
</li>
</ol>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">vmName</span>
</span></code></pre></div>
<ol>
<li><strong>Troubleshoot empty scopes:</strong></li>
<li>Verify subscription selection includes all your VMs</li>
<li>Check tag spelling: <code>PatchWindow</code> (case sensitive)</li>
<li>Confirm resource type filter: <code>Microsoft.Compute/virtualMachines</code></li>
<li>Wait longer - it can take up to 30 minutes</li>
</ol>
<h4 id="common-gotchas"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#common-gotchas">⚠️ Common Gotchas</a></h4>
<p><strong>Tag Case Sensitivity:</strong> Dynamic scopes are case-sensitive. <code>mon</code> ≠ <code>Mon</code> ≠ <code>MON</code></p>
<p><strong>Subscription Scope:</strong> Ensure you've selected all relevant subscriptions in the scope configuration.</p>
<p><strong>Resource Type Filter:</strong> Don't forget to set the resource type filter — without it, you'll match storage accounts, networking, etc.</p>
<p><strong>Timing:</strong> It can take 15-30 minutes for newly tagged VMs to appear in dynamic scopes.</p>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/dynamic-scope">Dynamic scope configuration docs</a></p>
<hr />
<h3 id="step-9-test-verify-the-moment-of-truth"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-9-test-verify-the-moment-of-truth">🚀 Step 9 – Test &amp; Verify (The Moment of Truth)</a></h3>
<p>The acid test: does it actually patch stuff properly?</p>
<h4 id="proof-of-concept-test"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#proof-of-concept-test">🎪 Proof of Concept Test</a></h4>
<p>I started conservatively — scoped <code>contoso-maintenance-config-vms-sun</code> to a few non-critical VMs and let it run overnight on Sunday.</p>
<p><strong>Monday morning verification:</strong></p>
<ul>
<li>✔️ <strong>Patch compliance dashboard:</strong> All green ticks</li>
<li>✔️ <strong>Reboot timing:</strong> Machines restarted within their 4-hour window (21:00-01:00)</li>
<li>✔️ <strong>Update logs:</strong> Activity logs showed expected patching behavior</li>
<li>✔️ <strong>Business impact:</strong> Zero helpdesk tickets on Monday morning</li>
</ul>
<h4 id="full-rollout-verification"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#full-rollout-verification">📊 Full Rollout Verification</a></h4>
<p>Once confident with the Sunday test, I enabled all remaining dynamic scopes and monitored the week:</p>
<p><strong>Key metrics tracked:</strong></p>
<ul>
<li>Patch compliance percentage across all VMs</li>
<li>Failed patch installations (and root causes)</li>
<li>Reboot timing adherence</li>
<li>Business hours impact (spoiler: zero)</li>
</ul>
<h4 id="monitoring-validation-tools"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#monitoring-validation-tools">🔍 Monitoring &amp; Validation Tools</a></h4>
<p><strong>Azure Update Manager Dashboard:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>Azure Portal → Update Manager → Overview
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>- Patch compliance summary
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>- Recent patch installations
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>- Failed installations with details
</span></code></pre></div>
<p><strong>Azure Resource Graph Queries:</strong></p>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c">// Verify all VMs have maintenance tags</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="n">Resources</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Updates</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">          </span><span class="n">patchWindow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">PatchWindow</span><span class="p">,</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">          </span><span class="n">owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Owner</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="c">// Check maintenance configuration assignments</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span></code></pre></div>
<p><strong>PowerShell Verification:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c"># Quick check of maintenance configuration status</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="p">|</span> 
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">MaintenanceScope</span><span class="p">,</span> <span class="n">RecurEvery</span> <span class="p">|</span> 
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>    <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="c"># Verify VM tag distribution</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="nv">$tagSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$sub</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>    <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Id</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>    <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span> <span class="p">}</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$tagSummary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$window</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>            <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>        <span class="p">}</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>        <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>    <span class="p">}</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="p">}</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VM DISTRIBUTION BY PATCH WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a><span class="nv">$tagSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="success-metrics"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#success-metrics">📈 Success Metrics</a></h4>
<p>After two full weeks of operation:</p>
<ul>
<li><strong>Better control:</strong> Direct management of patch schedules and policies  </li>
<li><strong>Increased visibility:</strong> Real-time compliance dashboards vs. periodic reports</li>
<li><strong>Reduced complexity:</strong> Native Azure tooling vs. third-party solutions</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/monitor-updates">Monitor updates in Azure Update Manager</a></p>
<hr />
<h3 id="final-thoughts-tips"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#final-thoughts-tips">📃 Final Thoughts &amp; Tips</a></h3>
<p>✅ <strong>Cost-neutral</strong> — No more third-party patch agents
✅ <strong>Policy-driven</strong> — Enforced consistency with Azure Policy
✅ <strong>Easily auditable</strong> — Tag-based scoping is clean and visible
✅ <strong>Scalable</strong> — New VMs auto-join patch schedules via tagging</p>
<h4 id="troubleshooting-guide-common-issues"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#troubleshooting-guide-common-issues">⚠️ Troubleshooting Guide &amp; Common Issues</a></h4>
<p>Here's what I learned the hard way, so you don't have to:</p>
<table>
<thead>
<tr>
<th><strong>Symptom</strong></th>
<th><strong>Possible Cause</strong></th>
<th><strong>Fix</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>VM not showing in dynamic scope</td>
<td>Tag typo or case mismatch</td>
<td>Verify <code>PatchWindow</code> tag exactly matches config name</td>
</tr>
<tr>
<td>Maintenance config creation fails</td>
<td>Invalid duration format</td>
<td>Use ISO 8601 format: <code>"03:00"</code> not <code>"3 hours"</code></td>
</tr>
<tr>
<td>VM skipped during patching</td>
<td>Policy prerequisites not met</td>
<td>Check Azure Policy compliance dashboard</td>
</tr>
<tr>
<td>No updates applied despite schedule</td>
<td>VM needs pending reboot</td>
<td>Clear previous reboots, check update history</td>
</tr>
<tr>
<td>Dynamic scope shows zero VMs</td>
<td>Wrong subscription scope</td>
<td>Verify subscription selection in scope config</td>
</tr>
<tr>
<td>Extension installation failed</td>
<td>Insufficient permissions</td>
<td>Ensure VM contributor rights and resource provider registration</td>
</tr>
<tr>
<td>Policy compliance stuck at 0%</td>
<td>Assignment scope too narrow</td>
<td>Check policy is assigned at subscription level</td>
</tr>
<tr>
<td>VMs appear/disappear from scope</td>
<td>Tag inconsistency</td>
<td>Run tag verification script across all subscriptions</td>
</tr>
</tbody>
</table>
<h4 id="advanced-troubleshooting-commands"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#advanced-troubleshooting-commands">🔧 Advanced Troubleshooting Commands</a></h4>
<p><strong>Check VM Update Readiness:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c"># Verify VM has required extensions and configuration</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nv">$vmName</span> <span class="p">=</span> <span class="s2">&quot;your-vm-name&quot;</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="nv">$rgName</span> <span class="p">=</span> <span class="s2">&quot;your-resource-group&quot;</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Name</span> <span class="nv">$vmName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$rgName</span> <span class="n">-Status</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="nv">$vm</span><span class="p">.</span><span class="n">Extensions</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Update*&quot;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Maintenance*&quot;</span> <span class="p">}</span>
</span></code></pre></div>
<p><strong>Validate Maintenance Configuration:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c"># Test maintenance configuration is properly formed</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-mon&quot;</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Config Name: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Recurrence: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Duration: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Start Time: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">StartDateTime</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Timezone: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">TimeZone</span><span class="p">)</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>Policy Compliance Deep Dive:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c"># Check specific VMs for policy compliance</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nv">$policyName</span> <span class="p">=</span> <span class="s2">&quot;Set prerequisites for scheduling recurring updates on Azure virtual machines&quot;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nv">$assignments</span> <span class="p">=</span> <span class="nb">Get-AzPolicyAssignment</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-eq</span> <span class="nv">$policyName</span> <span class="p">}</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$assignment</span> <span class="k">in</span> <span class="nv">$assignments</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="nb">Get-AzPolicyState</span> <span class="n">-PolicyAssignmentId</span> <span class="nv">$assignment</span><span class="p">.</span><span class="n">PolicyAssignmentId</span> <span class="p">|</span> 
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>        <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ComplianceState</span> <span class="o">-eq</span> <span class="s2">&quot;NonCompliant&quot;</span> <span class="p">}</span> <span class="p">|</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>        <span class="nb">Select-Object</span> <span class="n">ResourceId</span><span class="p">,</span> <span class="n">ComplianceState</span><span class="p">,</span> <span class="p">@{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Reason&quot;</span><span class="p">;</span><span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">PolicyEvaluationDetails</span><span class="p">.</span><span class="n">EvaluatedExpressions</span><span class="p">.</span><span class="n">ExpressionValue</span><span class="p">}}</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<p><em>As always, comments and suggestions welcome over on GitHub or LinkedIn. If you've migrated patching in a different way, I'd love to hear how you approached it.</em></p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Bringing%20Patch%20Management%20In-House%3A%20Migrating%20from%20MSP%20to%20Azure%20Update%20Manager%0A&amp;url=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-08 00:00:00+00:00">May 8, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../bcdr/" class="md-meta__link">BCDR</a>, 
              <a href="../cloud-architecture/" class="md-meta__link">Cloud Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-bcdr-review-turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/">⚙️ Azure BCDR Review – Turning Inherited Cloud Infrastructure into a Resilient Recovery Strategy</a></h2>
<p>When we inherited our Azure estate from a previous MSP, some of the key technical components were already in place — ASR was configured for a number of workloads, and backups had been partially implemented across the environment.</p>
<p>What we didn’t inherit was a documented or validated BCDR strategy.</p>
<p>There were no formal recovery plans defined in ASR, no clear failover sequences, and no evidence that a regional outage scenario had ever been modelled or tested. The building blocks were there — but there was no framework tying them together into a usable or supportable recovery posture.</p>
<p>This post shares how I approached the challenge of assessing and strengthening our Azure BCDR readiness. It's not about starting from scratch — it's about applying structure, logic, and realism to an environment that had the right intentions but lacked operational clarity.</p>
<p>Whether you're stepping into a similar setup or planning your first formal DR review, I hope this provides a practical and relatable blueprint.</p>
<hr />
<h3 id="where-we-started-technical-foundations-operational-gaps"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#where-we-started-technical-foundations-operational-gaps">🎯 Where We Started: Technical Foundations, Operational Gaps</a></h3>
<p>We weren’t starting from zero — but we weren’t in a position to confidently recover the environment either.</p>
<p><strong>What we found:</strong></p>
<ul>
<li>🟢 ASR replication was partially implemented  </li>
<li>🟡 VM backups were present but inconsistent  </li>
<li>❌ No Recovery Plans existed in ASR  </li>
<li>❌ No test failovers had ever been performed  </li>
<li>⚠️ No documented RTO/RPO targets  </li>
<li>❓ DNS and Private Endpoints weren’t accounted for in DR  </li>
<li>🔒 Networking had not been reviewed for failover scenarios  </li>
<li>🚫 No capacity reservations had been made</li>
</ul>
<p>This review was the first step in understanding whether our DR setup could work in practice — not just in theory.</p>
<hr />
<h3 id="1-workload-protection-whats-covered-whats-not"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#1-workload-protection-whats-covered-whats-not">🛡️ 1️⃣ Workload Protection: What’s Covered, What’s Not</a></h3>
<p>Some workloads were actively replicated via ASR. Others were only backed up. Some had both, a few had neither. There was no documented logic to explain why.</p>
<p>Workload protection appeared to be driven by convenience or historical context — not by business impact or recovery priority.</p>
<p>What we needed was a structured tiering model:</p>
<ul>
<li>🧠 Which workloads are mission-critical?</li>
<li>⏱️ Which ones can tolerate extended recovery times?</li>
<li>📊 What RTOs and RPOs are actually achievable?</li>
</ul>
<p>This became the foundation for everything else.</p>
<hr />
<h3 id="2-the-missing-operational-layer"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#2-the-missing-operational-layer">🧩 2️⃣ The Missing Operational Layer</a></h3>
<p>We had technical coverage — but no operational recovery strategy.</p>
<p>There were no Recovery Plans in ASR. No sequencing, no post-failover validation, and no scripts or automation.</p>
<p>In the absence of structure, recovery would be entirely manual — relying on individual knowledge, assumptions, and good luck during a critical event.</p>
<p>Codifying dependencies, failover order, and recovery steps became a priority.</p>
<hr />
<h3 id="3-dns-identity-and-private-endpoint-blind-spots"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#3-dns-identity-and-private-endpoint-blind-spots">🌐 3️⃣ DNS, Identity and Private Endpoint Blind Spots</a></h3>
<p>DNS and authentication are easy to overlook — until they break.</p>
<p>Our name resolution relied on internal DNS via AD-integrated zones, with no failover logic for internal record switching. No private DNS zones were in place.</p>
<p>Private Endpoints were widely used, but all existed in the primary region. In a DR scenario, they would become unreachable.</p>
<p>Identity was regionally redundant, but untested and not AZ-aware.</p>
<p>We needed to promote DNS, identity, and PE routing to first-class DR concerns.</p>
<hr />
<h3 id="4-storage-and-data-access-risk"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#4-storage-and-data-access-risk">💾 4️⃣ Storage and Data Access Risk</a></h3>
<p>Azure Storage backed a range of services — from SFTP and app data to file shares and diagnostics.</p>
<p>Replication strategies varied (LRS, RA-GRS, ZRS) with no consistent logic or documentation. Critical storage accounts weren’t aligned with workload tiering.</p>
<p>Some workloads used Azure Files and Azure File Sync, but without defined mount procedures or recovery checks.</p>
<p>In short: compute could come back, but data availability wasn’t assured.</p>
<hr />
<h3 id="5-the-networking-piece-and-why-it-matters-more-than-people-think"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#5-the-networking-piece-and-why-it-matters-more-than-people-think">🔌 5️⃣ The Networking Piece (And Why It Matters More Than People Think)</a></h3>
<p>NSGs, UDRs, custom routing, and SD-WAN all played a part in how traffic flowed.</p>
<p>But in DR, assumptions break quickly.</p>
<p>There was no documentation of network flow in the DR region, and no validation of inter-VM or service-to-service reachability post-failover.</p>
<p>Some services — like App Gateways, Internal Load Balancers, and Private Endpoints — were region-bound and would require re-deployment or manual intervention.</p>
<p>Networking wasn’t the background layer — it was core to recoverability.</p>
<hr />
<h3 id="6-capacity-risk-when-dr-isnt-guaranteed"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#6-capacity-risk-when-dr-isnt-guaranteed">📦 6️⃣ Capacity Risk: When DR Isn’t Guaranteed</a></h3>
<p>VM replication is only half the story. The other half is whether those VMs can actually start during a DR event.</p>
<p>Azure doesn’t guarantee regional capacity unless you've pre-purchased it.</p>
<p>In our case, <strong>no capacity reservations</strong> had been made. That meant no assurance that our Tier 0 or Tier 1 workloads could even boot if demand spiked during a region-wide outage.</p>
<p>This is a quiet but critical risk — and one worth addressing early.</p>
<hr />
<h3 id="conclusion-from-discovery-to-direction"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#conclusion-from-discovery-to-direction">✅ Conclusion: From Discovery to Direction</a></h3>
<p>This review wasn’t about proving whether DR was in place — it was about understanding whether it would actually work.</p>
<p>The tooling was present. The protection was partial. The process was missing.</p>
<p>By mapping out what was covered, where the gaps were, and how recovery would actually unfold, we created a baseline that gave us clarity and control.</p>
<hr />
<h3 id="coming-next-documenting-the-plan"><a class="toclink" href="../../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/#coming-next-documenting-the-plan">📘 Coming Next: Documenting the Plan</a></h3>
<p>In the next post, I’ll walk through how I formalised the review into a structured BCDR posture document — including:</p>
<ul>
<li>🧱 Mapping workloads by tier and impact  </li>
<li>⏳ Defining current vs target RTO/RPO  </li>
<li>🛠️ Highlighting gaps in automation, DNS, storage, and capacity  </li>
<li>🧭 Building a recovery plan roadmap  </li>
<li>⚖️ Framing cost vs risk for stakeholder alignment  </li>
</ul>
<p>If you're facing a similar situation — whether you're inheriting someone else's cloud estate or building DR into a growing environment — I hope this series helps bring structure to the complexity.</p>
<p>Let me know if you'd find it useful to share templates or walkthroughs in the next post.</p>
<hr />
<p><a class="md-button" href="https://x.com/intent/tweet?text=Azure%20BCDR%20Review%20%E2%80%93%20Turning%20Inherited%20Cloud%20Infrastructure%20into%20a%20Resilient%20Recovery%20Strategy%0A&amp;url=https://blog.pollockweb.com/blog/azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-08 00:00:00+00:00">May 8, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../bcdr/" class="md-meta__link">BCDR</a>, 
              <a href="../cloud-architecture/" class="md-meta__link">Cloud Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-bcdr-how-i-turned-a-dr-review-into-a-strategic-recovery-plan"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/">🧾 Azure BCDR – How I Turned a DR Review into a Strategic Recovery Plan</a></h2>
<p>In <a href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#">Part 1</a> of this series, I shared how we reviewed our Azure BCDR posture after inheriting a partially implemented cloud estate. The findings were clear: while the right tools were in place, the operational side of disaster recovery hadn’t been addressed.</p>
<p>There were no test failovers, no documented Recovery Plans, no automation, and several blind spots in DNS, storage, and private access.</p>
<p>This post outlines how I took that review and turned it into a practical recovery strategy — one that we could share internally, align with our CTO, and use as a foundation for further work with our support partner.</p>
<p>To provide context, our estate is deployed primarily in the <strong>UK South</strong> Azure region, with <strong>UK West</strong> serving as the designated DR target region.</p>
<p>It’s not a template — it’s a repeatable, real-world approach to structuring a BCDR plan when you’re starting from inherited infrastructure, not a clean slate.</p>
<hr />
<h3 id="1-why-documenting-the-plan-matters"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#1-why-documenting-the-plan-matters">🧭 1. Why Documenting the Plan Matters</a></h3>
<p>Most cloud teams can identify issues. Fewer take the time to formalise the findings in a way that supports action and alignment.</p>
<p>Documenting our BCDR posture gave us three things:</p>
<ul>
<li>🧠 Clarity — a shared understanding of what’s protected and what isn’t  </li>
<li>🔦 Visibility — a way to surface risk and prioritise fixes  </li>
<li>🎯 Direction — a set of realistic, cost-aware next steps  </li>
</ul>
<p>We weren’t trying to solve every problem at once. The goal was to define a usable plan we could act on, iterate, and eventually test — all while making sure that effort was focused on the right areas.</p>
<hr />
<h3 id="2-starting-the-document"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#2-starting-the-document">🧱 2. Starting the Document</a></h3>
<p>I structured the document to speak to both <strong>technical stakeholders</strong> and <strong>senior leadership</strong>. It needed to balance operational context with strategic risk.</p>
<h4 id="core-sections-included"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#core-sections-included">✍️ Core sections included</a></h4>
<ul>
<li><strong>Executive Summary</strong> – what the document is, why it matters  </li>
<li><strong>Maturity Snapshot</strong> – a simple traffic-light view of current vs target posture  </li>
<li><strong>Workload Overview</strong> – what’s in scope and what’s protected  </li>
<li><strong>Recovery Objectives</strong> – realistic RPO/RTO targets by tier  </li>
<li><strong>Gaps and Risks</strong> – the areas most likely to cause DR failure  </li>
<li><strong>Recommendations</strong> – prioritised, actionable, and cost-aware  </li>
<li><strong>Next Steps</strong> – what we can handle internally, and what goes to the MSP</li>
</ul>
<p>Each section followed the same principle: clear, honest, and focused on action. No fluff, no overstatements — just a straightforward review of where we stood and what needed doing.</p>
<hr />
<h3 id="3-defining-the-current-state"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#3-defining-the-current-state">🧩 3. Defining the Current State</a></h3>
<p>Before we could plan improvements, we had to document what actually existed. This wasn’t about assumptions — it was about capturing the <strong>real configuration and coverage</strong> in Azure.</p>
<h4 id="workload-inventory"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#workload-inventory">🗂️ Workload Inventory</a></h4>
<p>We started by categorising all VMs and services:</p>
<ul>
<li>Domain controllers</li>
<li>Application servers (web/API/backend)</li>
<li>SQL Managed Instances</li>
<li>Infrastructure services (file, render, schedulers)</li>
<li>Management and monitoring VMs</li>
</ul>
<p>Each workload was mapped by <strong>criticality</strong> and <strong>recovery priority</strong> — not just by type.</p>
<h4 id="protection-levels"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#protection-levels">🛡️ Protection Levels</a></h4>
<p>For each workload, we recorded:</p>
<ul>
<li>✅ Whether it was protected by ASR</li>
<li>🔁 Whether it was backed up only</li>
<li>🚫 Whether it had no protection (with justification)</li>
</ul>
<p>We also reviewed the <strong>geographic layout</strong> — e.g. which services were replicated into UK West, and which existed only in UK South.</p>
<h4 id="supporting-services"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#supporting-services">🧠 Supporting Services</a></h4>
<p>Beyond the VMs, we looked at:</p>
<ul>
<li>Identity services (AD, domain controllers, replication health)</li>
<li>DNS architecture (AD-integrated zones, private DNS zones)</li>
<li>Private Endpoints and their region-specific availability</li>
<li>Storage account replication types (LRS, RA-GRS, ZRS)</li>
<li>Network security and routing configurations in DR</li>
</ul>
<p>The aim wasn’t to build a full asset inventory — just to gather enough visibility to start making risk-based decisions about what mattered, and what was missing.</p>
<hr />
<h3 id="4-setting-recovery-objectives"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#4-setting-recovery-objectives">⏱️ 4. Setting Recovery Objectives</a></h3>
<p>Once the current state was mapped, the next step was to define what “recovery” should actually look like — in terms that could be communicated, challenged, and agreed.</p>
<p>We focused on two key metrics:</p>
<ul>
<li><strong>RTO</strong> (Recovery Time Objective): How long can this system be offline before we see significant operational impact?</li>
<li><strong>RPO</strong> (Recovery Point Objective): How much data loss is acceptable in a worst-case failover?</li>
</ul>
<p>These weren’t guessed or copied from a template. We worked with realistic assumptions based on our tooling, team capability, and criticality of the services.</p>
<h4 id="tiered-recovery-model"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#tiered-recovery-model">📊 Tiered Recovery Model</a></h4>
<p>Each workload was assigned to one of four tiers:</p>
<table>
<thead>
<tr>
<th>Tier</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tier 0</td>
<td>Core infrastructure (identity, DNS, routing)</td>
</tr>
<tr>
<td>Tier 1</td>
<td>Mission-critical production workloads</td>
</tr>
<tr>
<td>Tier 2</td>
<td>Important, but not time-sensitive services</td>
</tr>
<tr>
<td>SQL MI</td>
<td>Treated separately due to its PaaS nature</td>
</tr>
</tbody>
</table>
<p>We then applied RTO and RPO targets based on what we could achieve today vs what we aim to reach with improvements.</p>
<h4 id="heatmap-example"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#heatmap-example">🔥 Heatmap Example</a></h4>
<table>
<thead>
<tr>
<th>Workload Tier</th>
<th>RPO (Current)</th>
<th>RTO (Current)</th>
<th>RPO (Optimised)</th>
<th>RTO (Optimised)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tier 0 – Identity</td>
<td>5 min</td>
<td>60 min</td>
<td>5 min</td>
<td>30 min</td>
</tr>
<tr>
<td>Tier 1 – Prod</td>
<td>5 min</td>
<td>360 min</td>
<td>5 min</td>
<td>60 min</td>
</tr>
<tr>
<td>Tier 2 – Non-Crit</td>
<td>1440 min</td>
<td>1440 min</td>
<td>60 min</td>
<td>240 min</td>
</tr>
<tr>
<td>SQL MI</td>
<td>0 min</td>
<td>60 min</td>
<td>0 min</td>
<td>30 min</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="5-highlighting-gaps-and-risks"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#5-highlighting-gaps-and-risks">🚧 5. Highlighting Gaps and Risks</a></h3>
<p>With recovery objectives defined, the gaps became much easier to identify — and to prioritise.</p>
<p>We weren’t trying to protect everything equally. The goal was to focus attention on the areas that introduced the <strong>highest risk to recovery</strong> if left unresolved.</p>
<h4 id="what-we-flagged"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#what-we-flagged">⚠️ What We Flagged</a></h4>
<ul>
<li>❌ No test failovers had ever been performed  </li>
<li>❌ No Recovery Plans existed  </li>
<li>🌐 Public-facing infrastructure only existed in one region  </li>
<li>🔒 Private Endpoints lacked DR equivalents  </li>
<li>🧭 DNS failover was manual or undefined  </li>
<li>💾 Storage accounts had inconsistent replication logic  </li>
<li>🚫 No capacity reservations existed for critical VM SKUs  </li>
</ul>
<p>Each gap was documented with its impact, priority, and remediation options.</p>
<hr />
<h3 id="6-strategic-recommendations"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#6-strategic-recommendations">🛠️ 6. Strategic Recommendations</a></h3>
<p>We split our recommendations into what we could handle internally, and what would require input from our MSP or further investment.</p>
<h4 id="internal-actions"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#internal-actions">📌 Internal Actions</a></h4>
<ul>
<li>Build and test Recovery Plans for Tier 0 and Tier 1 workloads  </li>
<li>Improve DNS failover scripting  </li>
<li>Review VM tags to reflect criticality and protection state  </li>
<li>Create sequencing logic for application groups  </li>
<li>Align NSGs and UDRs in DR with production  </li>
</ul>
<h4 id="msp-led-or-partner-support"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#msp-led-or-partner-support">🤝 MSP-Led or Partner Support</a></h4>
<ul>
<li>Duplicate App Gateways / ILBs in UK West  </li>
<li>Implement Private DNS Zones  </li>
<li>Review and implement capacity reservations  </li>
<li>Test runbook-driven recovery automation  </li>
<li>Conduct structured test failovers across service groups  </li>
</ul>
<hr />
<h3 id="7-making-it-actionable"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#7-making-it-actionable">📅 7. Making It Actionable</a></h3>
<p>A plan needs ownership and timelines. We assigned tasks by role and defined short-, medium-, and long-term priorities using a simple planning table.</p>
<p>We treat the BCDR document as a <strong>living artefact</strong> — updated quarterly, tied to change control, and used to guide internal work and partner collaboration.</p>
<hr />
<h3 id="8-closing-reflections"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#8-closing-reflections">🔚 8. Closing Reflections</a></h3>
<p>The original goal wasn’t to build a perfect DR solution — it was to understand where we stood, make recovery realistic, and document a plan that would hold up when we needed it most.</p>
<p>We inherited a functional technical foundation — but needed to formalise and validate it as part of a resilient DR posture.</p>
<p>By documenting the estate, defining recovery objectives, and identifying where the real risks were, we turned a passive DR posture into something we could act on. We gave stakeholders clarity. We gave the support partner direction. And we gave ourselves a roadmap.</p>
<hr />
<h3 id="whats-next"><a class="toclink" href="../../azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/#whats-next">🔜 What’s Next</a></h3>
<p>In the next part of this series, I’ll walk through how we executed the plan:</p>
<ul>
<li>Building and testing our first Recovery Plan  </li>
<li>Improving ASR coverage and validation  </li>
<li>Running our first failover drill  </li>
<li>Reviewing results and updating the heatmap  </li>
</ul>
<hr />
<p>If you're stepping into an inherited cloud environment or starting your first structured DR review, I hope this gives you a practical view of what’s involved — and what’s achievable without overcomplicating the process.</p>
<p>Let me know if you'd like to see templates or report structures from this process in a future post.</p>
<hr />
<p><a class="md-button" href="https://x.com/intent/tweet?text=Azure%20BCDR%20%E2%80%93%20How%20I%20Turned%20a%20DR%20Review%20into%20a%20Strategic%20Recovery%20Plan%0A&amp;url=https://blog.pollockweb.com/blog/azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/azure-bcdr--how-i-turned-a-dr-review-into-a-strategic-recovery-plan/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-04-22 00:00:00+00:00">April 22, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../automation/" class="md-meta__link">Automation</a>, 
              <a href="../finops/" class="md-meta__link">FinOps</a>, 
              <a href="../powershell/" class="md-meta__link">PowerShell</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks</a></h2>
<p>As part of my ongoing commitment to FinOps practices, I've implemented several strategies to embed cost-efficiency into the way we manage cloud infrastructure. One proven tactic is scheduling virtual machines to shut down during idle periods, avoiding unnecessary spend.</p>
<p>In this post, I’ll share how I’ve built out <strong>custom Azure Automation jobs</strong> to schedule VM start and stop operations. Rather than relying on Microsoft’s pre-packaged solution, I’ve developed a <strong>streamlined, purpose-built PowerShell implementation</strong> that provides maximum flexibility, transparency, and control.</p>
<hr />
<h3 id="why-i-chose-custom-runbooks-over-the-prebuilt-solution"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#why-i-chose-custom-runbooks-over-the-prebuilt-solution">✍️ Why I Chose Custom Runbooks Over the Prebuilt Solution</a></h3>
<p>Microsoft provides a ready-made “Start/Stop VMs during off-hours” solution via the Automation gallery. While functional, it’s:</p>
<ul>
<li>A bit over-engineered for simple needs,</li>
<li>Relatively opaque under the hood, and</li>
<li>Not ideal for environments where control and transparency are priorities.</li>
</ul>
<p>My custom jobs:</p>
<ul>
<li>Use native PowerShell modules within Azure Automation,</li>
<li>Are scoped to exactly the VMs I want via <strong>tags</strong>,</li>
<li>Provide clean logging and alerting, and</li>
<li>Keep things simple, predictable, and auditable.</li>
</ul>
<hr />
<h3 id="step-1-set-up-the-azure-automation-account"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-1-set-up-the-azure-automation-account">🛠️ Step 1: Set Up the Azure Automation Account</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account">Official docs: Create and manage an Azure Automation Account</a></p>
</blockquote>
<ol>
<li>Go to the <strong>Azure Portal</strong> and search for <strong>Automation Accounts</strong>.</li>
<li>Click <strong>+ Create</strong>.</li>
<li>Fill out the basics:</li>
<li><strong>Name</strong>: e.g. <code>vm-scheduler</code></li>
<li><strong>Resource Group</strong>: Create new or select existing</li>
<li><strong>Region</strong>: Preferably where your VMs are located</li>
<li>Enable <strong>System-Assigned Managed Identity</strong></li>
<li>Once created, go to the Automation Account and ensure the following modules are imported using the <strong>Modules</strong> blade in the Azure Portal:</li>
<li><code>Az.Accounts</code></li>
<li><code>Az.Compute</code></li>
</ol>
<blockquote>
<p>✅ Tip: These modules can be added from the gallery in just a few clicks via the UI—no scripting required.</p>
<p>💡 Prefer scripting? You can also install them using PowerShell:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="n">Accounts</span> <span class="n">-Force</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="n">Compute</span> <span class="n">-Force</span>
</span></code></pre></div>
</blockquote>
<ol>
<li>Assign the <strong>Virtual Machine Contributor</strong> role to the Automation Account's managed identity at the resource group or subscription level.</li>
</ol>
<h4 id="cli-or-powershell-alternatives"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#cli-or-powershell-alternatives">⚙️ CLI or PowerShell alternatives</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Azure CLI example to create the automation account</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>az<span class="w"> </span>automation<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span>--name<span class="w"> </span>vm-scheduler<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>--resource-group<span class="w"> </span>MyResourceGroup<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span>--location<span class="w"> </span>uksouth<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span>--assign-identity
</span></code></pre></div>
<hr />
<h3 id="step-2-add-vm-tags-for-scheduling"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-2-add-vm-tags-for-scheduling">📅 Step 2: Add VM Tags for Scheduling</a></h3>
<p>Apply consistent tags to any VM you want the runbooks to manage.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AutoStartStop</code></td>
<td><code>devserver</code></td>
</tr>
</tbody>
</table>
<p>You can use the Azure Portal or PowerShell to apply these tags.</p>
<h4 id="tag-vms-via-powershell"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#tag-vms-via-powershell">⚙️ Tag VMs via PowerShell</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;MyRG&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;myVM&quot;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;AutoStartStop&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s2">&quot;devserver&quot;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;MyRG&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="step-3-create-the-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-3-create-the-runbooks">📂 Step 3: Create the Runbooks</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-runbook-create">Official docs: Create a runbook in Azure Automation</a></p>
</blockquote>
<h4 id="create-a-new-runbook"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#create-a-new-runbook">▶️ Create a New Runbook</a></h4>
<ol>
<li>In your Automation Account, go to <strong>Process Automation</strong> &gt; <strong>Runbooks</strong>.</li>
<li>Click <strong>+ Create a runbook</strong>.</li>
<li>Name it something like <code>Stop-TaggedVMs</code>.</li>
<li>Choose <strong>PowerShell</strong> as the type.</li>
<li>Paste in the code below (repeat this process for the start runbook later).</li>
</ol>
<h4 id="runbook-code-auto-stop-based-on-tags"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#runbook-code-auto-stop-based-on-tags">🔹 Runbook Code: Auto-Stop Based on Tags</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">Param</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="p">(</span>    
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)][</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="no">[String]</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="nv">$AzureVMName</span> <span class="p">=</span> <span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)][</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="no">[String]</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="nv">$AzureSubscriptionID</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-subscription-id&gt;&quot;</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="p">)</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="s2">&quot;Logging in to Azure...&quot;</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="c"># Authenticate using the system-assigned managed identity of the Automation Account</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="nb">Connect-AzAccount</span> <span class="n">-Identity</span> <span class="n">-AccountId</span> <span class="s2">&quot;&lt;managed-identity-client-id&gt;&quot;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="nb">Write-Error</span> <span class="n">-Message</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="k">throw</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="p">}</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="nv">$TagName</span>  <span class="p">=</span> <span class="s2">&quot;AutoStartStop&quot;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="nv">$TagValue</span> <span class="p">=</span> <span class="s2">&quot;devserver&quot;</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="nb">Set-AzContext</span> <span class="n">-Subscription</span> <span class="nv">$AzureSubscriptionID</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$AzureVMName</span> <span class="o">-ne</span> <span class="s2">&quot;All&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>    <span class="nv">$VMs</span> <span class="p">=</span> <span class="nb">Get-AzResource</span> <span class="n">-TagName</span> <span class="nv">$TagName</span> <span class="n">-TagValue</span> <span class="nv">$TagValue</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="nv">$_</span><span class="p">.</span><span class="n">ResourceType</span> <span class="o">-like</span> <span class="s1">&#39;Microsoft.Compute/virtualMachines&#39;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="nv">$AzureVMName</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>    <span class="p">}</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>    <span class="nv">$VMs</span> <span class="p">=</span> <span class="nb">Get-AzResource</span> <span class="n">-TagName</span> <span class="nv">$TagName</span> <span class="n">-TagValue</span> <span class="nv">$TagValue</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="nv">$_</span><span class="p">.</span><span class="n">ResourceType</span> <span class="o">-like</span> <span class="s1">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>    <span class="p">}</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="p">}</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$VM</span> <span class="k">in</span> <span class="nv">$VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>    <span class="nb">Stop-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Name</span> <span class="n">-Verbose</span> <span class="n">-Force</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount">Docs: Connect-AzAccount with Managed Identity</a></p>
</blockquote>
<h4 id="create-the-start-runbook"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#create-the-start-runbook">🔹 Create the Start Runbook</a></h4>
<p>Duplicate the above, replacing <code>Stop-AzVM</code> with <code>Start-AzVM</code>.</p>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/start-azvm">Docs: Start-AzVM</a></p>
</blockquote>
<hr />
<h3 id="step-4-create-and-link-schedules"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-4-create-and-link-schedules">⏰ Step 4: Create and Link Schedules</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-schedules">Docs: Create schedules in Azure Automation</a></p>
</blockquote>
<ol>
<li>Go to the Automation Account &gt; <strong>Schedules</strong> &gt; <strong>+ Add a schedule</strong>.</li>
<li>Create two schedules:</li>
<li><code>DailyStartWeekdays</code> — Recurs every weekday at 07:30</li>
<li><code>DailyStopWeekdays</code> — Recurs every weekday at 18:30</li>
<li>Go to each runbook &gt; <strong>Link to schedule</strong> &gt; Choose the matching schedule.</li>
</ol>
<blockquote>
<p>📊 You can get creative here: separate schedules for dev vs UAT, or different times for different departments.</p>
</blockquote>
<hr />
<h3 id="testing-your-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#testing-your-runbooks">🧪 Testing Your Runbooks</a></h3>
<p>You can test each runbook directly in the portal:</p>
<ul>
<li>Open the runbook</li>
<li>Click <strong>Edit</strong> &gt; <strong>Test Pane</strong></li>
<li>Provide test parameters if needed</li>
<li>Click <strong>Start</strong> and monitor output</li>
</ul>
<p>This is also a good time to validate:</p>
<ul>
<li>The identity has permission</li>
<li>The tags are applied correctly</li>
<li>The VMs are in a stopped or running state as expected</li>
</ul>
<hr />
<h3 id="the-results"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#the-results">📊 The Results</a></h3>
<p>Even this lightweight automation has produced major savings in our environment. Non-prod VMs are now automatically turned off outside office hours, resulting in monthly compute savings of up to <strong>60%</strong> without sacrificing availability during working hours.</p>
<hr />
<h3 id="ideas-for-further-enhancement"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#ideas-for-further-enhancement">🧠 Ideas for Further Enhancement</a></h3>
<ul>
<li>Pull tag values from a central config (e.g. Key Vault or Storage Table)</li>
<li>Add logic to check for active RDP sessions or Azure Monitor heartbeats</li>
<li>Alert via email or Teams on job success/failure</li>
<li>Track savings over time and visualize them</li>
</ul>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#final-thoughts">💭 Final Thoughts</a></h3>
<p>If you’re looking for a practical, immediate way to implement FinOps principles in Azure, VM scheduling is a great place to start. With minimal setup and maximum flexibility, custom runbooks give you control without the complexity of the canned solutions.</p>
<p>Have you built something similar or extended this idea further? I’d love to hear about it—drop me a comment or reach out on LinkedIn.</p>
<p>Stay tuned for more FinOps tips coming soon!</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Saving%20Azure%20Costs%20with%20Scheduled%20VM%20Start/Stop%20using%20Custom%20Azure%20Automation%20Runbooks%0A&amp;url=https://blog.pollockweb.com/blog/saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-28 00:00:00+00:00">March 28, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../storage/" class="md-meta__link">Storage</a>, 
              <a href="../identity/" class="md-meta__link">Identity</a>, 
              <a href="../automation/" class="md-meta__link">Automation</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">🕵️ Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads</a></h2>
<p>Using Shared Access Signature (SAS) tokens with <code>azcopy</code> is common — but rotating tokens and handling them securely can be a hassle. To improve security and simplify our automation, I recently replaced SAS-based authentication in our scheduled AzCopy jobs with <strong>Azure User Assigned Managed Identity (UAMI)</strong>.</p>
<p>In this post, I’ll walk through how to:</p>
<ul>
<li>Replace AzCopy SAS tokens with managed identity authentication</li>
<li>Assign the right roles to the UAMI</li>
<li>Use <code>azcopy login</code> to authenticate non-interactively</li>
<li>Automate the whole process in PowerShell</li>
</ul>
<hr />
<h3 id="why-remove-sas-tokens"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#why-remove-sas-tokens">🔍 Why Remove SAS Tokens?</a></h3>
<p>SAS tokens are useful, but:</p>
<ul>
<li>🔑 They’re still secrets — and secrets can be leaked</li>
<li>📅 They expire — which breaks automation when not rotated</li>
<li>🔐 They grant broad access — unless scoped very carefully</li>
</ul>
<p>Managed Identity is a much better approach when the copy job is running from within Azure (like an Azure VM or Automation account).</p>
<hr />
<h3 id="project-goal"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#project-goal">🌟 Project Goal</a></h3>
<blockquote>
<p>Replace the use of SAS tokens in an AzCopy job that uploads files from a local UNC share to Azure Blob Storage — by using a <strong>User Assigned Managed Identity</strong>.</p>
</blockquote>
<hr />
<h3 id="prerequisites"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#prerequisites">✅ Prerequisites</a></h3>
<p>To follow along, you’ll need:</p>
<ul>
<li>A <strong>User Assigned Managed Identity</strong> (UAMI)</li>
<li>A <strong>Windows Server or Azure VM</strong> to run the copy job</li>
<li>Access to a <strong>local source folder or UNC share</strong> (e.g., <code>\\fileserver\\data\\export\\</code>)</li>
<li><strong>AzCopy v10.7+</strong> installed on the machine</li>
<li>Azure RBAC permissions to assign roles</li>
</ul>
<blockquote>
<p>ℹ️ <strong>Check AzCopy Version:</strong>
Run <code>azcopy --version</code> to ensure you're using <strong>v10.7.0 or later</strong>, which is required for <code>--identity-client-id</code> support.</p>
</blockquote>
<hr />
<h3 id="step-by-step-setup"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-by-step-setup">🔧 Step-by-Step Setup</a></h3>
<h4 id="step-1-create-the-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-1-create-the-uami">🛠️ Step 1: Create the UAMI</a></h4>
<h5 id="cli"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>az<span class="w"> </span>identity<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span>--name<span class="w"> </span>my-azcopy-uami<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-resource-group<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span>--location<span class="w"> </span>&lt;region&gt;
</span></code></pre></div>
<h5 id="portal"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal">✅ Portal</a></h5>
<ol>
<li>Go to <strong>Managed Identities</strong> in the Azure Portal</li>
<li>Click <strong>+ Create</strong> and follow the wizard</li>
</ol>
<hr />
<h4 id="step-2-assign-the-uami-to-the-azure-vm"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-2-assign-the-uami-to-the-azure-vm">🖇️ Step 2: Assign the UAMI to the Azure VM</a></h4>
<p>AzCopy running on a VM must be able to assume the identity. Assign the UAMI to your VM:</p>
<h5 id="cli_1"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli_1">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>az<span class="w"> </span>vm<span class="w"> </span>identity<span class="w"> </span>assign<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span>--name<span class="w"> </span>my-vm-name<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-resource-group<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span>--identities<span class="w"> </span>my-azcopy-uami
</span></code></pre></div>
<h5 id="portal_1"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal_1">✅ Portal</a></h5>
<ol>
<li>Navigate to the <strong>Virtual Machines</strong> blade</li>
<li>Select the VM running your AzCopy script</li>
<li>Under <strong>Settings</strong>, click <strong>Identity</strong></li>
<li>Go to the <strong>User assigned</strong> tab</li>
<li>Click <strong>+ Add</strong>, select your UAMI, then click <strong>Add</strong></li>
</ol>
<hr />
<h4 id="step-3-assign-rbac-permissions-to-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-3-assign-rbac-permissions-to-uami">🔐 Step 3: Assign RBAC Permissions to UAMI</a></h4>
<p>For AzCopy to function correctly with a UAMI, the following role assignments are recommended:</p>
<ul>
<li><strong>Storage Blob Data Contributor</strong>: Required for read/write blob operations</li>
<li><strong>Storage Blob Data Reader</strong>: (Optional) For read-only scenarios or validation scripts</li>
<li><strong>Reader</strong>: (Optional) For browsing or metadata-only permissions on the storage account</li>
</ul>
<blockquote>
<p>⏳ <strong>RBAC Tip</strong>: It may take up to 5 minutes for role assignments to propagate fully. If access fails initially, wait and retry.</p>
</blockquote>
<h5 id="cli_2"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli_2">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Storage Blob Data Contributor&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;/blobServices/default/containers/&lt;container-name&gt;&quot;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Storage Blob Data Reader&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;&quot;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Reader&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;&quot;</span>
</span></code></pre></div>
<h5 id="portal_2"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal_2">✅ Portal</a></h5>
<ol>
<li>Go to your <strong>Storage Account</strong> in the Azure Portal</li>
<li>Click on the relevant <strong>container</strong> (or stay at the account level for broader scope)</li>
<li>Open <strong>Access Control (IAM)</strong></li>
<li>Click <strong>+ Add role assignment</strong></li>
<li>Repeat this for each role:</li>
<li>Select <strong>Storage Blob Data Contributor</strong>, assign to your UAMI, and click <strong>Save</strong></li>
<li>Select <strong>Storage Blob Data Reader</strong>, assign to your UAMI, and click <strong>Save</strong></li>
<li>Select <strong>Reader</strong>, assign to your UAMI, and click <strong>Save</strong></li>
</ol>
<hr />
<h4 id="step-4-test-azcopy-login-using-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-4-test-azcopy-login-using-uami">🧪 Step 4: Test AzCopy Login Using UAMI</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nv">$clientId</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-uami-client-id&gt;&quot;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="n">login</span> <span class="p">-</span><span class="n">-identity</span> <span class="p">-</span><span class="n">-identity-client-id</span> <span class="nv">$clientId</span>
</span></code></pre></div>
<p>You should see a confirmation message that AzCopy has successfully logged in.</p>
<blockquote>
<p>🔍 To verify AzCopy is authenticated with the correct identity, you can run:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>azcopy env
</span></code></pre></div>
<p>This will show the login type and confirm whether the token is being sourced from the Managed Identity.</p>
</blockquote>
<hr />
<h4 id="step-5-upload-files-using-azcopy-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-5-upload-files-using-azcopy-uami">📁 Step 5: Upload Files Using AzCopy + UAMI</a></h4>
<p>Here's the PowerShell script that copies all files from a local share to the Blob container:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nv">$clientId</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-uami-client-id&gt;&quot;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c"># Login with Managed Identity</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="n">login</span> <span class="p">-</span><span class="n">-identity</span> <span class="p">-</span><span class="n">-identity-client-id</span> <span class="nv">$clientId</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c"># Run the copy job</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="nb">copy </span><span class="p">\</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  <span class="s2">&quot;\\\\fileserver\\data\\export\\&quot;</span> <span class="p">\</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>  <span class="s2">&quot;https://&lt;your-storage-account&gt;.blob.core.windows.net/&lt;container-name&gt;&quot;</span> <span class="p">\</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  <span class="p">-</span><span class="n">-overwrite</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>  <span class="p">-</span><span class="n">-from-to</span><span class="p">=</span><span class="n">LocalBlob</span> <span class="p">\</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>  <span class="p">-</span><span class="n">-blob-type</span><span class="p">=</span><span class="n">Detect</span> <span class="p">\</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>  <span class="p">-</span><span class="n">-put-md5</span> <span class="p">\</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>  <span class="p">-</span><span class="n">-recursive</span> <span class="p">\</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>  <span class="p">-</span><span class="n">-log-level</span><span class="p">=</span><span class="n">INFO</span>
</span></code></pre></div>
<blockquote>
<p>💡 <strong>UNC Note</strong>: Double backslashes are used in PowerShell to represent UNC paths properly.</p>
</blockquote>
<p>This script can be scheduled using Task Scheduler or run on demand.</p>
<hr />
<h4 id="automate-with-task-scheduler-optional"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#automate-with-task-scheduler-optional">⏱️ Automate with Task Scheduler (Optional)</a></h4>
<p>To automate the job:</p>
<ol>
<li>Open <strong>Task Scheduler</strong> on your VM</li>
<li>Create a <strong>New Task</strong> (not a Basic Task)</li>
<li>Under <strong>General</strong>, select "Run whether user is logged on or not"</li>
<li>Under <strong>Actions</strong>, add a new action to run <code>powershell.exe</code></li>
<li>Set the arguments to point to your <code>.ps1</code> script</li>
<li>Ensure the AzCopy path is hardcoded in your script</li>
</ol>
<hr />
<h4 id="troubleshooting-common-errors"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#troubleshooting-common-errors">🚑 Troubleshooting Common Errors</a></h4>
<h5 id="403-authorizationpermissionmismatch"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#403-authorizationpermissionmismatch">❌ 403 AuthorizationPermissionMismatch</a></h5>
<ul>
<li>Usually means the identity doesn’t have the correct role or the role hasn’t propagated yet</li>
<li>Double-check:</li>
<li>UAMI is assigned to the VM</li>
<li>UAMI has <code>Storage Blob Data Contributor</code> on the correct container</li>
<li>Wait 2–5 minutes and try again</li>
</ul>
<h5 id="azcopy-the-term-azcopy-is-not-recognized"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#azcopy-the-term-azcopy-is-not-recognized">❌ azcopy : The term 'azcopy' is not recognized</a></h5>
<ul>
<li>AzCopy is not in the system PATH</li>
<li>Solution: Use the full path to <code>azcopy.exe</code>, like <code>C:\azcopy\azcopy.exe</code></li>
</ul>
<hr />
<h3 id="benefits-of-switching-to-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#benefits-of-switching-to-uami">🛡️ Benefits of Switching to UAMI</a></h3>
<ul>
<li>✅ No secrets or keys stored on disk</li>
<li>✅ No manual token expiry issues</li>
<li>✅ Access controlled via Azure RBAC</li>
<li>✅ Easily scoped and auditable</li>
</ul>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#final-thoughts">🧼 Final Thoughts</a></h3>
<p>Replacing AzCopy SAS tokens with UAMI is one of those small wins that pays dividends over time. Once set up, it's secure, robust, and hands-off.</p>
<p>Let me know if you'd like a variant of this that works from Azure Automation or a hybrid worker!</p>
<hr />
<p><a class="md-button" href="https://x.com/intent/tweet?text=Replacing%20SAS%20Tokens%20with%20User%20Assigned%20Managed%20Identity%20%28UAMI%29%20in%20AzCopy%20for%20Blob%20Uploads%0A&amp;url=https://blog.pollockweb.com/blog/replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-27 00:00:00+00:00">March 27, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../sql/" class="md-meta__link">SQL</a>, 
              <a href="../security/" class="md-meta__link">Security</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/">Replacing SQL Credentials with User Assigned Managed Identity (UAMI) in Azure SQL Managed Instance</a></h2>
<p>Storing SQL usernames and passwords in application configuration files is still common practice — but it poses a significant security risk. As part of improving our cloud security posture, I recently completed a project to eliminate plain text credentials from our app connection strings by switching to <strong>Azure User Assigned Managed Identity (UAMI)</strong> authentication for our <strong>SQL Managed Instance</strong>.</p>
<p>In this post, I’ll walk through how to:</p>
<ul>
<li>Securely connect to Azure SQL Managed Instance without using usernames or passwords</li>
<li>Use a <strong>User Assigned Managed Identity (UAMI)</strong> for authentication</li>
<li>Test this connection using the new Go-based <code>sqlcmd</code> CLI</li>
<li>Update real application code to remove SQL credentials</li>
</ul>
<hr />
<h3 id="why-replace-sql-credentials"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#why-replace-sql-credentials">🔐 Why Replace SQL Credentials?</a></h3>
<p>Hardcoded SQL credentials come with several downsides:</p>
<ul>
<li><strong>Security risk</strong>: Stored secrets can be compromised if not properly secured</li>
<li><strong>Maintenance overhead</strong>: Rotating passwords across environments is cumbersome</li>
<li><strong>Audit concerns</strong>: Plain text credentials often trigger compliance red flags</li>
</ul>
<p>Azure Managed Identity solves this by providing a token-based, identity-first way to connect to services — no secrets required.</p>
<hr />
<h3 id="what-is-a-user-assigned-managed-identity"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#what-is-a-user-assigned-managed-identity">⚙️ What is a User Assigned Managed Identity?</a></h3>
<p>There are two types of Managed Identities in Azure:</p>
<ul>
<li><strong>System-assigned</strong>: Tied to the lifecycle of a specific resource (like a VM or App Service)</li>
<li><strong>User-assigned</strong>: Standalone identity that can be attached to one or more resources</li>
</ul>
<p>For this project, we used a <strong>User Assigned Managed Identity (UAMI)</strong> to allow our applications to authenticate against SQL without managing secrets.</p>
<hr />
<h3 id="project-objective"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#project-objective">🌟 Project Objective</a></h3>
<blockquote>
<p>Replace plain text SQL credentials in application connection strings with <strong>User Assigned Managed Identity (UAMI)</strong> for secure, best-practice authentication to Azure SQL Managed Instances.</p>
</blockquote>
<hr />
<h3 id="prerequisites"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#prerequisites">✅ Prerequisites</a></h3>
<p>To follow this guide, you’ll need:</p>
<ul>
<li>An <strong>Azure SQL Managed Instance</strong> with Microsoft Entra (AAD) authentication enabled</li>
<li>A <strong>User Assigned Managed Identity</strong> (UAMI)</li>
<li>An <strong>Azure VM or App Service</strong> to host your app (or test client)</li>
<li>The <strong>Go-based <code>sqlcmd</code> CLI</strong> installed<br />
  → <a href="https://learn.microsoft.com/sql/tools/sqlcmd-utility?view=sql-server-ver16">Install guide</a></li>
</ul>
<hr />
<h3 id="setting-up-the-user-assigned-managed-identity-uami"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#setting-up-the-user-assigned-managed-identity-uami">🔧 Setting Up the User Assigned Managed Identity (UAMI)</a></h3>
<p>Before connecting to Azure SQL using UAMI, ensure the following steps are completed:</p>
<ul>
<li>Create the UAMI</li>
<li>Assign the UAMI to the Virtual Machine(s)</li>
<li>Configure Microsoft Entra authentication on the SQL Managed Instance</li>
<li>Grant SQL access to the UAMI</li>
</ul>
<p>These steps can be completed via <strong>Azure CLI</strong>, <strong>PowerShell</strong>, or the <strong>Azure Portal</strong>.</p>
<hr />
<h4 id="step-1-create-the-user-assigned-managed-identity-uami"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-1-create-the-user-assigned-managed-identity-uami">🛠️ Step 1: Create the User Assigned Managed Identity (UAMI)</a></h4>
<h5 id="cli"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#cli">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>az<span class="w"> </span>identity<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span>--name<span class="w"> </span>my-sql-uami<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-rg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span>--location<span class="w"> </span>&lt;region&gt;
</span></code></pre></div>
<p>Save the <strong>Client ID</strong> and <strong>Object ID</strong> — you’ll need them later.</p>
<h5 id="portal"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#portal">✅ Portal</a></h5>
<ol>
<li>Go to <strong>Azure Portal</strong> → Search <strong>Managed Identities</strong></li>
<li>Click <strong>+ Create</strong></li>
<li>Choose Subscription, Resource Group, and Region</li>
<li>Name the identity (e.g., <code>my-sql-uami</code>)</li>
<li>Click <strong>Review + Create</strong></li>
</ol>
<hr />
<h4 id="step-2-assign-the-uami-to-a-virtual-machine"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-2-assign-the-uami-to-a-virtual-machine">🖇️ Step 2: Assign the UAMI to a Virtual Machine</a></h4>
<p>Attach the UAMI to:</p>
<ul>
<li>The VM(s) running your application code</li>
<li>The VM used to test the connection</li>
</ul>
<h5 id="cli_1"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#cli_1">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>az<span class="w"> </span>vm<span class="w"> </span>identity<span class="w"> </span>assign<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span>--name<span class="w"> </span>my-vm-name<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-rg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span>--identities<span class="w"> </span>my-sql-uami
</span></code></pre></div>
<h5 id="portal_1"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#portal_1">✅ Portal</a></h5>
<ol>
<li>Go to <strong>Virtual Machines</strong> → Select your VM</li>
<li>Click <strong>Identity</strong> under <strong>Settings</strong></li>
<li>Go to the <strong>User assigned</strong> tab</li>
<li>Click <strong>+ Add</strong> → Select the UAMI</li>
<li>Click <strong>Add</strong></li>
</ol>
<hr />
<h4 id="step-3-configure-sql-managed-instance-for-microsoft-entra-authentication"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-3-configure-sql-managed-instance-for-microsoft-entra-authentication">🔑 Step 3: Configure SQL Managed Instance for Microsoft Entra Authentication</a></h4>
<ol>
<li><strong>Set an Entra Admin</strong>:</li>
<li>Go to your SQL MI → <strong>Azure AD admin</strong> blade</li>
<li>Click <strong>Set admin</strong> and choose a user or group</li>
<li>
<p>Save changes</p>
</li>
<li>
<p><strong>Ensure Directory Reader permissions</strong>:</p>
</li>
<li>Your SQL MI’s managed identity needs <strong>Directory Reader</strong> access</li>
<li>You can assign this role via Entra ID &gt; Roles and administrators &gt; Directory Readers</li>
</ol>
<p>More details: <a href="https://learn.microsoft.com/azure/azure-sql/database/authentication-aad-configure">Configure Entra authentication</a></p>
<hr />
<h4 id="step-4-optional-assign-azure-role-to-the-uami"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-4-optional-assign-azure-role-to-the-uami">📜 Step 4: (Optional) Assign Azure Role to the UAMI</a></h4>
<blockquote>
<p>This may be needed if the identity needs to access Azure resource metadata or use Azure CLI from the VM.</p>
</blockquote>
<h5 id="cli_2"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#cli_2">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span>--assignee-object-id<span class="w"> </span>&lt;uami-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Reader&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span>--scope<span class="w"> </span>/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg-name&gt;
</span></code></pre></div>
<h5 id="portal_2"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#portal_2">✅ Portal</a></h5>
<ol>
<li>Go to the UAMI → <strong>Azure role assignments</strong></li>
<li>Click <strong>+ Add role assignment</strong></li>
<li>Choose role (e.g., Reader)</li>
<li>Set scope</li>
<li>Click <strong>Save</strong></li>
</ol>
<hr />
<h3 id="step-5-grant-sql-access-to-the-uami"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-5-grant-sql-access-to-the-uami">🔑 Step 5: Grant SQL Access to the UAMI</a></h3>
<p>Once the UAMI is assigned to the VM and Entra auth is enabled on SQL MI, log in with an admin and run:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;</span><span class="n">client</span><span class="o">-</span><span class="n">id</span><span class="o">&gt;</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="n">PROVIDER</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">db_datareader</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">MEMBER</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;</span><span class="n">client</span><span class="o">-</span><span class="n">id</span><span class="o">&gt;</span><span class="p">];</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">db_datawriter</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">MEMBER</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;</span><span class="n">client</span><span class="o">-</span><span class="n">id</span><span class="o">&gt;</span><span class="p">];</span>
</span></code></pre></div>
<p>Or use a friendly name:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="p">[</span><span class="n">my</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="k">identity</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="n">PROVIDER</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">db_datareader</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">MEMBER</span><span class="w"> </span><span class="p">[</span><span class="n">my</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="k">identity</span><span class="p">];</span>
</span></code></pre></div>
<hr />
<h3 id="step-6-test-the-connection-using-sqlcmd"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-6-test-the-connection-using-sqlcmd">🧪 Step 6: Test the Connection Using <code>sqlcmd</code></a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>sqlcmd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span>-S<span class="w"> </span>&lt;your-sql-mi&gt;.database.windows.net<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span>-d<span class="w"> </span>&lt;database-name&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span>--authentication-method<span class="w"> </span>ActiveDirectoryManagedIdentity<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span>-U<span class="w"> </span>&lt;client-id-of-uami&gt;
</span></code></pre></div>
<p>If successful, you’ll see the <code>1&gt;</code> prompt where you can execute SQL queries.</p>
<hr />
<h3 id="step-7-update-application-code"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#step-7-update-application-code">📊 Step 7: Update Application Code</a></h3>
<p>Update your app to use the UAMI for authentication.</p>
<p>Example connection string for UAMI in C#:</p>
<div class="language-csharp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">string</span><span class="w"> </span><span class="n">connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">@&quot;Server=tcp:&lt;your-sql-mi&gt;.database.windows.net;&quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">                          </span><span class="s">&quot;Authentication=Active Directory Managed Identity;&quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">                          </span><span class="s">&quot;Encrypt=True;&quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">                          </span><span class="s">&quot;User Id=&lt;your-uami-client-id&gt;;&quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">                          </span><span class="s">&quot;Database=&lt;your-db-name&gt;;&quot;</span><span class="p">;</span>
</span></code></pre></div>
<blockquote>
<p>Make sure your code uses <code>Microsoft.Data.SqlClient</code> with AAD token support.</p>
</blockquote>
<p>Or retrieve and assign the token programmatically:</p>
<div class="language-csharp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">var</span><span class="w"> </span><span class="n">credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultAzureCredential</span><span class="p">();</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kt">var</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">credential</span><span class="p">.</span><span class="n">GetTokenAsync</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TokenRequestContext</span><span class="p">(</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="k">new</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;https://database.windows.net/&quot;</span><span class="w"> </span><span class="p">}));</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kt">var</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SqlConnection</span><span class="p">(</span><span class="s">&quot;Server=&lt;your-sql-mi&gt;; Database=&lt;your-db-name&gt;; Encrypt=True;&quot;</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">connection</span><span class="p">.</span><span class="n">AccessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>
</span></code></pre></div>
<hr />
<h3 id="security-benefits"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#security-benefits">🔒 Security Benefits</a></h3>
<ul>
<li>🔐 No credentials stored</li>
<li>🔁 No password rotation</li>
<li>🛡️ Entra-integrated access control and auditing</li>
</ul>
<hr />
<h3 id="summary"><a class="toclink" href="../../replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/#summary">✅ Summary</a></h3>
<p>By switching to User Assigned Managed Identity, we removed credentials from connection strings and aligned SQL access with best practices for cloud identity and security.</p>
<p>Comments and feedback welcome!</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Replacing%20SQL%20Credentials%20with%20User%20Assigned%20Managed%20Identity%20%28UAMI%29%20in%20Azure%20SQL%20Managed%20Instance%0A&amp;url=https://blog.pollockweb.com/blog/replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/replacing-sql-credentials-with-user-assigned-managed-identity-uami-in-azure-sql-managed-instance/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-12 00:00:00+00:00">March 12, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Azure</a>, 
              <a href="../iis/" class="md-meta__link">IIS</a>, 
              <a href="../application-insights/" class="md-meta__link">Application Insights</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="monitoring-an-iis-based-web-farm-with-azure-application-insights"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/">📊 Monitoring an IIS-Based Web Farm with Azure Application Insights</a></h2>
<p>In this guide, you'll learn how to:</p>
<p>✅ Set up <strong>Application Insights</strong> on an IIS-based web farm.<br />
✅ Configure <strong>Log Analytics</strong>, <strong>Data Collection Rules</strong>, and <strong>Data Collection Endpoints</strong>.<br />
✅ Use <strong>PowerShell</strong> to install the Application Insights agent.<br />
✅ Monitor <strong>live metrics, failures, performance, and logs</strong> in real-time.  </p>
<p>By the end, you'll have a <strong>fully monitored</strong> IIS-based web farm using Azure! 🎯</p>
<hr />
<h3 id="step-1-enabling-application-insights-on-iis-servers"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#step-1-enabling-application-insights-on-iis-servers">🏗️ <strong>Step 1: Enabling Application Insights on IIS Servers</strong></a></h3>
<p>To effectively monitor your IIS-based application, you need to configure Azure Application Insights and ensure all required components are installed on your Azure VMs.</p>
<h4 id="prerequisites"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#prerequisites">🛠️ <strong>Prerequisites</strong></a></h4>
<p>Before proceeding, ensure you have:</p>
<ul>
<li><strong>An active Azure Subscription</strong> with permissions to create and manage resources.</li>
<li><strong>A Log Analytics Workspace (LAW)</strong> to store collected telemetry data.</li>
<li><strong>Azure Monitor Agent (AMA)</strong> installed on your IIS VMs.</li>
<li><strong>Necessary permissions</strong> to create Data Collection Rules (DCRs) and Data Collection Endpoints (DCEs).</li>
</ul>
<h4 id="create-a-log-analytics-workspace"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#create-a-log-analytics-workspace"><strong>Create a Log Analytics Workspace</strong></a></h4>
<ol>
<li>Go to <strong>Azure Portal</strong> → <strong>Search for "Log Analytics Workspaces"</strong> → <strong>Create</strong>.</li>
<li>Provide the following details:</li>
<li><strong>Subscription</strong>: Select your Azure subscription.</li>
<li><strong>Resource Group</strong>: Choose or create a new one.</li>
<li><strong>Name</strong>: Enter a unique name (e.g., <code>log-corpapp-prod-uksouth</code>).</li>
<li><strong>Region</strong>: Same as your IIS VMs.</li>
<li><strong>Click "Review + Create"</strong> and deploy the workspace.</li>
</ol>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-workspace-overview">Microsoft Learn: Log Analytics Workspace</a></p>
<h4 id="create-a-data-collection-endpoint-dce"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#create-a-data-collection-endpoint-dce"><strong>Create a Data Collection Endpoint (DCE)</strong></a></h4>
<ol>
<li>Navigate to <strong>Monitor</strong> → <strong>Data Collection Endpoints</strong>.</li>
<li>Click <strong>"+ Create"</strong> and provide:</li>
<li><strong>Name</strong>: e.g., <code>dce-corpapp-prod-uksouth</code>.</li>
<li><strong>Subscription &amp; Resource Group</strong>: Same as your IIS VMs.</li>
<li><strong>Region</strong>: Same as Log Analytics Workspace.</li>
<li><strong>Review &amp; create the endpoint</strong>.</li>
</ol>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-endpoint-overview">Microsoft Learn: Data Collection Endpoints</a></p>
<h4 id="create-a-data-collection-rule-dcr"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#create-a-data-collection-rule-dcr"><strong>Create a Data Collection Rule (DCR)</strong></a></h4>
<ol>
<li>Go to <strong>Monitor</strong> → <strong>Data Collection Rules</strong> → <strong>+ Create</strong>.</li>
<li>Configure:</li>
<li><strong>Name</strong>: <code>dcr-corpapp-iis-prod-uksouth</code></li>
<li><strong>Subscription &amp; Resource Group</strong>: Same as above.</li>
<li><strong>Region</strong>: Same as DCE &amp; LAW.</li>
<li><strong>Define data sources</strong>:</li>
<li><strong>Windows Event Logs</strong>: Add <code>System</code>, <code>Application</code>, etc.</li>
<li><strong>Log Levels</strong>: Select relevant levels (Error, Warning, Information).</li>
<li><strong>Set Destination</strong>:</li>
<li>Choose <strong>"Log Analytics Workspace"</strong> → Select the previously created workspace.</li>
<li><strong>Associate with IIS VMs</strong> (<code>WEB01</code> - <code>WEB05</code>).</li>
<li><strong>Review &amp; Create the rule</strong>.</li>
</ol>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-overview">Microsoft Learn: Data Collection Rules</a></p>
<h4 id="install-the-azure-monitor-agent-ama"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#install-the-azure-monitor-agent-ama"><strong>Install the Azure Monitor Agent (AMA)</strong></a></h4>
<ol>
<li>Navigate to each IIS VM.</li>
<li>Under <strong>"Monitoring"</strong>, select <strong>"Extensions"</strong>.</li>
<li>Click <strong>"+ Add"</strong> → <strong>AzureMonitorWindowsAgent</strong> → Install.</li>
<li>Repeat for all IIS VMs.</li>
</ol>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-overview">Microsoft Learn: Azure Monitor Agent</a></p>
<h4 id="enable-application-insights"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#enable-application-insights"><strong>Enable Application Insights</strong></a></h4>
<ol>
<li>Navigate to <strong>Azure Portal</strong> → <strong>Search for "Application Insights"</strong>.</li>
<li>Click <strong>"+ Create"</strong> → Provide:</li>
<li><strong>Subscription &amp; Resource Group</strong>: Same as VMs.</li>
<li><strong>Name</strong>: <code>insights-corpapp-prod-uksouth-001</code>.</li>
<li><strong>Region</strong>: Same as your IIS VMs.</li>
<li><strong>Application Type</strong>: <strong>ASP.NET Web Application</strong>.</li>
<li><strong>Click "Review + Create"</strong> and deploy.</li>
</ol>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/app/asp-net">Microsoft Learn: Enable Application Insights</a></p>
<h4 id="install-the-application-insights-agent"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#install-the-application-insights-agent"><strong>Install the Application Insights Agent</strong></a></h4>
<p>Use the following <strong>PowerShell script</strong> to install the agent on all of the IIS servers:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c"># Install the Application Insights Agent</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">$instrumentationKey</span> <span class="p">=</span> <span class="s2">&quot;YOUR-INSTRUMENTATION-KEY&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nb">Install-PackageProvider</span> <span class="n">-Name</span> <span class="n">NuGet</span> <span class="n">-Force</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">ApplicationInsightsWebTracking</span> <span class="n">-Force</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nb">Enable-ApplicationInsightsMonitoring</span> <span class="n">-InstrumentationKey</span> <span class="nv">$instrumentationKey</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="nb">Restart-Service</span> <span class="n">W3SVC</span>
</span></code></pre></div>
<hr />
<h3 id="step-2-using-application-insights-for-monitoring"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#step-2-using-application-insights-for-monitoring">📊 <strong>Step 2: Using Application Insights for Monitoring</strong></a></h3>
<p>With everything set up, it's time to <strong>monitor and analyze</strong> application performance! 🔍</p>
<h4 id="overview-dashboard"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#overview-dashboard"><strong>📌 Overview Dashboard</strong></a></h4>
<ul>
<li>Displays high-level <strong>health metrics</strong>, failed requests, and response times.
📸 <strong><img alt="Insights Overview" src="../../azure-posts/app-insights/BO_Insights_Overview.png" /></strong></li>
</ul>
<h4 id="application-map"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#application-map"><strong>📌 Application Map</strong></a></h4>
<ul>
<li>Shows <strong>dependencies and interactions</strong> between components.
📸 <strong><img alt="Application Map" src="../../azure-posts/app-insights/BO_Insights_ApplicationMap.png" /></strong></li>
</ul>
<h4 id="live-metrics"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#live-metrics"><strong>📌 Live Metrics</strong></a></h4>
<ul>
<li>Monitor <strong>real-time requests, server performance, and failures</strong>.
📸 <strong><img alt="Live Metrics" src="../../azure-posts/app-insights/BO_Insights_LiveMetrics.png" /></strong></li>
</ul>
<h4 id="failures-exceptions"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#failures-exceptions"><strong>📌 Failures &amp; Exceptions</strong></a></h4>
<ul>
<li>Identify and diagnose <strong>failed requests &amp; top exceptions</strong>.
📸 <strong><img alt="Failures &amp; Exceptions" src="../../azure-posts/app-insights/BO_Insights_Failures.png" /></strong></li>
</ul>
<h4 id="performance-monitoring"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#performance-monitoring"><strong>📌 Performance Monitoring</strong></a></h4>
<ul>
<li>Analyze <strong>response times, dependencies &amp; bottlenecks</strong>.
📸 <strong><img alt="Performance Overview" src="../../azure-posts/app-insights/BO_Insights_Performance.png" /></strong></li>
</ul>
<h4 id="logs-queries"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#logs-queries"><strong>📌 Logs &amp; Queries</strong></a></h4>
<ul>
<li>Run <strong>Kusto Query Language (KQL)</strong> queries for deep insights.</li>
</ul>
<p>Example query to find failed requests:</p>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">requests</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">false</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="n">desc</span>
</span></code></pre></div>
<p>📸 <strong><img alt="Query Results" src="../../azure-posts/app-insights/BO_Insights_Logs.png" /></strong></p>
<hr />
<h4 id="next-steps"><a class="toclink" href="../../monitoring-an-iis-based-web-farm-with-azure-application-insights/#next-steps">✅ <strong>Next Steps</strong></a></h4>
<p>🎯 Continue monitoring logs &amp; alerts for trends.<br />
🎯 Optimize Application Insights sampling to reduce telemetry costs.<br />
🎯 Automate reporting for key performance metrics.  </p>
<p>By following this guide, you'll have a <strong>robust, real-time monitoring setup</strong> for your IIS web farm, ensuring optimal performance and quick issue resolution! 🚀</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Monitoring%20an%20IIS-Based%20Web%20Farm%20with%20Azure%20Application%20Insights%0A&amp;url=https://blog.pollockweb.com/blog/monitoring-an-iis-based-web-farm-with-azure-application-insights/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/monitoring-an-iis-based-web-farm-with-azure-application-insights/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        
  <div class="custom-footer">
    <div class="custom-footer-left">
      <p>Copyright &copy; 2025 Matthew Pollock</p>
    </div>
    <div class="custom-footer-right">
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github"></i>
      </a>
      <a href="https://linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe"></i>
      </a>
      <a href="https://blog.pollockweb.com/feed_rss_created.xml" target="_blank" title="RSS Feed">
        <i class="fa-solid fa-rss"></i>
      </a>
    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "content.code.select", "content.code.copy", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>