<head>
    <!-- Other head elements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>

  
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A blog about tech stuff">
      
      
        <meta name="author" content="matt.pollock@outlook.com (Matthew Pollock)">
      
      
        <link rel="canonical" href="https://blog.pollockweb.com/blog/category/automation/">
      
      
        <link rel="prev" href="../application-insights/">
      
      
        <link rel="next" href="../azure/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/icons/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Automation - cloudlabmp</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-800NGKWBYL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-800NGKWBYL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-800NGKWBYL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
    <div class="announcement-content">
      <p>Welcome to my blog! Connect with me:</p>
      <a href="https://www.linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe fa-2x"></i>
      </a>
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github fa-2x"></i>
      </a><!-- Add more icons as needed -->
    </div>
  
          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://cloudlabmp.github.io/project-blog/blog/welcome-to-my-blog/" title="cloudlabmp" class="md-header__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cloudlabmp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Automation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../learn/" class="md-tabs__link">
        
  
    
  
  Learn

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../work/" class="md-tabs__link">
        
  
    
  
  Work

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://cloudlabmp.github.io/project-blog/blog/welcome-to-my-blog/" title="cloudlabmp" class="md-nav__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    cloudlabmp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Posts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Posts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" checked>
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai--study-techniques/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI &amp; Study Techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../ai-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI Integration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../application-insights/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Insights
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Automation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Automation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos" class="md-nav__link">
    <span class="md-ellipsis">
      🤖 First Steps into AI Automation: My Journey from Trial to Self-Hosted Chaos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Enforcing Time Zone and DST Compliance on Windows Servers Using GPO and Scheduled Tasks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-uk-regional-settings-on-windows-servers-with-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring UK Regional Settings on Windows Servers with PowerShell
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uninstalling-papercut-mf-client-via-intune-a-step-by-step-guide" class="md-nav__link">
    <span class="md-ellipsis">
      📢 Uninstalling PaperCut MF Client via Intune – A Step-by-Step Guide 🚀
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../bcdr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BCDR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blogging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blogging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CI/CD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../career-development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Career Development
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../cloud-resume-challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Resume Challenge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../finops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FinOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../gitops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../group-policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Group Policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../iis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IIS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../iac/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IaC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../identity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Identity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../infrastructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../intune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../learning-projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning Projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../life-update/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Life Update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../microsoft-certifications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microsoft Certifications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../patch-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Patch Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../powershell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PowerShell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../regional-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Regional Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../scripting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scripting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../self-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Self-Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../serverless/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serverless
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../time-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../web-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learn
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../work/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Work
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos" class="md-nav__link">
    <span class="md-ellipsis">
      🤖 First Steps into AI Automation: My Journey from Trial to Self-Hosted Chaos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Enforcing Time Zone and DST Compliance on Windows Servers Using GPO and Scheduled Tasks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-uk-regional-settings-on-windows-servers-with-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring UK Regional Settings on Windows Servers with PowerShell
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uninstalling-papercut-mf-client-via-intune-a-step-by-step-guide" class="md-nav__link">
    <span class="md-ellipsis">
      📢 Uninstalling PaperCut MF Client via Intune – A Step-by-Step Guide 🚀
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="automation">Automation</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-09 00:00:00+00:00">June 9, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../ai/" class="md-meta__link">AI</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../self-hosting/" class="md-meta__link">Self-Hosting</a></li>
        
        
          
          <li class="md-meta__item">
            
              14 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/">🤖 First Steps into AI Automation: My Journey from Trial to Self-Hosted Chaos</a></h2>
<blockquote>
<p>What started as 'let me just automate some emails' somehow turned into a comprehensive exploration of every AI automation platform and deployment method known to mankind...</p>
</blockquote>
<p>After months of reading about AI automation tools and watching everyone else's productivity skyrocket with clever workflows, I finally decided to stop being a spectator and dive in myself. What started as a simple "let's automate job alert emails" experiment quickly became a week-long journey through cloud trials, self-hosted deployments, OAuth authentication battles, and enough Docker containers to power a small data centre.</p>
<p><strong>In this post, you'll discover:</strong></p>
<ul>
<li>Real costs of AI automation experimentation ($10-50 range)</li>
<li>Why self-hosted OAuth2 is significantly harder than cloud versions</li>
<li>Performance differences: Pi 5 vs. desktop hardware for local AI</li>
<li>When to choose local vs. cloud AI models</li>
<li>Time investment reality: ~10 hours over 1 week for this project</li>
</ul>
<p>Here's how my first real foray into AI automation unfolded — spoiler alert: it involved more container migrations than I initially planned.</p>
<p><strong>Hardware baseline for this project:</strong></p>
<blockquote>
<p><strong>💻 Development Environment</strong></p>
<ul>
<li><strong>Primary machine:</strong> AMD Ryzen 7 5800X, 32GB DDR4, NVMe SSD</li>
<li><strong>Pi 5 setup:</strong> 8GB RAM, microSD storage  </li>
<li><strong>Network:</strong> Standard home broadband (important for cloud API performance)</li>
</ul>
</blockquote>
<hr />
<h3 id="the-mission-taming-job-alert-email-chaos"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#the-mission-taming-job-alert-email-chaos">🎯 The Mission: Taming Job Alert Email Chaos</a></h3>
<p>Let's set the scene. If you're drowning in recruitment emails like I was, spending 30+ minutes daily parsing through multiple job listings scattered across different emails, you'll understand the frustration. Each recruitment platform has its own format, some emails contain 5-10 different opportunities, and manually extracting the relevant URLs was becoming a productivity killer.</p>
<p><strong>The vision:</strong> Create an automated workflow that would:</p>
<ul>
<li>Scrape job-related emails from my Outlook.com inbox</li>
<li>Extract and clean the job data using AI</li>
<li>Generate a neat summary email with all the job URLs in one place</li>
<li>Send it back to me in a digestible format</li>
</ul>
<p>Simple enough, right? <em>Famous last words.</em></p>
<hr />
<h3 id="phase-1-the-n8n-cloud-trial-adventure"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#phase-1-the-n8n-cloud-trial-adventure">🔄 Phase 1: The n8n Cloud Trial Adventure</a></h3>
<p>My research pointed to <a href="https://n8n.io/">n8n</a> as the go-to tool for this kind of automation workflow. Being sensible, I started with their 14-day cloud trial rather than jumping straight into self-hosting complexities.</p>
<h4 id="initial-setup-first-success"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#initial-setup-first-success">⚙️ Initial Setup &amp; First Success</a></h4>
<p>The n8n cloud interface is genuinely impressive — drag-and-drop workflow building with a proper visual editor that actually makes sense. Within a couple of hours, I had:</p>
<p>✅ <strong>Connected to Outlook.com</strong> via their built-in connector<br />
✅ <strong>Set up email filtering</strong> to grab job-related messages<br />
✅ <strong>Configured basic data processing</strong> to extract text content<br />
✅ <strong>Integrated OpenAI API</strong> for intelligent job URL extraction  </p>
<p><img alt="n8n jobs workflow with OpenAI API integration" src="../../ai-automation/n8n-jobs-workflow-openai.png" /></p>
<h4 id="the-ai-integration-challenge"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#the-ai-integration-challenge">🤖 The AI Integration Challenge</a></h4>
<p>This is where things got interesting. Initially, I connected the workflow to my <a href="https://openai.com/api/">OpenAI API</a> account, using GPT-4 to parse email content and extract job URLs. The AI component worked brilliantly — almost too well, since I managed to burn through my $10 worth of token credits in just two days of testing.</p>
<p><strong>The cost reality:</strong> Those "just testing a few prompts" sessions add up fast. A single complex email with multiple job listings processed through GPT-4 was costing around $0.15-0.30 per API call. When you're iterating on prompts and testing edge cases, those costs compound quickly.</p>
<p><strong>Lesson learned:</strong> Test with smaller models first, then scale up. GPT-4 is excellent but not cheap for experimental workflows.</p>
<h4 id="partial-success-the-classic-it-story"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#partial-success-the-classic-it-story">🎯 Partial Success (The Classic IT Story)</a></h4>
<p>The workflow was <em>partially</em> successful — and in true IT fashion, "partially" is doing some heavy lifting here. While the automation successfully processed emails and generated summaries, it had one glaring limitation: <strong>it only extracted one job URL per email</strong>, when most recruitment emails contain multiple opportunities.</p>
<p><strong>What this actually meant:</strong> A typical recruitment email might contain 5-7 job listings with individual URLs, but my workflow would only capture the first one it encountered. This wasn't a parsing issue — the AI was correctly identifying all the URLs in its response, but the n8n workflow was only processing the first result from the AI output.</p>
<p><strong>Why this limitation exists:</strong> The issue stemmed from how I'd configured the data processing nodes in n8n. The workflow was treating the AI response as a single data item rather than an array of multiple URLs. This is a common beginner mistake when working with structured data outputs.</p>
<p>This became the recurring theme of my experimentation week: <em>everything works, just not quite how you want it to.</em></p>
<h4 id="enter-azure-openai"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#enter-azure-openai">💡 Enter Azure OpenAI</a></h4>
<p>Rather than continue burning through OpenAI credits, I pivoted to <a href="https://azure.microsoft.com/en-gb/products/ai-services/openai-service">Azure OpenAI</a>. This turned out to be a smart move for several reasons:</p>
<ul>
<li><strong>Cost control:</strong> Better integration with my existing Azure credits</li>
<li><strong>Familiar environment:</strong> Already comfortable with Azure resource management  </li>
<li><strong>Testing flexibility:</strong> My Visual Studio Developer subscription gives me £120 monthly credits</li>
</ul>
<p>I deployed a <strong>GPT-4 Mini</strong> model in my test lab Azure tenant — perfect for experimentation without breaking the bank.</p>
<p><img alt="Azure OpenAI GPT-4 Mini deployment configuration" src="../../ai-automation/azure-openai-deployment.png" /></p>
<p>The Azure OpenAI integration worked seamlessly with n8n, and I successfully redirected my workflow to use the new endpoint. <em>Finally, something that worked first time.</em></p>
<p><img alt="n8n jobs workflow with Azure OpenAI integration" src="../../ai-automation/n8n-jobs-workflow-azure.png" /></p>
<hr />
<h3 id="phase-2-self-hosting-ambitions-container-edition-1"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#phase-2-self-hosting-ambitions-container-edition-1">🐳 Phase 2: Self-Hosting Ambitions (Container Edition #1)</a></h3>
<p>With the n8n cloud trial clocking ticking down, I faced the classic build-vs-buy decision. The cloud version was excellent, but I wanted full control and the ability to experiment without subscription constraints. The monthly $20 cost wasn't prohibitive, but the learning opportunity of self-hosting was too appealing to pass up.</p>
<p>Enter self-hosting with Docker containers — specifically, targeting my Raspberry Pi 5 setup.</p>
<h4 id="the-openmediavault-experiment"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#the-openmediavault-experiment">🏠 The OpenMediaVault Experiment</a></h4>
<p>My first attempt involved deploying n8n as a self-hosted Docker container on my <a href="https://www.openmediavault.org/">OpenMediaVault (OMV)</a> setup. For those unfamiliar, OMV is a network-attached storage (NAS) solution built on Debian, perfect for home lab environments where you want proper storage management with container capabilities.</p>
<p><strong>Why the Pi 5 + OMV route:</strong></p>
<ul>
<li><strong>Always-on availability:</strong> Unlike my main PC, the Pi runs 24/7</li>
<li><strong>Low power consumption:</strong> Perfect for continuous automation workflows</li>
<li><strong>Storage integration:</strong> OMV provides excellent Docker volume management</li>
<li><strong>Learning opportunity:</strong> Understanding self-hosted deployment challenges</li>
</ul>
<p><strong>The setup:</strong></p>
<ul>
<li><strong>Host:</strong> Raspberry Pi 5 running OpenMediaVault</li>
<li><strong>Backend storage:</strong> NAS device for persistent data</li>
<li><strong>Database:</strong> PostgreSQL container for n8n's backend</li>
<li><strong>Edition:</strong> n8n Community Edition (self-hosted)</li>
</ul>
<p><img alt="OpenMediaVault Docker container management interface" src="../../ai-automation/omv-docker-n8n-containers.png" /></p>
<h4 id="the-great-oauth-authentication-battle"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#the-great-oauth-authentication-battle">😤 The Great OAuth Authentication Battle</a></h4>
<p>This is where my self-hosting dreams met reality with a resounding thud.</p>
<p>I quickly discovered that replicating my cloud workflow wasn't going to be straightforward. The self-hosted community edition has functionality restrictions compared to the cloud version, but more frustratingly, I couldn't get OAuth2 authentication working properly.</p>
<p><strong>Why OAuth2 is trickier with self-hosted setups:</strong></p>
<ul>
<li><strong>Redirect URI complexity:</strong> Cloud services handle callback URLs automatically, but self-hosted instances need manually configured redirect URIs</li>
<li><strong>App registration headaches:</strong> Azure app registrations expect specific callback patterns that don't align well with dynamic self-hosted URLs</li>
<li><strong>Token management:</strong> Cloud versions handle OAuth token refresh automatically; self-hosted requires manual configuration</li>
<li><strong>Security certificate requirements:</strong> Many OAuth providers now require HTTPS callbacks, adding SSL certificate management complexity</li>
</ul>
<p><strong>The specific challenges I hit:</strong></p>
<ul>
<li><strong>Outlook.com authentication:</strong> Couldn't configure OAuth2 credentials using an app registration from my test lab Azure tenant</li>
<li><strong>Exchange Online integration:</strong> Also failed to connect via app registration — kept getting "invalid redirect URI" errors</li>
<li><strong>Documentation gaps:</strong> Self-hosting authentication setup felt less polished than the cloud version</li>
</ul>
<p>After several hours over two days debugging OAuth flows and Azure app registrations, I admitted defeat on the email integration front. <em>Sometimes retreat is the better part of valour.</em></p>
<h4 id="simple-success-weather-api-workflow"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#simple-success-weather-api-workflow">🌤️ Simple Success: Weather API Workflow</a></h4>
<p>Rather than abandon the entire self-hosting experiment, I pivoted to a simpler proof-of-concept. I created a basic workflow using:</p>
<ul>
<li><strong><a href="https://openweathermap.org/api">OpenWeatherMap API</a></strong> for weather data</li>
<li><strong>Gmail integration</strong> with app passwords (much simpler than OAuth2)</li>
<li><strong>Basic data processing</strong> and email generation</li>
</ul>
<p>This worked perfectly and proved that the self-hosted n8n environment was functional — the issue was specifically with the more complex authentication requirements of my original workflow.</p>
<p><img alt="Simple n8n weather workflow using OpenAI API" src="../../ai-automation/n8n-weather-workflow.png" /></p>
<hr />
<h3 id="phase-3-the-wsl-migration-container-migration-2"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#phase-3-the-wsl-migration-container-migration-2">🐳 Phase 3: The WSL Migration (Container Migration #2)</a></h3>
<p>While the Pi 5 setup was working fine for simple workflows, I started feeling the hardware limitations when testing more complex operations. Loading even smaller AI models was painfully slow, and memory constraints meant I couldn't experiment with anything approaching production-scale workflows.</p>
<p>Time for <strong>Container Migration #2</strong>.</p>
<h4 id="moving-to-wsl-docker-desktop"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#moving-to-wsl-docker-desktop">🖥️ Moving to WSL + Docker Desktop</a></h4>
<p>With the Pi 5 hitting performance limits, I decided to experiment with local AI models using Ollama (a local LLM hosting platform) and OpenWebUI (a web interface for interacting with AI models). This required more computational resources than the Pi could provide, so I deployed these tools using Docker Compose inside Ubuntu running on Windows WSL (Windows Subsystem for Linux).</p>
<p>This setup offered several advantages:</p>
<p><strong>Why WSL over the Pi 5:</strong></p>
<ul>
<li><strong>Better hardware resources:</strong> Access to my Windows PC's 32GB RAM and 8-core CPU vs. Pi 5's 8GB RAM limitation</li>
<li><strong>Docker Desktop integration:</strong> Visual container management through familiar interface</li>
<li><strong>Development flexibility:</strong> Easier to iterate and debug workflows with full IDE access</li>
<li><strong>Performance reality:</strong> Local LLM model loading went from 1+ minutes on Pi 5 to under 30 seconds</li>
</ul>
<p><strong>My development machine specs:</strong></p>
<ul>
<li><strong>CPU:</strong> AMD Ryzen 7 5800H with Radeon Graphics</li>
<li><strong>RAM:</strong> 32GB DDR4</li>
<li><strong>Storage:</strong> NVMe SSD for fast model loading</li>
<li><strong>GPU:</strong> None (pure CPU inference)</li>
</ul>
<p><strong>Time Investment Reality:</strong></p>
<ul>
<li><strong>n8n cloud setup:</strong> 2-3 hours (including initial workflow creation)</li>
<li><strong>OAuth2 debugging:</strong> 3+ hours over 2 days (ongoing challenge)</li>
<li><strong>Pi 5 container setup:</strong> 2+ hours</li>
<li><strong>Docker Desktop container set up:</strong> 2+ hours</li>
<li><strong>Total project time:</strong> ~10 hours over 1 week</li>
</ul>
<p><strong>The new stack:</strong></p>
<ul>
<li><strong>Host:</strong> Ubuntu in WSL2 on Windows</li>
<li><strong>Container orchestration:</strong> Docker Compose</li>
<li><strong>Management:</strong> Docker Desktop for Windows</li>
<li><strong>Models:</strong> <a href="https://ollama.ai/">Ollama</a> for local LLM hosting</li>
<li><strong>Interface:</strong> <a href="https://openwebui.com/">OpenWebUI</a> for model interaction</li>
</ul>
<p><img alt="Docker Desktop showing Ollama containers running" src="../../ai-automation/docker-desktop-ollama.png" /></p>
<h4 id="local-llm-experimentation"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#local-llm-experimentation">🧠 Local LLM Experimentation</a></h4>
<p>This is where the project took an interesting turn. Rather than continuing to rely on cloud APIs, I started experimenting with local language models through Ollama.</p>
<p><strong>Why local LLMs?</strong></p>
<ul>
<li><strong>Cost control:</strong> No per-token charges for experimentation</li>
<li><strong>Privacy:</strong> Sensitive data stays on local infrastructure</li>
<li><strong>Learning opportunity:</strong> Understanding how different models perform</li>
</ul>
<p>The Docker Compose setup made it trivial to spin up different model combinations and test their performance on my email processing use case.</p>
<h4 id="reality-check-local-vs-cloud-performance"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#reality-check-local-vs-cloud-performance">⚠️ Reality Check: Local vs. Cloud Performance</a></h4>
<p>Let's be honest here — <strong>using an LLM locally is never going to be a fully featured replacement for the likes of ChatGPT or Claude</strong>. This became apparent pretty quickly during my testing.</p>
<p><strong>Performance realities:</strong></p>
<ul>
<li><strong>Speed:</strong> Unless you're running some serious hardware, the performance will be a lot slower than the online AI counterparts</li>
<li><strong>Model capabilities:</strong> Local models (especially smaller ones that run on consumer hardware) lack the sophisticated reasoning of GPT-4 or Claude</li>
<li><strong>Resource constraints:</strong> My standard PC setup meant I was limited to smaller model variants</li>
<li><strong>Response quality:</strong> Noticeably less nuanced and accurate responses compared to cloud services</li>
</ul>
<p><strong>Where local LLMs do shine:</strong></p>
<ul>
<li><strong>Privacy-sensitive tasks:</strong> When you can't send data to external APIs</li>
<li><strong>Development and testing:</strong> Iterating on prompts without burning through API credits</li>
<li><strong>Learning and experimentation:</strong> Understanding how different model architectures behave</li>
<li><strong>Offline scenarios:</strong> When internet connectivity is unreliable</li>
</ul>
<p>The key insight: <strong>local LLMs are a complement to cloud services, not a replacement</strong>. Use them when privacy, cost, or learning are the primary concerns, but stick with cloud APIs when you need reliable, high-quality results.</p>
<h4 id="hybrid-approach-best-of-both-worlds"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#hybrid-approach-best-of-both-worlds">🔗 Hybrid Approach: Best of Both Worlds</a></h4>
<p>The final configuration became a hybrid approach:</p>
<ul>
<li><strong>OpenWebUI connected to Azure OpenAI</strong> for production-quality responses</li>
<li><strong>Local Ollama models</strong> for development and privacy-sensitive testing</li>
<li><strong>Docker containers</strong> exposed through Docker Desktop for easy management</li>
</ul>
<p>This gave me the flexibility to choose the right tool for each task — cloud APIs when I need reliability and performance, local models when I want to experiment or maintain privacy.</p>
<p><img alt="OpenWebUI local interface with model selection" src="../../ai-automation/openwebui-local.png" /></p>
<h4 id="cost-reality-check"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#cost-reality-check">💰 Cost Reality Check</a></h4>
<p>After a week of experimentation, here's how the costs actually broke down:</p>
<table>
<thead>
<tr>
<th><strong>Service</strong></th>
<th><strong>Trial Period</strong></th>
<th><strong>Monthly Cost</strong></th>
<th><strong>My Usage</strong></th>
<th><strong>Notes</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>n8n Cloud</td>
<td>14 days free</td>
<td>€20/month</td>
<td>2 weeks testing</td>
<td>Full OAuth2 features</td>
</tr>
<tr>
<td>OpenAI API</td>
<td>Pay-per-use</td>
<td>Variable</td>
<td>$10 in 2 days</td>
<td>Expensive for testing</td>
</tr>
<tr>
<td>Azure OpenAI</td>
<td>Free credits</td>
<td>£120/month budget</td>
<td>~£15 used</td>
<td>Better for experimentation</td>
</tr>
<tr>
<td>Self-hosted</td>
<td>Free</td>
<td>Hardware + time</td>
<td>2 days setup</td>
<td>OAuth2 complexity</td>
</tr>
</tbody>
</table>
<p><strong>Key insight:</strong> The "free" self-hosted option came with a significant time cost — debugging authentication issues for hours vs. having things work immediately in the cloud version.</p>
<hr />
<h3 id="current-state-lessons-learned-next-steps"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#current-state-lessons-learned-next-steps">📊 Current State: Lessons Learned &amp; Next Steps</a></h3>
<p>After a week of container deployments, OAuth battles, and API integrations, here's where I've landed:</p>
<h4 id="whats-working-well"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#whats-working-well">✅ What's Working Well</a></h4>
<p><strong>Technical Stack:</strong></p>
<ul>
<li><strong>n8n self-hosted:</strong> Currently running 2 active workflows (weather alerts, basic data processing)</li>
<li><strong>Azure OpenAI integration:</strong> Reliable and cost-effective for AI processing — saving ~£25/month vs. direct OpenAI API</li>
<li><strong>Docker containerisation:</strong> Easy deployment and management across different environments</li>
<li><strong>WSL environment:</strong> 10x performance improvement over Pi 5 for local AI model loading</li>
</ul>
<p><strong>Process Improvements:</strong></p>
<ul>
<li><strong>Iterative approach:</strong> Start simple, add complexity gradually — this saved significant debugging time</li>
<li><strong>Hybrid cloud/local strategy:</strong> Use the right tool for each requirement rather than forcing one solution</li>
<li><strong>Container flexibility:</strong> Easy to migrate and scale across different hosts when hardware constraints appear</li>
</ul>
<p><strong>Daily productivity impact:</strong> While the original job email automation isn't fully solved, the weather automation saves ~10 minutes daily, and the learning has already paid dividends in other automation projects.</p>
<h4 id="ongoing-challenges-the-work-in-progress-list"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#ongoing-challenges-the-work-in-progress-list">⚠️ Ongoing Challenges (The Work-in-Progress List)</a></h4>
<p><strong>Authentication Issues:</strong></p>
<ul>
<li>OAuth2 integration with Outlook.com/Exchange Online still unresolved</li>
<li>Need to explore alternative authentication methods or different email providers</li>
<li>May require diving deeper into Azure app registration configurations</li>
</ul>
<p><strong>Workflow Limitations:</strong></p>
<ul>
<li>Original job email processing goal partially achieved but needs refinement</li>
<li>Multiple job URL extraction per email still needs work</li>
<li>Error handling and retry logic need improvement</li>
</ul>
<p><strong>Infrastructure Decisions:</strong></p>
<ul>
<li>Balancing local vs. cloud resources for different use cases</li>
<li>Determining optimal Docker deployment strategy for production workflows</li>
<li>Managing costs across multiple AI service providers</li>
</ul>
<p><strong>Decision-making process during failures:</strong> When something doesn't work, I typically: (1) Troubleshoot the exact error using ChatGPT or Anthropic Claude, (2) Search for similar issues in community forums, (3) Try a simpler alternative approach, (4) If still stuck after 2-3 hours, pivot to a different method rather than continuing to debug indefinitely.</p>
<h4 id="next-steps-future-experiments"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#next-steps-future-experiments">🚀 Next Steps &amp; Future Experiments</a></h4>
<p><strong>Short-term goals (next 2-4 weeks):</strong></p>
<ol>
<li><strong>Resolve OAuth2 authentication</strong> for proper email integration</li>
<li><strong>Improve job URL extraction accuracy</strong> — tackle the multiple URLs per email challenge</li>
<li><strong>Add error handling and logging</strong> to existing workflows</li>
<li><strong>Explore alternative email providers</strong> if Outlook.com integration remains problematic</li>
</ol>
<p><strong>Medium-term exploration (next 2-3 months):</strong></p>
<ol>
<li><strong>Local LLM performance tuning</strong> for specific use cases</li>
<li><strong>Workflow templates</strong> for common automation patterns</li>
<li><strong>Integration with other productivity tools</strong> (calendar, task management)</li>
<li><strong>Monitoring and alerting</strong> for automated workflows</li>
</ol>
<h4 id="quick-wins-for-beginners"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#quick-wins-for-beginners">🛠️ Quick Wins for Beginners</a></h4>
<p>If you're just starting your AI automation journey, here are the lessons learned that could save you time:</p>
<blockquote>
<p><strong>🎯 Start Simple First</strong></p>
<ul>
<li>Begin with n8n cloud trial to understand the platform without authentication headaches</li>
<li>Use simple APIs (weather, RSS feeds) before tackling complex ones (email OAuth2)</li>
<li>Test with smaller AI models before jumping to GPT-4</li>
</ul>
<p><strong>💡 Budget for Experimentation</strong></p>
<ul>
<li>Set aside $20-50 for API testing — it goes faster than you think</li>
<li>Azure OpenAI credits can be more cost-effective than direct OpenAI API for learning</li>
<li>Factor in time costs when choosing self-hosted vs. cloud solutions</li>
</ul>
<p><strong>🔧 Have Fallback Options Ready</strong></p>
<ul>
<li>Plan alternative authentication methods (app passwords vs. OAuth2)</li>
<li>Keep both cloud and local AI options available</li>
<li>Document what works and what doesn't for future reference</li>
</ul>
</blockquote>
<hr />
<h3 id="technical-resources-documentation"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#technical-resources-documentation">🔧 Technical Resources &amp; Documentation</a></h3>
<p>For anyone inspired to start their own AI automation journey, here are the key resources that proved invaluable:</p>
<h4 id="core-tools-platforms"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#core-tools-platforms">🛠️ Core Tools &amp; Platforms</a></h4>
<ul>
<li><strong><a href="https://n8n.io/">n8n</a></strong> — Visual workflow automation platform</li>
<li><strong><a href="https://www.docker.com/">Docker</a></strong> — Containerisation platform</li>
<li><strong><a href="https://docs.docker.com/compose/">Docker Compose</a></strong> — Multi-container orchestration tool</li>
<li><strong><a href="https://www.openmediavault.org/">OpenMediaVault</a></strong> — NAS/storage management solution</li>
</ul>
<h4 id="ai-llm-resources"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#ai-llm-resources">🤖 AI &amp; LLM Resources</a></h4>
<ul>
<li><strong><a href="https://ollama.ai/">Ollama</a></strong> — Local LLM hosting platform</li>
<li><strong><a href="https://openwebui.com/">OpenWebUI</a></strong> — Web interface for local LLM interaction</li>
<li><strong><a href="https://azure.microsoft.com/en-gb/products/ai-services/openai-service">Azure OpenAI Service</a></strong> — Enterprise AI API platform</li>
<li><strong><a href="https://openai.com/api/">OpenAI API</a></strong> — Direct API access to GPT models</li>
</ul>
<h4 id="setup-guides-documentation"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#setup-guides-documentation">📚 Setup Guides &amp; Documentation</a></h4>
<ul>
<li><strong><a href="https://docs.n8n.io/hosting/">n8n Self-Hosting Guide</a></strong></li>
<li><strong><a href="https://docs.docker.com/get-docker/">Docker Installation Documentation</a></strong></li>
<li><strong><a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/quickstart">Azure OpenAI Quickstart</a></strong> — Getting started with Azure OpenAI</li>
<li><strong><a href="https://docs.microsoft.com/en-us/windows/wsl/install">WSL Installation Guide</a></strong> — Windows Subsystem for Linux setup</li>
</ul>
<h4 id="troubleshooting-common-issues"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#troubleshooting-common-issues">🔧 Troubleshooting Common Issues</a></h4>
<p>Based on my week of trial and error, here are the most common problems you'll likely encounter:</p>
<p><strong>🔐 OAuth2 Authentication Failures</strong></p>
<p><em>Symptoms:</em> "Invalid redirect URI" or "Authentication failed" errors when connecting to email services.</p>
<p><em>Likely causes:</em></p>
<ul>
<li>Redirect URI mismatch between app registration and n8n configuration</li>
<li>Self-hosted instance not using HTTPS for callbacks</li>
<li>App registration missing required API permissions</li>
</ul>
<p><em>Solutions to try:</em></p>
<ul>
<li>Use app passwords instead of OAuth2 where possible (Gmail, Outlook.com) — <strong>Note:</strong> App passwords are simpler username/password credentials that bypass OAuth2 complexity but offer less security</li>
<li>Ensure your n8n instance is accessible via HTTPS with valid SSL certificate</li>
<li>Double-check app registration redirect URIs match exactly (including trailing slashes)</li>
<li>Start with cloud trial to verify workflow logic before self-hosting</li>
</ul>
<p><strong>🐳 Container Performance Issues</strong></p>
<p><em>Symptoms:</em> Slow model loading, container crashes, high memory usage.</p>
<p><em>Likely causes:</em></p>
<ul>
<li>Insufficient RAM allocation to Docker</li>
<li>CPU-intensive models running on inadequate hardware</li>
<li>Competing containers for limited resources</li>
</ul>
<p><em>Solutions to try:</em></p>
<ul>
<li>Increase Docker memory limits in Docker Desktop settings</li>
<li>Use smaller model variants (7B instead of 13B+ parameters)</li>
<li>Monitor resource usage with <code>docker stats</code> command</li>
<li>Consider migrating from Pi to x86 hardware for better performance</li>
</ul>
<p><strong>💸 API Rate Limiting and Costs</strong></p>
<p><em>Symptoms:</em> API calls failing, unexpected high costs, token limits exceeded.</p>
<p><em>Likely causes:</em></p>
<ul>
<li>Testing with expensive models (GPT-4) instead of cheaper alternatives</li>
<li>No rate limiting in workflow configurations</li>
<li>Inefficient prompt design causing high token usage</li>
</ul>
<p><em>Solutions to try:</em></p>
<ul>
<li>Start testing with GPT-3.5-turbo or GPT-4-mini models</li>
<li>Implement workflow rate limiting and retry logic</li>
<li>Optimize prompts to reduce token consumption</li>
<li>Set API spending alerts in provider dashboards</li>
</ul>
<p><strong>💻 Resource Requirements Summary</strong></p>
<p><em>Minimum Requirements for Recreation:</em></p>
<ul>
<li><strong>Cloud approach:</strong> n8n trial account + $20-50 API experimentation budget</li>
<li><strong>Self-hosted approach:</strong> 8GB+ RAM, Docker knowledge, 2-3 days setup time</li>
<li><strong>Local AI experimentation:</strong> 16GB+ RAM recommended, considerable patience, NVMe storage preferred</li>
<li><strong>Network:</strong> Stable broadband connection for cloud API performance</li>
</ul>
<hr />
<h3 id="final-thoughts-the-joy-of-controlled-chaos"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#final-thoughts-the-joy-of-controlled-chaos">💭 Final Thoughts: The Joy of Controlled Chaos</a></h3>
<p>What started as a simple email automation project became a comprehensive exploration of modern AI automation tools. While I didn't achieve my original goal completely (yet), the journey provided invaluable hands-on experience with:</p>
<ul>
<li><strong>Container orchestration</strong> across different environments</li>
<li><strong>AI service integration</strong> patterns and best practices  </li>
<li><strong>Authentication complexity</strong> in self-hosted vs. cloud environments</li>
<li><strong>Hybrid deployment strategies</strong> for flexibility and cost control</li>
</ul>
<p>The beauty of this approach is that each "failed" experiment taught me something valuable about the tools and processes involved. The OAuth2 authentication issues, while frustrating, highlighted the importance of proper authentication design. The container migrations demonstrated the flexibility of modern deployment approaches.</p>
<p><strong>Most importantly:</strong> I now have a functional foundation for AI automation experiments, with both cloud and local capabilities at my disposal.</p>
<p>Is it overengineered for a simple email processing task? Absolutely. Was it worth the learning experience? Without question.</p>
<p><em>Have you tackled similar AI automation projects?</em> I'd particularly love to hear from anyone who's solved the OAuth2 self-hosting puzzle or found creative workarounds for email processing limitations. Drop me a line if you've found better approaches to any of these challenges.</p>
<hr />
<h4 id="image-requirements-summary"><a class="toclink" href="../../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/#image-requirements-summary">📸 Image Requirements Summary</a></h4>
<p><strong>For anyone recreating this setup, here are the key screenshots included in this post:</strong></p>
<ol>
<li><strong>n8n-jobs-workflow-openai.png</strong> — Original workflow using direct OpenAI API (the expensive version that burned through $10 in 2 days)</li>
<li><strong>azure-openai-deployment.png</strong> — Azure OpenAI Studio showing GPT-4 Mini deployment configuration  </li>
<li><strong>n8n-jobs-workflow-azure.png</strong> — Improved workflow using Azure OpenAI integration (the cost-effective version)</li>
<li><strong>omv-docker-n8n-containers.png</strong> — OpenMediaVault interface showing Docker container management on Pi 5</li>
<li><strong>n8n-weather-workflow.png</strong> — Simple weather API to Gmail workflow demonstrating successful self-hosted setup</li>
<li><strong>docker-desktop-ollama.png</strong> — Docker Desktop showing Ollama and OpenWebUI containers running on WSL</li>
<li><strong>openwebui-local.png</strong> — OpenWebUI interface showing both Azure OpenAI and local model selection options</li>
</ol>
<p>Each image demonstrates the practical implementation rather than theoretical concepts, helping readers visualize the actual tools and interfaces involved in the automation journey.</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=First%20Steps%20into%20AI%20Automation%3A%20My%20Journey%20from%20Trial%20to%20Self-Hosted%20Chaos%0A&amp;url=https://blog.pollockweb.com/blog/first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-29 00:00:00+00:00">May 29, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../azure/" class="md-meta__link">Azure</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../patch-management/" class="md-meta__link">Patch Management</a></li>
        
        
          
          <li class="md-meta__item">
            
              21 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager</a></h2>
<blockquote>
<p>It's all fun and games until the MSP contract expires and you realise 90 VMs still need their patching schedules sorted…</p>
</blockquote>
<p>With our MSP contract winding down, the time had come to bring VM patching <em>back in house</em>. Our third-party provider had been handling it with their own tooling, which would no longer be used when the service contract expired.</p>
<p>Enter <a href="https://learn.microsoft.com/en-us/azure/update-manager/overview">Azure Update Manager</a> — the modern, agentless way to manage patching schedules across your Azure VMs. Add a bit of PowerShell, sprinkle in some Azure Policy, and you've got yourself a scalable, policy-driven solution that's more visible, auditable, and way more maintainable.</p>
<p>Here's how I made the switch — and managed to avoid a patching panic.</p>
<hr />
<h3 id="prerequisites-permissions"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#prerequisites-permissions">⚙️ Prerequisites &amp; Permissions</a></h3>
<p>Let's get the plumbing sorted before diving in.</p>
<p>You'll need:</p>
<ul>
<li>The right <strong>PowerShell modules</strong>:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nb">Install-Module</span> <span class="n">Az</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span> <span class="n">-Force</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nb">Import-Module</span> <span class="n">Az</span><span class="p">.</span><span class="n">Maintenance</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Resources</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Compute</span>
</span></code></pre></div>
<ul>
<li>An account with <strong>Contributor</strong> permissions (or higher)</li>
<li>Registered providers to avoid mysterious error messages:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Maintenance</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">GuestConfiguration</span>
</span></code></pre></div>
<blockquote>
<p><strong>Why Resource Providers?</strong> Azure Update Manager needs these registered to create the necessary API endpoints and resource types in your subscription. Without them, you'll get cryptic "resource type not found" errors.</p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/overview#prerequisites">Official documentation on Azure Update Manager prerequisites</a></p>
<hr />
<h3 id="step-1-audit-the-current-setup"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-1-audit-the-current-setup">🕵️ Step 1 – Audit the Current Setup</a></h3>
<p>First order of business: collect the patching summary data from the MSP — which, helpfully, came in the form of multiple weekly CSV exports.</p>
<p>I used GenAI to wrangle the mess into a structured format. The result was a clear categorisation of VMs based on the day and time they were typically patched — a solid foundation to work from.</p>
<hr />
<h3 id="step-2-create-seven-new-maintenance-configurations"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-2-create-seven-new-maintenance-configurations">🧱 Step 2 – Create Seven New Maintenance Configurations</a></h3>
<p>This is the foundation of Update Manager — define your recurring patch windows.</p>
<details>
<summary>Click to expand: Create Maintenance Configurations (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c"># Azure Update Manager - Create Weekly Maintenance Configurations</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="c"># Pure PowerShell syntax</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="c"># Define parameters</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="nv">$resourceGroupName</span> <span class="p">=</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="nv">$location</span> <span class="p">=</span> <span class="s2">&quot;uksouth&quot;</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="nv">$timezone</span> <span class="p">=</span> <span class="s2">&quot;GMT Standard Time&quot;</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="nv">$startDateTime</span> <span class="p">=</span> <span class="s2">&quot;2024-06-01 21:00&quot;</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="nv">$duration</span> <span class="p">=</span> <span class="s2">&quot;03:00&quot;</span>  <span class="c"># 3 hours - meets minimum requirement</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="c"># Day mapping for config naming (3-letter lowercase)</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="nv">$dayMap</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>    <span class="s2">&quot;Monday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>    <span class="s2">&quot;Tuesday&quot;</span>   <span class="p">=</span> <span class="s2">&quot;tue&quot;</span> 
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>    <span class="s2">&quot;Thursday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>    <span class="s2">&quot;Friday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>    <span class="s2">&quot;Saturday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;sat&quot;</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>    <span class="s2">&quot;Sunday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="p">}</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="c"># Create maintenance configurations for each day</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$day</span> <span class="k">in</span> <span class="nv">$dayMap</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>    <span class="nv">$shortDay</span> <span class="p">=</span> <span class="nv">$dayMap</span><span class="p">[</span><span class="nv">$day</span><span class="p">]</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a>    <span class="nv">$configName</span> <span class="p">=</span> <span class="s2">&quot;contoso-maintenance-config-vms-$shortDay&quot;</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Creating: $configName for $day...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">New-AzMaintenanceConfiguration</span> <span class="p">`</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a>            <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="p">`</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>            <span class="n">-Name</span> <span class="nv">$configName</span> <span class="p">`</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a>            <span class="n">-MaintenanceScope</span> <span class="s2">&quot;InGuestPatch&quot;</span> <span class="p">`</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a>            <span class="n">-Location</span> <span class="nv">$location</span> <span class="p">`</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a>            <span class="n">-StartDateTime</span> <span class="nv">$startDateTime</span> <span class="p">`</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a>            <span class="n">-Timezone</span> <span class="nv">$timezone</span> <span class="p">`</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a>            <span class="n">-Duration</span> <span class="nv">$duration</span> <span class="p">`</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a>            <span class="n">-RecurEvery</span> <span class="s2">&quot;Week $day&quot;</span> <span class="p">`</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a>            <span class="n">-InstallPatchRebootSetting</span> <span class="s2">&quot;IfRequired&quot;</span> <span class="p">`</span>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a>            <span class="n">-ExtensionProperty</span> <span class="p">@{</span><span class="s2">&quot;InGuestPatchMode&quot;</span> <span class="p">=</span> <span class="s2">&quot;User&quot;</span><span class="p">}</span> <span class="p">`</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a>            <span class="n">-WindowParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a>            <span class="n">-LinuxParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a>            <span class="n">-Tag</span> <span class="p">@{</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a>                <span class="s2">&quot;Application&quot;</span>  <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a>                <span class="s2">&quot;Owner&quot;</span>        <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a>                <span class="s2">&quot;PatchWindow&quot;</span>  <span class="p">=</span> <span class="nv">$shortDay</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a>            <span class="p">}</span> <span class="p">`</span>
</span><span id="__span-30-48"><a id="__codelineno-30-48" name="__codelineno-30-48" href="#__codelineno-30-48"></a>            <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-30-49"><a id="__codelineno-30-49" name="__codelineno-30-49" href="#__codelineno-30-49"></a>
</span><span id="__span-30-50"><a id="__codelineno-30-50" name="__codelineno-30-50" href="#__codelineno-30-50"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✓ SUCCESS: $configName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-30-51"><a id="__codelineno-30-51" name="__codelineno-30-51" href="#__codelineno-30-51"></a>
</span><span id="__span-30-52"><a id="__codelineno-30-52" name="__codelineno-30-52" href="#__codelineno-30-52"></a>        <span class="c"># Quick validation</span>
</span><span id="__span-30-53"><a id="__codelineno-30-53" name="__codelineno-30-53" href="#__codelineno-30-53"></a>        <span class="nv">$createdConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="n">-Name</span> <span class="nv">$configName</span>
</span><span id="__span-30-54"><a id="__codelineno-30-54" name="__codelineno-30-54" href="#__codelineno-30-54"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Validated: </span><span class="p">$(</span><span class="nv">$createdConfig</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2"> schedule confirmed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-30-55"><a id="__codelineno-30-55" name="__codelineno-30-55" href="#__codelineno-30-55"></a>
</span><span id="__span-30-56"><a id="__codelineno-30-56" name="__codelineno-30-56" href="#__codelineno-30-56"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-30-57"><a id="__codelineno-30-57" name="__codelineno-30-57" href="#__codelineno-30-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✗ FAILED: $configName - </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-30-58"><a id="__codelineno-30-58" name="__codelineno-30-58" href="#__codelineno-30-58"></a>        <span class="k">continue</span>
</span><span id="__span-30-59"><a id="__codelineno-30-59" name="__codelineno-30-59" href="#__codelineno-30-59"></a>    <span class="p">}</span>
</span><span id="__span-30-60"><a id="__codelineno-30-60" name="__codelineno-30-60" href="#__codelineno-30-60"></a><span class="p">}</span>
</span></code></pre></div>

</details>

<blockquote>
<p>⚠️ <em>Don't forget: duration format is ISO 8601, not "2 hours" — and start time has to match the day it's tied to.</em></p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/new-azmaintenanceconfiguration">Learn more about New-AzMaintenanceConfiguration</a></p>
<hr />
<h3 id="step-3-tweak-the-maintenance-configs"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-3-tweak-the-maintenance-configs">🛠️ Step 3 – Tweak the Maintenance Configs</a></h3>
<p>Some patch windows felt too tight — and, just as importantly, I needed to avoid overlaps with existing backup jobs. Rather than let a large CU fail halfway through or run headlong into an Azure Backup job, I extended the duration on select configs and staggered them across the week:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span> <span class="p">=</span> <span class="s2">&quot;04:00&quot;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="nb">Update-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span> <span class="n">-Configuration</span> <span class="nv">$config</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="c"># Verify the change</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="nv">$updatedConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Sunday window now: </span><span class="p">$(</span><span class="nv">$updatedConfig</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2"> duration&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></code></pre></div>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/update-azmaintenanceconfiguration?view=azps-14.0.0&amp;viewFallbackFrom=azps-13.5.0">Learn more about Update-AzMaintenanceConfiguration</a></p>
<hr />
<h3 id="step-4-use-ai-to-group-vms-by-patch-activity"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-4-use-ai-to-group-vms-by-patch-activity">🤖 Step 4 – Use AI to Group VMs by Patch Activity</a></h3>
<p>Armed with CSV exports of the latest patching summaries, I got AI to do the grunt work and make sense of the contents.</p>
<p><strong>What I did:</strong></p>
<ol>
<li><strong>Exported MSP data:</strong> Weekly CSV reports showing patch installation timestamps for each VM</li>
<li>
<p><strong>Used Gen AI</strong> with various iterative prompts, starting the conversation with this:</p>
<blockquote>
<p>"Attached is an export summary of the current patching activity from our incumbent MSP who currently look after the patching of the VM's in Azure
I need you to review timestamps and work out which maintenance window each vm is currently in, and then match that to the appropriate maintenance config that we have just created.
If there are mis matches in new and current schedule then we may need to tweak the settings of the new configs"</p>
</blockquote>
</li>
<li>
<p><strong>AI analysis revealed:</strong></p>
</li>
<li>60% of VMs were patching on one weekday evening</li>
<li>Several critical systems patching simultaneously</li>
<li>
<p>No consideration for application dependencies</p>
</li>
<li>
<p><strong>AI recommendation:</strong> Spread VMs across weekdays based on:</p>
</li>
<li><strong>Criticality:</strong> Domain controllers on different days</li>
<li><strong>Function:</strong> Similar servers on different days (avoid single points of failure)  </li>
<li><strong>Dependencies:</strong> Database servers before application servers</li>
</ol>
<p><strong>The result:</strong> A logical rebalancing that avoided "all our eggs in Sunday 1AM" basket and considered business impact.</p>
<blockquote>
<p><strong>Why this matters:</strong> The current patching schedule was not optimized for business continuity. AI helped identify risks we hadn't considered.</p>
</blockquote>
<hr />
<h3 id="step-5-discover-all-vms-and-identify-gaps"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-5-discover-all-vms-and-identify-gaps">🔍 Step 5 – Discover All VMs and Identify Gaps</a></h3>
<p>Before diving into bulk tagging, I needed to understand what we were working with across all subscriptions.</p>
<p><strong>First, let's see what VMs we have:</strong></p>
<details>
<summary>Click to expand: Discover Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c"># Discover Untagged VMs Script for Azure Update Manager</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="c"># This script identifies VMs that are missing Azure Update Manager tags</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Azure Update Manager - Discover Untagged VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Scanning all accessible subscriptions for VMs missing maintenance tags...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="c"># Function to check if VM has Azure Update Manager tags</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="k">function</span> <span class="nb">Test-VMHasMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">)</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>    <span class="c"># Check for the three required tags</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>    <span class="nv">$hasOwnerTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Owner&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Owner&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>    <span class="nv">$hasUpdatesTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Updates&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Updates&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>    <span class="nv">$hasPatchWindowTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">)</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a>    <span class="k">return</span> <span class="nv">$hasOwnerTag</span> <span class="o">-and</span> <span class="nv">$hasUpdatesTag</span> <span class="o">-and</span> <span class="nv">$hasPatchWindowTag</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="p">}</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="c"># Function to get VM details for reporting</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="k">function</span> <span class="nb">Get-VMDetails</span> <span class="p">{</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">,</span> <span class="nv">$SubscriptionName</span><span class="p">)</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a>    <span class="k">return</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a>        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>        <span class="n">ResourceGroup</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a>        <span class="n">Subscription</span> <span class="p">=</span> <span class="nv">$SubscriptionName</span>
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">SubscriptionId</span>
</span><span id="__span-32-32"><a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a>        <span class="n">PowerState</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">PowerState</span>
</span><span id="__span-32-33"><a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a>        <span class="n">OsType</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">StorageProfile</span><span class="p">.</span><span class="n">OsDisk</span><span class="p">.</span><span class="n">OsType</span>
</span><span id="__span-32-34"><a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a>        <span class="n">VmSize</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">HardwareProfile</span><span class="p">.</span><span class="n">VmSize</span>
</span><span id="__span-32-35"><a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a>        <span class="n">Tags</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="s2">&quot;$_=</span><span class="p">$(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">])</span><span class="s2">&quot;</span> <span class="p">})</span> <span class="n">-join</span> <span class="s2">&quot;; &quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;No tags&quot;</span> <span class="p">}</span>
</span><span id="__span-32-36"><a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a>    <span class="p">}</span>
</span><span id="__span-32-37"><a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a><span class="p">}</span>
</span><span id="__span-32-38"><a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a>
</span><span id="__span-32-39"><a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a><span class="c"># Initialize collections</span>
</span><span id="__span-32-40"><a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a><span class="nv">$taggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-32-41"><a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a><span class="nv">$untaggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-32-42"><a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a><span class="nv">$allVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-32-43"><a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a><span class="nv">$subscriptionSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-32-44"><a id="__codelineno-32-44" name="__codelineno-32-44" href="#__codelineno-32-44"></a>
</span><span id="__span-32-45"><a id="__codelineno-32-45" name="__codelineno-32-45" href="#__codelineno-32-45"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== DISCOVERING VMs ACROSS ALL SUBSCRIPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-46"><a id="__codelineno-32-46" name="__codelineno-32-46" href="#__codelineno-32-46"></a>
</span><span id="__span-32-47"><a id="__codelineno-32-47" name="__codelineno-32-47" href="#__codelineno-32-47"></a><span class="c"># Get all accessible subscriptions</span>
</span><span id="__span-32-48"><a id="__codelineno-32-48" name="__codelineno-32-48" href="#__codelineno-32-48"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-32-49"><a id="__codelineno-32-49" name="__codelineno-32-49" href="#__codelineno-32-49"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Found </span><span class="p">$(</span><span class="nv">$subscriptions</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> accessible subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-50"><a id="__codelineno-32-50" name="__codelineno-32-50" href="#__codelineno-32-50"></a>
</span><span id="__span-32-51"><a id="__codelineno-32-51" name="__codelineno-32-51" href="#__codelineno-32-51"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-52"><a id="__codelineno-32-52" name="__codelineno-32-52" href="#__codelineno-32-52"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-32-53"><a id="__codelineno-32-53" name="__codelineno-32-53" href="#__codelineno-32-53"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Scanning subscription: </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="s2">)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-32-54"><a id="__codelineno-32-54" name="__codelineno-32-54" href="#__codelineno-32-54"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-32-55"><a id="__codelineno-32-55" name="__codelineno-32-55" href="#__codelineno-32-55"></a>
</span><span id="__span-32-56"><a id="__codelineno-32-56" name="__codelineno-32-56" href="#__codelineno-32-56"></a>        <span class="c"># Get all VMs in this subscription</span>
</span><span id="__span-32-57"><a id="__codelineno-32-57" name="__codelineno-32-57" href="#__codelineno-32-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Retrieving VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-58"><a id="__codelineno-32-58" name="__codelineno-32-58" href="#__codelineno-32-58"></a>        <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Status</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-32-59"><a id="__codelineno-32-59" name="__codelineno-32-59" href="#__codelineno-32-59"></a>
</span><span id="__span-32-60"><a id="__codelineno-32-60" name="__codelineno-32-60" href="#__codelineno-32-60"></a>        <span class="nv">$subTagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-32-61"><a id="__codelineno-32-61" name="__codelineno-32-61" href="#__codelineno-32-61"></a>        <span class="nv">$subUntagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-32-62"><a id="__codelineno-32-62" name="__codelineno-32-62" href="#__codelineno-32-62"></a>        <span class="nv">$subTotal</span> <span class="p">=</span> <span class="nv">$vms</span><span class="p">.</span><span class="n">Count</span>
</span><span id="__span-32-63"><a id="__codelineno-32-63" name="__codelineno-32-63" href="#__codelineno-32-63"></a>
</span><span id="__span-32-64"><a id="__codelineno-32-64" name="__codelineno-32-64" href="#__codelineno-32-64"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Found $subTotal VMs in this subscription&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-65"><a id="__codelineno-32-65" name="__codelineno-32-65" href="#__codelineno-32-65"></a>
</span><span id="__span-32-66"><a id="__codelineno-32-66" name="__codelineno-32-66" href="#__codelineno-32-66"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-67"><a id="__codelineno-32-67" name="__codelineno-32-67" href="#__codelineno-32-67"></a>            <span class="nv">$vmDetails</span> <span class="p">=</span> <span class="nb">Get-VMDetails</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-SubscriptionName</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-32-68"><a id="__codelineno-32-68" name="__codelineno-32-68" href="#__codelineno-32-68"></a>            <span class="nv">$allVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-32-69"><a id="__codelineno-32-69" name="__codelineno-32-69" href="#__codelineno-32-69"></a>
</span><span id="__span-32-70"><a id="__codelineno-32-70" name="__codelineno-32-70" href="#__codelineno-32-70"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">Test-VMHasMaintenanceTags</span> <span class="n">-VM</span> <span class="nv">$vm</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-71"><a id="__codelineno-32-71" name="__codelineno-32-71" href="#__codelineno-32-71"></a>                <span class="nv">$taggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-32-72"><a id="__codelineno-32-72" name="__codelineno-32-72" href="#__codelineno-32-72"></a>                <span class="nv">$subTagged</span><span class="p">++</span>
</span><span id="__span-32-73"><a id="__codelineno-32-73" name="__codelineno-32-73" href="#__codelineno-32-73"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ✓ Tagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-32-74"><a id="__codelineno-32-74" name="__codelineno-32-74" href="#__codelineno-32-74"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-32-75"><a id="__codelineno-32-75" name="__codelineno-32-75" href="#__codelineno-32-75"></a>                <span class="nv">$untaggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-32-76"><a id="__codelineno-32-76" name="__codelineno-32-76" href="#__codelineno-32-76"></a>                <span class="nv">$subUntagged</span><span class="p">++</span>
</span><span id="__span-32-77"><a id="__codelineno-32-77" name="__codelineno-32-77" href="#__codelineno-32-77"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ⚠️ Untagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-32-78"><a id="__codelineno-32-78" name="__codelineno-32-78" href="#__codelineno-32-78"></a>            <span class="p">}</span>
</span><span id="__span-32-79"><a id="__codelineno-32-79" name="__codelineno-32-79" href="#__codelineno-32-79"></a>        <span class="p">}</span>
</span><span id="__span-32-80"><a id="__codelineno-32-80" name="__codelineno-32-80" href="#__codelineno-32-80"></a>
</span><span id="__span-32-81"><a id="__codelineno-32-81" name="__codelineno-32-81" href="#__codelineno-32-81"></a>        <span class="c"># Store subscription summary</span>
</span><span id="__span-32-82"><a id="__codelineno-32-82" name="__codelineno-32-82" href="#__codelineno-32-82"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-32-83"><a id="__codelineno-32-83" name="__codelineno-32-83" href="#__codelineno-32-83"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="nv">$subTotal</span>
</span><span id="__span-32-84"><a id="__codelineno-32-84" name="__codelineno-32-84" href="#__codelineno-32-84"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="nv">$subTagged</span>
</span><span id="__span-32-85"><a id="__codelineno-32-85" name="__codelineno-32-85" href="#__codelineno-32-85"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="nv">$subUntagged</span>
</span><span id="__span-32-86"><a id="__codelineno-32-86" name="__codelineno-32-86" href="#__codelineno-32-86"></a>            <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-32-87"><a id="__codelineno-32-87" name="__codelineno-32-87" href="#__codelineno-32-87"></a>        <span class="p">}</span>
</span><span id="__span-32-88"><a id="__codelineno-32-88" name="__codelineno-32-88" href="#__codelineno-32-88"></a>
</span><span id="__span-32-89"><a id="__codelineno-32-89" name="__codelineno-32-89" href="#__codelineno-32-89"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Subscription Summary - Total: $subTotal | Tagged: $subTagged | Untagged: $subUntagged&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-90"><a id="__codelineno-32-90" name="__codelineno-32-90" href="#__codelineno-32-90"></a>
</span><span id="__span-32-91"><a id="__codelineno-32-91" name="__codelineno-32-91" href="#__codelineno-32-91"></a>    <span class="p">}</span>
</span><span id="__span-32-92"><a id="__codelineno-32-92" name="__codelineno-32-92" href="#__codelineno-32-92"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-32-93"><a id="__codelineno-32-93" name="__codelineno-32-93" href="#__codelineno-32-93"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-32-94"><a id="__codelineno-32-94" name="__codelineno-32-94" href="#__codelineno-32-94"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-32-95"><a id="__codelineno-32-95" name="__codelineno-32-95" href="#__codelineno-32-95"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-32-96"><a id="__codelineno-32-96" name="__codelineno-32-96" href="#__codelineno-32-96"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-32-97"><a id="__codelineno-32-97" name="__codelineno-32-97" href="#__codelineno-32-97"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-32-98"><a id="__codelineno-32-98" name="__codelineno-32-98" href="#__codelineno-32-98"></a>            <span class="n">Error</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>
</span><span id="__span-32-99"><a id="__codelineno-32-99" name="__codelineno-32-99" href="#__codelineno-32-99"></a>        <span class="p">}</span>
</span><span id="__span-32-100"><a id="__codelineno-32-100" name="__codelineno-32-100" href="#__codelineno-32-100"></a>    <span class="p">}</span>
</span><span id="__span-32-101"><a id="__codelineno-32-101" name="__codelineno-32-101" href="#__codelineno-32-101"></a><span class="p">}</span>
</span><span id="__span-32-102"><a id="__codelineno-32-102" name="__codelineno-32-102" href="#__codelineno-32-102"></a>
</span><span id="__span-32-103"><a id="__codelineno-32-103" name="__codelineno-32-103" href="#__codelineno-32-103"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-104"><a id="__codelineno-32-104" name="__codelineno-32-104" href="#__codelineno-32-104"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== OVERALL DISCOVERY SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-105"><a id="__codelineno-32-105" name="__codelineno-32-105" href="#__codelineno-32-105"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs found: </span><span class="p">$(</span><span class="nv">$allVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-106"><a id="__codelineno-32-106" name="__codelineno-32-106" href="#__codelineno-32-106"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs with maintenance tags: </span><span class="p">$(</span><span class="nv">$taggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-32-107"><a id="__codelineno-32-107" name="__codelineno-32-107" href="#__codelineno-32-107"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs missing maintenance tags: </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-32-108"><a id="__codelineno-32-108" name="__codelineno-32-108" href="#__codelineno-32-108"></a>
</span><span id="__span-32-109"><a id="__codelineno-32-109" name="__codelineno-32-109" href="#__codelineno-32-109"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-110"><a id="__codelineno-32-110" name="__codelineno-32-110" href="#__codelineno-32-110"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs ARE ALREADY TAGGED! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-32-111"><a id="__codelineno-32-111" name="__codelineno-32-111" href="#__codelineno-32-111"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;No further action required.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-112"><a id="__codelineno-32-112" name="__codelineno-32-112" href="#__codelineno-32-112"></a>    <span class="n">exit</span> <span class="n">0</span>
</span><span id="__span-32-113"><a id="__codelineno-32-113" name="__codelineno-32-113" href="#__codelineno-32-113"></a><span class="p">}</span>
</span><span id="__span-32-114"><a id="__codelineno-32-114" name="__codelineno-32-114" href="#__codelineno-32-114"></a>
</span><span id="__span-32-115"><a id="__codelineno-32-115" name="__codelineno-32-115" href="#__codelineno-32-115"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-116"><a id="__codelineno-32-116" name="__codelineno-32-116" href="#__codelineno-32-116"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SUBSCRIPTION BREAKDOWN ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-117"><a id="__codelineno-32-117" name="__codelineno-32-117" href="#__codelineno-32-117"></a><span class="nv">$subscriptionSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-118"><a id="__codelineno-32-118" name="__codelineno-32-118" href="#__codelineno-32-118"></a>    <span class="nv">$sub</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-32-119"><a id="__codelineno-32-119" name="__codelineno-32-119" href="#__codelineno-32-119"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-120"><a id="__codelineno-32-120" name="__codelineno-32-120" href="#__codelineno-32-120"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: ERROR - </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-32-121"><a id="__codelineno-32-121" name="__codelineno-32-121" href="#__codelineno-32-121"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-32-122"><a id="__codelineno-32-122" name="__codelineno-32-122" href="#__codelineno-32-122"></a>        <span class="nv">$percentage</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span> <span class="no">[math]</span><span class="p">::</span><span class="n">Round</span><span class="p">((</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span> <span class="p">/</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span> <span class="p">*</span> <span class="n">100</span><span class="p">,</span> <span class="n">1</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">0</span> <span class="p">}</span>
</span><span id="__span-32-123"><a id="__codelineno-32-123" name="__codelineno-32-123" href="#__codelineno-32-123"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span><span class="p">)</span><span class="s2">/</span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span><span class="s2"> tagged ($percentage%)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-124"><a id="__codelineno-32-124" name="__codelineno-32-124" href="#__codelineno-32-124"></a>    <span class="p">}</span>
</span><span id="__span-32-125"><a id="__codelineno-32-125" name="__codelineno-32-125" href="#__codelineno-32-125"></a><span class="p">}</span>
</span><span id="__span-32-126"><a id="__codelineno-32-126" name="__codelineno-32-126" href="#__codelineno-32-126"></a>
</span><span id="__span-32-127"><a id="__codelineno-32-127" name="__codelineno-32-127" href="#__codelineno-32-127"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-128"><a id="__codelineno-32-128" name="__codelineno-32-128" href="#__codelineno-32-128"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== UNTAGGED VMs DETAILED LIST ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-32-129"><a id="__codelineno-32-129" name="__codelineno-32-129" href="#__codelineno-32-129"></a><span class="nb">Write-Host</span> <span class="s2">&quot;The following </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs are missing Azure Update Manager maintenance tags:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-130"><a id="__codelineno-32-130" name="__codelineno-32-130" href="#__codelineno-32-130"></a>
</span><span id="__span-32-131"><a id="__codelineno-32-131" name="__codelineno-32-131" href="#__codelineno-32-131"></a><span class="c"># Group untagged VMs by subscription for easier reading</span>
</span><span id="__span-32-132"><a id="__codelineno-32-132" name="__codelineno-32-132" href="#__codelineno-32-132"></a><span class="nv">$untaggedBySubscription</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Subscription</span>
</span><span id="__span-32-133"><a id="__codelineno-32-133" name="__codelineno-32-133" href="#__codelineno-32-133"></a>
</span><span id="__span-32-134"><a id="__codelineno-32-134" name="__codelineno-32-134" href="#__codelineno-32-134"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$group</span> <span class="k">in</span> <span class="nv">$untaggedBySubscription</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-135"><a id="__codelineno-32-135" name="__codelineno-32-135" href="#__codelineno-32-135"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Subscription: </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> untagged VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-32-136"><a id="__codelineno-32-136" name="__codelineno-32-136" href="#__codelineno-32-136"></a>
</span><span id="__span-32-137"><a id="__codelineno-32-137" name="__codelineno-32-137" href="#__codelineno-32-137"></a>    <span class="nv">$group</span><span class="p">.</span><span class="nb">Group </span><span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-138"><a id="__codelineno-32-138" name="__codelineno-32-138" href="#__codelineno-32-138"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  • </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-32-139"><a id="__codelineno-32-139" name="__codelineno-32-139" href="#__codelineno-32-139"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Resource Group: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ResourceGroup</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-140"><a id="__codelineno-32-140" name="__codelineno-32-140" href="#__codelineno-32-140"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Location: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Location</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-141"><a id="__codelineno-32-141" name="__codelineno-32-141" href="#__codelineno-32-141"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    OS Type: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">OsType</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-142"><a id="__codelineno-32-142" name="__codelineno-32-142" href="#__codelineno-32-142"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    VM Size: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">VmSize</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-143"><a id="__codelineno-32-143" name="__codelineno-32-143" href="#__codelineno-32-143"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Power State: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PowerState</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-144"><a id="__codelineno-32-144" name="__codelineno-32-144" href="#__codelineno-32-144"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-ne</span> <span class="s2">&quot;No tags&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-32-145"><a id="__codelineno-32-145" name="__codelineno-32-145" href="#__codelineno-32-145"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;    Existing Tags: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">DarkGray</span>
</span><span id="__span-32-146"><a id="__codelineno-32-146" name="__codelineno-32-146" href="#__codelineno-32-146"></a>        <span class="p">}</span>
</span><span id="__span-32-147"><a id="__codelineno-32-147" name="__codelineno-32-147" href="#__codelineno-32-147"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-148"><a id="__codelineno-32-148" name="__codelineno-32-148" href="#__codelineno-32-148"></a>    <span class="p">}</span>
</span><span id="__span-32-149"><a id="__codelineno-32-149" name="__codelineno-32-149" href="#__codelineno-32-149"></a><span class="p">}</span>
</span><span id="__span-32-150"><a id="__codelineno-32-150" name="__codelineno-32-150" href="#__codelineno-32-150"></a>
</span><span id="__span-32-151"><a id="__codelineno-32-151" name="__codelineno-32-151" href="#__codelineno-32-151"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== ANALYSIS BY VM CHARACTERISTICS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-152"><a id="__codelineno-32-152" name="__codelineno-32-152" href="#__codelineno-32-152"></a>
</span><span id="__span-32-153"><a id="__codelineno-32-153" name="__codelineno-32-153" href="#__codelineno-32-153"></a><span class="c"># Analyze by OS Type</span>
</span><span id="__span-32-154"><a id="__codelineno-32-154" name="__codelineno-32-154" href="#__codelineno-32-154"></a><span class="nv">$untaggedByOS</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">OsType</span>
</span><span id="__span-32-155"><a id="__codelineno-32-155" name="__codelineno-32-155" href="#__codelineno-32-155"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by OS Type:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-156"><a id="__codelineno-32-156" name="__codelineno-32-156" href="#__codelineno-32-156"></a><span class="nv">$untaggedByOS</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-157"><a id="__codelineno-32-157" name="__codelineno-32-157" href="#__codelineno-32-157"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-158"><a id="__codelineno-32-158" name="__codelineno-32-158" href="#__codelineno-32-158"></a><span class="p">}</span>
</span><span id="__span-32-159"><a id="__codelineno-32-159" name="__codelineno-32-159" href="#__codelineno-32-159"></a>
</span><span id="__span-32-160"><a id="__codelineno-32-160" name="__codelineno-32-160" href="#__codelineno-32-160"></a><span class="c"># Analyze by Location</span>
</span><span id="__span-32-161"><a id="__codelineno-32-161" name="__codelineno-32-161" href="#__codelineno-32-161"></a><span class="nv">$untaggedByLocation</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Location</span>
</span><span id="__span-32-162"><a id="__codelineno-32-162" name="__codelineno-32-162" href="#__codelineno-32-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Location:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-163"><a id="__codelineno-32-163" name="__codelineno-32-163" href="#__codelineno-32-163"></a><span class="nv">$untaggedByLocation</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-164"><a id="__codelineno-32-164" name="__codelineno-32-164" href="#__codelineno-32-164"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-165"><a id="__codelineno-32-165" name="__codelineno-32-165" href="#__codelineno-32-165"></a><span class="p">}</span>
</span><span id="__span-32-166"><a id="__codelineno-32-166" name="__codelineno-32-166" href="#__codelineno-32-166"></a>
</span><span id="__span-32-167"><a id="__codelineno-32-167" name="__codelineno-32-167" href="#__codelineno-32-167"></a><span class="c"># Analyze by VM Size (to understand workload types)</span>
</span><span id="__span-32-168"><a id="__codelineno-32-168" name="__codelineno-32-168" href="#__codelineno-32-168"></a><span class="nv">$untaggedBySize</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">VmSize</span>
</span><span id="__span-32-169"><a id="__codelineno-32-169" name="__codelineno-32-169" href="#__codelineno-32-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Size:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-170"><a id="__codelineno-32-170" name="__codelineno-32-170" href="#__codelineno-32-170"></a><span class="nv">$untaggedBySize</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-171"><a id="__codelineno-32-171" name="__codelineno-32-171" href="#__codelineno-32-171"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-172"><a id="__codelineno-32-172" name="__codelineno-32-172" href="#__codelineno-32-172"></a><span class="p">}</span>
</span><span id="__span-32-173"><a id="__codelineno-32-173" name="__codelineno-32-173" href="#__codelineno-32-173"></a>
</span><span id="__span-32-174"><a id="__codelineno-32-174" name="__codelineno-32-174" href="#__codelineno-32-174"></a><span class="c"># Analyze by Resource Group (might indicate application/workload groupings)</span>
</span><span id="__span-32-175"><a id="__codelineno-32-175" name="__codelineno-32-175" href="#__codelineno-32-175"></a><span class="nv">$untaggedByRG</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">ResourceGroup</span>
</span><span id="__span-32-176"><a id="__codelineno-32-176" name="__codelineno-32-176" href="#__codelineno-32-176"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Resource Group (Top 10):&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-177"><a id="__codelineno-32-177" name="__codelineno-32-177" href="#__codelineno-32-177"></a><span class="nv">$untaggedByRG</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-178"><a id="__codelineno-32-178" name="__codelineno-32-178" href="#__codelineno-32-178"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-179"><a id="__codelineno-32-179" name="__codelineno-32-179" href="#__codelineno-32-179"></a><span class="p">}</span>
</span><span id="__span-32-180"><a id="__codelineno-32-180" name="__codelineno-32-180" href="#__codelineno-32-180"></a>
</span><span id="__span-32-181"><a id="__codelineno-32-181" name="__codelineno-32-181" href="#__codelineno-32-181"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-182"><a id="__codelineno-32-182" name="__codelineno-32-182" href="#__codelineno-32-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== POWER STATE ANALYSIS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-183"><a id="__codelineno-32-183" name="__codelineno-32-183" href="#__codelineno-32-183"></a><span class="nv">$powerStates</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">PowerState</span>
</span><span id="__span-32-184"><a id="__codelineno-32-184" name="__codelineno-32-184" href="#__codelineno-32-184"></a><span class="nv">$powerStates</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-32-185"><a id="__codelineno-32-185" name="__codelineno-32-185" href="#__codelineno-32-185"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-186"><a id="__codelineno-32-186" name="__codelineno-32-186" href="#__codelineno-32-186"></a><span class="p">}</span>
</span><span id="__span-32-187"><a id="__codelineno-32-187" name="__codelineno-32-187" href="#__codelineno-32-187"></a>
</span><span id="__span-32-188"><a id="__codelineno-32-188" name="__codelineno-32-188" href="#__codelineno-32-188"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-189"><a id="__codelineno-32-189" name="__codelineno-32-189" href="#__codelineno-32-189"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== EXPORT OPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-190"><a id="__codelineno-32-190" name="__codelineno-32-190" href="#__codelineno-32-190"></a><span class="nb">Write-Host</span> <span class="s2">&quot;You can export this data for further analysis:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-191"><a id="__codelineno-32-191" name="__codelineno-32-191" href="#__codelineno-32-191"></a>
</span><span id="__span-32-192"><a id="__codelineno-32-192" name="__codelineno-32-192" href="#__codelineno-32-192"></a><span class="c"># Export to CSV option</span>
</span><span id="__span-32-193"><a id="__codelineno-32-193" name="__codelineno-32-193" href="#__codelineno-32-193"></a><span class="nv">$timestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s2">&quot;yyyyMMdd-HHmm&quot;</span>
</span><span id="__span-32-194"><a id="__codelineno-32-194" name="__codelineno-32-194" href="#__codelineno-32-194"></a><span class="nv">$csvPath</span> <span class="p">=</span> <span class="s2">&quot;D:\UntaggedVMs-$timestamp.csv&quot;</span>
</span><span id="__span-32-195"><a id="__codelineno-32-195" name="__codelineno-32-195" href="#__codelineno-32-195"></a>
</span><span id="__span-32-196"><a id="__codelineno-32-196" name="__codelineno-32-196" href="#__codelineno-32-196"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-32-197"><a id="__codelineno-32-197" name="__codelineno-32-197" href="#__codelineno-32-197"></a>    <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="nv">$csvPath</span> <span class="n">-NoTypeInformation</span>
</span><span id="__span-32-198"><a id="__codelineno-32-198" name="__codelineno-32-198" href="#__codelineno-32-198"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✓ Exported untagged VMs to: $csvPath&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-32-199"><a id="__codelineno-32-199" name="__codelineno-32-199" href="#__codelineno-32-199"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-32-200"><a id="__codelineno-32-200" name="__codelineno-32-200" href="#__codelineno-32-200"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✗ Failed to export CSV: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-32-201"><a id="__codelineno-32-201" name="__codelineno-32-201" href="#__codelineno-32-201"></a><span class="p">}</span>
</span><span id="__span-32-202"><a id="__codelineno-32-202" name="__codelineno-32-202" href="#__codelineno-32-202"></a>
</span><span id="__span-32-203"><a id="__codelineno-32-203" name="__codelineno-32-203" href="#__codelineno-32-203"></a><span class="c"># Show simple list for easy copying</span>
</span><span id="__span-32-204"><a id="__codelineno-32-204" name="__codelineno-32-204" href="#__codelineno-32-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-205"><a id="__codelineno-32-205" name="__codelineno-32-205" href="#__codelineno-32-205"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SIMPLE VM NAME LIST (for copy/paste) ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-206"><a id="__codelineno-32-206" name="__codelineno-32-206" href="#__codelineno-32-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VM Names:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-207"><a id="__codelineno-32-207" name="__codelineno-32-207" href="#__codelineno-32-207"></a><span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span> <span class="p">}</span>
</span><span id="__span-32-208"><a id="__codelineno-32-208" name="__codelineno-32-208" href="#__codelineno-32-208"></a>
</span><span id="__span-32-209"><a id="__codelineno-32-209" name="__codelineno-32-209" href="#__codelineno-32-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-210"><a id="__codelineno-32-210" name="__codelineno-32-210" href="#__codelineno-32-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEXT STEPS RECOMMENDATIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-211"><a id="__codelineno-32-211" name="__codelineno-32-211" href="#__codelineno-32-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Review the untagged VMs list above&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-212"><a id="__codelineno-32-212" name="__codelineno-32-212" href="#__codelineno-32-212"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Investigate why these VMs were not in the original patching schedule&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-213"><a id="__codelineno-32-213" name="__codelineno-32-213" href="#__codelineno-32-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Determine appropriate maintenance windows for these VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-214"><a id="__codelineno-32-214" name="__codelineno-32-214" href="#__codelineno-32-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Consider grouping by:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-215"><a id="__codelineno-32-215" name="__codelineno-32-215" href="#__codelineno-32-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Application/workload (Resource Group analysis)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-216"><a id="__codelineno-32-216" name="__codelineno-32-216" href="#__codelineno-32-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Environment (naming patterns, tags)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-217"><a id="__codelineno-32-217" name="__codelineno-32-217" href="#__codelineno-32-217"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Business criticality&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-218"><a id="__codelineno-32-218" name="__codelineno-32-218" href="#__codelineno-32-218"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Maintenance window preferences&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-219"><a id="__codelineno-32-219" name="__codelineno-32-219" href="#__codelineno-32-219"></a><span class="nb">Write-Host</span> <span class="s2">&quot;5. Run the tagging script to assign maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-220"><a id="__codelineno-32-220" name="__codelineno-32-220" href="#__codelineno-32-220"></a>
</span><span id="__span-32-221"><a id="__codelineno-32-221" name="__codelineno-32-221" href="#__codelineno-32-221"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-222"><a id="__codelineno-32-222" name="__codelineno-32-222" href="#__codelineno-32-222"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-223"><a id="__codelineno-32-223" name="__codelineno-32-223" href="#__codelineno-32-223"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query in Azure Resource Graph Explorer to verify results:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-32-224"><a id="__codelineno-32-224" name="__codelineno-32-224" href="#__codelineno-32-224"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-225"><a id="__codelineno-32-225" name="__codelineno-32-225" href="#__codelineno-32-225"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-32-226"><a id="__codelineno-32-226" name="__codelineno-32-226" href="#__codelineno-32-226"></a><span class="sh">Resources</span>
</span><span id="__span-32-227"><a id="__codelineno-32-227" name="__codelineno-32-227" href="#__codelineno-32-227"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-32-228"><a id="__codelineno-32-228" name="__codelineno-32-228" href="#__codelineno-32-228"></a><span class="sh">| where tags.PatchWindow == &quot;&quot; or isempty(tags.PatchWindow) or isnull(tags.PatchWindow)</span>
</span><span id="__span-32-229"><a id="__codelineno-32-229" name="__codelineno-32-229" href="#__codelineno-32-229"></a><span class="sh">| project name, resourceGroup, subscriptionId, location, </span>
</span><span id="__span-32-230"><a id="__codelineno-32-230" name="__codelineno-32-230" href="#__codelineno-32-230"></a><span class="sh">          osType = properties.storageProfile.osDisk.osType,</span>
</span><span id="__span-32-231"><a id="__codelineno-32-231" name="__codelineno-32-231" href="#__codelineno-32-231"></a><span class="sh">          vmSize = properties.hardwareProfile.vmSize,</span>
</span><span id="__span-32-232"><a id="__codelineno-32-232" name="__codelineno-32-232" href="#__codelineno-32-232"></a><span class="sh">          powerState = properties.extended.instanceView.powerState.displayStatus,</span>
</span><span id="__span-32-233"><a id="__codelineno-32-233" name="__codelineno-32-233" href="#__codelineno-32-233"></a><span class="sh">          tags</span>
</span><span id="__span-32-234"><a id="__codelineno-32-234" name="__codelineno-32-234" href="#__codelineno-32-234"></a><span class="sh">| sort by name asc</span>
</span><span id="__span-32-235"><a id="__codelineno-32-235" name="__codelineno-32-235" href="#__codelineno-32-235"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-32-236"><a id="__codelineno-32-236" name="__codelineno-32-236" href="#__codelineno-32-236"></a>
</span><span id="__span-32-237"><a id="__codelineno-32-237" name="__codelineno-32-237" href="#__codelineno-32-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-32-238"><a id="__codelineno-32-238" name="__codelineno-32-238" href="#__codelineno-32-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-32-239"><a id="__codelineno-32-239" name="__codelineno-32-239" href="#__codelineno-32-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<p><strong>Discovery results:</strong></p>
<ul>
<li><strong>35 VMs</strong> from the original MSP schedule (our planned list)</li>
<li><strong>12 additional VMs</strong> not in the MSP schedule (the "stragglers")</li>
<li><strong>Total: 90 VMs</strong> needing Update Manager tags</li>
</ul>
<blockquote>
<p><strong>Key insight:</strong> The MSP wasn't managing everything. Several dev/test VMs and a few production systems were missing from their schedule.</p>
</blockquote>
<hr />
<h3 id="step-6-bulk-tag-all-vms-with-patch-windows"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-6-bulk-tag-all-vms-with-patch-windows">✍️ Step 6 – Bulk Tag All VMs with Patch Windows</a></h3>
<p>Now for the main event: tagging all VMs with their maintenance windows. This includes both our planned VMs and the newly discovered ones.</p>
<h4 id="main-vm-tagging-planned-schedule"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#main-vm-tagging-planned-schedule">🎯 Main VM Tagging (Planned Schedule)</a></h4>
<p>Each tag serves a specific purpose:</p>
<ul>
<li><code>PatchWindow</code> — The key tag used by dynamic scopes to assign VMs to maintenance configurations</li>
<li><code>Owner</code> — For accountability and filtering</li>
<li><code>Updates</code> — Identifies VMs managed by Azure Update Manager</li>
</ul>
<details>
<summary>Click to expand: Multi-Subscription Azure Update Manager VM Tagging (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c"># Multi-Subscription Azure Update Manager VM Tagging Script</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="c"># This script discovers VMs across multiple subscriptions and tags them appropriately</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Multi-Subscription Azure Update Manager - VM Tagging Script ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="c"># Function to safely tag a VM</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>    <span class="p">)</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>        <span class="c"># Get the VM and update tags</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">}</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>        <span class="p">}</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a>    <span class="p">}</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>    <span class="p">}</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="p">}</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="c"># Define all target VMs organized by maintenance window</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="nv">$maintenanceGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a>        <span class="p">}</span>
</span><span id="__span-33-51"><a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a>    <span class="p">}</span>
</span><span id="__span-33-52"><a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-53"><a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">)</span>
</span><span id="__span-33-54"><a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-55"><a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-56"><a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-57"><a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;tue&quot;</span>
</span><span id="__span-33-58"><a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a>        <span class="p">}</span>
</span><span id="__span-33-59"><a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a>    <span class="p">}</span>
</span><span id="__span-33-60"><a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-61"><a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-03&quot;</span><span class="p">)</span>
</span><span id="__span-33-62"><a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-63"><a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-64"><a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-65"><a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-33-66"><a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a>        <span class="p">}</span>
</span><span id="__span-33-67"><a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a>    <span class="p">}</span>
</span><span id="__span-33-68"><a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-69"><a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;PRINT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-33-70"><a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-71"><a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-72"><a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-73"><a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-33-74"><a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a>        <span class="p">}</span>
</span><span id="__span-33-75"><a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a>    <span class="p">}</span>
</span><span id="__span-33-76"><a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-77"><a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;MONITOR-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-33-78"><a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-79"><a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-80"><a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-81"><a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-33-82"><a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a>        <span class="p">}</span>
</span><span id="__span-33-83"><a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a>    <span class="p">}</span>
</span><span id="__span-33-84"><a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-85"><a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">,</span> <span class="s2">&quot;SANDBOX-01&quot;</span><span class="p">)</span>
</span><span id="__span-33-86"><a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-87"><a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-88"><a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-89"><a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>
</span><span id="__span-33-90"><a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a>        <span class="p">}</span>
</span><span id="__span-33-91"><a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a>    <span class="p">}</span>
</span><span id="__span-33-92"><a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-93"><a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;MGMT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-33-94"><a id="__codelineno-33-94" name="__codelineno-33-94" href="#__codelineno-33-94"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-95"><a id="__codelineno-33-95" name="__codelineno-33-95" href="#__codelineno-33-95"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-33-96"><a id="__codelineno-33-96" name="__codelineno-33-96" href="#__codelineno-33-96"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-33-97"><a id="__codelineno-33-97" name="__codelineno-33-97" href="#__codelineno-33-97"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-33-98"><a id="__codelineno-33-98" name="__codelineno-33-98" href="#__codelineno-33-98"></a>        <span class="p">}</span>
</span><span id="__span-33-99"><a id="__codelineno-33-99" name="__codelineno-33-99" href="#__codelineno-33-99"></a>    <span class="p">}</span>
</span><span id="__span-33-100"><a id="__codelineno-33-100" name="__codelineno-33-100" href="#__codelineno-33-100"></a><span class="p">}</span>
</span><span id="__span-33-101"><a id="__codelineno-33-101" name="__codelineno-33-101" href="#__codelineno-33-101"></a>
</span><span id="__span-33-102"><a id="__codelineno-33-102" name="__codelineno-33-102" href="#__codelineno-33-102"></a><span class="c"># Function to discover VMs across all subscriptions</span>
</span><span id="__span-33-103"><a id="__codelineno-33-103" name="__codelineno-33-103" href="#__codelineno-33-103"></a><span class="k">function</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="p">{</span>
</span><span id="__span-33-104"><a id="__codelineno-33-104" name="__codelineno-33-104" href="#__codelineno-33-104"></a>    <span class="k">param</span><span class="p">(</span><span class="no">[array]</span><span class="nv">$TargetVMNames</span><span class="p">)</span>
</span><span id="__span-33-105"><a id="__codelineno-33-105" name="__codelineno-33-105" href="#__codelineno-33-105"></a>
</span><span id="__span-33-106"><a id="__codelineno-33-106" name="__codelineno-33-106" href="#__codelineno-33-106"></a>    <span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-33-107"><a id="__codelineno-33-107" name="__codelineno-33-107" href="#__codelineno-33-107"></a>    <span class="nv">$vmInventory</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-33-108"><a id="__codelineno-33-108" name="__codelineno-33-108" href="#__codelineno-33-108"></a>
</span><span id="__span-33-109"><a id="__codelineno-33-109" name="__codelineno-33-109" href="#__codelineno-33-109"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-110"><a id="__codelineno-33-110" name="__codelineno-33-110" href="#__codelineno-33-110"></a>        <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-33-111"><a id="__codelineno-33-111" name="__codelineno-33-111" href="#__codelineno-33-111"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-33-112"><a id="__codelineno-33-112" name="__codelineno-33-112" href="#__codelineno-33-112"></a>            <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-33-113"><a id="__codelineno-33-113" name="__codelineno-33-113" href="#__codelineno-33-113"></a>
</span><span id="__span-33-114"><a id="__codelineno-33-114" name="__codelineno-33-114" href="#__codelineno-33-114"></a>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-115"><a id="__codelineno-33-115" name="__codelineno-33-115" href="#__codelineno-33-115"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span> <span class="n">-in</span> <span class="nv">$TargetVMNames</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-116"><a id="__codelineno-33-116" name="__codelineno-33-116" href="#__codelineno-33-116"></a>                    <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-33-117"><a id="__codelineno-33-117" name="__codelineno-33-117" href="#__codelineno-33-117"></a>                        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-33-118"><a id="__codelineno-33-118" name="__codelineno-33-118" href="#__codelineno-33-118"></a>                        <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-33-119"><a id="__codelineno-33-119" name="__codelineno-33-119" href="#__codelineno-33-119"></a>                        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-33-120"><a id="__codelineno-33-120" name="__codelineno-33-120" href="#__codelineno-33-120"></a>                        <span class="n">SubscriptionName</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-33-121"><a id="__codelineno-33-121" name="__codelineno-33-121" href="#__codelineno-33-121"></a>                        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-33-122"><a id="__codelineno-33-122" name="__codelineno-33-122" href="#__codelineno-33-122"></a>                    <span class="p">}</span>
</span><span id="__span-33-123"><a id="__codelineno-33-123" name="__codelineno-33-123" href="#__codelineno-33-123"></a>                <span class="p">}</span>
</span><span id="__span-33-124"><a id="__codelineno-33-124" name="__codelineno-33-124" href="#__codelineno-33-124"></a>            <span class="p">}</span>
</span><span id="__span-33-125"><a id="__codelineno-33-125" name="__codelineno-33-125" href="#__codelineno-33-125"></a>        <span class="p">}</span>
</span><span id="__span-33-126"><a id="__codelineno-33-126" name="__codelineno-33-126" href="#__codelineno-33-126"></a>        <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-33-127"><a id="__codelineno-33-127" name="__codelineno-33-127" href="#__codelineno-33-127"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-33-128"><a id="__codelineno-33-128" name="__codelineno-33-128" href="#__codelineno-33-128"></a>        <span class="p">}</span>
</span><span id="__span-33-129"><a id="__codelineno-33-129" name="__codelineno-33-129" href="#__codelineno-33-129"></a>    <span class="p">}</span>
</span><span id="__span-33-130"><a id="__codelineno-33-130" name="__codelineno-33-130" href="#__codelineno-33-130"></a>
</span><span id="__span-33-131"><a id="__codelineno-33-131" name="__codelineno-33-131" href="#__codelineno-33-131"></a>    <span class="k">return</span> <span class="nv">$vmInventory</span>
</span><span id="__span-33-132"><a id="__codelineno-33-132" name="__codelineno-33-132" href="#__codelineno-33-132"></a><span class="p">}</span>
</span><span id="__span-33-133"><a id="__codelineno-33-133" name="__codelineno-33-133" href="#__codelineno-33-133"></a>
</span><span id="__span-33-134"><a id="__codelineno-33-134" name="__codelineno-33-134" href="#__codelineno-33-134"></a><span class="c"># Get all unique VM names and discover their locations</span>
</span><span id="__span-33-135"><a id="__codelineno-33-135" name="__codelineno-33-135" href="#__codelineno-33-135"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-33-136"><a id="__codelineno-33-136" name="__codelineno-33-136" href="#__codelineno-33-136"></a><span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$allTargetVMs</span> <span class="p">+=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">VMs</span> <span class="p">}</span>
</span><span id="__span-33-137"><a id="__codelineno-33-137" name="__codelineno-33-137" href="#__codelineno-33-137"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="nv">$allTargetVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Unique</span>
</span><span id="__span-33-138"><a id="__codelineno-33-138" name="__codelineno-33-138" href="#__codelineno-33-138"></a>
</span><span id="__span-33-139"><a id="__codelineno-33-139" name="__codelineno-33-139" href="#__codelineno-33-139"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Discovering locations for </span><span class="p">$(</span><span class="nv">$allTargetVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> target VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-33-140"><a id="__codelineno-33-140" name="__codelineno-33-140" href="#__codelineno-33-140"></a><span class="nv">$vmInventory</span> <span class="p">=</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="n">-TargetVMNames</span> <span class="nv">$allTargetVMs</span>
</span><span id="__span-33-141"><a id="__codelineno-33-141" name="__codelineno-33-141" href="#__codelineno-33-141"></a>
</span><span id="__span-33-142"><a id="__codelineno-33-142" name="__codelineno-33-142" href="#__codelineno-33-142"></a><span class="c"># Process each maintenance window</span>
</span><span id="__span-33-143"><a id="__codelineno-33-143" name="__codelineno-33-143" href="#__codelineno-33-143"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-33-144"><a id="__codelineno-33-144" name="__codelineno-33-144" href="#__codelineno-33-144"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-33-145"><a id="__codelineno-33-145" name="__codelineno-33-145" href="#__codelineno-33-145"></a>
</span><span id="__span-33-146"><a id="__codelineno-33-146" name="__codelineno-33-146" href="#__codelineno-33-146"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$windowName</span> <span class="k">in</span> <span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-147"><a id="__codelineno-33-147" name="__codelineno-33-147" href="#__codelineno-33-147"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$maintenanceGroups</span><span class="p">[</span><span class="nv">$windowName</span><span class="p">]</span>
</span><span id="__span-33-148"><a id="__codelineno-33-148" name="__codelineno-33-148" href="#__codelineno-33-148"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $windowName MAINTENANCE WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-33-149"><a id="__codelineno-33-149" name="__codelineno-33-149" href="#__codelineno-33-149"></a>
</span><span id="__span-33-150"><a id="__codelineno-33-150" name="__codelineno-33-150" href="#__codelineno-33-150"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmName</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-33-151"><a id="__codelineno-33-151" name="__codelineno-33-151" href="#__codelineno-33-151"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vmInventory</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$vmName</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-33-152"><a id="__codelineno-33-152" name="__codelineno-33-152" href="#__codelineno-33-152"></a>            <span class="nv">$vmInfo</span> <span class="p">=</span> <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vmName</span><span class="p">]</span>
</span><span id="__span-33-153"><a id="__codelineno-33-153" name="__codelineno-33-153" href="#__codelineno-33-153"></a>            <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">ResourceGroupName</span> <span class="n">-SubscriptionId</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">SubscriptionId</span> <span class="n">-Tags</span> <span class="nv">$group</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$windowName</span>
</span><span id="__span-33-154"><a id="__codelineno-33-154" name="__codelineno-33-154" href="#__codelineno-33-154"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$totalSuccess</span><span class="p">++</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nv">$totalFailed</span><span class="p">++</span> <span class="p">}</span>
</span><span id="__span-33-155"><a id="__codelineno-33-155" name="__codelineno-33-155" href="#__codelineno-33-155"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-33-156"><a id="__codelineno-33-156" name="__codelineno-33-156" href="#__codelineno-33-156"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;  ⚠️ VM not found: $vmName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-33-157"><a id="__codelineno-33-157" name="__codelineno-33-157" href="#__codelineno-33-157"></a>            <span class="nv">$totalFailed</span><span class="p">++</span>
</span><span id="__span-33-158"><a id="__codelineno-33-158" name="__codelineno-33-158" href="#__codelineno-33-158"></a>        <span class="p">}</span>
</span><span id="__span-33-159"><a id="__codelineno-33-159" name="__codelineno-33-159" href="#__codelineno-33-159"></a>    <span class="p">}</span>
</span><span id="__span-33-160"><a id="__codelineno-33-160" name="__codelineno-33-160" href="#__codelineno-33-160"></a><span class="p">}</span>
</span><span id="__span-33-161"><a id="__codelineno-33-161" name="__codelineno-33-161" href="#__codelineno-33-161"></a>
</span><span id="__span-33-162"><a id="__codelineno-33-162" name="__codelineno-33-162" href="#__codelineno-33-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-33-163"><a id="__codelineno-33-163" name="__codelineno-33-163" href="#__codelineno-33-163"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-33-164"><a id="__codelineno-33-164" name="__codelineno-33-164" href="#__codelineno-33-164"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></code></pre></div>

</details>

<h4 id="handle-the-stragglers"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#handle-the-stragglers">🧹 Handle the Stragglers</a></h4>
<p>For the 12 VMs not in the original MSP schedule, I used intelligent assignment based on their function:</p>
<details>
<summary>Click to expand: Tagging Script for Remaining Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c"># Intelligent VM Tagging Script for Remaining Untagged VMs</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="c"># This script analyzes and tags the remaining VMs based on workload patterns and load balancing</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Intelligent VM Tagging for Remaining VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Analyzing and tagging 26 untagged VMs with optimal maintenance window distribution...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="c"># Function to safely tag a VM across subscriptions</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>    <span class="p">)</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>        <span class="nv">$currentContext</span> <span class="p">=</span> <span class="nb">Get-AzContext</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$currentContext</span><span class="p">.</span><span class="n">Subscription</span><span class="p">.</span><span class="n">Id</span> <span class="o">-ne</span> <span class="nv">$SubscriptionId</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>        <span class="p">}</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>        <span class="c"># Get the VM</span>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a>        <span class="c"># Add maintenance tags to existing tags (preserve existing tags)</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a>                <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a>            <span class="p">}</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a>        <span class="p">}</span>
</span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a>
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a>        <span class="c"># Update the VM tags</span>
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a>
</span><span id="__span-34-45"><a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-34-46"><a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a>    <span class="p">}</span>
</span><span id="__span-34-47"><a id="__codelineno-34-47" name="__codelineno-34-47" href="#__codelineno-34-47"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-34-48"><a id="__codelineno-34-48" name="__codelineno-34-48" href="#__codelineno-34-48"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-34-49"><a id="__codelineno-34-49" name="__codelineno-34-49" href="#__codelineno-34-49"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-34-50"><a id="__codelineno-34-50" name="__codelineno-34-50" href="#__codelineno-34-50"></a>    <span class="p">}</span>
</span><span id="__span-34-51"><a id="__codelineno-34-51" name="__codelineno-34-51" href="#__codelineno-34-51"></a><span class="p">}</span>
</span><span id="__span-34-52"><a id="__codelineno-34-52" name="__codelineno-34-52" href="#__codelineno-34-52"></a>
</span><span id="__span-34-53"><a id="__codelineno-34-53" name="__codelineno-34-53" href="#__codelineno-34-53"></a><span class="c"># Define current maintenance window loads (after existing 59 VMs)</span>
</span><span id="__span-34-54"><a id="__codelineno-34-54" name="__codelineno-34-54" href="#__codelineno-34-54"></a><span class="nv">$currentLoad</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-55"><a id="__codelineno-34-55" name="__codelineno-34-55" href="#__codelineno-34-55"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">7</span>
</span><span id="__span-34-56"><a id="__codelineno-34-56" name="__codelineno-34-56" href="#__codelineno-34-56"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">7</span> 
</span><span id="__span-34-57"><a id="__codelineno-34-57" name="__codelineno-34-57" href="#__codelineno-34-57"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">10</span>
</span><span id="__span-34-58"><a id="__codelineno-34-58" name="__codelineno-34-58" href="#__codelineno-34-58"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-34-59"><a id="__codelineno-34-59" name="__codelineno-34-59" href="#__codelineno-34-59"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-34-60"><a id="__codelineno-34-60" name="__codelineno-34-60" href="#__codelineno-34-60"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">17</span>  <span class="c"># Dev/Test at 09:00</span>
</span><span id="__span-34-61"><a id="__codelineno-34-61" name="__codelineno-34-61" href="#__codelineno-34-61"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-34-62"><a id="__codelineno-34-62" name="__codelineno-34-62" href="#__codelineno-34-62"></a><span class="p">}</span>
</span><span id="__span-34-63"><a id="__codelineno-34-63" name="__codelineno-34-63" href="#__codelineno-34-63"></a>
</span><span id="__span-34-64"><a id="__codelineno-34-64" name="__codelineno-34-64" href="#__codelineno-34-64"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== CURRENT MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-65"><a id="__codelineno-34-65" name="__codelineno-34-65" href="#__codelineno-34-65"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-34-66"><a id="__codelineno-34-66" name="__codelineno-34-66" href="#__codelineno-34-66"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-67"><a id="__codelineno-34-67" name="__codelineno-34-67" href="#__codelineno-34-67"></a><span class="p">}</span>
</span><span id="__span-34-68"><a id="__codelineno-34-68" name="__codelineno-34-68" href="#__codelineno-34-68"></a>
</span><span id="__span-34-69"><a id="__codelineno-34-69" name="__codelineno-34-69" href="#__codelineno-34-69"></a><span class="c"># Initialize counters for new assignments</span>
</span><span id="__span-34-70"><a id="__codelineno-34-70" name="__codelineno-34-70" href="#__codelineno-34-70"></a><span class="nv">$newAssignments</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-71"><a id="__codelineno-34-71" name="__codelineno-34-71" href="#__codelineno-34-71"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-72"><a id="__codelineno-34-72" name="__codelineno-34-72" href="#__codelineno-34-72"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-73"><a id="__codelineno-34-73" name="__codelineno-34-73" href="#__codelineno-34-73"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-74"><a id="__codelineno-34-74" name="__codelineno-34-74" href="#__codelineno-34-74"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-75"><a id="__codelineno-34-75" name="__codelineno-34-75" href="#__codelineno-34-75"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-76"><a id="__codelineno-34-76" name="__codelineno-34-76" href="#__codelineno-34-76"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">0</span>  <span class="c"># Will use sat-09 for dev/test</span>
</span><span id="__span-34-77"><a id="__codelineno-34-77" name="__codelineno-34-77" href="#__codelineno-34-77"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-78"><a id="__codelineno-34-78" name="__codelineno-34-78" href="#__codelineno-34-78"></a><span class="p">}</span>
</span><span id="__span-34-79"><a id="__codelineno-34-79" name="__codelineno-34-79" href="#__codelineno-34-79"></a>
</span><span id="__span-34-80"><a id="__codelineno-34-80" name="__codelineno-34-80" href="#__codelineno-34-80"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-81"><a id="__codelineno-34-81" name="__codelineno-34-81" href="#__codelineno-34-81"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== INTELLIGENT VM GROUPING AND ASSIGNMENT ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-82"><a id="__codelineno-34-82" name="__codelineno-34-82" href="#__codelineno-34-82"></a>
</span><span id="__span-34-83"><a id="__codelineno-34-83" name="__codelineno-34-83" href="#__codelineno-34-83"></a><span class="c"># Define VM groups with intelligent maintenance window assignments</span>
</span><span id="__span-34-84"><a id="__codelineno-34-84" name="__codelineno-34-84" href="#__codelineno-34-84"></a><span class="nv">$vmGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-85"><a id="__codelineno-34-85" name="__codelineno-34-85" href="#__codelineno-34-85"></a>
</span><span id="__span-34-86"><a id="__codelineno-34-86" name="__codelineno-34-86" href="#__codelineno-34-86"></a>    <span class="c"># CRITICAL PRODUCTION SYSTEMS - Spread across different days</span>
</span><span id="__span-34-87"><a id="__codelineno-34-87" name="__codelineno-34-87" href="#__codelineno-34-87"></a>    <span class="s2">&quot;Critical Infrastructure&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-88"><a id="__codelineno-34-88" name="__codelineno-34-88" href="#__codelineno-34-88"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-34-89"><a id="__codelineno-34-89" name="__codelineno-34-89" href="#__codelineno-34-89"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Sunday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - critical infrastructure&quot;</span> <span class="p">},</span>
</span><span id="__span-34-90"><a id="__codelineno-34-90" name="__codelineno-34-90" href="#__codelineno-34-90"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - spread from other DCs&quot;</span> <span class="p">},</span>
</span><span id="__span-34-91"><a id="__codelineno-34-91" name="__codelineno-34-91" href="#__codelineno-34-91"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-backup&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Backup Server - spread across week&quot;</span> <span class="p">}</span>
</span><span id="__span-34-92"><a id="__codelineno-34-92" name="__codelineno-34-92" href="#__codelineno-34-92"></a>        <span class="p">)</span>
</span><span id="__span-34-93"><a id="__codelineno-34-93" name="__codelineno-34-93" href="#__codelineno-34-93"></a>    <span class="p">}</span>
</span><span id="__span-34-94"><a id="__codelineno-34-94" name="__codelineno-34-94" href="#__codelineno-34-94"></a>
</span><span id="__span-34-95"><a id="__codelineno-34-95" name="__codelineno-34-95" href="#__codelineno-34-95"></a>    <span class="c"># PRODUCTION BUSINESS APPLICATIONS - Spread for business continuity</span>
</span><span id="__span-34-96"><a id="__codelineno-34-96" name="__codelineno-34-96" href="#__codelineno-34-96"></a>    <span class="s2">&quot;Production Applications&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-97"><a id="__codelineno-34-97" name="__codelineno-34-97" href="#__codelineno-34-97"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-34-98"><a id="__codelineno-34-98" name="__codelineno-34-98" href="#__codelineno-34-98"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Server - Monday for week start&quot;</span> <span class="p">},</span>
</span><span id="__span-34-99"><a id="__codelineno-34-99" name="__codelineno-34-99" href="#__codelineno-34-99"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Server - Tuesday&quot;</span> <span class="p">},</span>
</span><span id="__span-34-100"><a id="__codelineno-34-100" name="__codelineno-34-100" href="#__codelineno-34-100"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-app-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Wednesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Application Server - mid-week&quot;</span> <span class="p">}</span>
</span><span id="__span-34-101"><a id="__codelineno-34-101" name="__codelineno-34-101" href="#__codelineno-34-101"></a>        <span class="p">)</span>
</span><span id="__span-34-102"><a id="__codelineno-34-102" name="__codelineno-34-102" href="#__codelineno-34-102"></a>    <span class="p">}</span>
</span><span id="__span-34-103"><a id="__codelineno-34-103" name="__codelineno-34-103" href="#__codelineno-34-103"></a>
</span><span id="__span-34-104"><a id="__codelineno-34-104" name="__codelineno-34-104" href="#__codelineno-34-104"></a>    <span class="c"># DEV/TEST SYSTEMS - Saturday morning maintenance (like existing dev/test)</span>
</span><span id="__span-34-105"><a id="__codelineno-34-105" name="__codelineno-34-105" href="#__codelineno-34-105"></a>    <span class="s2">&quot;Development Systems&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-106"><a id="__codelineno-34-106" name="__codelineno-34-106" href="#__codelineno-34-106"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-34-107"><a id="__codelineno-34-107" name="__codelineno-34-107" href="#__codelineno-34-107"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-34-108"><a id="__codelineno-34-108" name="__codelineno-34-108" href="#__codelineno-34-108"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-34-109"><a id="__codelineno-34-109" name="__codelineno-34-109" href="#__codelineno-34-109"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-testing&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Test Server - join existing dev/test window&quot;</span> <span class="p">}</span>
</span><span id="__span-34-110"><a id="__codelineno-34-110" name="__codelineno-34-110" href="#__codelineno-34-110"></a>            <span class="c"># ... additional dev/test VMs</span>
</span><span id="__span-34-111"><a id="__codelineno-34-111" name="__codelineno-34-111" href="#__codelineno-34-111"></a>        <span class="p">)</span>
</span><span id="__span-34-112"><a id="__codelineno-34-112" name="__codelineno-34-112" href="#__codelineno-34-112"></a>    <span class="p">}</span>
</span><span id="__span-34-113"><a id="__codelineno-34-113" name="__codelineno-34-113" href="#__codelineno-34-113"></a><span class="p">}</span>
</span><span id="__span-34-114"><a id="__codelineno-34-114" name="__codelineno-34-114" href="#__codelineno-34-114"></a>
</span><span id="__span-34-115"><a id="__codelineno-34-115" name="__codelineno-34-115" href="#__codelineno-34-115"></a><span class="c"># Initialize counters</span>
</span><span id="__span-34-116"><a id="__codelineno-34-116" name="__codelineno-34-116" href="#__codelineno-34-116"></a><span class="nv">$totalProcessed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-117"><a id="__codelineno-34-117" name="__codelineno-34-117" href="#__codelineno-34-117"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-118"><a id="__codelineno-34-118" name="__codelineno-34-118" href="#__codelineno-34-118"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-34-119"><a id="__codelineno-34-119" name="__codelineno-34-119" href="#__codelineno-34-119"></a>
</span><span id="__span-34-120"><a id="__codelineno-34-120" name="__codelineno-34-120" href="#__codelineno-34-120"></a><span class="c"># Process each group</span>
</span><span id="__span-34-121"><a id="__codelineno-34-121" name="__codelineno-34-121" href="#__codelineno-34-121"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$groupName</span> <span class="k">in</span> <span class="nv">$vmGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-122"><a id="__codelineno-34-122" name="__codelineno-34-122" href="#__codelineno-34-122"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$vmGroups</span><span class="p">[</span><span class="nv">$groupName</span><span class="p">]</span>
</span><span id="__span-34-123"><a id="__codelineno-34-123" name="__codelineno-34-123" href="#__codelineno-34-123"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $groupName ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-34-124"><a id="__codelineno-34-124" name="__codelineno-34-124" href="#__codelineno-34-124"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Processing </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs in this group&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-125"><a id="__codelineno-34-125" name="__codelineno-34-125" href="#__codelineno-34-125"></a>
</span><span id="__span-34-126"><a id="__codelineno-34-126" name="__codelineno-34-126" href="#__codelineno-34-126"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmInfo</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-127"><a id="__codelineno-34-127" name="__codelineno-34-127" href="#__codelineno-34-127"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Window</span>
</span><span id="__span-34-128"><a id="__codelineno-34-128" name="__codelineno-34-128" href="#__codelineno-34-128"></a>        <span class="nv">$vmName</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-34-129"><a id="__codelineno-34-129" name="__codelineno-34-129" href="#__codelineno-34-129"></a>
</span><span id="__span-34-130"><a id="__codelineno-34-130" name="__codelineno-34-130" href="#__codelineno-34-130"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">�️ $vmName → $window maintenance window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-34-131"><a id="__codelineno-34-131" name="__codelineno-34-131" href="#__codelineno-34-131"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;   Reason: </span><span class="p">$(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Reason</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-34-132"><a id="__codelineno-34-132" name="__codelineno-34-132" href="#__codelineno-34-132"></a>
</span><span id="__span-34-133"><a id="__codelineno-34-133" name="__codelineno-34-133" href="#__codelineno-34-133"></a>        <span class="c"># Determine subscription ID from name</span>
</span><span id="__span-34-134"><a id="__codelineno-34-134" name="__codelineno-34-134" href="#__codelineno-34-134"></a>        <span class="nv">$subscriptionId</span> <span class="p">=</span> <span class="k">switch</span> <span class="p">(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Sub</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-135"><a id="__codelineno-34-135" name="__codelineno-34-135" href="#__codelineno-34-135"></a>            <span class="s2">&quot;Production&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Production&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-34-136"><a id="__codelineno-34-136" name="__codelineno-34-136" href="#__codelineno-34-136"></a>            <span class="s2">&quot;DevTest&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DevTest&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-34-137"><a id="__codelineno-34-137" name="__codelineno-34-137" href="#__codelineno-34-137"></a>            <span class="s2">&quot;Identity&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Identity&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-34-138"><a id="__codelineno-34-138" name="__codelineno-34-138" href="#__codelineno-34-138"></a>            <span class="s2">&quot;DMZ&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DMZ&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-34-139"><a id="__codelineno-34-139" name="__codelineno-34-139" href="#__codelineno-34-139"></a>        <span class="p">}</span>
</span><span id="__span-34-140"><a id="__codelineno-34-140" name="__codelineno-34-140" href="#__codelineno-34-140"></a>
</span><span id="__span-34-141"><a id="__codelineno-34-141" name="__codelineno-34-141" href="#__codelineno-34-141"></a>        <span class="c"># Create appropriate tags based on maintenance window</span>
</span><span id="__span-34-142"><a id="__codelineno-34-142" name="__codelineno-34-142" href="#__codelineno-34-142"></a>        <span class="nv">$tags</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-34-143"><a id="__codelineno-34-143" name="__codelineno-34-143" href="#__codelineno-34-143"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-34-144"><a id="__codelineno-34-144" name="__codelineno-34-144" href="#__codelineno-34-144"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-34-145"><a id="__codelineno-34-145" name="__codelineno-34-145" href="#__codelineno-34-145"></a>        <span class="p">}</span>
</span><span id="__span-34-146"><a id="__codelineno-34-146" name="__codelineno-34-146" href="#__codelineno-34-146"></a>
</span><span id="__span-34-147"><a id="__codelineno-34-147" name="__codelineno-34-147" href="#__codelineno-34-147"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$window</span> <span class="o">-eq</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-148"><a id="__codelineno-34-148" name="__codelineno-34-148" href="#__codelineno-34-148"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>  <span class="c"># Saturday 09:00 for dev/test</span>
</span><span id="__span-34-149"><a id="__codelineno-34-149" name="__codelineno-34-149" href="#__codelineno-34-149"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-34-150"><a id="__codelineno-34-150" name="__codelineno-34-150" href="#__codelineno-34-150"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$window</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  <span class="c"># mon, tue, wed, etc.</span>
</span><span id="__span-34-151"><a id="__codelineno-34-151" name="__codelineno-34-151" href="#__codelineno-34-151"></a>        <span class="p">}</span>
</span><span id="__span-34-152"><a id="__codelineno-34-152" name="__codelineno-34-152" href="#__codelineno-34-152"></a>
</span><span id="__span-34-153"><a id="__codelineno-34-153" name="__codelineno-34-153" href="#__codelineno-34-153"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">RG</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscriptionId</span> <span class="n">-Tags</span> <span class="nv">$tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$window</span>
</span><span id="__span-34-154"><a id="__codelineno-34-154" name="__codelineno-34-154" href="#__codelineno-34-154"></a>
</span><span id="__span-34-155"><a id="__codelineno-34-155" name="__codelineno-34-155" href="#__codelineno-34-155"></a>        <span class="nv">$totalProcessed</span><span class="p">++</span>
</span><span id="__span-34-156"><a id="__codelineno-34-156" name="__codelineno-34-156" href="#__codelineno-34-156"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> 
</span><span id="__span-34-157"><a id="__codelineno-34-157" name="__codelineno-34-157" href="#__codelineno-34-157"></a>            <span class="nv">$totalSuccess</span><span class="p">++</span>
</span><span id="__span-34-158"><a id="__codelineno-34-158" name="__codelineno-34-158" href="#__codelineno-34-158"></a>            <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-34-159"><a id="__codelineno-34-159" name="__codelineno-34-159" href="#__codelineno-34-159"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span><span id="__span-34-160"><a id="__codelineno-34-160" name="__codelineno-34-160" href="#__codelineno-34-160"></a>            <span class="nv">$totalFailed</span><span class="p">++</span> 
</span><span id="__span-34-161"><a id="__codelineno-34-161" name="__codelineno-34-161" href="#__codelineno-34-161"></a>        <span class="p">}</span>
</span><span id="__span-34-162"><a id="__codelineno-34-162" name="__codelineno-34-162" href="#__codelineno-34-162"></a>    <span class="p">}</span>
</span><span id="__span-34-163"><a id="__codelineno-34-163" name="__codelineno-34-163" href="#__codelineno-34-163"></a><span class="p">}</span>
</span><span id="__span-34-164"><a id="__codelineno-34-164" name="__codelineno-34-164" href="#__codelineno-34-164"></a>
</span><span id="__span-34-165"><a id="__codelineno-34-165" name="__codelineno-34-165" href="#__codelineno-34-165"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-166"><a id="__codelineno-34-166" name="__codelineno-34-166" href="#__codelineno-34-166"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-167"><a id="__codelineno-34-167" name="__codelineno-34-167" href="#__codelineno-34-167"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs processed: $totalProcessed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-168"><a id="__codelineno-34-168" name="__codelineno-34-168" href="#__codelineno-34-168"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-169"><a id="__codelineno-34-169" name="__codelineno-34-169" href="#__codelineno-34-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-34-170"><a id="__codelineno-34-170" name="__codelineno-34-170" href="#__codelineno-34-170"></a>
</span><span id="__span-34-171"><a id="__codelineno-34-171" name="__codelineno-34-171" href="#__codelineno-34-171"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-172"><a id="__codelineno-34-172" name="__codelineno-34-172" href="#__codelineno-34-172"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEW MAINTENANCE WINDOW DISTRIBUTION ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-173"><a id="__codelineno-34-173" name="__codelineno-34-173" href="#__codelineno-34-173"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs added to each maintenance window:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-174"><a id="__codelineno-34-174" name="__codelineno-34-174" href="#__codelineno-34-174"></a>
</span><span id="__span-34-175"><a id="__codelineno-34-175" name="__codelineno-34-175" href="#__codelineno-34-175"></a><span class="nv">$newAssignments</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-34-176"><a id="__codelineno-34-176" name="__codelineno-34-176" href="#__codelineno-34-176"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-177"><a id="__codelineno-34-177" name="__codelineno-34-177" href="#__codelineno-34-177"></a>        <span class="nv">$newTotal</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-34-178"><a id="__codelineno-34-178" name="__codelineno-34-178" href="#__codelineno-34-178"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: +</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs (total: $newTotal VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-179"><a id="__codelineno-34-179" name="__codelineno-34-179" href="#__codelineno-34-179"></a>    <span class="p">}</span>
</span><span id="__span-34-180"><a id="__codelineno-34-180" name="__codelineno-34-180" href="#__codelineno-34-180"></a><span class="p">}</span>
</span><span id="__span-34-181"><a id="__codelineno-34-181" name="__codelineno-34-181" href="#__codelineno-34-181"></a>
</span><span id="__span-34-182"><a id="__codelineno-34-182" name="__codelineno-34-182" href="#__codelineno-34-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-183"><a id="__codelineno-34-183" name="__codelineno-34-183" href="#__codelineno-34-183"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== FINAL MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-184"><a id="__codelineno-34-184" name="__codelineno-34-184" href="#__codelineno-34-184"></a><span class="nv">$finalLoad</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-34-185"><a id="__codelineno-34-185" name="__codelineno-34-185" href="#__codelineno-34-185"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-34-186"><a id="__codelineno-34-186" name="__codelineno-34-186" href="#__codelineno-34-186"></a>    <span class="nv">$finalLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-34-187"><a id="__codelineno-34-187" name="__codelineno-34-187" href="#__codelineno-34-187"></a><span class="p">}</span>
</span><span id="__span-34-188"><a id="__codelineno-34-188" name="__codelineno-34-188" href="#__codelineno-34-188"></a>
</span><span id="__span-34-189"><a id="__codelineno-34-189" name="__codelineno-34-189" href="#__codelineno-34-189"></a><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-34-190"><a id="__codelineno-34-190" name="__codelineno-34-190" href="#__codelineno-34-190"></a>    <span class="nv">$status</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">8</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Green&quot;</span> <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">12</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Yellow&quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;Red&quot;</span> <span class="p">}</span>
</span><span id="__span-34-191"><a id="__codelineno-34-191" name="__codelineno-34-191" href="#__codelineno-34-191"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="nv">$status</span>
</span><span id="__span-34-192"><a id="__codelineno-34-192" name="__codelineno-34-192" href="#__codelineno-34-192"></a><span class="p">}</span>
</span><span id="__span-34-193"><a id="__codelineno-34-193" name="__codelineno-34-193" href="#__codelineno-34-193"></a>
</span><span id="__span-34-194"><a id="__codelineno-34-194" name="__codelineno-34-194" href="#__codelineno-34-194"></a><span class="nv">$grandTotal</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="nb">Measure-Object</span> <span class="n">-Sum</span><span class="p">).</span><span class="n">Sum</span>
</span><span id="__span-34-195"><a id="__codelineno-34-195" name="__codelineno-34-195" href="#__codelineno-34-195"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Grand Total: $grandTotal VMs across all maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-196"><a id="__codelineno-34-196" name="__codelineno-34-196" href="#__codelineno-34-196"></a>
</span><span id="__span-34-197"><a id="__codelineno-34-197" name="__codelineno-34-197" href="#__codelineno-34-197"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-198"><a id="__codelineno-34-198" name="__codelineno-34-198" href="#__codelineno-34-198"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== BUSINESS LOGIC APPLIED ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-199"><a id="__codelineno-34-199" name="__codelineno-34-199" href="#__codelineno-34-199"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Critical systems spread across different days for resilience&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-200"><a id="__codelineno-34-200" name="__codelineno-34-200" href="#__codelineno-34-200"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Domain Controllers distributed to avoid single points of failure&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-201"><a id="__codelineno-34-201" name="__codelineno-34-201" href="#__codelineno-34-201"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Dev/Test systems consolidated to Saturday morning (existing pattern)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-202"><a id="__codelineno-34-202" name="__codelineno-34-202" href="#__codelineno-34-202"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Production workstations spread to minimize user impact&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-203"><a id="__codelineno-34-203" name="__codelineno-34-203" href="#__codelineno-34-203"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Business applications distributed for operational continuity&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-204"><a id="__codelineno-34-204" name="__codelineno-34-204" href="#__codelineno-34-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Load balancing maintained across the week&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-205"><a id="__codelineno-34-205" name="__codelineno-34-205" href="#__codelineno-34-205"></a>
</span><span id="__span-34-206"><a id="__codelineno-34-206" name="__codelineno-34-206" href="#__codelineno-34-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-207"><a id="__codelineno-34-207" name="__codelineno-34-207" href="#__codelineno-34-207"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VERIFICATION STEPS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-208"><a id="__codelineno-34-208" name="__codelineno-34-208" href="#__codelineno-34-208"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Verify tags in Azure Portal across all subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-209"><a id="__codelineno-34-209" name="__codelineno-34-209" href="#__codelineno-34-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Check that critical systems are on different days&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-210"><a id="__codelineno-34-210" name="__codelineno-34-210" href="#__codelineno-34-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Confirm dev/test systems are in Saturday morning window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-211"><a id="__codelineno-34-211" name="__codelineno-34-211" href="#__codelineno-34-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Review production systems distribution&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-212"><a id="__codelineno-34-212" name="__codelineno-34-212" href="#__codelineno-34-212"></a>
</span><span id="__span-34-213"><a id="__codelineno-34-213" name="__codelineno-34-213" href="#__codelineno-34-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-214"><a id="__codelineno-34-214" name="__codelineno-34-214" href="#__codelineno-34-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH VERIFICATION QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-215"><a id="__codelineno-34-215" name="__codelineno-34-215" href="#__codelineno-34-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query to verify all VMs are now tagged:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-34-216"><a id="__codelineno-34-216" name="__codelineno-34-216" href="#__codelineno-34-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-217"><a id="__codelineno-34-217" name="__codelineno-34-217" href="#__codelineno-34-217"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-34-218"><a id="__codelineno-34-218" name="__codelineno-34-218" href="#__codelineno-34-218"></a><span class="sh">Resources</span>
</span><span id="__span-34-219"><a id="__codelineno-34-219" name="__codelineno-34-219" href="#__codelineno-34-219"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-34-220"><a id="__codelineno-34-220" name="__codelineno-34-220" href="#__codelineno-34-220"></a><span class="sh">| where tags.Updates == &quot;Azure Update Manager&quot;</span>
</span><span id="__span-34-221"><a id="__codelineno-34-221" name="__codelineno-34-221" href="#__codelineno-34-221"></a><span class="sh">| project name, resourceGroup, subscriptionId, </span>
</span><span id="__span-34-222"><a id="__codelineno-34-222" name="__codelineno-34-222" href="#__codelineno-34-222"></a><span class="sh">          patchWindow = tags.PatchWindow,</span>
</span><span id="__span-34-223"><a id="__codelineno-34-223" name="__codelineno-34-223" href="#__codelineno-34-223"></a><span class="sh">          owner = tags.Owner,</span>
</span><span id="__span-34-224"><a id="__codelineno-34-224" name="__codelineno-34-224" href="#__codelineno-34-224"></a><span class="sh">          updates = tags.Updates</span>
</span><span id="__span-34-225"><a id="__codelineno-34-225" name="__codelineno-34-225" href="#__codelineno-34-225"></a><span class="sh">| sort by patchWindow, name</span>
</span><span id="__span-34-226"><a id="__codelineno-34-226" name="__codelineno-34-226" href="#__codelineno-34-226"></a><span class="sh">| summarize count() by patchWindow</span>
</span><span id="__span-34-227"><a id="__codelineno-34-227" name="__codelineno-34-227" href="#__codelineno-34-227"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-34-228"><a id="__codelineno-34-228" name="__codelineno-34-228" href="#__codelineno-34-228"></a>
</span><span id="__span-34-229"><a id="__codelineno-34-229" name="__codelineno-34-229" href="#__codelineno-34-229"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$totalFailed</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-34-230"><a id="__codelineno-34-230" name="__codelineno-34-230" href="#__codelineno-34-230"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-231"><a id="__codelineno-34-231" name="__codelineno-34-231" href="#__codelineno-34-231"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs SUCCESSFULLY TAGGED WITH INTELLIGENT DISTRIBUTION! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-34-232"><a id="__codelineno-34-232" name="__codelineno-34-232" href="#__codelineno-34-232"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-34-233"><a id="__codelineno-34-233" name="__codelineno-34-233" href="#__codelineno-34-233"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-234"><a id="__codelineno-34-234" name="__codelineno-34-234" href="#__codelineno-34-234"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;⚠️ Some VMs failed to tag. Please review errors above.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-34-235"><a id="__codelineno-34-235" name="__codelineno-34-235" href="#__codelineno-34-235"></a><span class="p">}</span>
</span><span id="__span-34-236"><a id="__codelineno-34-236" name="__codelineno-34-236" href="#__codelineno-34-236"></a>
</span><span id="__span-34-237"><a id="__codelineno-34-237" name="__codelineno-34-237" href="#__codelineno-34-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-34-238"><a id="__codelineno-34-238" name="__codelineno-34-238" href="#__codelineno-34-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-34-239"><a id="__codelineno-34-239" name="__codelineno-34-239" href="#__codelineno-34-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<blockquote>
<p><strong>Key insight:</strong> I grouped VMs by function and criticality, not just by convenience. Domain controllers got spread across different days, dev/test systems joined the existing Saturday morning window, and production applications were distributed for business continuity.</p>
</blockquote>
<hr />
<h3 id="step-7-configure-azure-policy-prerequisites"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-7-configure-azure-policy-prerequisites">🧰 Step 7 – Configure Azure Policy Prerequisites</a></h3>
<p>Here's where things get interesting. Update Manager is built on compliance — but your VMs won't show up in dynamic scopes unless they meet certain prerequisites. Enter Azure Policy to save the day.</p>
<p>You'll need two specific built-in policies assigned at the subscription (or management group) level:</p>
<h4 id="policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines">✅ Policy 1: <code>Set prerequisites for scheduling recurring updates on Azure virtual machines</code></a></h4>
<p><strong>What it does:</strong> This policy ensures your VMs have the necessary configurations to participate in Azure Update Manager. It automatically:</p>
<ul>
<li>Installs the Azure Update Manager extension on Windows VMs</li>
<li>Registers required resource providers</li>
<li>Configures the VM to report its update compliance status</li>
<li>Sets the patch orchestration mode appropriately</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> Without this policy, VMs won't appear in Update Manager scopes even if they're tagged correctly. The policy handles all the "plumbing" automatically.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Apply this at subscription or management group level to catch all VMs.</p>
<h4 id="policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines">✅ Policy 2: <code>Configure periodic checking for missing system updates on Azure virtual machines</code></a></h4>
<p><strong>What it does:</strong> This is your compliance engine. It configures VMs to:</p>
<ul>
<li>Regularly scan for available updates (but not install them automatically)</li>
<li>Report update status back to Azure Update Manager</li>
<li>Enable the compliance dashboard views in the portal</li>
<li>Provide the data needed for maintenance configuration targeting</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> This policy turns on the "update awareness" for your VMs. Without it, Azure Update Manager has no visibility into what patches are needed.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Same as above — subscription or management group level.</p>
<h4 id="assigning-the-policies"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#assigning-the-policies">🎯 Assigning the Policies</a></h4>
<p><strong>Step-by-step in Azure Portal:</strong></p>
<ol>
<li><strong>Navigate to Azure Policy</strong></li>
<li>
<p>Azure Portal → Search "Policy" → Select "Policy"</p>
</li>
<li>
<p><strong>Find the First Policy</strong></p>
</li>
<li>Left menu: <strong>Definitions</strong></li>
<li>Search: <code>Set prerequisites for scheduling recurring updates</code></li>
<li>
<p>Click on the policy title</p>
</li>
<li>
<p><strong>Assign the Policy</strong></p>
</li>
<li>Click <strong>Assign</strong> button</li>
<li><strong>Scope:</strong> Select your subscription(s)</li>
<li><strong>Basics:</strong> Leave policy name as default</li>
<li><strong>Parameters:</strong> Leave as default</li>
<li><strong>Remediation:</strong> ✅ Check "Create remediation task"</li>
<li>
<p><strong>Review + create</strong></p>
</li>
<li>
<p><strong>Repeat for Second Policy</strong></p>
</li>
<li>Search: <code>Configure periodic checking for missing system updates</code></li>
<li>Follow same assignment process</li>
</ol>
<blockquote>
<p>⚠️ <strong>Important:</strong> Policy compliance can take 30+ minutes to evaluate and apply. Perfect time for that brew I mentioned earlier.</p>
</blockquote>
<h4 id="monitoring-compliance"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#monitoring-compliance">🔍 Monitoring Compliance</a></h4>
<p>Once assigned, you can track compliance in <strong>Azure Policy &gt; Compliance</strong>. Look for:</p>
<ul>
<li>Non-compliant VMs that need the extension installed</li>
<li>VMs that aren't reporting update status properly</li>
<li>Any policy assignment errors that need investigation</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/prerequsite-for-schedule-patching">Learn more about Azure Policy for Update Management</a></p>
<hr />
<h3 id="step-8-create-dynamic-scopes-in-update-manager"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-8-create-dynamic-scopes-in-update-manager">🧪 Step 8 – Create Dynamic Scopes in Update Manager</a></h3>
<p>This is where it all comes together — and where the magic happens.</p>
<p>Dynamic scopes use those <code>PatchWindow</code> tags to assign VMs to the correct patch config automatically. No more manual VM assignment, no more "did we remember to add the new server?" conversations.</p>
<h4 id="the-portal-dance"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#the-portal-dance">🎯 The Portal Dance</a></h4>
<p>Unfortunately, as of writing, dynamic scopes can only be configured through the Azure portal — no PowerShell or ARM template support yet.</p>
<blockquote>
<p><strong>Why portal only?</strong> Dynamic scopes are still in preview, and Microsoft hasn't released the PowerShell cmdlets or ARM template schemas yet. This means you can't fully automate the deployment, but the functionality itself works perfectly.</p>
</blockquote>
<p>Here's the step-by-step:</p>
<ol>
<li><strong>Navigate to Azure Update Manager</strong></li>
<li>
<p>Portal → All Services → Azure Update Manager</p>
</li>
<li>
<p><strong>Access Maintenance Configurations</strong></p>
</li>
<li>Go to <strong>Maintenance Configurations (Preview)</strong></li>
<li>
<p>Select one of your configs (e.g., <code>contoso-maintenance-config-vms-mon</code>)</p>
</li>
<li>
<p><strong>Create Dynamic Scope</strong></p>
</li>
<li>Click <strong>Dynamic Scopes</strong> → <strong>Add</strong></li>
<li><strong>Name:</strong> <code>DynamicScope-Monday-VMs</code></li>
<li>
<p><strong>Description:</strong> <code>Auto-assign Windows VMs tagged for Monday maintenance</code></p>
</li>
<li>
<p><strong>Configure Scope Settings</strong></p>
</li>
<li><strong>Subscription:</strong> Select your subscription(s)</li>
<li><strong>Resource Type:</strong> <code>Microsoft.Compute/virtualMachines</code></li>
<li>
<p><strong>OS Type:</strong> <code>Windows</code> (create separate scopes for Linux if needed)</p>
</li>
<li>
<p><strong>Set Tag Filters</strong></p>
</li>
<li><strong>Tag Name:</strong> <code>PatchWindow</code></li>
<li><strong>Tag Value:</strong> <code>mon</code> (must match your maintenance config naming)</li>
<li>
<p><strong>Additional filters</strong> (optional):</p>
<ul>
<li><code>Owner</code> = <code>Contoso</code></li>
<li><code>Updates</code> = <code>Azure Update Manager</code></li>
</ul>
</li>
<li>
<p><strong>Review and Create</strong></p>
</li>
<li>Verify the filter logic</li>
<li>Click <strong>Create</strong></li>
</ol>
<h4 id="repeat-for-all-days"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#repeat-for-all-days">🔄 Repeat for All Days</a></h4>
<p>You'll need to create dynamic scopes for each maintenance configuration:</p>
<table>
<thead>
<tr>
<th>Maintenance Config</th>
<th>Dynamic Scope Name</th>
<th>Tag Filter</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>contoso-maintenance-config-vms-mon</code></td>
<td><code>DynamicScope-Monday-VMs</code></td>
<td><code>PatchWindow = mon</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-tue</code></td>
<td><code>DynamicScope-Tuesday-VMs</code></td>
<td><code>PatchWindow = tue</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-wed</code></td>
<td><code>DynamicScope-Wednesday-VMs</code></td>
<td><code>PatchWindow = wed</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-thu</code></td>
<td><code>DynamicScope-Thursday-VMs</code></td>
<td><code>PatchWindow = thu</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-fri</code></td>
<td><code>DynamicScope-Friday-VMs</code></td>
<td><code>PatchWindow = fri</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sat</code></td>
<td><code>DynamicScope-Saturday-VMs</code></td>
<td><code>PatchWindow = sat-09</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sun</code></td>
<td><code>DynamicScope-Sunday-VMs</code></td>
<td><code>PatchWindow = sun</code></td>
</tr>
</tbody>
</table>
<h4 id="verify-dynamic-scope-assignment"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#verify-dynamic-scope-assignment">🔍 Verify Dynamic Scope Assignment</a></h4>
<p>Once created, you can verify the scopes are working:</p>
<ol>
<li><strong>In the Maintenance Configuration:</strong></li>
<li>Go to <strong>Dynamic Scopes</strong></li>
<li>Check <strong>Resources</strong> tab to see matched VMs</li>
<li>Verify expected VM count matches your tagging</li>
<li>
<p><strong>Wait time:</strong> Allow 15-30 minutes for newly tagged VMs to appear</p>
</li>
<li>
<p><strong>What success looks like:</strong></p>
</li>
<li>Monday scope shows 5 VMs (WEB-PROD-01, DB-PROD-01, etc.)</li>
<li>Saturday scope shows 5 VMs (WEB-DEV-01, DB-DEV-01, etc.)</li>
<li>
<p>No VMs showing? Check tag case sensitivity and filters</p>
</li>
<li>
<p><strong>In Azure Resource Graph:</strong></p>
</li>
</ol>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">vmName</span>
</span></code></pre></div>
<ol>
<li><strong>Troubleshoot empty scopes:</strong></li>
<li>Verify subscription selection includes all your VMs</li>
<li>Check tag spelling: <code>PatchWindow</code> (case sensitive)</li>
<li>Confirm resource type filter: <code>Microsoft.Compute/virtualMachines</code></li>
<li>Wait longer - it can take up to 30 minutes</li>
</ol>
<h4 id="common-gotchas"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#common-gotchas">⚠️ Common Gotchas</a></h4>
<p><strong>Tag Case Sensitivity:</strong> Dynamic scopes are case-sensitive. <code>mon</code> ≠ <code>Mon</code> ≠ <code>MON</code></p>
<p><strong>Subscription Scope:</strong> Ensure you've selected all relevant subscriptions in the scope configuration.</p>
<p><strong>Resource Type Filter:</strong> Don't forget to set the resource type filter — without it, you'll match storage accounts, networking, etc.</p>
<p><strong>Timing:</strong> It can take 15-30 minutes for newly tagged VMs to appear in dynamic scopes.</p>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/dynamic-scope">Dynamic scope configuration docs</a></p>
<hr />
<h3 id="step-9-test-verify-the-moment-of-truth"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#step-9-test-verify-the-moment-of-truth">🚀 Step 9 – Test &amp; Verify (The Moment of Truth)</a></h3>
<p>The acid test: does it actually patch stuff properly?</p>
<h4 id="proof-of-concept-test"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#proof-of-concept-test">🎪 Proof of Concept Test</a></h4>
<p>I started conservatively — scoped <code>contoso-maintenance-config-vms-sun</code> to a few non-critical VMs and let it run overnight on Sunday.</p>
<p><strong>Monday morning verification:</strong></p>
<ul>
<li>✔️ <strong>Patch compliance dashboard:</strong> All green ticks</li>
<li>✔️ <strong>Reboot timing:</strong> Machines restarted within their 4-hour window (21:00-01:00)</li>
<li>✔️ <strong>Update logs:</strong> Activity logs showed expected patching behavior</li>
<li>✔️ <strong>Business impact:</strong> Zero helpdesk tickets on Monday morning</li>
</ul>
<h4 id="full-rollout-verification"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#full-rollout-verification">📊 Full Rollout Verification</a></h4>
<p>Once confident with the Sunday test, I enabled all remaining dynamic scopes and monitored the week:</p>
<p><strong>Key metrics tracked:</strong></p>
<ul>
<li>Patch compliance percentage across all VMs</li>
<li>Failed patch installations (and root causes)</li>
<li>Reboot timing adherence</li>
<li>Business hours impact (spoiler: zero)</li>
</ul>
<h4 id="monitoring-validation-tools"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#monitoring-validation-tools">🔍 Monitoring &amp; Validation Tools</a></h4>
<p><strong>Azure Update Manager Dashboard:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Azure Portal → Update Manager → Overview
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>- Patch compliance summary
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>- Recent patch installations
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>- Failed installations with details
</span></code></pre></div>
<p><strong>Azure Resource Graph Queries:</strong></p>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c">// Verify all VMs have maintenance tags</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">Resources</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Updates</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">          </span><span class="n">patchWindow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">PatchWindow</span><span class="p">,</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">          </span><span class="n">owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Owner</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="c">// Check maintenance configuration assignments</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span></code></pre></div>
<p><strong>PowerShell Verification:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c"># Quick check of maintenance configuration status</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="p">|</span> 
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">MaintenanceScope</span><span class="p">,</span> <span class="n">RecurEvery</span> <span class="p">|</span> 
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="c"># Verify VM tag distribution</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="nv">$tagSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$sub</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>    <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Id</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>    <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span> <span class="p">}</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$tagSummary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$window</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>            <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>        <span class="p">}</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>        <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>    <span class="p">}</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="p">}</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VM DISTRIBUTION BY PATCH WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="nv">$tagSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="success-metrics"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#success-metrics">📈 Success Metrics</a></h4>
<p>After two full weeks of operation:</p>
<ul>
<li><strong>Better control:</strong> Direct management of patch schedules and policies  </li>
<li><strong>Increased visibility:</strong> Real-time compliance dashboards vs. periodic reports</li>
<li><strong>Reduced complexity:</strong> Native Azure tooling vs. third-party solutions</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/monitor-updates">Monitor updates in Azure Update Manager</a></p>
<hr />
<h3 id="final-thoughts-tips"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#final-thoughts-tips">📃 Final Thoughts &amp; Tips</a></h3>
<p>✅ <strong>Cost-neutral</strong> — No more third-party patch agents
✅ <strong>Policy-driven</strong> — Enforced consistency with Azure Policy
✅ <strong>Easily auditable</strong> — Tag-based scoping is clean and visible
✅ <strong>Scalable</strong> — New VMs auto-join patch schedules via tagging</p>
<h4 id="troubleshooting-guide-common-issues"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#troubleshooting-guide-common-issues">⚠️ Troubleshooting Guide &amp; Common Issues</a></h4>
<p>Here's what I learned the hard way, so you don't have to:</p>
<table>
<thead>
<tr>
<th><strong>Symptom</strong></th>
<th><strong>Possible Cause</strong></th>
<th><strong>Fix</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>VM not showing in dynamic scope</td>
<td>Tag typo or case mismatch</td>
<td>Verify <code>PatchWindow</code> tag exactly matches config name</td>
</tr>
<tr>
<td>Maintenance config creation fails</td>
<td>Invalid duration format</td>
<td>Use ISO 8601 format: <code>"03:00"</code> not <code>"3 hours"</code></td>
</tr>
<tr>
<td>VM skipped during patching</td>
<td>Policy prerequisites not met</td>
<td>Check Azure Policy compliance dashboard</td>
</tr>
<tr>
<td>No updates applied despite schedule</td>
<td>VM needs pending reboot</td>
<td>Clear previous reboots, check update history</td>
</tr>
<tr>
<td>Dynamic scope shows zero VMs</td>
<td>Wrong subscription scope</td>
<td>Verify subscription selection in scope config</td>
</tr>
<tr>
<td>Extension installation failed</td>
<td>Insufficient permissions</td>
<td>Ensure VM contributor rights and resource provider registration</td>
</tr>
<tr>
<td>Policy compliance stuck at 0%</td>
<td>Assignment scope too narrow</td>
<td>Check policy is assigned at subscription level</td>
</tr>
<tr>
<td>VMs appear/disappear from scope</td>
<td>Tag inconsistency</td>
<td>Run tag verification script across all subscriptions</td>
</tr>
</tbody>
</table>
<h4 id="advanced-troubleshooting-commands"><a class="toclink" href="../../bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/#advanced-troubleshooting-commands">🔧 Advanced Troubleshooting Commands</a></h4>
<p><strong>Check VM Update Readiness:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c"># Verify VM has required extensions and configuration</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="nv">$vmName</span> <span class="p">=</span> <span class="s2">&quot;your-vm-name&quot;</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nv">$rgName</span> <span class="p">=</span> <span class="s2">&quot;your-resource-group&quot;</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Name</span> <span class="nv">$vmName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$rgName</span> <span class="n">-Status</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="nv">$vm</span><span class="p">.</span><span class="n">Extensions</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Update*&quot;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Maintenance*&quot;</span> <span class="p">}</span>
</span></code></pre></div>
<p><strong>Validate Maintenance Configuration:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c"># Test maintenance configuration is properly formed</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-mon&quot;</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Config Name: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Recurrence: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Duration: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Start Time: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">StartDateTime</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Timezone: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">TimeZone</span><span class="p">)</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>Policy Compliance Deep Dive:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c"># Check specific VMs for policy compliance</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="nv">$policyName</span> <span class="p">=</span> <span class="s2">&quot;Set prerequisites for scheduling recurring updates on Azure virtual machines&quot;</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="nv">$assignments</span> <span class="p">=</span> <span class="nb">Get-AzPolicyAssignment</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-eq</span> <span class="nv">$policyName</span> <span class="p">}</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$assignment</span> <span class="k">in</span> <span class="nv">$assignments</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="nb">Get-AzPolicyState</span> <span class="n">-PolicyAssignmentId</span> <span class="nv">$assignment</span><span class="p">.</span><span class="n">PolicyAssignmentId</span> <span class="p">|</span> 
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>        <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ComplianceState</span> <span class="o">-eq</span> <span class="s2">&quot;NonCompliant&quot;</span> <span class="p">}</span> <span class="p">|</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>        <span class="nb">Select-Object</span> <span class="n">ResourceId</span><span class="p">,</span> <span class="n">ComplianceState</span><span class="p">,</span> <span class="p">@{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Reason&quot;</span><span class="p">;</span><span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">PolicyEvaluationDetails</span><span class="p">.</span><span class="n">EvaluatedExpressions</span><span class="p">.</span><span class="n">ExpressionValue</span><span class="p">}}</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<p><em>As always, comments and suggestions welcome over on GitHub or LinkedIn. If you've migrated patching in a different way, I'd love to hear how you approached it.</em></p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Bringing%20Patch%20Management%20In-House%3A%20Migrating%20from%20MSP%20to%20Azure%20Update%20Manager%0A&amp;url=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-04-22 00:00:00+00:00">April 22, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../azure/" class="md-meta__link">Azure</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../finops/" class="md-meta__link">FinOps</a>, 
              <a href="../powershell/" class="md-meta__link">PowerShell</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">💰 Saving Azure Costs with Scheduled VM Start/Stop using Custom Azure Automation Runbooks</a></h2>
<p>As part of my ongoing commitment to FinOps practices, I've implemented several strategies to embed cost-efficiency into the way we manage cloud infrastructure. One proven tactic is scheduling virtual machines to shut down during idle periods, avoiding unnecessary spend.</p>
<p>In this post, I’ll share how I’ve built out <strong>custom Azure Automation jobs</strong> to schedule VM start and stop operations. Rather than relying on Microsoft’s pre-packaged solution, I’ve developed a <strong>streamlined, purpose-built PowerShell implementation</strong> that provides maximum flexibility, transparency, and control.</p>
<hr />
<h3 id="why-i-chose-custom-runbooks-over-the-prebuilt-solution"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#why-i-chose-custom-runbooks-over-the-prebuilt-solution">✍️ Why I Chose Custom Runbooks Over the Prebuilt Solution</a></h3>
<p>Microsoft provides a ready-made “Start/Stop VMs during off-hours” solution via the Automation gallery. While functional, it’s:</p>
<ul>
<li>A bit over-engineered for simple needs,</li>
<li>Relatively opaque under the hood, and</li>
<li>Not ideal for environments where control and transparency are priorities.</li>
</ul>
<p>My custom jobs:</p>
<ul>
<li>Use native PowerShell modules within Azure Automation,</li>
<li>Are scoped to exactly the VMs I want via <strong>tags</strong>,</li>
<li>Provide clean logging and alerting, and</li>
<li>Keep things simple, predictable, and auditable.</li>
</ul>
<hr />
<h3 id="step-1-set-up-the-azure-automation-account"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-1-set-up-the-azure-automation-account">🛠️ Step 1: Set Up the Azure Automation Account</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-create-standalone-account">Official docs: Create and manage an Azure Automation Account</a></p>
</blockquote>
<ol>
<li>Go to the <strong>Azure Portal</strong> and search for <strong>Automation Accounts</strong>.</li>
<li>Click <strong>+ Create</strong>.</li>
<li>Fill out the basics:</li>
<li><strong>Name</strong>: e.g. <code>vm-scheduler</code></li>
<li><strong>Resource Group</strong>: Create new or select existing</li>
<li><strong>Region</strong>: Preferably where your VMs are located</li>
<li>Enable <strong>System-Assigned Managed Identity</strong></li>
<li>Once created, go to the Automation Account and ensure the following modules are imported using the <strong>Modules</strong> blade in the Azure Portal:</li>
<li><code>Az.Accounts</code></li>
<li><code>Az.Compute</code></li>
</ol>
<blockquote>
<p>✅ Tip: These modules can be added from the gallery in just a few clicks via the UI—no scripting required.</p>
<p>💡 Prefer scripting? You can also install them using PowerShell:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="n">Accounts</span> <span class="n">-Force</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="n">Compute</span> <span class="n">-Force</span>
</span></code></pre></div>
</blockquote>
<ol>
<li>Assign the <strong>Virtual Machine Contributor</strong> role to the Automation Account's managed identity at the resource group or subscription level.</li>
</ol>
<h4 id="cli-or-powershell-alternatives"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#cli-or-powershell-alternatives">⚙️ CLI or PowerShell alternatives</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Azure CLI example to create the automation account</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>az<span class="w"> </span>automation<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span>--name<span class="w"> </span>vm-scheduler<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span>--resource-group<span class="w"> </span>MyResourceGroup<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span>--location<span class="w"> </span>uksouth<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span>--assign-identity
</span></code></pre></div>
<hr />
<h3 id="step-2-add-vm-tags-for-scheduling"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-2-add-vm-tags-for-scheduling">📅 Step 2: Add VM Tags for Scheduling</a></h3>
<p>Apply consistent tags to any VM you want the runbooks to manage.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AutoStartStop</code></td>
<td><code>devserver</code></td>
</tr>
</tbody>
</table>
<p>You can use the Azure Portal or PowerShell to apply these tags.</p>
<h4 id="tag-vms-via-powershell"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#tag-vms-via-powershell">⚙️ Tag VMs via PowerShell</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;MyRG&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;myVM&quot;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;AutoStartStop&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s2">&quot;devserver&quot;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;MyRG&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="step-3-create-the-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-3-create-the-runbooks">📂 Step 3: Create the Runbooks</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-runbook-create">Official docs: Create a runbook in Azure Automation</a></p>
</blockquote>
<h4 id="create-a-new-runbook"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#create-a-new-runbook">▶️ Create a New Runbook</a></h4>
<ol>
<li>In your Automation Account, go to <strong>Process Automation</strong> &gt; <strong>Runbooks</strong>.</li>
<li>Click <strong>+ Create a runbook</strong>.</li>
<li>Name it something like <code>Stop-TaggedVMs</code>.</li>
<li>Choose <strong>PowerShell</strong> as the type.</li>
<li>Paste in the code below (repeat this process for the start runbook later).</li>
</ol>
<h4 id="runbook-code-auto-stop-based-on-tags"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#runbook-code-auto-stop-based-on-tags">🔹 Runbook Code: Auto-Stop Based on Tags</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">Param</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">(</span>    
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)][</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="no">[String]</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="nv">$AzureVMName</span> <span class="p">=</span> <span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)][</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="no">[String]</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="nv">$AzureSubscriptionID</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-subscription-id&gt;&quot;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="p">)</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="s2">&quot;Logging in to Azure...&quot;</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="c"># Authenticate using the system-assigned managed identity of the Automation Account</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="nb">Connect-AzAccount</span> <span class="n">-Identity</span> <span class="n">-AccountId</span> <span class="s2">&quot;&lt;managed-identity-client-id&gt;&quot;</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="nb">Write-Error</span> <span class="n">-Message</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="k">throw</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="p">}</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="nv">$TagName</span>  <span class="p">=</span> <span class="s2">&quot;AutoStartStop&quot;</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="nv">$TagValue</span> <span class="p">=</span> <span class="s2">&quot;devserver&quot;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="nb">Set-AzContext</span> <span class="n">-Subscription</span> <span class="nv">$AzureSubscriptionID</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$AzureVMName</span> <span class="o">-ne</span> <span class="s2">&quot;All&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="nv">$VMs</span> <span class="p">=</span> <span class="nb">Get-AzResource</span> <span class="n">-TagName</span> <span class="nv">$TagName</span> <span class="n">-TagValue</span> <span class="nv">$TagValue</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>        <span class="nv">$_</span><span class="p">.</span><span class="n">ResourceType</span> <span class="o">-like</span> <span class="s1">&#39;Microsoft.Compute/virtualMachines&#39;</span> <span class="o">-and</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="nv">$AzureVMName</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="p">}</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="nv">$VMs</span> <span class="p">=</span> <span class="nb">Get-AzResource</span> <span class="n">-TagName</span> <span class="nv">$TagName</span> <span class="n">-TagValue</span> <span class="nv">$TagValue</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>        <span class="nv">$_</span><span class="p">.</span><span class="n">ResourceType</span> <span class="o">-like</span> <span class="s1">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="p">}</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="p">}</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$VM</span> <span class="k">in</span> <span class="nv">$VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    <span class="nb">Stop-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Name</span> <span class="n">-Verbose</span> <span class="n">-Force</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount">Docs: Connect-AzAccount with Managed Identity</a></p>
</blockquote>
<h4 id="create-the-start-runbook"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#create-the-start-runbook">🔹 Create the Start Runbook</a></h4>
<p>Duplicate the above, replacing <code>Stop-AzVM</code> with <code>Start-AzVM</code>.</p>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/start-azvm">Docs: Start-AzVM</a></p>
</blockquote>
<hr />
<h3 id="step-4-create-and-link-schedules"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#step-4-create-and-link-schedules">⏰ Step 4: Create and Link Schedules</a></h3>
<blockquote>
<p>🔗 <a href="https://learn.microsoft.com/en-us/azure/automation/automation-schedules">Docs: Create schedules in Azure Automation</a></p>
</blockquote>
<ol>
<li>Go to the Automation Account &gt; <strong>Schedules</strong> &gt; <strong>+ Add a schedule</strong>.</li>
<li>Create two schedules:</li>
<li><code>DailyStartWeekdays</code> — Recurs every weekday at 07:30</li>
<li><code>DailyStopWeekdays</code> — Recurs every weekday at 18:30</li>
<li>Go to each runbook &gt; <strong>Link to schedule</strong> &gt; Choose the matching schedule.</li>
</ol>
<blockquote>
<p>📊 You can get creative here: separate schedules for dev vs UAT, or different times for different departments.</p>
</blockquote>
<hr />
<h3 id="testing-your-runbooks"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#testing-your-runbooks">🧪 Testing Your Runbooks</a></h3>
<p>You can test each runbook directly in the portal:</p>
<ul>
<li>Open the runbook</li>
<li>Click <strong>Edit</strong> &gt; <strong>Test Pane</strong></li>
<li>Provide test parameters if needed</li>
<li>Click <strong>Start</strong> and monitor output</li>
</ul>
<p>This is also a good time to validate:</p>
<ul>
<li>The identity has permission</li>
<li>The tags are applied correctly</li>
<li>The VMs are in a stopped or running state as expected</li>
</ul>
<hr />
<h3 id="the-results"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#the-results">📊 The Results</a></h3>
<p>Even this lightweight automation has produced major savings in our environment. Non-prod VMs are now automatically turned off outside office hours, resulting in monthly compute savings of up to <strong>60%</strong> without sacrificing availability during working hours.</p>
<hr />
<h3 id="ideas-for-further-enhancement"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#ideas-for-further-enhancement">🧠 Ideas for Further Enhancement</a></h3>
<ul>
<li>Pull tag values from a central config (e.g. Key Vault or Storage Table)</li>
<li>Add logic to check for active RDP sessions or Azure Monitor heartbeats</li>
<li>Alert via email or Teams on job success/failure</li>
<li>Track savings over time and visualize them</li>
</ul>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/#final-thoughts">💭 Final Thoughts</a></h3>
<p>If you’re looking for a practical, immediate way to implement FinOps principles in Azure, VM scheduling is a great place to start. With minimal setup and maximum flexibility, custom runbooks give you control without the complexity of the canned solutions.</p>
<p>Have you built something similar or extended this idea further? I’d love to hear about it—drop me a comment or reach out on LinkedIn.</p>
<p>Stay tuned for more FinOps tips coming soon!</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Saving%20Azure%20Costs%20with%20Scheduled%20VM%20Start/Stop%20using%20Custom%20Azure%20Automation%20Runbooks%0A&amp;url=https://blog.pollockweb.com/blog/saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/saving-azure-costs-with-scheduled-vm-startstop-using-custom-azure-automation-runbooks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-31 00:00:00+00:00">March 31, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../windows/" class="md-meta__link">Windows</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../group-policy/" class="md-meta__link">Group Policy</a>, 
              <a href="../time-settings/" class="md-meta__link">Time Settings</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/">Enforcing Time Zone and DST Compliance on Windows Servers Using GPO and Scheduled Tasks</a></h2>
<hr />
<h3 id="why-this-matters"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#why-this-matters">🛠️ Why This Matters</a></h3>
<p>Time zone misconfigurations — especially those affecting Daylight Saving Time (DST) — can cause:</p>
<ul>
<li>Scheduled tasks to run early or late</li>
<li>Timestamp mismatches in logs</li>
<li>Errors in time-sensitive integrations</li>
</ul>
<p>Windows doesn’t always honour DST automatically, particularly in <strong>Azure VMs</strong>, <strong>automated deployments</strong>, or <strong>custom images</strong>.</p>
<hr />
<h3 id="whats-changed-in-2025"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#whats-changed-in-2025">🔁 What’s Changed in 2025?</a></h3>
<p>As of <strong>April 2025</strong>, we revised our approach to enforce time zone compliance in a cleaner, more manageable way:</p>
<ul>
<li>🧹 <strong>Removed all registry-based enforcement</strong> from existing GPOs</li>
<li>⚙️ <strong>Executed a one-time PowerShell script</strong> to correct servers incorrectly set to <code>UTC</code> (excluding domain controllers)</li>
<li>⏲️ <strong>Updated the GPO</strong> to use a <strong>Scheduled Task</strong> that sets the correct time zone at startup (<code>GMT Standard Time</code>)</li>
</ul>
<hr />
<h3 id="audit-process-time-zone-and-ntp-source-check"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#audit-process-time-zone-and-ntp-source-check">📋 Audit Process: Time Zone and NTP Source Check</a></h3>
<p>Before remediation, an audit was performed across the server estate to confirm the current time zone and time sync source for each host.</p>
<h4 id="time-zone-audit-script"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#time-zone-audit-script">🔎 Time Zone Audit Script</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c"># Set your target OU</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nv">$OU</span> <span class="p">=</span> <span class="s2">&quot;OU=Servers,DC=yourdomain,DC=local&quot;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c"># Prompt for credentials once</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="c"># Optional: output to file</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="nv">$OutputCsv</span> <span class="p">=</span> <span class="s2">&quot;C:\Temp\TimeZoneAudit.csv&quot;</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="nv">$results</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="c"># Get all enabled computer objects in the OU</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="nv">$servers</span> <span class="p">=</span> <span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">Enabled</span> <span class="o">-eq</span> <span class="nv">$true</span><span class="p">}</span> <span class="n">-SearchBase</span> <span class="nv">$OU</span> <span class="n">-Properties</span> <span class="n">Name</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">Name</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$server</span> <span class="k">in</span> <span class="nv">$servers</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Connecting to $server...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="nv">$tzInfo</span> <span class="p">=</span> <span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="nv">$server</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-ScriptBlock</span> <span class="p">{</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>            <span class="nv">$tz</span> <span class="p">=</span> <span class="nb">Get-TimeZone</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>            <span class="nv">$source</span> <span class="p">=</span> <span class="p">(</span><span class="n">w32tm</span> <span class="p">/</span><span class="n">query</span> <span class="p">/</span><span class="n">source</span><span class="p">)</span> <span class="n">-join</span> <span class="s1">&#39;&#39;</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>            <span class="nv">$status</span> <span class="p">=</span> <span class="p">(</span><span class="n">w32tm</span> <span class="p">/</span><span class="n">query</span> <span class="p">/</span><span class="n">status</span> <span class="p">|</span> <span class="nb">Out-String</span><span class="p">).</span><span class="n">Trim</span><span class="p">()</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>            <span class="no">[PSCustomObject]</span><span class="p">@{</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>                <span class="n">ComputerName</span>     <span class="p">=</span> <span class="nv">$env:COMPUTERNAME</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>                <span class="n">TimeZoneId</span>       <span class="p">=</span> <span class="nv">$tz</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>                <span class="n">TimeZoneDisplay</span>  <span class="p">=</span> <span class="nv">$tz</span><span class="p">.</span><span class="n">DisplayName</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>                <span class="n">CurrentTime</span>      <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">ToString</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">)</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>                <span class="n">TimeSource</span>       <span class="p">=</span> <span class="nv">$source</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>                <span class="n">SyncStatus</span>       <span class="p">=</span> <span class="nv">$status</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>            <span class="p">}</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>        <span class="p">}</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>        <span class="nv">$results</span> <span class="p">+=</span> <span class="nv">$tzInfo</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="p">}</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="nb">Write-Warning</span> <span class="s2">&quot;Failed to connect to ${server}: $_&quot;</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="nv">$results</span> <span class="p">+=</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>            <span class="n">ComputerName</span>     <span class="p">=</span> <span class="nv">$server</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>            <span class="n">TimeZoneId</span>       <span class="p">=</span> <span class="s2">&quot;ERROR&quot;</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>            <span class="n">TimeZoneDisplay</span>  <span class="p">=</span> <span class="s2">&quot;ERROR&quot;</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>            <span class="n">CurrentTime</span>      <span class="p">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>            <span class="n">TimeSource</span>       <span class="p">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>            <span class="n">SyncStatus</span>       <span class="p">=</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="p">}</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>    <span class="p">}</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="p">}</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a><span class="c"># Output results</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a><span class="nv">$results</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a><span class="c"># Save to CSV</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a><span class="nv">$results</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-NoTypeInformation</span> <span class="n">-Path</span> <span class="nv">$OutputCsv</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Audit complete. Results saved to $OutputCsv&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></code></pre></div>
<hr />
<h3 id="gpo-based-scheduled-task-preferred-solution"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#gpo-based-scheduled-task-preferred-solution">🧰 GPO-Based Scheduled Task (Preferred Solution)</a></h3>
<p>Instead of relying on registry modifications, we now use a <strong>Scheduled Task deployed via Group Policy</strong>.</p>
<h4 id="task-overview"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#task-overview">✅ Task Overview</a></h4>
<ul>
<li><strong>Trigger:</strong> At Startup</li>
<li><strong>Action:</strong> Run <code>powershell.exe</code></li>
<li><strong>Arguments:</strong></li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>-Command<span class="w"> </span><span class="s2">&quot;Set-TimeZone -Id &#39;GMT Standard Time&#39;&quot;</span>
</span></code></pre></div>
<blockquote>
<p>💡 The GPO targets all domain-joined servers. Servers in isolated environments (e.g. DMZ) or not joined to the domain are excluded.</p>
</blockquote>
<hr />
<h4 id="scheduled-task-screenshots"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#scheduled-task-screenshots">📸 Scheduled Task Screenshots</a></h4>
<p><img alt="GPO Task Properties - General Tab" src="../../server-posts/fix-dst-settings/scheduled-task-gpo.png" /><br />
<em>Fig 1: Scheduled Task created via GPO Preferences</em></p>
<p><img alt="Scheduled Task Action Details" src="../../server-posts/fix-dst-settings/scheduled-task.png" /><br />
<em>Fig 2: PowerShell command configuring the time zone</em></p>
<hr />
<h3 id="one-off-remediation-script-setting-the-time-zone"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#one-off-remediation-script-setting-the-time-zone">🛠️ One-Off Remediation Script: Setting the Time Zone</a></h3>
<p>For servers identified as incorrect in the audit, the following script was used to apply the fix:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># List of servers to correct (e.g., from your audit results)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nv">$servers</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="s2">&quot;server1&quot;</span><span class="p">,</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="s2">&quot;server2&quot;</span><span class="p">,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="s2">&quot;server3&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="p">)</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="c"># Prompt for credentials if needed</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$server</span> <span class="k">in</span> <span class="nv">$servers</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Setting time zone on $server...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="nv">$server</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-ScriptBlock</span> <span class="p">{</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>            <span class="nb">Set-TimeZone</span> <span class="n">-Id</span> <span class="s2">&quot;GMT Standard Time&quot;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="p">}</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✔ $server: Time zone set to GMT Standard Time&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="p">}</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="nb">Write-Warning</span> <span class="s2">&quot;✖ Failed to set time zone on ${server}: $_&quot;</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="p">}</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<h3 id="how-to-verify-time-zone-dst-compliance"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#how-to-verify-time-zone-dst-compliance">🔍 How to Verify Time Zone + DST Compliance</a></h3>
<p>Use these PowerShell commands to verify:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">Get-TimeZone</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="p">(</span><span class="nb">Get-TimeZone</span><span class="p">).</span><span class="n">SupportsDaylightSavingTime</span>
</span></code></pre></div>
<p>And for registry inspection (read-only):</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nb">Get-ItemProperty</span> <span class="s2">&quot;HKLM:\SYSTEM\CurrentControlSet\Control\TimeZoneInformation&quot;</span> <span class="p">|</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  <span class="nb">Select-Object</span> <span class="n">TimeZoneKeyName</span><span class="p">,</span> <span class="n">DisableAutoDaylightTimeSet</span><span class="p">,</span> <span class="n">DynamicDaylightTimeDisabled</span>
</span></code></pre></div>
<p>Expected values:</p>
<ul>
<li><code>TimeZoneKeyName</code>: <code>"GMT Standard Time"</code></li>
<li><code>DisableAutoDaylightTimeSet</code>: <code>0</code></li>
<li><code>DynamicDaylightTimeDisabled</code>: <code>0</code></li>
</ul>
<hr />
<h3 id="summary"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#summary">🧼 Summary</a></h3>
<p>To ensure consistent time zone configuration and DST compliance:</p>
<ul>
<li>Use a <strong>GPO-based Scheduled Task</strong> to set <code>GMT Standard Time</code> at startup</li>
<li>Run a <strong>one-time audit and remediation</strong> script to fix legacy misconfigurations</li>
<li>Avoid registry edits — they’re no longer required</li>
<li>Validate using <code>Get-TimeZone</code> and confirm time sync via <code>w32tm</code></li>
</ul>
<hr />
<h3 id="next-steps"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#next-steps">📘 Next Steps</a></h3>
<ul>
<li>[ ] Extend to Azure Arc or Intune-managed servers  </li>
<li>[ ] Monitor for changes in Windows DST behaviour in future builds  </li>
<li>[ ] Automate reporting to maintain compliance across environments</li>
</ul>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/#final-thoughts">🧠 Final Thoughts</a></h3>
<p>This GPO+script approach delivers a clean, scalable way to enforce time zone standards and DST logic — without relying on brittle registry changes.</p>
<p>Let me know if you'd like help adapting this for cloud-native or hybrid environments!</p>
<hr />
<p><a class="md-button" href="https://x.com/intent/tweet?text=Enforcing%20Time%20Zone%20and%20DST%20Compliance%20on%20Windows%20Servers%20Using%20GPO%20and%20Scheduled%20Tasks%0A&amp;url=https://blog.pollockweb.com/blog/enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/enforcing-time-zone-and-dst-compliance-on-windows-servers-using-gpo-and-scheduled-tasks/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-31 00:00:00+00:00">March 31, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../windows/" class="md-meta__link">Windows</a>, 
              <a href="../powershell/" class="md-meta__link">PowerShell</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../regional-settings/" class="md-meta__link">Regional Settings</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="configuring-uk-regional-settings-on-windows-servers-with-powershell"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/">Configuring UK Regional Settings on Windows Servers with PowerShell</a></h2>
<p>When building out cloud-hosted or automated deployments of Windows Servers, especially for UK-based organisations, it’s easy to overlook <strong>regional settings</strong>. But these seemingly small configurations — like date/time formats, currency symbols, or keyboard layouts — can have a big impact on usability, application compatibility, and user experience.</p>
<p>In this post, I’ll show how I automate this using a simple PowerShell script that sets all relevant UK regional settings in one go.</p>
<hr />
<h3 id="why-regional-settings-matter"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#why-regional-settings-matter">🔍 Why Regional Settings Matter</a></h3>
<p>Out-of-the-box, Windows often defaults to <strong>en-US</strong> settings:</p>
<ul>
<li>Date format becomes <code>MM/DD/YYYY</code></li>
<li>Decimal separators switch to <code>.</code> instead of <code>,</code></li>
<li>Currency symbols use <code>$</code></li>
<li>Time zones default to US-based settings</li>
<li>Keyboard layout defaults to US (which can be infuriating!)</li>
</ul>
<p>For UK-based organisations, this can:</p>
<ul>
<li>Cause confusion in logs or spreadsheets</li>
<li>Break date parsing in scripts or apps expecting <code>DD/MM/YYYY</code></li>
<li>Result in the wrong characters being typed (e.g., <code>@</code> vs <code>"</code>)</li>
<li>Require manual fixing after deployment</li>
</ul>
<p>Automating this ensures <strong>consistency across environments</strong>, saves time, and avoids annoying regional mismatches.</p>
<hr />
<h3 id="script-overview"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#script-overview">🔧 Script Overview</a></h3>
<p>I created a PowerShell script that:</p>
<ul>
<li>Sets the system locale and input methods</li>
<li>Configures UK date/time formats</li>
<li>Applies the British English language pack (if needed)</li>
<li>Sets the time zone to GMT Standard Time (London)</li>
</ul>
<p>The script can be run manually, included in provisioning pipelines, or dropped into automation tools like Task Scheduler or cloud-init processes.</p>
<hr />
<h3 id="prerequisites"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#prerequisites">✅ Prerequisites</a></h3>
<p>To run this script, you should have:</p>
<ul>
<li>Administrator privileges</li>
<li>PowerShell 5.1+ (default on most supported Windows Server versions)</li>
<li>Optional: Internet access (if language pack needs to be added)</li>
</ul>
<hr />
<h3 id="the-script-set-ukregionalsettingsps1"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#the-script-set-ukregionalsettingsps1">🔹 The Script: <code>Set-UKRegionalSettings.ps1</code></a></h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># Set system locale and formats to English (United Kingdom)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nb">Set-WinSystemLocale</span> <span class="n">-SystemLocale</span> <span class="n">en-GB</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nb">Set-WinUserLanguageList</span> <span class="n">-LanguageList</span> <span class="n">en-GB</span> <span class="n">-Force</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="nb">Set-Culture</span> <span class="n">en-GB</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nb">Set-WinHomeLocation</span> <span class="n">-GeoId</span> <span class="n">242</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="nb">Set-TimeZone</span> <span class="n">-Id</span> <span class="s2">&quot;GMT Standard Time&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="c"># Optional reboot prompt</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="nb">Write-Host</span> <span class="s2">&quot;UK regional settings applied. A reboot is recommended for all changes to take effect.&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="how-to-use-it"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#how-to-use-it">🚀 How to Use It</a></h3>
<h4 id="option-1-manual-execution"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#option-1-manual-execution">✈️ Option 1: Manual Execution</a></h4>
<ol>
<li>Open <strong>PowerShell as Administrator</strong></li>
<li>Run the script:</li>
</ol>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="p">.\</span><span class="nb">Set-UKRegionalSettings</span><span class="p">.</span><span class="n">ps1</span>
</span></code></pre></div>
<hr />
<h4 id="option-2-include-in-build-pipeline-or-image"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#option-2-include-in-build-pipeline-or-image">🔢 Option 2: Include in Build Pipeline or Image</a></h4>
<p>For Azure VMs or cloud images, consider running this as part of your deployment process via:</p>
<ul>
<li><strong>Custom Script Extension</strong> in ARM/Bicep</li>
<li><strong>cloud-init</strong> or <strong>Terraform provisioners</strong></li>
<li><strong>Group Policy Startup Script</strong></li>
</ul>
<hr />
<h3 id="quick-tips"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#quick-tips">⚡ Quick Tips</a></h3>
<ul>
<li>Reboot after running to ensure all settings apply across UI and system processes.</li>
<li>For non-UK keyboards (like US physical hardware), you may also want to explicitly set <code>InputLocale</code>.</li>
<li>Want to validate the settings? Use:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nb">Get-WinSystemLocale</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nb">Get-Culture</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nb">Get-WinUserLanguageList</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="nb">Get-TimeZone</span>
</span></code></pre></div>
<hr />
<h3 id="registry-verification-per-user-and-default-settings"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#registry-verification-per-user-and-default-settings">📂 Registry Verification: Per-User and Default Settings</a></h3>
<p><img alt="Registry Editor Screenshot" src="../../server-posts/regional-settings/registry-editor.png" /></p>
<p>If you're troubleshooting or validating the configuration for specific users, regional settings are stored in the <strong>Windows Registry</strong> under:</p>
<h4 id="for-each-user-profile"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#for-each-user-profile">👤 For Each User Profile</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>HKEY_USERS\&lt;SID&gt;\Control Panel\International
</span></code></pre></div>
<p>You can find the user SIDs by looking under <code>HKEY_USERS</code> or using:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nb">Get-ChildItem</span> <span class="n">Registry</span><span class="p">::</span><span class="n">HKEY_USERS</span>
</span></code></pre></div>
<h4 id="for-new-users-default-profile"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#for-new-users-default-profile">🧵 For New Users (Default Profile)</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>HKEY_USERS\.DEFAULT\Control Panel\International
</span></code></pre></div>
<p>This determines what settings new user profiles inherit on first logon.</p>
<p>You can script changes here if needed, but always test carefully to avoid corrupting profile defaults.</p>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../configuring-uk-regional-settings-on-windows-servers-with-powershell/#final-thoughts">🌟 Final Thoughts</a></h3>
<p>Small tweaks like regional settings might seem minor, but they go a long way in making your Windows Server environments feel localised and ready for your users.</p>
<p>Automating them early in your build pipeline means one less thing to worry about during post-deployment configuration.</p>
<p>Let me know if you want a version of this that handles <strong>multi-user scenarios</strong> or works across <strong>multiple OS versions</strong>!</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Configuring%20UK%20Regional%20Settings%20on%20Windows%20Servers%20with%20PowerShell%0A&amp;url=https://blog.pollockweb.com/blog/configuring-uk-regional-settings-on-windows-servers-with-powershell/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/configuring-uk-regional-settings-on-windows-servers-with-powershell/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-28 00:00:00+00:00">March 28, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../azure/" class="md-meta__link">Azure</a>, 
              <a href="../storage/" class="md-meta__link">Storage</a>, 
              <a href="../identity/" class="md-meta__link">Identity</a>, 
              <a href="./" class="md-meta__link">Automation</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">Replacing SAS Tokens with User Assigned Managed Identity (UAMI) in AzCopy for Blob Uploads</a></h2>
<p>Using Shared Access Signature (SAS) tokens with <code>azcopy</code> is common — but rotating tokens and handling them securely can be a hassle. To improve security and simplify our automation, I recently replaced SAS-based authentication in our scheduled AzCopy jobs with <strong>Azure User Assigned Managed Identity (UAMI)</strong>.</p>
<p>In this post, I’ll walk through how to:</p>
<ul>
<li>Replace AzCopy SAS tokens with managed identity authentication</li>
<li>Assign the right roles to the UAMI</li>
<li>Use <code>azcopy login</code> to authenticate non-interactively</li>
<li>Automate the whole process in PowerShell</li>
</ul>
<hr />
<h3 id="why-remove-sas-tokens"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#why-remove-sas-tokens">🔍 Why Remove SAS Tokens?</a></h3>
<p>SAS tokens are useful, but:</p>
<ul>
<li>🔑 They’re still secrets — and secrets can be leaked</li>
<li>📅 They expire — which breaks automation when not rotated</li>
<li>🔐 They grant broad access — unless scoped very carefully</li>
</ul>
<p>Managed Identity is a much better approach when the copy job is running from within Azure (like an Azure VM or Automation account).</p>
<hr />
<h3 id="project-goal"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#project-goal">🌟 Project Goal</a></h3>
<blockquote>
<p>Replace the use of SAS tokens in an AzCopy job that uploads files from a local UNC share to Azure Blob Storage — by using a <strong>User Assigned Managed Identity</strong>.</p>
</blockquote>
<hr />
<h3 id="prerequisites"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#prerequisites">✅ Prerequisites</a></h3>
<p>To follow along, you’ll need:</p>
<ul>
<li>A <strong>User Assigned Managed Identity</strong> (UAMI)</li>
<li>A <strong>Windows Server or Azure VM</strong> to run the copy job</li>
<li>Access to a <strong>local source folder or UNC share</strong> (e.g., <code>\\fileserver\\data\\export\\</code>)</li>
<li><strong>AzCopy v10.7+</strong> installed on the machine</li>
<li>Azure RBAC permissions to assign roles</li>
</ul>
<blockquote>
<p>ℹ️ <strong>Check AzCopy Version:</strong>
Run <code>azcopy --version</code> to ensure you're using <strong>v10.7.0 or later</strong>, which is required for <code>--identity-client-id</code> support.</p>
</blockquote>
<hr />
<h3 id="step-by-step-setup"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-by-step-setup">🔧 Step-by-Step Setup</a></h3>
<h4 id="step-1-create-the-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-1-create-the-uami">🛠️ Step 1: Create the UAMI</a></h4>
<h5 id="cli"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>az<span class="w"> </span>identity<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span>--name<span class="w"> </span>my-azcopy-uami<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-resource-group<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span>--location<span class="w"> </span>&lt;region&gt;
</span></code></pre></div>
<h5 id="portal"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal">✅ Portal</a></h5>
<ol>
<li>Go to <strong>Managed Identities</strong> in the Azure Portal</li>
<li>Click <strong>+ Create</strong> and follow the wizard</li>
</ol>
<hr />
<h4 id="step-2-assign-the-uami-to-the-azure-vm"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-2-assign-the-uami-to-the-azure-vm">🖇️ Step 2: Assign the UAMI to the Azure VM</a></h4>
<p>AzCopy running on a VM must be able to assume the identity. Assign the UAMI to your VM:</p>
<h5 id="cli_1"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli_1">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>az<span class="w"> </span>vm<span class="w"> </span>identity<span class="w"> </span>assign<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span>--name<span class="w"> </span>my-vm-name<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span>--resource-group<span class="w"> </span>my-resource-group<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>--identities<span class="w"> </span>my-azcopy-uami
</span></code></pre></div>
<h5 id="portal_1"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal_1">✅ Portal</a></h5>
<ol>
<li>Navigate to the <strong>Virtual Machines</strong> blade</li>
<li>Select the VM running your AzCopy script</li>
<li>Under <strong>Settings</strong>, click <strong>Identity</strong></li>
<li>Go to the <strong>User assigned</strong> tab</li>
<li>Click <strong>+ Add</strong>, select your UAMI, then click <strong>Add</strong></li>
</ol>
<hr />
<h4 id="step-3-assign-rbac-permissions-to-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-3-assign-rbac-permissions-to-uami">🔐 Step 3: Assign RBAC Permissions to UAMI</a></h4>
<p>For AzCopy to function correctly with a UAMI, the following role assignments are recommended:</p>
<ul>
<li><strong>Storage Blob Data Contributor</strong>: Required for read/write blob operations</li>
<li><strong>Storage Blob Data Reader</strong>: (Optional) For read-only scenarios or validation scripts</li>
<li><strong>Reader</strong>: (Optional) For browsing or metadata-only permissions on the storage account</li>
</ul>
<blockquote>
<p>⏳ <strong>RBAC Tip</strong>: It may take up to 5 minutes for role assignments to propagate fully. If access fails initially, wait and retry.</p>
</blockquote>
<h5 id="cli_2"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#cli_2">✅ CLI</a></h5>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Storage Blob Data Contributor&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;/blobServices/default/containers/&lt;container-name&gt;&quot;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Storage Blob Data Reader&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;&quot;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;client-id-or-object-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Reader&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">  </span>--scope<span class="w"> </span><span class="s2">&quot;/subscriptions/&lt;sub-id&gt;/resourceGroups/&lt;rg&gt;/providers/Microsoft.Storage/storageAccounts/&lt;storage-account&gt;&quot;</span>
</span></code></pre></div>
<h5 id="portal_2"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#portal_2">✅ Portal</a></h5>
<ol>
<li>Go to your <strong>Storage Account</strong> in the Azure Portal</li>
<li>Click on the relevant <strong>container</strong> (or stay at the account level for broader scope)</li>
<li>Open <strong>Access Control (IAM)</strong></li>
<li>Click <strong>+ Add role assignment</strong></li>
<li>Repeat this for each role:</li>
<li>Select <strong>Storage Blob Data Contributor</strong>, assign to your UAMI, and click <strong>Save</strong></li>
<li>Select <strong>Storage Blob Data Reader</strong>, assign to your UAMI, and click <strong>Save</strong></li>
<li>Select <strong>Reader</strong>, assign to your UAMI, and click <strong>Save</strong></li>
</ol>
<hr />
<h4 id="step-4-test-azcopy-login-using-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-4-test-azcopy-login-using-uami">🧪 Step 4: Test AzCopy Login Using UAMI</a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nv">$clientId</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-uami-client-id&gt;&quot;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="n">login</span> <span class="p">-</span><span class="n">-identity</span> <span class="p">-</span><span class="n">-identity-client-id</span> <span class="nv">$clientId</span>
</span></code></pre></div>
<p>You should see a confirmation message that AzCopy has successfully logged in.</p>
<blockquote>
<p>🔍 To verify AzCopy is authenticated with the correct identity, you can run:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>azcopy env
</span></code></pre></div>
<p>This will show the login type and confirm whether the token is being sourced from the Managed Identity.</p>
</blockquote>
<hr />
<h4 id="step-5-upload-files-using-azcopy-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#step-5-upload-files-using-azcopy-uami">📁 Step 5: Upload Files Using AzCopy + UAMI</a></h4>
<p>Here's the PowerShell script that copies all files from a local share to the Blob container:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nv">$clientId</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-uami-client-id&gt;&quot;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c"># Login with Managed Identity</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="n">login</span> <span class="p">-</span><span class="n">-identity</span> <span class="p">-</span><span class="n">-identity-client-id</span> <span class="nv">$clientId</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="c"># Run the copy job</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="p">&amp;</span> <span class="s2">&quot;C:\azcopy\azcopy.exe&quot;</span> <span class="nb">copy </span><span class="p">\</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>  <span class="s2">&quot;\\\\fileserver\\data\\export\\&quot;</span> <span class="p">\</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>  <span class="s2">&quot;https://&lt;your-storage-account&gt;.blob.core.windows.net/&lt;container-name&gt;&quot;</span> <span class="p">\</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>  <span class="p">-</span><span class="n">-overwrite</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>  <span class="p">-</span><span class="n">-from-to</span><span class="p">=</span><span class="n">LocalBlob</span> <span class="p">\</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>  <span class="p">-</span><span class="n">-blob-type</span><span class="p">=</span><span class="n">Detect</span> <span class="p">\</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>  <span class="p">-</span><span class="n">-put-md5</span> <span class="p">\</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>  <span class="p">-</span><span class="n">-recursive</span> <span class="p">\</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>  <span class="p">-</span><span class="n">-log-level</span><span class="p">=</span><span class="n">INFO</span>
</span></code></pre></div>
<blockquote>
<p>💡 <strong>UNC Note</strong>: Double backslashes are used in PowerShell to represent UNC paths properly.</p>
</blockquote>
<p>This script can be scheduled using Task Scheduler or run on demand.</p>
<hr />
<h4 id="automate-with-task-scheduler-optional"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#automate-with-task-scheduler-optional">⏱️ Automate with Task Scheduler (Optional)</a></h4>
<p>To automate the job:</p>
<ol>
<li>Open <strong>Task Scheduler</strong> on your VM</li>
<li>Create a <strong>New Task</strong> (not a Basic Task)</li>
<li>Under <strong>General</strong>, select "Run whether user is logged on or not"</li>
<li>Under <strong>Actions</strong>, add a new action to run <code>powershell.exe</code></li>
<li>Set the arguments to point to your <code>.ps1</code> script</li>
<li>Ensure the AzCopy path is hardcoded in your script</li>
</ol>
<hr />
<h4 id="troubleshooting-common-errors"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#troubleshooting-common-errors">🚑 Troubleshooting Common Errors</a></h4>
<h5 id="403-authorizationpermissionmismatch"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#403-authorizationpermissionmismatch">❌ 403 AuthorizationPermissionMismatch</a></h5>
<ul>
<li>Usually means the identity doesn’t have the correct role or the role hasn’t propagated yet</li>
<li>Double-check:</li>
<li>UAMI is assigned to the VM</li>
<li>UAMI has <code>Storage Blob Data Contributor</code> on the correct container</li>
<li>Wait 2–5 minutes and try again</li>
</ul>
<h5 id="azcopy-the-term-azcopy-is-not-recognized"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#azcopy-the-term-azcopy-is-not-recognized">❌ azcopy : The term 'azcopy' is not recognized</a></h5>
<ul>
<li>AzCopy is not in the system PATH</li>
<li>Solution: Use the full path to <code>azcopy.exe</code>, like <code>C:\azcopy\azcopy.exe</code></li>
</ul>
<hr />
<h3 id="benefits-of-switching-to-uami"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#benefits-of-switching-to-uami">🛡️ Benefits of Switching to UAMI</a></h3>
<ul>
<li>✅ No secrets or keys stored on disk</li>
<li>✅ No manual token expiry issues</li>
<li>✅ Access controlled via Azure RBAC</li>
<li>✅ Easily scoped and auditable</li>
</ul>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/#final-thoughts">🧼 Final Thoughts</a></h3>
<p>Replacing AzCopy SAS tokens with UAMI is one of those small wins that pays dividends over time. Once set up, it's secure, robust, and hands-off.</p>
<p>Let me know if you'd like a variant of this that works from Azure Automation or a hybrid worker!</p>
<hr />
<p><a class="md-button" href="https://x.com/intent/tweet?text=Replacing%20SAS%20Tokens%20with%20User%20Assigned%20Managed%20Identity%20%28UAMI%29%20in%20AzCopy%20for%20Blob%20Uploads%0A&amp;url=https://blog.pollockweb.com/blog/replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/replacing-sas-tokens-with-user-assigned-managed-identity-uami-in-azcopy-for-blob-uploads/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/110421070?s=400&v=4" alt="Matthew Pollock">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-03-11 00:00:00+00:00">March 11, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../intune/" class="md-meta__link">Intune</a>, 
              <a href="./" class="md-meta__link">Automation</a>, 
              <a href="../scripting/" class="md-meta__link">Scripting</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="uninstalling-papercut-mf-client-via-intune-a-step-by-step-guide"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/">📢 Uninstalling PaperCut MF Client via Intune – A Step-by-Step Guide 🚀</a></h2>
<h3 id="scenario-overview"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#scenario-overview"><strong>🔍 Scenario Overview</strong></a></h3>
<p>Managing software across an enterprise can be a headache, especially when it comes to <strong>removing outdated applications</strong>. Recently, I needed to <strong>uninstall the PaperCut MF Client from multiple Windows PCs</strong> in my environment. The challenge? Ensuring a clean removal <strong>without user intervention</strong> and <strong>no leftover files</strong>.</p>
<p>Rather than relying on manual uninstallation, we used <strong>Microsoft Intune</strong> to deploy a <strong>PowerShell script</strong> that handles the removal automatically. This blog post details the full process, from <strong>script development to deployment and testing</strong>.</p>
<hr />
<h3 id="the-goal"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#the-goal"><strong>🎯 The Goal</strong></a></h3>
<p>✅ Uninstall the PaperCut MF Client <strong>silently</strong><br />
✅ Ensure <strong>no residual files</strong> are left behind<br />
✅ Deploy the solution <strong>via Intune</strong> as a PowerShell script (NOT as a Win32 app)<br />
✅ Test both <strong>locally</strong> and <strong>remotely</strong> before large-scale deployment  </p>
<hr />
<h3 id="step-1-writing-the-uninstall-script"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#step-1-writing-the-uninstall-script"><strong>🛠 Step 1: Writing the Uninstall Script</strong></a></h3>
<p>We first created a <strong>PowerShell script</strong> to:</p>
<ol>
<li><strong>Stop PaperCut-related processes</strong></li>
<li><strong>Run the built-in uninstaller (<code>unins000.exe</code>)</strong> if present</li>
<li><strong>Use MSIEXEC to remove the MSI-based install</strong></li>
<li><strong>Forcefully delete any remaining files and registry entries</strong></li>
</ol>
<h4 id="the-uninstall-script"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#the-uninstall-script"><strong>📝 The Uninstall Script</strong></a></h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c"># Define variables</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">$UninstallExePath</span> <span class="p">=</span> <span class="s2">&quot;C:\Program Files (x86)\PaperCut MF Client\unins000.exe&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nv">$MsiProductCode</span> <span class="p">=</span> <span class="s2">&quot;{5B4B80DE-34C4-11E9-9CA9-F53BB8A68831}&quot;</span>  <span class="c"># Replace with actual Product Code</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nv">$LogFile</span> <span class="p">=</span> <span class="s2">&quot;C:\ProgramData\Custom-Intune-Scripts\Papercut-Uninstall.log&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nv">$InstallPath</span> <span class="p">=</span> <span class="s2">&quot;C:\Program Files (x86)\PaperCut MF Client&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c"># Function to log output</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">Function</span> <span class="nb">Write-Log</span> <span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">param</span> <span class="p">(</span><span class="no">[string]</span><span class="nv">$Message</span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="nv">$TimeStamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s2">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="s2">&quot;$TimeStamp - $Message&quot;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-Append</span> <span class="n">-FilePath</span> <span class="nv">$LogFile</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">}</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="nb">Write-Log</span> <span class="s2">&quot;Starting PaperCut MF Client uninstallation process.&quot;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="c"># Stop any running PaperCut processes before uninstalling</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="nv">$Processes</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;pc-client&quot;</span><span class="p">,</span> <span class="s2">&quot;pc-client-java&quot;</span><span class="p">,</span> <span class="s2">&quot;pc-client-local-cache&quot;</span><span class="p">)</span>  <span class="c"># Common PaperCut processes</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Process</span> <span class="k">in</span> <span class="nv">$Processes</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">Get-Process</span> <span class="n">-Name</span> <span class="nv">$Process</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="nb">Write-Log</span> <span class="s2">&quot;Stopping process: $Process&quot;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="nb">Stop-Process</span> <span class="n">-Name</span> <span class="nv">$Process</span> <span class="n">-Force</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="p">}</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="p">}</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="c"># Check if unins000.exe exists</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$UninstallExePath</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="nb">Write-Log</span> <span class="s2">&quot;Found unins000.exe at $UninstallExePath. Initiating uninstallation.&quot;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="nv">$UninstallExePath</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;/SILENT&quot;</span> <span class="n">-NoNewWindow</span> <span class="n">-Wait</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="nb">Write-Log</span> <span class="s2">&quot;Uninstallation process completed using unins000.exe.&quot;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="nb">Write-Log</span> <span class="s2">&quot;unins000.exe not found. Attempting MSI uninstallation using Product Code $MsiProductCode.&quot;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="s2">&quot;msiexec.exe&quot;</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;/x $MsiProductCode /qn /norestart&quot;</span> <span class="n">-NoNewWindow</span> <span class="n">-Wait</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="p">}</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="c"># Forcefully delete the remaining installation folder</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$InstallPath</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="nb">Write-Log</span> <span class="s2">&quot;Residual files found at $InstallPath. Attempting to remove forcefully.&quot;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="n">takeown</span> <span class="p">/</span><span class="n">F</span> <span class="s2">&quot;$InstallPath&quot;</span> <span class="p">/</span><span class="nb">R </span><span class="p">/</span><span class="n">D</span> <span class="n">Y</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="n">icacls</span> <span class="s2">&quot;$InstallPath&quot;</span> <span class="p">/</span><span class="n">grant</span> <span class="n">Administrators</span><span class="p">:</span><span class="n">F</span> <span class="p">/</span><span class="n">T</span> <span class="p">/</span><span class="n">C</span> <span class="p">/</span><span class="n">Q</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="nb">Remove-Item</span> <span class="n">-Path</span> <span class="nv">$InstallPath</span> <span class="n">-Recurse</span> <span class="n">-Force</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$InstallPath</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="nb">Write-Log</span> <span class="s2">&quot;SUCCESS: Residual files successfully removed.&quot;</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="nb">Write-Log</span> <span class="s2">&quot;ERROR: Failed to remove residual files. Manual intervention may be required.&quot;</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="p">}</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="nb">Write-Log</span> <span class="s2">&quot;No residual files found.&quot;</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="p">}</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="nb">Write-Log</span> <span class="s2">&quot;PaperCut MF Client uninstallation script execution finished.&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="step-2-testing-the-script-locally"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#step-2-testing-the-script-locally"><strong>🧪 Step 2: Testing the Script Locally</strong></a></h3>
<p>Before deploying via Intune, it's best to <strong>test locally</strong>:</p>
<ol>
<li><strong>Open PowerShell as Administrator</strong></li>
<li><strong>Run the script manually</strong>:</li>
</ol>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-File</span> <span class="s2">&quot;C:\Path\To\Script.ps1&quot;</span>
</span></code></pre></div>
<ol>
<li><strong>Verify</strong>:</li>
<li>Check <code>C:\Program Files (x86)\PaperCut MF Client</code> to confirm deletion</li>
<li>Check <code>C:\ProgramData\AXA-Custom-Intune-Scripts\Papercut-Uninstall.log</code> for success logs</li>
</ol>
<hr />
<h3 id="step-3-running-the-script-on-a-remote-pc"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#step-3-running-the-script-on-a-remote-pc"><strong>🌍 Step 3: Running the Script on a Remote PC</strong></a></h3>
<p>If you need to test the script remotely before deploying via Intune:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nv">$RemotePC</span> <span class="p">=</span> <span class="s2">&quot;COMPUTER-NAME&quot;</span>  <span class="c"># Change this to the target PC name</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="nv">$RemotePC</span> <span class="n">-FilePath</span> <span class="s2">&quot;C:\Path\To\Script.ps1&quot;</span> <span class="n">-Credential</span> <span class="p">(</span><span class="nb">Get-Credential</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="step-4-deploying-via-intune"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#step-4-deploying-via-intune"><strong>📡 Step 4: Deploying via Intune</strong></a></h3>
<p>Instead of packaging the script as a <code>.intunewin</code> file, we will deploy it <strong>as a PowerShell script in Intune</strong>.</p>
<h4 id="steps-to-deploy-in-intune"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#steps-to-deploy-in-intune"><strong>🎯 Steps to Deploy in Intune</strong></a></h4>
<ol>
<li><strong>Go to</strong> Microsoft Endpoint Manager admin center (<strong>endpoint.microsoft.com</strong>)</li>
<li>Navigate to <strong>Devices &gt; Scripts</strong></li>
<li>Click <strong>Add &gt; Windows 10 and later</strong></li>
<li><strong>Upload the PowerShell script</strong> (<code>Papercut-Uninstall.ps1</code>)</li>
<li>Configure settings:</li>
<li><strong>Run script using the logged-on credentials?</strong> → <strong>No</strong> (runs as SYSTEM)</li>
<li><strong>Enforce script signature check?</strong> → <strong>No</strong></li>
<li><strong>Run script in 64-bit PowerShell Host?</strong> → <strong>Yes</strong></li>
<li><strong>Assign the script to device groups</strong> (not users)</li>
<li><strong>Monitor deployment logs</strong> in Intune</li>
</ol>
<hr />
<h3 id="final-thoughts"><a class="toclink" href="../../uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/#final-thoughts"><strong>📌 Final Thoughts</strong></a></h3>
<p>By using <strong>Intune and PowerShell</strong>, we successfully automated the <strong>silent uninstallation</strong> of PaperCut MF Client. This approach ensures a <strong>zero-touch removal</strong> with <strong>no residual files</strong>, keeping endpoints clean and manageable. 🚀</p>
<p>Got questions or need enhancements? Drop them in the comments! 😊</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Uninstalling%20PaperCut%20MF%20Client%20via%20Intune%20%E2%80%93%20A%20Step-by-Step%20Guide%0A&amp;url=https://blog.pollockweb.com/blog/uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/uninstalling-papercut-mf-client-via-intune--a-step-by-step-guide/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        
  <div class="custom-footer">
    <div class="custom-footer-left">
      <p>Copyright &copy; 2025 Matthew Pollock</p>
    </div>
    <div class="custom-footer-right">
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github"></i>
      </a>
      <a href="https://linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe"></i>
      </a>
    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "content.code.select", "content.code.copy", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>