<head>
    <!-- Other head elements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

  
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A real-world walkthrough of migrating VM patching from a third-party provider to Azure Update Manager using PowerShell, tagging, and policy automation.">
      
      
        <meta name="author" content="Matt Pollock">
      
      
        <link rel="canonical" href="https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">
      
      
        <link rel="prev" href="../azure-bcdr-review--turning-inherited-cloud-infrastructure-into-a-resilient-recovery-strategy/">
      
      
        <link rel="next" href="../first-steps-into-ai-automation-my-journey-from-trial-to-self-hosted-chaos/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/icons/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager - cloudlabmp</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-800NGKWBYL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-800NGKWBYL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-800NGKWBYL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
    <div class="announcement-content">
      <p>Welcome to my blog! Connect with me:</p>
      <a href="https://www.linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe fa-2x"></i>
      </a>
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github fa-2x"></i>
      </a><!-- Add more icons as needed -->
    </div>
  
          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://cloudlabmp.github.io/project-blog/blog/welcome-to-my-blog/" title="cloudlabmp" class="md-header__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cloudlabmp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../learn/" class="md-tabs__link">
        
  
    
  
  Learn

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../work/" class="md-tabs__link">
        
  
    
  
  Work

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://cloudlabmp.github.io/project-blog/blog/welcome-to-my-blog/" title="cloudlabmp" class="md-nav__button md-logo" aria-label="cloudlabmp" data-md-component="logo">
      
  <img src="../../assets/icons/logo-48x48.png" alt="logo">

    </a>
    cloudlabmp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cloudlabmp/project-blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    cloudlabmp/project-blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Posts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Posts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/ai--study-techniques/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI &amp; Study Techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/ai-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI Integration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/aws/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/application-insights/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Insights
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/bcdr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BCDR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/blogging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blogging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CI/CD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/career-development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Career Development
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/cloud-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/cloud-resume-challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Resume Challenge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/finops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FinOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/gitops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/group-policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Group Policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/iis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IIS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/iac/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IaC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/identity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Identity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/infrastructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/intune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/learning-projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning Projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/life-update/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Life Update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/microsoft-certifications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microsoft Certifications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/patch-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Patch Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/powershell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PowerShell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/regional-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Regional Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/sql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/scripting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scripting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/self-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Self-Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/serverless/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serverless
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/tech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/time-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/web-hosting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web Hosting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../category/windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learn
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../work/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Work
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      ⚙️ Prerequisites &amp; Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-audit-the-current-setup" class="md-nav__link">
    <span class="md-ellipsis">
      🕵️ Step 1 – Audit the Current Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-seven-new-maintenance-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      🧱 Step 2 – Create Seven New Maintenance Configurations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-tweak-the-maintenance-configs" class="md-nav__link">
    <span class="md-ellipsis">
      🛠️ Step 3 – Tweak the Maintenance Configs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-use-ai-to-group-vms-by-patch-activity" class="md-nav__link">
    <span class="md-ellipsis">
      🤖 Step 4 – Use AI to Group VMs by Patch Activity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-discover-all-vms-and-identify-gaps" class="md-nav__link">
    <span class="md-ellipsis">
      🔍 Step 5 – Discover All VMs and Identify Gaps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-bulk-tag-all-vms-with-patch-windows" class="md-nav__link">
    <span class="md-ellipsis">
      ✍️ Step 6 – Bulk Tag All VMs with Patch Windows
    </span>
  </a>
  
    <nav class="md-nav" aria-label="✍️ Step 6 – Bulk Tag All VMs with Patch Windows">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-vm-tagging-planned-schedule" class="md-nav__link">
    <span class="md-ellipsis">
      🎯 Main VM Tagging (Planned Schedule)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handle-the-stragglers" class="md-nav__link">
    <span class="md-ellipsis">
      🧹 Handle the Stragglers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-configure-azure-policy-prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      🧰 Step 7 – Configure Azure Policy Prerequisites
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🧰 Step 7 – Configure Azure Policy Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Policy 1: Set prerequisites for scheduling recurring updates on Azure virtual machines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Policy 2: Configure periodic checking for missing system updates on Azure virtual machines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#assigning-the-policies" class="md-nav__link">
    <span class="md-ellipsis">
      🎯 Assigning the Policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      🔍 Monitoring Compliance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-create-dynamic-scopes-in-update-manager" class="md-nav__link">
    <span class="md-ellipsis">
      🧪 Step 8 – Create Dynamic Scopes in Update Manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🧪 Step 8 – Create Dynamic Scopes in Update Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-portal-dance" class="md-nav__link">
    <span class="md-ellipsis">
      🎯 The Portal Dance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#repeat-for-all-days" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Repeat for All Days
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-dynamic-scope-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      🔍 Verify Dynamic Scope Assignment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-gotchas" class="md-nav__link">
    <span class="md-ellipsis">
      ⚠️ Common Gotchas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-test-verify-the-moment-of-truth" class="md-nav__link">
    <span class="md-ellipsis">
      🚀 Step 9 – Test &amp; Verify (The Moment of Truth)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🚀 Step 9 – Test & Verify (The Moment of Truth)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proof-of-concept-test" class="md-nav__link">
    <span class="md-ellipsis">
      🎪 Proof of Concept Test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-rollout-verification" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Full Rollout Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-validation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      🔍 Monitoring &amp; Validation Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#success-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      📈 Success Metrics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-thoughts-tips" class="md-nav__link">
    <span class="md-ellipsis">
      📃 Final Thoughts &amp; Tips
    </span>
  </a>
  
    <nav class="md-nav" aria-label="📃 Final Thoughts & Tips">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting-guide-common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      ⚠️ Troubleshooting Guide &amp; Common Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-troubleshooting-commands" class="md-nav__link">
    <span class="md-ellipsis">
      🔧 Advanced Troubleshooting Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-05-29 00:00:00+00:00" class="md-ellipsis">May 29, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../category/azure/">Azure</a>, 
                              <a href="../category/automation/">Automation</a>, 
                              <a href="../category/patch-management/">Patch Management</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              21 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  
  

<nav class="md-tags" >
  
    
    
    
      <a href="../tags/#azure-update-manager" class="md-tag">Azure Update Manager</a>
    
  
    
    
    
      <a href="../tags/#powershell" class="md-tag">PowerShell</a>
    
  
    
    
    
      <a href="../tags/#azure-policy" class="md-tag">Azure Policy</a>
    
  
    
    
    
      <a href="../tags/#vm-patching" class="md-tag">VM Patching</a>
    
  
    
    
    
      <a href="../tags/#finops" class="md-tag">FinOps</a>
    
  
</nav>


  
  


<h1 id="bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager">🔄 Bringing Patch Management In-House: Migrating from MSP to Azure Update Manager</h1>
<blockquote>
<p>It's all fun and games until the MSP contract expires and you realise 90 VMs still need their patching schedules sorted…</p>
</blockquote>
<p>With our MSP contract winding down, the time had come to bring VM patching <em>back in house</em>. Our third-party provider had been handling it with their own tooling, which would no longer be used when the service contract expired.</p>
<p>Enter <a href="https://learn.microsoft.com/en-us/azure/update-manager/overview">Azure Update Manager</a> — the modern, agentless way to manage patching schedules across your Azure VMs. Add a bit of PowerShell, sprinkle in some Azure Policy, and you've got yourself a scalable, policy-driven solution that's more visible, auditable, and way more maintainable.</p>
<p>Here's how I made the switch — and managed to avoid a patching panic.</p>
<hr />
<h2 id="prerequisites-permissions">⚙️ Prerequisites &amp; Permissions</h2>
<p>Let's get the plumbing sorted before diving in.</p>
<p>You'll need:</p>
<ul>
<li>The right <strong>PowerShell modules</strong>:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">Install-Module</span> <span class="n">Az</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span> <span class="n">-Force</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">Import-Module</span> <span class="n">Az</span><span class="p">.</span><span class="n">Maintenance</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Resources</span><span class="p">,</span> <span class="n">Az</span><span class="p">.</span><span class="n">Compute</span>
</span></code></pre></div>
<ul>
<li>An account with <strong>Contributor</strong> permissions (or higher)</li>
<li>Registered providers to avoid mysterious error messages:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Maintenance</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">GuestConfiguration</span>
</span></code></pre></div>
<blockquote>
<p><strong>Why Resource Providers?</strong> Azure Update Manager needs these registered to create the necessary API endpoints and resource types in your subscription. Without them, you'll get cryptic "resource type not found" errors.</p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/overview#prerequisites">Official documentation on Azure Update Manager prerequisites</a></p>
<hr />
<h2 id="step-1-audit-the-current-setup">🕵️ Step 1 – Audit the Current Setup</h2>
<p>First order of business: collect the patching summary data from the MSP — which, helpfully, came in the form of multiple weekly CSV exports.</p>
<p>I used GenAI to wrangle the mess into a structured format. The result was a clear categorisation of VMs based on the day and time they were typically patched — a solid foundation to work from.</p>
<hr />
<h2 id="step-2-create-seven-new-maintenance-configurations">🧱 Step 2 – Create Seven New Maintenance Configurations</h2>
<p>This is the foundation of Update Manager — define your recurring patch windows.</p>
<details>
<summary>Click to expand: Create Maintenance Configurations (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c"># Azure Update Manager - Create Weekly Maintenance Configurations</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c"># Pure PowerShell syntax</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c"># Define parameters</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nv">$resourceGroupName</span> <span class="p">=</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nv">$location</span> <span class="p">=</span> <span class="s2">&quot;uksouth&quot;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nv">$timezone</span> <span class="p">=</span> <span class="s2">&quot;GMT Standard Time&quot;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="nv">$startDateTime</span> <span class="p">=</span> <span class="s2">&quot;2024-06-01 21:00&quot;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="nv">$duration</span> <span class="p">=</span> <span class="s2">&quot;03:00&quot;</span>  <span class="c"># 3 hours - meets minimum requirement</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c"># Day mapping for config naming (3-letter lowercase)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nv">$dayMap</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="s2">&quot;Monday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="s2">&quot;Tuesday&quot;</span>   <span class="p">=</span> <span class="s2">&quot;tue&quot;</span> 
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="s2">&quot;Thursday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="s2">&quot;Friday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="s2">&quot;Saturday&quot;</span>  <span class="p">=</span> <span class="s2">&quot;sat&quot;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="s2">&quot;Sunday&quot;</span>    <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="p">}</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="c"># Create maintenance configurations for each day</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$day</span> <span class="k">in</span> <span class="nv">$dayMap</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="nv">$shortDay</span> <span class="p">=</span> <span class="nv">$dayMap</span><span class="p">[</span><span class="nv">$day</span><span class="p">]</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="nv">$configName</span> <span class="p">=</span> <span class="s2">&quot;contoso-maintenance-config-vms-$shortDay&quot;</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Creating: $configName for $day...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">New-AzMaintenanceConfiguration</span> <span class="p">`</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>            <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="p">`</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>            <span class="n">-Name</span> <span class="nv">$configName</span> <span class="p">`</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>            <span class="n">-MaintenanceScope</span> <span class="s2">&quot;InGuestPatch&quot;</span> <span class="p">`</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>            <span class="n">-Location</span> <span class="nv">$location</span> <span class="p">`</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>            <span class="n">-StartDateTime</span> <span class="nv">$startDateTime</span> <span class="p">`</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>            <span class="n">-Timezone</span> <span class="nv">$timezone</span> <span class="p">`</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>            <span class="n">-Duration</span> <span class="nv">$duration</span> <span class="p">`</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>            <span class="n">-RecurEvery</span> <span class="s2">&quot;Week $day&quot;</span> <span class="p">`</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="n">-InstallPatchRebootSetting</span> <span class="s2">&quot;IfRequired&quot;</span> <span class="p">`</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>            <span class="n">-ExtensionProperty</span> <span class="p">@{</span><span class="s2">&quot;InGuestPatchMode&quot;</span> <span class="p">=</span> <span class="s2">&quot;User&quot;</span><span class="p">}</span> <span class="p">`</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>            <span class="n">-WindowParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>            <span class="n">-LinuxParameterClassificationToInclude</span> <span class="p">@(</span><span class="s2">&quot;Critical&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">)</span> <span class="p">`</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>            <span class="n">-Tag</span> <span class="p">@{</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>                <span class="s2">&quot;Application&quot;</span>  <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>                <span class="s2">&quot;Owner&quot;</span>        <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>                <span class="s2">&quot;PatchWindow&quot;</span>  <span class="p">=</span> <span class="nv">$shortDay</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="p">}</span> <span class="p">`</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>            <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✓ SUCCESS: $configName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>        <span class="c"># Quick validation</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="nv">$createdConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="n">-Name</span> <span class="nv">$configName</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Validated: </span><span class="p">$(</span><span class="nv">$createdConfig</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2"> schedule confirmed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;✗ FAILED: $configName - </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>        <span class="k">continue</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>    <span class="p">}</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="p">}</span>
</span></code></pre></div>

</details>

<blockquote>
<p>⚠️ <em>Don't forget: duration format is ISO 8601, not "2 hours" — and start time has to match the day it's tied to.</em></p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/new-azmaintenanceconfiguration">Learn more about New-AzMaintenanceConfiguration</a></p>
<hr />
<h2 id="step-3-tweak-the-maintenance-configs">🛠️ Step 3 – Tweak the Maintenance Configs</h2>
<p>Some patch windows felt too tight — and, just as importantly, I needed to avoid overlaps with existing backup jobs. Rather than let a large CU fail halfway through or run headlong into an Azure Backup job, I extended the duration on select configs and staggered them across the week:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span> <span class="p">=</span> <span class="s2">&quot;04:00&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nb">Update-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span> <span class="n">-Configuration</span> <span class="nv">$config</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c"># Verify the change</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nv">$updatedConfig</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-sun&quot;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Sunday window now: </span><span class="p">$(</span><span class="nv">$updatedConfig</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2"> duration&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></code></pre></div>
<p><a href="https://learn.microsoft.com/en-us/powershell/module/az.maintenance/update-azmaintenanceconfiguration?view=azps-14.0.0&amp;viewFallbackFrom=azps-13.5.0">Learn more about Update-AzMaintenanceConfiguration</a></p>
<hr />
<h2 id="step-4-use-ai-to-group-vms-by-patch-activity">🤖 Step 4 – Use AI to Group VMs by Patch Activity</h2>
<p>Armed with CSV exports of the latest patching summaries, I got AI to do the grunt work and make sense of the contents.</p>
<p><strong>What I did:</strong></p>
<ol>
<li><strong>Exported MSP data:</strong> Weekly CSV reports showing patch installation timestamps for each VM</li>
<li>
<p><strong>Used Gen AI</strong> with various iterative prompts, starting the conversation with this:</p>
<blockquote>
<p>"Attached is an export summary of the current patching activity from our incumbent MSP who currently look after the patching of the VM's in Azure
I need you to review timestamps and work out which maintenance window each vm is currently in, and then match that to the appropriate maintenance config that we have just created.
If there are mis matches in new and current schedule then we may need to tweak the settings of the new configs"</p>
</blockquote>
</li>
<li>
<p><strong>AI analysis revealed:</strong></p>
</li>
<li>60% of VMs were patching on one weekday evening</li>
<li>Several critical systems patching simultaneously</li>
<li>
<p>No consideration for application dependencies</p>
</li>
<li>
<p><strong>AI recommendation:</strong> Spread VMs across weekdays based on:</p>
</li>
<li><strong>Criticality:</strong> Domain controllers on different days</li>
<li><strong>Function:</strong> Similar servers on different days (avoid single points of failure)  </li>
<li><strong>Dependencies:</strong> Database servers before application servers</li>
</ol>
<p><strong>The result:</strong> A logical rebalancing that avoided "all our eggs in Sunday 1AM" basket and considered business impact.</p>
<blockquote>
<p><strong>Why this matters:</strong> The current patching schedule was not optimized for business continuity. AI helped identify risks we hadn't considered.</p>
</blockquote>
<hr />
<h2 id="step-5-discover-all-vms-and-identify-gaps">🔍 Step 5 – Discover All VMs and Identify Gaps</h2>
<p>Before diving into bulk tagging, I needed to understand what we were working with across all subscriptions.</p>
<p><strong>First, let's see what VMs we have:</strong></p>
<details>
<summary>Click to expand: Discover Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c"># Discover Untagged VMs Script for Azure Update Manager</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c"># This script identifies VMs that are missing Azure Update Manager tags</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Azure Update Manager - Discover Untagged VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Scanning all accessible subscriptions for VMs missing maintenance tags...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="c"># Function to check if VM has Azure Update Manager tags</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="k">function</span> <span class="nb">Test-VMHasMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">)</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="c"># Check for the three required tags</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="nv">$hasOwnerTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Owner&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Owner&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="nv">$hasUpdatesTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;Updates&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="s2">&quot;Updates&quot;</span><span class="p">]</span> <span class="o">-eq</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="nv">$hasPatchWindowTag</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-and</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">)</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="k">return</span> <span class="nv">$hasOwnerTag</span> <span class="o">-and</span> <span class="nv">$hasUpdatesTag</span> <span class="o">-and</span> <span class="nv">$hasPatchWindowTag</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="p">}</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="c"># Function to get VM details for reporting</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="k">function</span> <span class="nb">Get-VMDetails</span> <span class="p">{</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">param</span><span class="p">(</span><span class="nv">$VM</span><span class="p">,</span> <span class="nv">$SubscriptionName</span><span class="p">)</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">return</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="n">ResourceGroup</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="n">Subscription</span> <span class="p">=</span> <span class="nv">$SubscriptionName</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">SubscriptionId</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="n">PowerState</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">PowerState</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="n">OsType</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">StorageProfile</span><span class="p">.</span><span class="n">OsDisk</span><span class="p">.</span><span class="n">OsType</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="n">VmSize</span> <span class="p">=</span> <span class="nv">$VM</span><span class="p">.</span><span class="n">HardwareProfile</span><span class="p">.</span><span class="n">VmSize</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="n">Tags</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="s2">&quot;$_=</span><span class="p">$(</span><span class="nv">$VM</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">])</span><span class="s2">&quot;</span> <span class="p">})</span> <span class="n">-join</span> <span class="s2">&quot;; &quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;No tags&quot;</span> <span class="p">}</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>    <span class="p">}</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="p">}</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="c"># Initialize collections</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="nv">$taggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="nv">$untaggedVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="nv">$allVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="nv">$subscriptionSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== DISCOVERING VMs ACROSS ALL SUBSCRIPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="c"># Get all accessible subscriptions</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Found </span><span class="p">$(</span><span class="nv">$subscriptions</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> accessible subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Scanning subscription: </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span><span class="s2">)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="c"># Get all VMs in this subscription</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Retrieving VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Status</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="nv">$subTagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="nv">$subUntagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>        <span class="nv">$subTotal</span> <span class="p">=</span> <span class="nv">$vms</span><span class="p">.</span><span class="n">Count</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Found $subTotal VMs in this subscription&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>            <span class="nv">$vmDetails</span> <span class="p">=</span> <span class="nb">Get-VMDetails</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-SubscriptionName</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="nv">$allVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">Test-VMHasMaintenanceTags</span> <span class="n">-VM</span> <span class="nv">$vm</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                <span class="nv">$taggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>                <span class="nv">$subTagged</span><span class="p">++</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ✓ Tagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                <span class="nv">$untaggedVMs</span> <span class="p">+=</span> <span class="nv">$vmDetails</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>                <span class="nv">$subUntagged</span><span class="p">++</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>                <span class="nb">Write-Host</span> <span class="s2">&quot;    ⚠️ Untagged: </span><span class="p">$(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>            <span class="p">}</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>        <span class="p">}</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="c"># Store subscription summary</span>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="nv">$subTotal</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="nv">$subTagged</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="nv">$subUntagged</span>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>            <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>        <span class="p">}</span>
</span><span id="__span-4-88"><a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>
</span><span id="__span-4-89"><a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Subscription Summary - Total: $subTotal | Tagged: $subTagged | Untagged: $subUntagged&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-90"><a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
</span><span id="__span-4-91"><a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>    <span class="p">}</span>
</span><span id="__span-4-92"><a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-4-93"><a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-4-94"><a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>        <span class="nv">$subscriptionSummary</span><span class="p">[</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-4-95"><a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>            <span class="n">Total</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-4-96"><a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>            <span class="n">Tagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-4-97"><a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>            <span class="n">Untagged</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-4-98"><a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>            <span class="n">Error</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>
</span><span id="__span-4-99"><a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>        <span class="p">}</span>
</span><span id="__span-4-100"><a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>    <span class="p">}</span>
</span><span id="__span-4-101"><a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="p">}</span>
</span><span id="__span-4-102"><a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
</span><span id="__span-4-103"><a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-104"><a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== OVERALL DISCOVERY SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-105"><a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs found: </span><span class="p">$(</span><span class="nv">$allVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-106"><a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs with maintenance tags: </span><span class="p">$(</span><span class="nv">$taggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-4-107"><a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs missing maintenance tags: </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-4-108"><a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>
</span><span id="__span-4-109"><a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-110"><a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs ARE ALREADY TAGGED! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-4-111"><a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;No further action required.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-112"><a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>    <span class="n">exit</span> <span class="n">0</span>
</span><span id="__span-4-113"><a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="p">}</span>
</span><span id="__span-4-114"><a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>
</span><span id="__span-4-115"><a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-116"><a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SUBSCRIPTION BREAKDOWN ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-117"><a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="nv">$subscriptionSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-118"><a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>    <span class="nv">$sub</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-4-119"><a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-120"><a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: ERROR - </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-4-121"><a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-4-122"><a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>        <span class="nv">$percentage</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span> <span class="no">[math]</span><span class="p">::</span><span class="n">Round</span><span class="p">((</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span> <span class="p">/</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span> <span class="p">*</span> <span class="n">100</span><span class="p">,</span> <span class="n">1</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">0</span> <span class="p">}</span>
</span><span id="__span-4-123"><a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Tagged</span><span class="p">)</span><span class="s2">/</span><span class="p">$(</span><span class="nv">$sub</span><span class="p">.</span><span class="n">Total</span><span class="p">)</span><span class="s2"> tagged ($percentage%)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-124"><a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>    <span class="p">}</span>
</span><span id="__span-4-125"><a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a><span class="p">}</span>
</span><span id="__span-4-126"><a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>
</span><span id="__span-4-127"><a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-128"><a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== UNTAGGED VMs DETAILED LIST ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-4-129"><a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a><span class="nb">Write-Host</span> <span class="s2">&quot;The following </span><span class="p">$(</span><span class="nv">$untaggedVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs are missing Azure Update Manager maintenance tags:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-130"><a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>
</span><span id="__span-4-131"><a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a><span class="c"># Group untagged VMs by subscription for easier reading</span>
</span><span id="__span-4-132"><a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a><span class="nv">$untaggedBySubscription</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Subscription</span>
</span><span id="__span-4-133"><a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>
</span><span id="__span-4-134"><a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$group</span> <span class="k">in</span> <span class="nv">$untaggedBySubscription</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-135"><a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Subscription: </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> (</span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> untagged VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-4-136"><a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>
</span><span id="__span-4-137"><a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>    <span class="nv">$group</span><span class="p">.</span><span class="nb">Group </span><span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-138"><a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  • </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-4-139"><a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Resource Group: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ResourceGroup</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-140"><a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Location: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Location</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-141"><a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    OS Type: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">OsType</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-142"><a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    VM Size: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">VmSize</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-143"><a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;    Power State: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">PowerState</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-144"><a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span> <span class="o">-ne</span> <span class="s2">&quot;No tags&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-4-145"><a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;    Existing Tags: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">DarkGray</span>
</span><span id="__span-4-146"><a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>        <span class="p">}</span>
</span><span id="__span-4-147"><a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-148"><a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>    <span class="p">}</span>
</span><span id="__span-4-149"><a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a><span class="p">}</span>
</span><span id="__span-4-150"><a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>
</span><span id="__span-4-151"><a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== ANALYSIS BY VM CHARACTERISTICS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-152"><a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>
</span><span id="__span-4-153"><a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a><span class="c"># Analyze by OS Type</span>
</span><span id="__span-4-154"><a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a><span class="nv">$untaggedByOS</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">OsType</span>
</span><span id="__span-4-155"><a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by OS Type:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-156"><a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a><span class="nv">$untaggedByOS</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-157"><a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-158"><a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a><span class="p">}</span>
</span><span id="__span-4-159"><a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>
</span><span id="__span-4-160"><a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a><span class="c"># Analyze by Location</span>
</span><span id="__span-4-161"><a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a><span class="nv">$untaggedByLocation</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">Location</span>
</span><span id="__span-4-162"><a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Location:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-163"><a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a><span class="nv">$untaggedByLocation</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-164"><a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-165"><a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a><span class="p">}</span>
</span><span id="__span-4-166"><a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>
</span><span id="__span-4-167"><a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a><span class="c"># Analyze by VM Size (to understand workload types)</span>
</span><span id="__span-4-168"><a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a><span class="nv">$untaggedBySize</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">VmSize</span>
</span><span id="__span-4-169"><a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Size:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-170"><a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a><span class="nv">$untaggedBySize</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-171"><a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-172"><a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a><span class="p">}</span>
</span><span id="__span-4-173"><a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>
</span><span id="__span-4-174"><a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a><span class="c"># Analyze by Resource Group (might indicate application/workload groupings)</span>
</span><span id="__span-4-175"><a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a><span class="nv">$untaggedByRG</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">ResourceGroup</span>
</span><span id="__span-4-176"><a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">� Untagged VMs by Resource Group (Top 10):&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-177"><a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a><span class="nv">$untaggedByRG</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">10</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-178"><a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-179"><a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a><span class="p">}</span>
</span><span id="__span-4-180"><a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>
</span><span id="__span-4-181"><a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-182"><a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== POWER STATE ANALYSIS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-183"><a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a><span class="nv">$powerStates</span> <span class="p">=</span> <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Group-Object</span> <span class="n">PowerState</span>
</span><span id="__span-4-184"><a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a><span class="nv">$powerStates</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Count</span> <span class="n">-Descending</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-4-185"><a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-186"><a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a><span class="p">}</span>
</span><span id="__span-4-187"><a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>
</span><span id="__span-4-188"><a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-189"><a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== EXPORT OPTIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-190"><a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a><span class="nb">Write-Host</span> <span class="s2">&quot;You can export this data for further analysis:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-191"><a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>
</span><span id="__span-4-192"><a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a><span class="c"># Export to CSV option</span>
</span><span id="__span-4-193"><a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a><span class="nv">$timestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s2">&quot;yyyyMMdd-HHmm&quot;</span>
</span><span id="__span-4-194"><a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a><span class="nv">$csvPath</span> <span class="p">=</span> <span class="s2">&quot;D:\UntaggedVMs-$timestamp.csv&quot;</span>
</span><span id="__span-4-195"><a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>
</span><span id="__span-4-196"><a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-4-197"><a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a>    <span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Export-Csv</span> <span class="n">-Path</span> <span class="nv">$csvPath</span> <span class="n">-NoTypeInformation</span>
</span><span id="__span-4-198"><a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✓ Exported untagged VMs to: $csvPath&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-4-199"><a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-4-200"><a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;✗ Failed to export CSV: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-4-201"><a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a><span class="p">}</span>
</span><span id="__span-4-202"><a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>
</span><span id="__span-4-203"><a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a><span class="c"># Show simple list for easy copying</span>
</span><span id="__span-4-204"><a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-205"><a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== SIMPLE VM NAME LIST (for copy/paste) ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-206"><a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VM Names:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-207"><a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a><span class="nv">$untaggedVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nb">Write-Host</span> <span class="s2">&quot;  </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span> <span class="p">}</span>
</span><span id="__span-4-208"><a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a>
</span><span id="__span-4-209"><a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-210"><a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEXT STEPS RECOMMENDATIONS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-211"><a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Review the untagged VMs list above&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-212"><a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Investigate why these VMs were not in the original patching schedule&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-213"><a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Determine appropriate maintenance windows for these VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-214"><a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Consider grouping by:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-215"><a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Application/workload (Resource Group analysis)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-216"><a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Environment (naming patterns, tags)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-217"><a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Business criticality&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-218"><a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a><span class="nb">Write-Host</span> <span class="s2">&quot;   • Maintenance window preferences&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-219"><a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a><span class="nb">Write-Host</span> <span class="s2">&quot;5. Run the tagging script to assign maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-220"><a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a>
</span><span id="__span-4-221"><a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-222"><a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-223"><a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query in Azure Resource Graph Explorer to verify results:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-4-224"><a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-225"><a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-4-226"><a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a><span class="sh">Resources</span>
</span><span id="__span-4-227"><a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-4-228"><a id="__codelineno-4-228" name="__codelineno-4-228" href="#__codelineno-4-228"></a><span class="sh">| where tags.PatchWindow == &quot;&quot; or isempty(tags.PatchWindow) or isnull(tags.PatchWindow)</span>
</span><span id="__span-4-229"><a id="__codelineno-4-229" name="__codelineno-4-229" href="#__codelineno-4-229"></a><span class="sh">| project name, resourceGroup, subscriptionId, location, </span>
</span><span id="__span-4-230"><a id="__codelineno-4-230" name="__codelineno-4-230" href="#__codelineno-4-230"></a><span class="sh">          osType = properties.storageProfile.osDisk.osType,</span>
</span><span id="__span-4-231"><a id="__codelineno-4-231" name="__codelineno-4-231" href="#__codelineno-4-231"></a><span class="sh">          vmSize = properties.hardwareProfile.vmSize,</span>
</span><span id="__span-4-232"><a id="__codelineno-4-232" name="__codelineno-4-232" href="#__codelineno-4-232"></a><span class="sh">          powerState = properties.extended.instanceView.powerState.displayStatus,</span>
</span><span id="__span-4-233"><a id="__codelineno-4-233" name="__codelineno-4-233" href="#__codelineno-4-233"></a><span class="sh">          tags</span>
</span><span id="__span-4-234"><a id="__codelineno-4-234" name="__codelineno-4-234" href="#__codelineno-4-234"></a><span class="sh">| sort by name asc</span>
</span><span id="__span-4-235"><a id="__codelineno-4-235" name="__codelineno-4-235" href="#__codelineno-4-235"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-4-236"><a id="__codelineno-4-236" name="__codelineno-4-236" href="#__codelineno-4-236"></a>
</span><span id="__span-4-237"><a id="__codelineno-4-237" name="__codelineno-4-237" href="#__codelineno-4-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-238"><a id="__codelineno-4-238" name="__codelineno-4-238" href="#__codelineno-4-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-4-239"><a id="__codelineno-4-239" name="__codelineno-4-239" href="#__codelineno-4-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<p><strong>Discovery results:</strong></p>
<ul>
<li><strong>35 VMs</strong> from the original MSP schedule (our planned list)</li>
<li><strong>12 additional VMs</strong> not in the MSP schedule (the "stragglers")</li>
<li><strong>Total: 90 VMs</strong> needing Update Manager tags</li>
</ul>
<blockquote>
<p><strong>Key insight:</strong> The MSP wasn't managing everything. Several dev/test VMs and a few production systems were missing from their schedule.</p>
</blockquote>
<hr />
<h2 id="step-6-bulk-tag-all-vms-with-patch-windows">✍️ Step 6 – Bulk Tag All VMs with Patch Windows</h2>
<p>Now for the main event: tagging all VMs with their maintenance windows. This includes both our planned VMs and the newly discovered ones.</p>
<h3 id="main-vm-tagging-planned-schedule">🎯 Main VM Tagging (Planned Schedule)</h3>
<p>Each tag serves a specific purpose:</p>
<ul>
<li><code>PatchWindow</code> — The key tag used by dynamic scopes to assign VMs to maintenance configurations</li>
<li><code>Owner</code> — For accountability and filtering</li>
<li><code>Updates</code> — Identifies VMs managed by Azure Update Manager</li>
</ul>
<details>
<summary>Click to expand: Multi-Subscription Azure Update Manager VM Tagging (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c"># Multi-Subscription Azure Update Manager VM Tagging Script</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c"># This script discovers VMs across multiple subscriptions and tags them appropriately</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Multi-Subscription Azure Update Manager - VM Tagging Script ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="c"># Function to safely tag a VM</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="p">)</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="c"># Get the VM and update tags</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">}</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="p">}</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>    <span class="p">}</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    <span class="p">}</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="p">}</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="c"># Define all target VMs organized by maintenance window</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="nv">$maintenanceGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;mon&quot;</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>        <span class="p">}</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="p">}</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-02&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">)</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;tue&quot;</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="p">}</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>    <span class="p">}</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-03&quot;</span><span class="p">,</span> <span class="s2">&quot;DC-PROD-03&quot;</span><span class="p">)</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;wed&quot;</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>        <span class="p">}</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>    <span class="p">}</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-04&quot;</span><span class="p">,</span> <span class="s2">&quot;PRINT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;thu&quot;</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>        <span class="p">}</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>    <span class="p">}</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE-PROD-05&quot;</span><span class="p">,</span> <span class="s2">&quot;MONITOR-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;fri&quot;</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>        <span class="p">}</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>    <span class="p">}</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-DEV-01&quot;</span><span class="p">,</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">,</span> <span class="s2">&quot;SANDBOX-01&quot;</span><span class="p">)</span>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>        <span class="p">}</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>    <span class="p">}</span>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;WEB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;DB-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;APP-UAT-01&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">,</span> <span class="s2">&quot;MGMT-PROD-01&quot;</span><span class="p">)</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>        <span class="s2">&quot;Tags&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>            <span class="s2">&quot;PatchWindow&quot;</span> <span class="p">=</span> <span class="s2">&quot;sun&quot;</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>        <span class="p">}</span>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>    <span class="p">}</span>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a><span class="p">}</span>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a><span class="c"># Function to discover VMs across all subscriptions</span>
</span><span id="__span-5-103"><a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a><span class="k">function</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="p">{</span>
</span><span id="__span-5-104"><a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>    <span class="k">param</span><span class="p">(</span><span class="no">[array]</span><span class="nv">$TargetVMNames</span><span class="p">)</span>
</span><span id="__span-5-105"><a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>
</span><span id="__span-5-106"><a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>    <span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-5-107"><a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>    <span class="nv">$vmInventory</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-5-108"><a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>
</span><span id="__span-5-109"><a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscription</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-110"><a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>        <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-5-111"><a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-5-112"><a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>            <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ErrorAction</span> <span class="k">Continue</span>
</span><span id="__span-5-113"><a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>
</span><span id="__span-5-114"><a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-115"><a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span> <span class="n">-in</span> <span class="nv">$TargetVMNames</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-116"><a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>                    <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-5-117"><a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>                        <span class="n">Name</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-5-118"><a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>                        <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">ResourceGroupName</span>
</span><span id="__span-5-119"><a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>                        <span class="n">SubscriptionId</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-5-120"><a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>                        <span class="n">SubscriptionName</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-5-121"><a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>                        <span class="n">Location</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Location</span>
</span><span id="__span-5-122"><a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>                    <span class="p">}</span>
</span><span id="__span-5-123"><a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>                <span class="p">}</span>
</span><span id="__span-5-124"><a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>            <span class="p">}</span>
</span><span id="__span-5-125"><a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>        <span class="p">}</span>
</span><span id="__span-5-126"><a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>        <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-5-127"><a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;Error scanning subscription </span><span class="p">$(</span><span class="nv">$subscription</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-5-128"><a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>        <span class="p">}</span>
</span><span id="__span-5-129"><a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>    <span class="p">}</span>
</span><span id="__span-5-130"><a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>
</span><span id="__span-5-131"><a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>    <span class="k">return</span> <span class="nv">$vmInventory</span>
</span><span id="__span-5-132"><a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a><span class="p">}</span>
</span><span id="__span-5-133"><a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>
</span><span id="__span-5-134"><a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a><span class="c"># Get all unique VM names and discover their locations</span>
</span><span id="__span-5-135"><a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="p">@()</span>
</span><span id="__span-5-136"><a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a><span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$allTargetVMs</span> <span class="p">+=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">VMs</span> <span class="p">}</span>
</span><span id="__span-5-137"><a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a><span class="nv">$allTargetVMs</span> <span class="p">=</span> <span class="nv">$allTargetVMs</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Unique</span>
</span><span id="__span-5-138"><a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>
</span><span id="__span-5-139"><a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Discovering locations for </span><span class="p">$(</span><span class="nv">$allTargetVMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> target VMs...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-5-140"><a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a><span class="nv">$vmInventory</span> <span class="p">=</span> <span class="nb">Find-VMsAcrossSubscriptions</span> <span class="n">-TargetVMNames</span> <span class="nv">$allTargetVMs</span>
</span><span id="__span-5-141"><a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>
</span><span id="__span-5-142"><a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a><span class="c"># Process each maintenance window</span>
</span><span id="__span-5-143"><a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-5-144"><a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-5-145"><a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>
</span><span id="__span-5-146"><a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$windowName</span> <span class="k">in</span> <span class="nv">$maintenanceGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-147"><a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$maintenanceGroups</span><span class="p">[</span><span class="nv">$windowName</span><span class="p">]</span>
</span><span id="__span-5-148"><a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $windowName MAINTENANCE WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-5-149"><a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>
</span><span id="__span-5-150"><a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmName</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-5-151"><a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vmInventory</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$vmName</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-5-152"><a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>            <span class="nv">$vmInfo</span> <span class="p">=</span> <span class="nv">$vmInventory</span><span class="p">[</span><span class="nv">$vmName</span><span class="p">]</span>
</span><span id="__span-5-153"><a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>            <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">ResourceGroupName</span> <span class="n">-SubscriptionId</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">SubscriptionId</span> <span class="n">-Tags</span> <span class="nv">$group</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$windowName</span>
</span><span id="__span-5-154"><a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$totalSuccess</span><span class="p">++</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nv">$totalFailed</span><span class="p">++</span> <span class="p">}</span>
</span><span id="__span-5-155"><a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-5-156"><a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>            <span class="nb">Write-Host</span> <span class="s2">&quot;  ⚠️ VM not found: $vmName&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-5-157"><a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>            <span class="nv">$totalFailed</span><span class="p">++</span>
</span><span id="__span-5-158"><a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>        <span class="p">}</span>
</span><span id="__span-5-159"><a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>    <span class="p">}</span>
</span><span id="__span-5-160"><a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a><span class="p">}</span>
</span><span id="__span-5-161"><a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>
</span><span id="__span-5-162"><a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-5-163"><a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-5-164"><a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></code></pre></div>

</details>

<h3 id="handle-the-stragglers">🧹 Handle the Stragglers</h3>
<p>For the 12 VMs not in the original MSP schedule, I used intelligent assignment based on their function:</p>
<details>
<summary>Click to expand: Tagging Script for Remaining Untagged VMs (Sample Script)</summary>

<div class="language-powershell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c"># Intelligent VM Tagging Script for Remaining Untagged VMs</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c"># This script analyzes and tags the remaining VMs based on workload patterns and load balancing</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nv">$scriptStart</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== Intelligent VM Tagging for Remaining VMs ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Analyzing and tagging 26 untagged VMs with optimal maintenance window distribution...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="c"># Function to safely tag a VM across subscriptions</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="k">function</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="p">{</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="k">param</span><span class="p">(</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="no">[string]</span><span class="nv">$VMName</span><span class="p">,</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="no">[string]</span><span class="nv">$ResourceGroupName</span><span class="p">,</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="no">[string]</span><span class="nv">$SubscriptionId</span><span class="p">,</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="no">[hashtable]</span><span class="nv">$Tags</span><span class="p">,</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>        <span class="no">[string]</span><span class="nv">$MaintenanceWindow</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="c"># Set context to the VM&#39;s subscription</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="nv">$currentContext</span> <span class="p">=</span> <span class="nb">Get-AzContext</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$currentContext</span><span class="p">.</span><span class="n">Subscription</span><span class="p">.</span><span class="n">Id</span> <span class="o">-ne</span> <span class="nv">$SubscriptionId</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>            <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="p">}</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  Processing: $VMName...&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>        <span class="c"># Get the VM</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>        <span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Name</span> <span class="nv">$VMName</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="c"># Add maintenance tags to existing tags (preserve existing tags)</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>            <span class="nv">$Tags</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>                <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$Tags</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>            <span class="p">}</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>            <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nv">$Tags</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="p">}</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span class="c"># Update the VM tags</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="nv">$null</span> <span class="p">=</span> <span class="nb">Update-AzVM</span> <span class="n">-VM</span> <span class="nv">$vm</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-Tag</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✓ Successfully tagged $VMName for $MaintenanceWindow maintenance&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>        <span class="k">return</span> <span class="nv">$true</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="p">}</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;  ✗ Failed to tag $VMName`: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="k">return</span> <span class="nv">$false</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>    <span class="p">}</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="p">}</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="c"># Define current maintenance window loads (after existing 59 VMs)</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="nv">$currentLoad</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">7</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">7</span> 
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">10</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">17</span>  <span class="c"># Dev/Test at 09:00</span>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">6</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="p">}</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== CURRENT MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="p">}</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="c"># Initialize counters for new assignments</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="nv">$newAssignments</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>    <span class="s2">&quot;Monday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>    <span class="s2">&quot;Tuesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>    <span class="s2">&quot;Wednesday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>    <span class="s2">&quot;Thursday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>    <span class="s2">&quot;Friday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>    <span class="s2">&quot;Saturday&quot;</span> <span class="p">=</span> <span class="n">0</span>  <span class="c"># Will use sat-09 for dev/test</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>    <span class="s2">&quot;Sunday&quot;</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="p">}</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== INTELLIGENT VM GROUPING AND ASSIGNMENT ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="c"># Define VM groups with intelligent maintenance window assignments</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a><span class="nv">$vmGroups</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>    <span class="c"># CRITICAL PRODUCTION SYSTEMS - Spread across different days</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>    <span class="s2">&quot;Critical Infrastructure&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Sunday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - critical infrastructure&quot;</span> <span class="p">},</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DC-PROD-02&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-infrastructure&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Domain Controller - spread from other DCs&quot;</span> <span class="p">},</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;BACKUP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-backup&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Backup Server - spread across week&quot;</span> <span class="p">}</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>        <span class="p">)</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>    <span class="p">}</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>    <span class="c"># PRODUCTION BUSINESS APPLICATIONS - Spread for business continuity</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>    <span class="s2">&quot;Production Applications&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Monday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Server - Monday for week start&quot;</span> <span class="p">},</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Server - Tuesday&quot;</span> <span class="p">},</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;APP-PROD-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-app-production&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Production&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Wednesday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Application Server - mid-week&quot;</span> <span class="p">}</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>        <span class="p">)</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a>    <span class="p">}</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a>    <span class="c"># DEV/TEST SYSTEMS - Saturday morning maintenance (like existing dev/test)</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a>    <span class="s2">&quot;Development Systems&quot;</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>        <span class="s2">&quot;VMs&quot;</span> <span class="p">=</span> <span class="p">@(</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;WEB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-web-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Web Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;DB-DEV-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-database-development&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Database Dev - join existing dev/test window&quot;</span> <span class="p">},</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>            <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;TEST-SERVER-01&quot;</span><span class="p">;</span> <span class="n">RG</span> <span class="p">=</span> <span class="s2">&quot;rg-testing&quot;</span><span class="p">;</span> <span class="n">Sub</span> <span class="p">=</span> <span class="s2">&quot;Development&quot;</span><span class="p">;</span> <span class="n">Window</span> <span class="p">=</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">;</span> <span class="n">Reason</span> <span class="p">=</span> <span class="s2">&quot;Test Server - join existing dev/test window&quot;</span> <span class="p">}</span>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>            <span class="c"># ... additional dev/test VMs</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>        <span class="p">)</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>    <span class="p">}</span>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a><span class="p">}</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>
</span><span id="__span-6-115"><a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a><span class="c"># Initialize counters</span>
</span><span id="__span-6-116"><a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a><span class="nv">$totalProcessed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-117"><a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a><span class="nv">$totalSuccess</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-118"><a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a><span class="nv">$totalFailed</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-6-119"><a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>
</span><span id="__span-6-120"><a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a><span class="c"># Process each group</span>
</span><span id="__span-6-121"><a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$groupName</span> <span class="k">in</span> <span class="nv">$vmGroups</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-122"><a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>    <span class="nv">$group</span> <span class="p">=</span> <span class="nv">$vmGroups</span><span class="p">[</span><span class="nv">$groupName</span><span class="p">]</span>
</span><span id="__span-6-123"><a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">=== $groupName ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span><span id="__span-6-124"><a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Processing </span><span class="p">$(</span><span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span><span class="s2"> VMs in this group&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-125"><a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>
</span><span id="__span-6-126"><a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vmInfo</span> <span class="k">in</span> <span class="nv">$group</span><span class="p">.</span><span class="n">VMs</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-127"><a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Window</span>
</span><span id="__span-6-128"><a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>        <span class="nv">$vmName</span> <span class="p">=</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span>
</span><span id="__span-6-129"><a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>
</span><span id="__span-6-130"><a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">�️ $vmName → $window maintenance window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-6-131"><a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;   Reason: </span><span class="p">$(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Reason</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-6-132"><a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a>
</span><span id="__span-6-133"><a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>        <span class="c"># Determine subscription ID from name</span>
</span><span id="__span-6-134"><a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>        <span class="nv">$subscriptionId</span> <span class="p">=</span> <span class="k">switch</span> <span class="p">(</span><span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Sub</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-135"><a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>            <span class="s2">&quot;Production&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Production&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-6-136"><a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>            <span class="s2">&quot;DevTest&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DevTest&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-6-137"><a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>            <span class="s2">&quot;Identity&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;Identity&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-6-138"><a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>            <span class="s2">&quot;DMZ&quot;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionName</span> <span class="s2">&quot;DMZ&quot;</span><span class="p">).</span><span class="n">Id</span> <span class="p">}</span>
</span><span id="__span-6-139"><a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>        <span class="p">}</span>
</span><span id="__span-6-140"><a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>
</span><span id="__span-6-141"><a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>        <span class="c"># Create appropriate tags based on maintenance window</span>
</span><span id="__span-6-142"><a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>        <span class="nv">$tags</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-6-143"><a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>            <span class="s2">&quot;Owner&quot;</span> <span class="p">=</span> <span class="s2">&quot;Contoso&quot;</span>
</span><span id="__span-6-144"><a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>            <span class="s2">&quot;Updates&quot;</span> <span class="p">=</span> <span class="s2">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-6-145"><a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>        <span class="p">}</span>
</span><span id="__span-6-146"><a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>
</span><span id="__span-6-147"><a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$window</span> <span class="o">-eq</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-148"><a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s2">&quot;sat-09&quot;</span>  <span class="c"># Saturday 09:00 for dev/test</span>
</span><span id="__span-6-149"><a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-6-150"><a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>            <span class="nv">$tags</span><span class="p">[</span><span class="s2">&quot;PatchWindow&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$window</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  <span class="c"># mon, tue, wed, etc.</span>
</span><span id="__span-6-151"><a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>        <span class="p">}</span>
</span><span id="__span-6-152"><a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>
</span><span id="__span-6-153"><a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>        <span class="nv">$result</span> <span class="p">=</span> <span class="nb">Set-VMMaintenanceTags</span> <span class="n">-VMName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">Name</span> <span class="n">-ResourceGroupName</span> <span class="nv">$vmInfo</span><span class="p">.</span><span class="n">RG</span> <span class="n">-SubscriptionId</span> <span class="nv">$subscriptionId</span> <span class="n">-Tags</span> <span class="nv">$tags</span> <span class="n">-MaintenanceWindow</span> <span class="nv">$window</span>
</span><span id="__span-6-154"><a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>
</span><span id="__span-6-155"><a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>        <span class="nv">$totalProcessed</span><span class="p">++</span>
</span><span id="__span-6-156"><a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span> 
</span><span id="__span-6-157"><a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>            <span class="nv">$totalSuccess</span><span class="p">++</span>
</span><span id="__span-6-158"><a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>            <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-6-159"><a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span><span id="__span-6-160"><a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a>            <span class="nv">$totalFailed</span><span class="p">++</span> 
</span><span id="__span-6-161"><a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>        <span class="p">}</span>
</span><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a>    <span class="p">}</span>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a><span class="p">}</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-166"><a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== TAGGING SUMMARY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-167"><a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total VMs processed: $totalProcessed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-168"><a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Successfully tagged: $totalSuccess&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-169"><a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Failed to tag: $totalFailed&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span><span id="__span-6-170"><a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a>
</span><span id="__span-6-171"><a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-172"><a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== NEW MAINTENANCE WINDOW DISTRIBUTION ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-173"><a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a><span class="nb">Write-Host</span> <span class="s2">&quot;VMs added to each maintenance window:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-174"><a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>
</span><span id="__span-6-175"><a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a><span class="nv">$newAssignments</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-6-176"><a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-177"><a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>        <span class="nv">$newTotal</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Value</span>
</span><span id="__span-6-178"><a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: +</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs (total: $newTotal VMs)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-179"><a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>    <span class="p">}</span>
</span><span id="__span-6-180"><a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a><span class="p">}</span>
</span><span id="__span-6-181"><a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>
</span><span id="__span-6-182"><a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-183"><a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== FINAL MAINTENANCE WINDOW LOAD ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-184"><a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a><span class="nv">$finalLoad</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-6-185"><a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a><span class="nv">$currentLoad</span><span class="p">.</span><span class="n">Keys</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-6-186"><a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>    <span class="nv">$finalLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$currentLoad</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span> <span class="p">+</span> <span class="nv">$newAssignments</span><span class="p">[</span><span class="nv">$_</span><span class="p">]</span>
</span><span id="__span-6-187"><a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a><span class="p">}</span>
</span><span id="__span-6-188"><a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>
</span><span id="__span-6-189"><a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-6-190"><a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>    <span class="nv">$status</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">8</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Green&quot;</span> <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span> <span class="o">-le</span> <span class="n">12</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Yellow&quot;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s2">&quot;Red&quot;</span> <span class="p">}</span>
</span><span id="__span-6-191"><a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="nv">$status</span>
</span><span id="__span-6-192"><a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a><span class="p">}</span>
</span><span id="__span-6-193"><a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>
</span><span id="__span-6-194"><a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a><span class="nv">$grandTotal</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$finalLoad</span><span class="p">.</span><span class="n">Values</span> <span class="p">|</span> <span class="nb">Measure-Object</span> <span class="n">-Sum</span><span class="p">).</span><span class="n">Sum</span>
</span><span id="__span-6-195"><a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Grand Total: $grandTotal VMs across all maintenance windows&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-196"><a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>
</span><span id="__span-6-197"><a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-198"><a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== BUSINESS LOGIC APPLIED ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-199"><a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Critical systems spread across different days for resilience&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-200"><a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Domain Controllers distributed to avoid single points of failure&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-201"><a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Dev/Test systems consolidated to Saturday morning (existing pattern)&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-202"><a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Production workstations spread to minimize user impact&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-203"><a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Business applications distributed for operational continuity&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-204"><a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a><span class="nb">Write-Host</span> <span class="s2">&quot;✅ Load balancing maintained across the week&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-205"><a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>
</span><span id="__span-6-206"><a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-207"><a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VERIFICATION STEPS ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-208"><a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a><span class="nb">Write-Host</span> <span class="s2">&quot;1. Verify tags in Azure Portal across all subscriptions&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-209"><a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a><span class="nb">Write-Host</span> <span class="s2">&quot;2. Check that critical systems are on different days&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-210"><a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a><span class="nb">Write-Host</span> <span class="s2">&quot;3. Confirm dev/test systems are in Saturday morning window&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-211"><a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a><span class="nb">Write-Host</span> <span class="s2">&quot;4. Review production systems distribution&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-212"><a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>
</span><span id="__span-6-213"><a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-214"><a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== AZURE RESOURCE GRAPH VERIFICATION QUERY ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-215"><a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Use this query to verify all VMs are now tagged:&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-6-216"><a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-217"><a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a><span class="nb">Write-Host</span> <span class="sh">@&quot;</span>
</span><span id="__span-6-218"><a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a><span class="sh">Resources</span>
</span><span id="__span-6-219"><a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a><span class="sh">| where type == &quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-6-220"><a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a><span class="sh">| where tags.Updates == &quot;Azure Update Manager&quot;</span>
</span><span id="__span-6-221"><a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a><span class="sh">| project name, resourceGroup, subscriptionId, </span>
</span><span id="__span-6-222"><a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a><span class="sh">          patchWindow = tags.PatchWindow,</span>
</span><span id="__span-6-223"><a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a><span class="sh">          owner = tags.Owner,</span>
</span><span id="__span-6-224"><a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a><span class="sh">          updates = tags.Updates</span>
</span><span id="__span-6-225"><a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a><span class="sh">| sort by patchWindow, name</span>
</span><span id="__span-6-226"><a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a><span class="sh">| summarize count() by patchWindow</span>
</span><span id="__span-6-227"><a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a><span class="sh">&quot;@</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span><span id="__span-6-228"><a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a>
</span><span id="__span-6-229"><a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$totalFailed</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-6-230"><a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-231"><a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;� ALL VMs SUCCESSFULLY TAGGED WITH INTELLIGENT DISTRIBUTION! �&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span><span id="__span-6-232"><a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-6-233"><a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-234"><a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;⚠️ Some VMs failed to tag. Please review errors above.&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span id="__span-6-235"><a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a><span class="p">}</span>
</span><span id="__span-6-236"><a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>
</span><span id="__span-6-237"><a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a><span class="nb">Write-Host</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-6-238"><a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Script completed at </span><span class="p">$(</span><span class="nb">Get-Date</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-6-239"><a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Total runtime: </span><span class="p">$((</span><span class="nb">Get-Date</span><span class="p">)</span> <span class="p">-</span> <span class="nv">$scriptStart</span><span class="p">)</span><span class="s2">&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></code></pre></div>

</details>

<blockquote>
<p><strong>Key insight:</strong> I grouped VMs by function and criticality, not just by convenience. Domain controllers got spread across different days, dev/test systems joined the existing Saturday morning window, and production applications were distributed for business continuity.</p>
</blockquote>
<hr />
<h2 id="step-7-configure-azure-policy-prerequisites">🧰 Step 7 – Configure Azure Policy Prerequisites</h2>
<p>Here's where things get interesting. Update Manager is built on compliance — but your VMs won't show up in dynamic scopes unless they meet certain prerequisites. Enter Azure Policy to save the day.</p>
<p>You'll need two specific built-in policies assigned at the subscription (or management group) level:</p>
<h3 id="policy-1-set-prerequisites-for-scheduling-recurring-updates-on-azure-virtual-machines">✅ Policy 1: <code>Set prerequisites for scheduling recurring updates on Azure virtual machines</code></h3>
<p><strong>What it does:</strong> This policy ensures your VMs have the necessary configurations to participate in Azure Update Manager. It automatically:</p>
<ul>
<li>Installs the Azure Update Manager extension on Windows VMs</li>
<li>Registers required resource providers</li>
<li>Configures the VM to report its update compliance status</li>
<li>Sets the patch orchestration mode appropriately</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> Without this policy, VMs won't appear in Update Manager scopes even if they're tagged correctly. The policy handles all the "plumbing" automatically.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Apply this at subscription or management group level to catch all VMs.</p>
<h3 id="policy-2-configure-periodic-checking-for-missing-system-updates-on-azure-virtual-machines">✅ Policy 2: <code>Configure periodic checking for missing system updates on Azure virtual machines</code></h3>
<p><strong>What it does:</strong> This is your compliance engine. It configures VMs to:</p>
<ul>
<li>Regularly scan for available updates (but not install them automatically)</li>
<li>Report update status back to Azure Update Manager</li>
<li>Enable the compliance dashboard views in the portal</li>
<li>Provide the data needed for maintenance configuration targeting</li>
</ul>
<blockquote>
<p><strong>Why this matters:</strong> This policy turns on the "update awareness" for your VMs. Without it, Azure Update Manager has no visibility into what patches are needed.</p>
</blockquote>
<p><strong>Assignment scope:</strong> Same as above — subscription or management group level.</p>
<h3 id="assigning-the-policies">🎯 Assigning the Policies</h3>
<p><strong>Step-by-step in Azure Portal:</strong></p>
<ol>
<li><strong>Navigate to Azure Policy</strong></li>
<li>
<p>Azure Portal → Search "Policy" → Select "Policy"</p>
</li>
<li>
<p><strong>Find the First Policy</strong></p>
</li>
<li>Left menu: <strong>Definitions</strong></li>
<li>Search: <code>Set prerequisites for scheduling recurring updates</code></li>
<li>
<p>Click on the policy title</p>
</li>
<li>
<p><strong>Assign the Policy</strong></p>
</li>
<li>Click <strong>Assign</strong> button</li>
<li><strong>Scope:</strong> Select your subscription(s)</li>
<li><strong>Basics:</strong> Leave policy name as default</li>
<li><strong>Parameters:</strong> Leave as default</li>
<li><strong>Remediation:</strong> ✅ Check "Create remediation task"</li>
<li>
<p><strong>Review + create</strong></p>
</li>
<li>
<p><strong>Repeat for Second Policy</strong></p>
</li>
<li>Search: <code>Configure periodic checking for missing system updates</code></li>
<li>Follow same assignment process</li>
</ol>
<blockquote>
<p>⚠️ <strong>Important:</strong> Policy compliance can take 30+ minutes to evaluate and apply. Perfect time for that brew I mentioned earlier.</p>
</blockquote>
<h3 id="monitoring-compliance">🔍 Monitoring Compliance</h3>
<p>Once assigned, you can track compliance in <strong>Azure Policy &gt; Compliance</strong>. Look for:</p>
<ul>
<li>Non-compliant VMs that need the extension installed</li>
<li>VMs that aren't reporting update status properly</li>
<li>Any policy assignment errors that need investigation</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/prerequsite-for-schedule-patching">Learn more about Azure Policy for Update Management</a></p>
<hr />
<h2 id="step-8-create-dynamic-scopes-in-update-manager">🧪 Step 8 – Create Dynamic Scopes in Update Manager</h2>
<p>This is where it all comes together — and where the magic happens.</p>
<p>Dynamic scopes use those <code>PatchWindow</code> tags to assign VMs to the correct patch config automatically. No more manual VM assignment, no more "did we remember to add the new server?" conversations.</p>
<h3 id="the-portal-dance">🎯 The Portal Dance</h3>
<p>Unfortunately, as of writing, dynamic scopes can only be configured through the Azure portal — no PowerShell or ARM template support yet.</p>
<blockquote>
<p><strong>Why portal only?</strong> Dynamic scopes are still in preview, and Microsoft hasn't released the PowerShell cmdlets or ARM template schemas yet. This means you can't fully automate the deployment, but the functionality itself works perfectly.</p>
</blockquote>
<p>Here's the step-by-step:</p>
<ol>
<li><strong>Navigate to Azure Update Manager</strong></li>
<li>
<p>Portal → All Services → Azure Update Manager</p>
</li>
<li>
<p><strong>Access Maintenance Configurations</strong></p>
</li>
<li>Go to <strong>Maintenance Configurations (Preview)</strong></li>
<li>
<p>Select one of your configs (e.g., <code>contoso-maintenance-config-vms-mon</code>)</p>
</li>
<li>
<p><strong>Create Dynamic Scope</strong></p>
</li>
<li>Click <strong>Dynamic Scopes</strong> → <strong>Add</strong></li>
<li><strong>Name:</strong> <code>DynamicScope-Monday-VMs</code></li>
<li>
<p><strong>Description:</strong> <code>Auto-assign Windows VMs tagged for Monday maintenance</code></p>
</li>
<li>
<p><strong>Configure Scope Settings</strong></p>
</li>
<li><strong>Subscription:</strong> Select your subscription(s)</li>
<li><strong>Resource Type:</strong> <code>Microsoft.Compute/virtualMachines</code></li>
<li>
<p><strong>OS Type:</strong> <code>Windows</code> (create separate scopes for Linux if needed)</p>
</li>
<li>
<p><strong>Set Tag Filters</strong></p>
</li>
<li><strong>Tag Name:</strong> <code>PatchWindow</code></li>
<li><strong>Tag Value:</strong> <code>mon</code> (must match your maintenance config naming)</li>
<li>
<p><strong>Additional filters</strong> (optional):</p>
<ul>
<li><code>Owner</code> = <code>Contoso</code></li>
<li><code>Updates</code> = <code>Azure Update Manager</code></li>
</ul>
</li>
<li>
<p><strong>Review and Create</strong></p>
</li>
<li>Verify the filter logic</li>
<li>Click <strong>Create</strong></li>
</ol>
<h3 id="repeat-for-all-days">🔄 Repeat for All Days</h3>
<p>You'll need to create dynamic scopes for each maintenance configuration:</p>
<table>
<thead>
<tr>
<th>Maintenance Config</th>
<th>Dynamic Scope Name</th>
<th>Tag Filter</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>contoso-maintenance-config-vms-mon</code></td>
<td><code>DynamicScope-Monday-VMs</code></td>
<td><code>PatchWindow = mon</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-tue</code></td>
<td><code>DynamicScope-Tuesday-VMs</code></td>
<td><code>PatchWindow = tue</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-wed</code></td>
<td><code>DynamicScope-Wednesday-VMs</code></td>
<td><code>PatchWindow = wed</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-thu</code></td>
<td><code>DynamicScope-Thursday-VMs</code></td>
<td><code>PatchWindow = thu</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-fri</code></td>
<td><code>DynamicScope-Friday-VMs</code></td>
<td><code>PatchWindow = fri</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sat</code></td>
<td><code>DynamicScope-Saturday-VMs</code></td>
<td><code>PatchWindow = sat-09</code></td>
</tr>
<tr>
<td><code>contoso-maintenance-config-vms-sun</code></td>
<td><code>DynamicScope-Sunday-VMs</code></td>
<td><code>PatchWindow = sun</code></td>
</tr>
</tbody>
</table>
<h3 id="verify-dynamic-scope-assignment">🔍 Verify Dynamic Scope Assignment</h3>
<p>Once created, you can verify the scopes are working:</p>
<ol>
<li><strong>In the Maintenance Configuration:</strong></li>
<li>Go to <strong>Dynamic Scopes</strong></li>
<li>Check <strong>Resources</strong> tab to see matched VMs</li>
<li>Verify expected VM count matches your tagging</li>
<li>
<p><strong>Wait time:</strong> Allow 15-30 minutes for newly tagged VMs to appear</p>
</li>
<li>
<p><strong>What success looks like:</strong></p>
</li>
<li>Monday scope shows 5 VMs (WEB-PROD-01, DB-PROD-01, etc.)</li>
<li>Saturday scope shows 5 VMs (WEB-DEV-01, DB-DEV-01, etc.)</li>
<li>
<p>No VMs showing? Check tag case sensitivity and filters</p>
</li>
<li>
<p><strong>In Azure Resource Graph:</strong></p>
</li>
</ol>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">vmName</span>
</span></code></pre></div>
<ol>
<li><strong>Troubleshoot empty scopes:</strong></li>
<li>Verify subscription selection includes all your VMs</li>
<li>Check tag spelling: <code>PatchWindow</code> (case sensitive)</li>
<li>Confirm resource type filter: <code>Microsoft.Compute/virtualMachines</code></li>
<li>Wait longer - it can take up to 30 minutes</li>
</ol>
<h3 id="common-gotchas">⚠️ Common Gotchas</h3>
<p><strong>Tag Case Sensitivity:</strong> Dynamic scopes are case-sensitive. <code>mon</code> ≠ <code>Mon</code> ≠ <code>MON</code></p>
<p><strong>Subscription Scope:</strong> Ensure you've selected all relevant subscriptions in the scope configuration.</p>
<p><strong>Resource Type Filter:</strong> Don't forget to set the resource type filter — without it, you'll match storage accounts, networking, etc.</p>
<p><strong>Timing:</strong> It can take 15-30 minutes for newly tagged VMs to appear in dynamic scopes.</p>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/dynamic-scope">Dynamic scope configuration docs</a></p>
<hr />
<h2 id="step-9-test-verify-the-moment-of-truth">🚀 Step 9 – Test &amp; Verify (The Moment of Truth)</h2>
<p>The acid test: does it actually patch stuff properly?</p>
<h3 id="proof-of-concept-test">🎪 Proof of Concept Test</h3>
<p>I started conservatively — scoped <code>contoso-maintenance-config-vms-sun</code> to a few non-critical VMs and let it run overnight on Sunday.</p>
<p><strong>Monday morning verification:</strong></p>
<ul>
<li>✔️ <strong>Patch compliance dashboard:</strong> All green ticks</li>
<li>✔️ <strong>Reboot timing:</strong> Machines restarted within their 4-hour window (21:00-01:00)</li>
<li>✔️ <strong>Update logs:</strong> Activity logs showed expected patching behavior</li>
<li>✔️ <strong>Business impact:</strong> Zero helpdesk tickets on Monday morning</li>
</ul>
<h3 id="full-rollout-verification">📊 Full Rollout Verification</h3>
<p>Once confident with the Sunday test, I enabled all remaining dynamic scopes and monitored the week:</p>
<p><strong>Key metrics tracked:</strong></p>
<ul>
<li>Patch compliance percentage across all VMs</li>
<li>Failed patch installations (and root causes)</li>
<li>Reboot timing adherence</li>
<li>Business hours impact (spoiler: zero)</li>
</ul>
<h3 id="monitoring-validation-tools">🔍 Monitoring &amp; Validation Tools</h3>
<p><strong>Azure Update Manager Dashboard:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Azure Portal → Update Manager → Overview
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>- Patch compliance summary
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>- Recent patch installations
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>- Failed installations with details
</span></code></pre></div>
<p><strong>Azure Resource Graph Queries:</strong></p>
<div class="language-kusto highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c">// Verify all VMs have maintenance tags</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">Resources</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.compute/virtualmachines&quot;</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Updates</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;Azure Update Manager&quot;</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">resourceGroup</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">          </span><span class="n">patchWindow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">PatchWindow</span><span class="p">,</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">          </span><span class="n">owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tags</span><span class="err">.</span><span class="n">Owner</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">patchWindow</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="c">// Check maintenance configuration assignments</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="n">MaintenanceResources</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;microsoft.maintenance/configurationassignments&quot;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">vmName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">resourceId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="p">|</span><span class="w"> </span><span class="k">extend</span><span class="w"> </span><span class="n">configName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tostring</span><span class="p">(</span><span class="n">properties</span><span class="err">.</span><span class="n">maintenanceConfigurationId</span><span class="p">)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="p">|</span><span class="w"> </span><span class="k">project</span><span class="w"> </span><span class="n">vmName</span><span class="p">,</span><span class="w"> </span><span class="n">configName</span><span class="p">,</span><span class="w"> </span><span class="n">subscriptionId</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="p">|</span><span class="w"> </span><span class="k">summarize</span><span class="w"> </span><span class="n">VMCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="p">|</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">configName</span>
</span></code></pre></div>
<p><strong>PowerShell Verification:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c"># Quick check of maintenance configuration status</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="p">|</span> 
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span> <span class="n">MaintenanceScope</span><span class="p">,</span> <span class="n">RecurEvery</span> <span class="p">|</span> 
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="nb">Format-Table</span> <span class="n">-AutoSize</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c"># Verify VM tag distribution</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="nv">$subscriptions</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">State</span> <span class="o">-eq</span> <span class="s2">&quot;Enabled&quot;</span> <span class="p">}</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="nv">$tagSummary</span> <span class="p">=</span> <span class="p">@{}</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$sub</span> <span class="k">in</span> <span class="nv">$subscriptions</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="nb">Set-AzContext</span> <span class="n">-SubscriptionId</span> <span class="nv">$sub</span><span class="p">.</span><span class="n">Id</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="nv">$vms</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span> <span class="p">}</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$vm</span> <span class="k">in</span> <span class="nv">$vms</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="nv">$window</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">PatchWindow</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$tagSummary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="nv">$window</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>            <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]</span> <span class="p">=</span> <span class="n">0</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="p">}</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="nv">$tagSummary</span><span class="p">[</span><span class="nv">$window</span><span class="p">]++</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    <span class="p">}</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="p">}</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="nb">Write-Host</span> <span class="s2">&quot;=== VM DISTRIBUTION BY PATCH WINDOW ===&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="nv">$tagSummary</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">Name</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$_</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span><span class="s2"> VMs&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="success-metrics">📈 Success Metrics</h3>
<p>After two full weeks of operation:</p>
<ul>
<li><strong>Better control:</strong> Direct management of patch schedules and policies  </li>
<li><strong>Increased visibility:</strong> Real-time compliance dashboards vs. periodic reports</li>
<li><strong>Reduced complexity:</strong> Native Azure tooling vs. third-party solutions</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/azure/update-manager/monitor-updates">Monitor updates in Azure Update Manager</a></p>
<hr />
<h2 id="final-thoughts-tips">📃 Final Thoughts &amp; Tips</h2>
<p>✅ <strong>Cost-neutral</strong> — No more third-party patch agents
✅ <strong>Policy-driven</strong> — Enforced consistency with Azure Policy
✅ <strong>Easily auditable</strong> — Tag-based scoping is clean and visible
✅ <strong>Scalable</strong> — New VMs auto-join patch schedules via tagging</p>
<h3 id="troubleshooting-guide-common-issues">⚠️ Troubleshooting Guide &amp; Common Issues</h3>
<p>Here's what I learned the hard way, so you don't have to:</p>
<table>
<thead>
<tr>
<th><strong>Symptom</strong></th>
<th><strong>Possible Cause</strong></th>
<th><strong>Fix</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>VM not showing in dynamic scope</td>
<td>Tag typo or case mismatch</td>
<td>Verify <code>PatchWindow</code> tag exactly matches config name</td>
</tr>
<tr>
<td>Maintenance config creation fails</td>
<td>Invalid duration format</td>
<td>Use ISO 8601 format: <code>"03:00"</code> not <code>"3 hours"</code></td>
</tr>
<tr>
<td>VM skipped during patching</td>
<td>Policy prerequisites not met</td>
<td>Check Azure Policy compliance dashboard</td>
</tr>
<tr>
<td>No updates applied despite schedule</td>
<td>VM needs pending reboot</td>
<td>Clear previous reboots, check update history</td>
</tr>
<tr>
<td>Dynamic scope shows zero VMs</td>
<td>Wrong subscription scope</td>
<td>Verify subscription selection in scope config</td>
</tr>
<tr>
<td>Extension installation failed</td>
<td>Insufficient permissions</td>
<td>Ensure VM contributor rights and resource provider registration</td>
</tr>
<tr>
<td>Policy compliance stuck at 0%</td>
<td>Assignment scope too narrow</td>
<td>Check policy is assigned at subscription level</td>
</tr>
<tr>
<td>VMs appear/disappear from scope</td>
<td>Tag inconsistency</td>
<td>Run tag verification script across all subscriptions</td>
</tr>
</tbody>
</table>
<h3 id="advanced-troubleshooting-commands">🔧 Advanced Troubleshooting Commands</h3>
<p><strong>Check VM Update Readiness:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c"># Verify VM has required extensions and configuration</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nv">$vmName</span> <span class="p">=</span> <span class="s2">&quot;your-vm-name&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nv">$rgName</span> <span class="p">=</span> <span class="s2">&quot;your-resource-group&quot;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nv">$vm</span> <span class="p">=</span> <span class="nb">Get-AzVM</span> <span class="n">-Name</span> <span class="nv">$vmName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$rgName</span> <span class="n">-Status</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="nv">$vm</span><span class="p">.</span><span class="n">Extensions</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Update*&quot;</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-like</span> <span class="s2">&quot;*Maintenance*&quot;</span> <span class="p">}</span>
</span></code></pre></div>
<p><strong>Validate Maintenance Configuration:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># Test maintenance configuration is properly formed</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nv">$config</span> <span class="p">=</span> <span class="nb">Get-AzMaintenanceConfiguration</span> <span class="n">-ResourceGroupName</span> <span class="s2">&quot;rg-maintenance-uksouth-001&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;contoso-maintenance-config-vms-mon&quot;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Config Name: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Recurrence: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">RecurEvery</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Duration: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">Duration</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Start Time: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">StartDateTime</span><span class="p">)</span><span class="s2">&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Timezone: </span><span class="p">$(</span><span class="nv">$config</span><span class="p">.</span><span class="n">TimeZone</span><span class="p">)</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>Policy Compliance Deep Dive:</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c"># Check specific VMs for policy compliance</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nv">$policyName</span> <span class="p">=</span> <span class="s2">&quot;Set prerequisites for scheduling recurring updates on Azure virtual machines&quot;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nv">$assignments</span> <span class="p">=</span> <span class="nb">Get-AzPolicyAssignment</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-eq</span> <span class="nv">$policyName</span> <span class="p">}</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$assignment</span> <span class="k">in</span> <span class="nv">$assignments</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="nb">Get-AzPolicyState</span> <span class="n">-PolicyAssignmentId</span> <span class="nv">$assignment</span><span class="p">.</span><span class="n">PolicyAssignmentId</span> <span class="p">|</span> 
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ComplianceState</span> <span class="o">-eq</span> <span class="s2">&quot;NonCompliant&quot;</span> <span class="p">}</span> <span class="p">|</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="nb">Select-Object</span> <span class="n">ResourceId</span><span class="p">,</span> <span class="n">ComplianceState</span><span class="p">,</span> <span class="p">@{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Reason&quot;</span><span class="p">;</span><span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">PolicyEvaluationDetails</span><span class="p">.</span><span class="n">EvaluatedExpressions</span><span class="p">.</span><span class="n">ExpressionValue</span><span class="p">}}</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<p><em>As always, comments and suggestions welcome over on GitHub or LinkedIn. If you've migrated patching in a different way, I'd love to hear how you approached it.</em></p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=Bringing%20Patch%20Management%20In-House%3A%20Migrating%20from%20MSP%20to%20Azure%20Update%20Manager%0A&amp;url=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.pollockweb.com/blog/bringing-patch-management-in-house-migrating-from-msp-to-azure-update-manager/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 30, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 29, 2025</span>
  </span>

    
    
    
  </aside>


  


  


<script src="https://giscus.app/client.js"
        data-repo="cloudlabmp/project-blog"
        data-repo-id="R_kgDOODgKaQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOODgKac4Cnldm"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        
  <div class="custom-footer">
    <div class="custom-footer-left">
      <p>Copyright &copy; 2025 Matthew Pollock</p>
    </div>
    <div class="custom-footer-right">
      <a href="https://github.com/cloudlabmp" target="_blank" title="GitHub">
        <i class="fab fa-github"></i>
      </a>
      <a href="https://linkedin.com/in/matthew-pollock-76831920/" target="_blank" title="LinkedIn">
        <i class="fab fa-linkedin"></i>
      </a>
      <a href="https://profile.pollockweb.com" target="_blank" title="profile.pollockweb.com">
        <i class="fas fa-globe"></i>
      </a>
    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "content.code.select", "content.code.copy", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>